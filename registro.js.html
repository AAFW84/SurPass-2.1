<script>
// Sistema de Toasts Modernos
function showToast(title, message, type = 'info') {
    const container = document.getElementById('toast-container');
    if (!container) return;
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    const iconMap = {
        success: 'fa-circle-check',
        error: 'fa-circle-exclamation',
        info: 'fa-circle-info'
    };
    toast.innerHTML = `
        <span class="toast-icon"><i class="fa-solid ${iconMap[type] || iconMap.info}"></i></span>
        <div style="flex:1;">
            <div class="toast-title">${title}</div>
            <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()"><i class="fa-solid fa-xmark"></i></button>
        <div class="toast-progress"><div class="toast-progress-bar"></div></div>
    `;
    container.appendChild(toast);
    // Barra de progreso animada
    const progressBar = toast.querySelector('.toast-progress-bar');
    let start = null;
    let duration = 5000;
    function animate(ts) {
        if (!start) start = ts;
        let elapsed = ts - start;
        let percent = Math.min(elapsed / duration, 1);
        progressBar.style.width = ((1 - percent) * 100) + '%';
        if (percent < 1) {
            requestAnimationFrame(animate);
        } else {
            toast.remove();
        }
    }
    progressBar.style.width = '100%';
    requestAnimationFrame(animate);
}
    document.addEventListener('DOMContentLoaded', function() {

        console.log('üöÄ Iniciando SurPass - Sistema Unificado v3.0');

        // =====================================================
        // üîß [CONFIG-INTEGRATION] CARGA DE CONFIGURACIONES EMPRESARIALES
        // =====================================================
        
        // Funci√≥n para cargar y aplicar configuraciones empresariales
        function cargarConfiguracionesEmpresa() {
            console.log('üè¢ [CONFIG-INTEGRATION] Cargando configuraciones empresariales...');
            
            // Obtener configuraciones del sistema global
            const empresaConfig = window.systemConfig?.empresa || {};
            
            // Aplicar nombre de empresa din√°mico
            const nombreEmpresa = empresaConfig.EMPRESA_NOMBRE || 'SurPass';
            const companyNameElement = document.getElementById('company-name');
            const pageTitleElement = document.getElementById('page-title');
            
            if (companyNameElement) {
                companyNameElement.textContent = nombreEmpresa;
                console.log('üè¢ [CONFIG-INTEGRATION] Nombre empresa aplicado:', nombreEmpresa);
            }
            
            if (pageTitleElement) {
                pageTitleElement.textContent = `${nombreEmpresa} - Sistema de Control de Acceso`;
                console.log('üìÑ [CONFIG-INTEGRATION] T√≠tulo p√°gina aplicado:', pageTitleElement.textContent);
            }
            
            // Aplicar logo si est√° disponible
            const logoEmpresa = empresaConfig.EMPRESA_LOGO;
            if (logoEmpresa && logoEmpresa.trim() !== '') {
                const logoElement = document.querySelector('.logo i');
                if (logoElement) {
                    // Si es una URL de imagen, reemplazar con img
                    if (logoEmpresa.includes('http')) {
                        const imgElement = document.createElement('img');
                        imgElement.src = logoEmpresa;
                        imgElement.alt = nombreEmpresa;
                        imgElement.className = 'company-logo';
                        imgElement.style.maxHeight = '32px';
                        imgElement.style.maxWidth = '32px';
                        logoElement.parentNode.replaceChild(imgElement, logoElement);
                        console.log('üñºÔ∏è [CONFIG-INTEGRATION] Logo empresa aplicado:', logoEmpresa);
                    }
                    // Si es una clase de icono, cambiar la clase
                    else if (logoEmpresa.includes('fa-')) {
                        logoElement.className = `fas ${logoEmpresa}`;
                        console.log('üé® [CONFIG-INTEGRATION] Icono empresa aplicado:', logoEmpresa);
                    }
                }
            }
            
            // Guardar configuraciones para validaciones posteriores
            window.empresaConfig = empresaConfig;
            
            // üîç DEBUG: Logging detallado de la configuraci√≥n empresarial
            console.log('‚úÖ [CONFIG-INTEGRATION] Configuraciones empresariales cargadas:', empresaConfig);
            console.log('üîç [DEBUG-CONFIG] DIAS_LABORABLES espec√≠fico:', empresaConfig.DIAS_LABORABLES);
            console.log('üîç [DEBUG-CONFIG] Configuraci√≥n completa disponible:');
            Object.keys(empresaConfig).forEach(key => {
                console.log(`   ‚Ä¢ ${key}: ${empresaConfig[key]}`);
            });
            
            // Verificaci√≥n espec√≠fica para d√≠as laborables
            if (empresaConfig.DIAS_LABORABLES) {
                const diasConfigurados = empresaConfig.DIAS_LABORABLES.split(',').map(d => d.trim());
                console.log('üìÖ [CONFIG-SUCCESS] D√≠as laborables configurados:', diasConfigurados);
                
                // Verificar si incluye fines de semana
                const tieneSabado = diasConfigurados.includes('S√°bado');
                const tieneDomingo = diasConfigurados.includes('Domingo');
                console.log(`üìÖ [CONFIG-INFO] Incluye S√°bado: ${tieneSabado ? '‚úÖ S√ç' : '‚ùå NO'}`);
                console.log(`üìÖ [CONFIG-INFO] Incluye Domingo: ${tieneDomingo ? '‚úÖ S√ç' : '‚ùå NO'}`);
                
            } else {
                console.warn('‚ö†Ô∏è [CONFIG-WARNING] DIAS_LABORABLES no encontrado en configuraci√≥n empresarial');
            }
        }
        
        // üîß [CONFIG-INTEGRATION] Funci√≥n de validaci√≥n de horario empresarial
        function validarHorarioEmpresa() {
            const config = window.empresaConfig || {};
            // Usar zona horaria de Panam√° cuando sea posible
            const ahora = (typeof obtenerFechaHoraPanama === 'function') ? obtenerFechaHoraPanama() : new Date();
            const diaActual = ahora.getDay(); // 0 = Domingo, 1 = Lunes, etc.
            const horaActual = ahora.getHours() + ':' + ahora.getMinutes().toString().padStart(2, '0');
            
            // Parsear d√≠as laborables - IMPORTANTE: Usar configuraci√≥n real de Google Sheets
            let diasLaborables = config.DIAS_LABORABLES;
            let skipDiasCheck = false;
            
            // ‚ö†Ô∏è DEBUGGING: Log para verificar qu√© configuraci√≥n se est√° usando
            console.log('üîç [DEBUG-DIAS-LABORABLES] Configuraci√≥n recibida:', config);
            console.log('üîç [DEBUG-DIAS-LABORABLES] DIAS_LABORABLES desde config:', diasLaborables);
            console.log('üîç [DEBUG-DIAS-LABORABLES] Tipo de dato:', typeof diasLaborables);
            
            // Si no hay configuraci√≥n desde Google Sheets, no aplicar valores por defecto: omitir validaci√≥n de d√≠as
            if (typeof diasLaborables === 'string') diasLaborables = diasLaborables.trim();
            if (!diasLaborables) {
                console.warn('‚ö†Ô∏è [CONFIG-WARNING] DIAS_LABORABLES no definido en hoja de configuraci√≥n. Se omite validaci√≥n de d√≠as laborables.');
                if (typeof google !== 'undefined' && google.script && google.script.run) {
                    try {
                        google.script.run.registrarLog('WARNING', 'DIAS_LABORABLES no definido - Omitiendo validaci√≥n de d√≠as', {
                            configDisponible: Object.keys(config),
                            valorRecibido: diasLaborables,
                            tipoConfiguracion: typeof config
                        }, 'Sistema de Registro');
                    } catch (e) {
                        console.warn('No se pudo registrar advertencia de configuraci√≥n:', e);
                    }
                }
                if (typeof mostrarAlerta === 'function') {
                    mostrarAlerta('‚ö†Ô∏è No se configuraron D√çAS LABORABLES en la hoja. Se omitir√° esta validaci√≥n.', 'warning');
                }
                skipDiasCheck = true;
            } else {
                console.log('‚úÖ [CONFIG-SUCCESS] DIAS_LABORABLES cargado correctamente:', diasLaborables);
            }
            
            // Normalizar d√≠as (con o sin acentos) y mapear a n√∫meros
            const quitarAcentos = (s) => s.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            let diasNumericos = [0,1,2,3,4,5,6];
            if (!skipDiasCheck) {
                const diasArray = diasLaborables.split(',').map(d => d.trim());
                diasNumericos = diasArray
                    .map(d => quitarAcentos(d).toLowerCase())
                    .map(d => ({ domingo:0,lunes:1,martes:2,miercoles:3,jueves:4,viernes:5,sabado:6 })[d])
                    .filter(n => n !== undefined);
            }
            
            // Verificar si es d√≠a laborable
            if (!skipDiasCheck && !diasNumericos.includes(diaActual)) {
                const nombreDia = Object.keys(diasMap).find(key => diasMap[key] === diaActual);
                return {
                    permitido: false,
                    mensaje: `Hoy ${nombreDia} no es un d√≠a laborable. D√≠as laborables: ${diasLaborables}`
                };
            }
            
            // Parsear horarios. Si faltan, NO bloquear: se omite validaci√≥n de horario.
            const horaApertura = (config.HORARIO_APERTURA || '').toString().trim();
            const horaCierre = (config.HORARIO_CIERRE || '').toString().trim();
            const modo24h = String(config.MODO_24_HORAS || '').toUpperCase() === 'SI';
            
            // Si est√° en modo 24 horas, siempre permitir acceso
            if (modo24h) {
                console.log('üïê [CONFIG-INTEGRATION] Modo 24 horas activado - acceso permitido');
                return { permitido: true, mensaje: 'Modo 24 horas activo' };
            }
            // Si no hay horario configurado, no bloquear por horario
            if (!horaApertura || !horaCierre) {
                console.warn('‚ö†Ô∏è [CONFIG-WARNING] HORARIO_APERTURA/CIERRE no configurado. Se omite validaci√≥n de horario.');
                if (typeof google !== 'undefined' && google.script && google.script.run) {
                    try {
                        google.script.run.registrarLog('WARNING', 'Horario no configurado - Omitiendo validaci√≥n de horario', {
                            horaApertura, horaCierre, modo24h
                        }, 'Sistema de Registro');
                    } catch (e) {
                        console.warn('No se pudo registrar advertencia de horario:', e);
                    }
                }
                return { permitido: true, mensaje: 'Validaci√≥n de horario deshabilitada por falta de configuraci√≥n' };
            }
            
            // Funci√≥n para convertir hora string a minutos desde medianoche
            function horaAMinutos(horaStr) {
                const [horas, minutos] = horaStr.split(':').map(Number);
                return horas * 60 + minutos;
            }
            
            const minutosActuales = horaAMinutos(horaActual);
            const minutosApertura = horaAMinutos(horaApertura);
            const minutosCierre = horaAMinutos(horaCierre);
            
            // Verificar si est√° dentro del horario
            let dentroHorario;
            if (minutosApertura <= minutosCierre) {
                // Horario normal (no cruza medianoche)
                dentroHorario = minutosActuales >= minutosApertura && minutosActuales <= minutosCierre;
            } else {
                // Horario que cruza medianoche
                dentroHorario = minutosActuales >= minutosApertura || minutosActuales <= minutosCierre;
            }
            
            if (!dentroHorario) {
                return {
                    permitido: false,
                    mensaje: `Fuera de horario permitido (${horaApertura} - ${horaCierre})`
                };
            }
            
            // Si pasa todas las validaciones
            return { permitido: true, mensaje: 'Acceso permitido' };
        }

        // Alias de compatibilidad: algunas partes del c√≥digo llaman a validarHorarioEmpresarial()
        if (typeof validarHorarioEmpresarial !== 'function') {
            function validarHorarioEmpresarial() {
                return validarHorarioEmpresa();
            }
        }
        
        // üîß [CONFIG-INTEGRATION] Funci√≥n para cargar todas las configuraciones del sistema
        function cargarConfiguracionesSistema() {
            console.log('‚öôÔ∏è [CONFIG-INTEGRATION] Cargando configuraciones completas del sistema...');
            
            // Cargar configuraciones desde el backend
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result && result.success && result.config) {
                            // Organizar configuraciones por categor√≠as
                            window.systemConfig = {
                                empresa: {},
                                qr: {},
                                cache: {},
                                notificaciones: {},
                                seguridad: {},
                                ui: {}
                            };
                            
                            // Clasificar configuraciones
                            Object.keys(result.config).forEach(key => {
                                const value = result.config[key];
                                if (key.startsWith('EMPRESA_')) {
                                    window.systemConfig.empresa[key] = value;
                                } else if (key.startsWith('QR_')) {
                                    window.systemConfig.qr[key] = value;
                                } else if (key.startsWith('CACHE_')) {
                                    window.systemConfig.cache[key] = value;
                                } else if (key.startsWith('NOTIF') || key.includes('EMAIL')) {
                                    window.systemConfig.notificaciones[key] = value;
                                } else if (key.includes('CONTRASE√ëA') || key.includes('LOGIN') || key.includes('SESION')) {
                                    window.systemConfig.seguridad[key] = value;
                                } else if (key.startsWith('UI_') || key.includes('TEMA') || key.includes('IDIOMA')) {
                                    window.systemConfig.ui[key] = value;
                                }
                            });
                            
                            console.log('‚úÖ [CONFIG-INTEGRATION] Configuraciones del sistema cargadas:', Object.keys(result.config).length + ' par√°metros');
                            console.log('üìã [CONFIG-INTEGRATION] Categor√≠as:', Object.keys(window.systemConfig));
                            
                            // Recargar configuraciones empresariales con los nuevos datos
                            cargarConfiguracionesEmpresa();
                            
                        } else {
                            console.warn('‚ö†Ô∏è [CONFIG-INTEGRATION] Error cargando configuraciones del sistema:', result);
                            console.warn('‚ö†Ô∏è [CONFIG-INTEGRATION] Usando configuraciones por defecto debido a error en backend');
                            
                            // Registrar el error en logs si la funci√≥n est√° disponible
                            if (typeof google !== 'undefined' && google.script && google.script.run && typeof google.script.run.registrarLog === 'function') {
                                google.script.run.registrarLog('WARNING', 'Sistema usando configuraciones por defecto - Error cargando desde Google Sheets', { resultado: result }, 'Sistema de Registro');
                            }
                            
                            // Usar configuraciones por defecto
                            window.systemConfig = {
                                empresa: { EMPRESA_NOMBRE: 'SurPass', MODO_24_HORAS: 'NO' },
                                qr: { QR_CAMPO_VISION: '350', QR_TIEMPO_ESCANEO: '250', QR_AUTOCLOSE_DELAY: '0' },
                                cache: {},
                                notificaciones: {},
                                seguridad: {},
                                ui: {}
                            };
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('‚ùå [CONFIG-INTEGRATION] Error de conexi√≥n cargando configuraciones:', error);
                        console.error('‚ùå [CONFIG-INTEGRATION] Verificar que la funci√≥n obtenerConfiguracion() existe y funciona correctamente');
                        
                        // Registrar el error cr√≠tico en logs si la funci√≥n est√° disponible
                        try {
                            if (typeof google !== 'undefined' && google.script && google.script.run && typeof google.script.run.registrarLog === 'function') {
                                google.script.run.registrarLog('ERROR', 'Error cr√≠tico cargando configuraci√≥n desde Google Sheets', { error: error.toString(), stack: error.stack }, 'Sistema de Registro');
                            }
                        } catch (logError) {
                            console.error('Error adicional intentando registrar el fallo:', logError);
                        }
                        
                        // Usar configuraciones por defecto
                        window.systemConfig = {
                            empresa: { EMPRESA_NOMBRE: 'SurPass', MODO_24_HORAS: 'NO' },
                            qr: { QR_CAMPO_VISION: '350', QR_TIEMPO_ESCANEO: '250', QR_AUTOCLOSE_DELAY: '0' },
                            cache: {},
                            notificaciones: {},
                            seguridad: {},
                            ui: {}
                        };
                    })
                    .obtenerConfiguracion();
            } else {
                // Modo desarrollo - configuraciones simuladas
                console.log('üîß [CONFIG-INTEGRATION] Modo desarrollo - usando configuraciones simuladas');
                window.systemConfig = {
                    empresa: { 
                        EMPRESA_NOMBRE: 'SurPass Demo',
                        HORARIO_APERTURA: '08:00',
                        HORARIO_CIERRE: '17:00',
                        MODO_24_HORAS: 'NO',
                        DIAS_LABORABLES: ''  // Sin valor por defecto en modo dev; depender de hoja
                    },
                    qr: { 
                        QR_CAMPO_VISION: '350', 
                        QR_TIEMPO_ESCANEO: '250', 
                        QR_AUTOCLOSE_DELAY: '1000',
                        QR_MODO_CAMARA: 'environment',
                        QR_RESOLUCION_PREFERIDA: 'HD'
                    },
                    cache: {
                        CACHE_DURACION_ESTADISTICAS: '180',
                        CACHE_DURACION_COLUMNAS: '1800',
                        CACHE_DURACION_CONFIG: '900'
                    },
                    notificaciones: {
                        NOTIFICACIONES_EMAIL: 'demo@surpass.com',
                        NOTIFICAR_ACCESOS_DENEGADOS: 'SI',
                        SONIDOS_ACTIVADOS: 'SI'
                    },
                    seguridad: {
                        INTENTOS_MAX_LOGIN: '5',
                        TIEMPO_BLOQUEO_LOGIN: '10',
                        CONTRASE√ëA_MIN_LONGITUD: '6'
                    },
                    ui: {}
                };
                
                // Recargar configuraciones empresariales
                cargarConfiguracionesEmpresa();
            }
        }
        
        // Cargar configuraciones en el inicio
        cargarConfiguracionesEmpresa();
        
        // üîß [CONFIG-INTEGRATION] Cargar configuraciones del sistema al inicio
        cargarConfiguracionesSistema();

        // =====================================================
        // PARTE 1: VARIABLES GLOBALES Y CACH√â LOCAL
        // =====================================================

        // Variables globales para el estado de la aplicaci√≥n
        let personalGlobal = []; 
        let timeoutIdCedula; 
        let html5QrCodeScanner = null; 
        let isScannerActive = false;
        
        // Variables para control de QR scanning y prevenir m√∫ltiples ejecuciones
        window.scannerActive = false;
        window.qrProcessing = false;
        
        // Inicializar entradas activas como arreglo vac√≠o
        window.entradasActivas = [];
        
        // Intentar cargar entradas activas desde localStorage si existe
        const entradasGuardadas = localStorage.getItem('entradasActivas');
        if (entradasGuardadas) {
            try {
                window.entradasActivas = JSON.parse(entradasGuardadas);
                console.log('üìù Entradas activas cargadas desde localStorage:', window.entradasActivas.length);
            } catch (e) {
                console.error('Error al cargar entradas activas:', e);
            }
        }
        
        // Sincronizar con el servidor para tener datos actualizados
        // Esta funci√≥n debe existir en el backend (Google Apps Script)
        if (typeof google !== 'undefined' && google.script && google.script.run) {
            console.log('üîÑ Sincronizando entradas activas con el servidor...');
            try {
                google.script.run
                    .withSuccessHandler(function(entradas) {
                        if (entradas && Array.isArray(entradas)) {
                            window.entradasActivas = entradas;
                            localStorage.setItem('entradasActivas', JSON.stringify(entradas));
                            console.log('‚úÖ Entradas activas sincronizadas:', entradas.length);
                        } else {
                            console.warn('‚ö†Ô∏è Respuesta de sincronizaci√≥n no v√°lida');
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('‚ùå Error sincronizando entradas activas:', error);
                    })
                    .sincronizarEntradasActivas();
            } catch (e) {
                console.error('‚ùå Error al llamar sincronizarEntradasActivas:', e);
            }
        } else {
            console.warn('‚ö†Ô∏è API de Google Apps Script no disponible para sincronizaci√≥n');
        }
        
        // Variables para navegaci√≥n con teclado en autocompletado
        let selectedSuggestionIndex = -1;
        let currentSuggestions = []; 
        let useJsQR = false; 
        let mostrarEstadisticas = true; 
        let formularioBloqueado = false; 

        // =====================================================
        // INICIALIZACI√ìN DE GOOGLE CHARTS
        // =====================================================
        
        // Inicializar Google Charts temprano para evitar problemas de carga
        if (typeof google !== 'undefined' && google.charts) {
            console.log('üìä Inicializando Google Charts...');
            google.charts.load('current', { 'packages': ['corechart'] });
            google.charts.setOnLoadCallback(function() {
                window._chartsLoaded = true;
                console.log('‚úÖ Google Charts inicializado correctamente');
            });
        }

        // =====================================================
        // CONFIGURACI√ìN DE ENCABEZADOS DE HOJAS (Backend)
        // =====================================================
        /*
        NOTA: Los siguientes encabezados deben ser configurados en Google Apps Script
        para asegurar la compatibilidad con el sistema:
        
        Hoja de Personal:
        - C√©dula, Nombre, Empresa, √Årea, Cargo, Estado
        
        Hoja de Movimientos:
        - Fecha, Hora, C√©dula, Nombre, Acci√≥n, Empresa, Observaciones
        
        Hoja de Logs:
        - Timestamp, Nivel, Mensaje, Detalles, Usuario, IP
        
        Hoja de Evacuaciones:
        - Fecha, Hora, Tipo, Personas_Evacuadas, Total_Personas, Estado, Responsable
        */ 
        
        // =====================================================
        // CONSTANTES DE EVACUACI√ìN
        // =====================================================
        const TIPOS_EVACUACION = {
            SIMULACRO: 'simulacro',
            REAL: 'real'
        };
        
        let sonidosActivados = true; 
        let evacuationMode = false; 
        let evacuationData = null; 
        let tipoEvacuacionSeleccionado = null; 
        let personasSeleccionadasEvacuacion = []; 
        
        // Variables globales para sistema de evacuaci√≥n mejorado
        window.evacuacionSimulacro = {
            activa: false,
            tipo: null,
            personasOriginales: [], // Lista inicial de personas dentro
            personasEvacuadas: [], // Tracking de evacuados en simulacro
            personasRestantes: []  // Personas que a√∫n faltan por evacuar
        }; 

        // Variables de estad√≠sticas
        let ultimasEstadisticas = { entradas: 0, salidas: 0, salidasValidas: 0, personasDentro: 0, salidasSinEntrada: 0 };
        let updateStatsInterval = null; 
        window.statsInitialized = false; 

        // Variables de historial en vivo
        let historyCache = [];

        // Variable de timestamp para la √∫ltima evacuaci√≥n real
        window.TIMESTAMP_ULTIMA_EVACUACION = null; 

        // =====================================================
        // PARTE 2: REFERENCIAS A ELEMENTOS DEL DOM - CORREGIDAS
        // =====================================================

        // Objeto DOM para almacenamiento centralizado de referencias al DOM
        // Esto mejora el rendimiento al evitar repetidas llamadas a getElementById/querySelector
        const DOM = {
            // Paneles y contenedores principales
            statsPanelDiv: document.getElementById('statsPanel'),
            qrScannerDiv: document.getElementById('qrScanner'),
            mainContainer: document.getElementById('mainContainer'),
            appContent: document.getElementById('appContent'),
            
            // Modales y overlays
            logOverlay: document.getElementById('logOverlay'),
            customNotificationModal: document.getElementById('customNotificationModal'),
            commentModal: document.getElementById('commentModal'),
            customCommentModal: document.getElementById('customCommentModal'),
            evacuationModal: document.getElementById('evacuationModal'),
            evacuationModalContent: document.getElementById('evacuationModalContent'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            historialModal: document.getElementById('historialModal'),
            historialModalClose: document.getElementById('historialModalClose'),
            historialModalBody: document.getElementById('historialModalBody'),
            historialMessage: document.getElementById('historialMessage'),
            historialTable: document.getElementById('historialTable'),
            tablaHistorialBody: document.getElementById('tablaHistorialBody'),
            
            // Men√∫s y navegaci√≥n
            menuDropdown: document.getElementById('menuDropdown'),
            menuButton: document.getElementById('menuButton'),
            
            // Entradas y formularios
            cedulaInput: document.getElementById('cedulaInput'),
            cedulaSuggestions: document.getElementById('cedulaSuggestions'),
            comentarioInput: document.getElementById('comentarioInput'),
            customCommentInput: document.getElementById('customCommentInput'),
            
            // Elementos informativos
            infoSeleccionada: document.getElementById('infoSeleccionada'),
            radioError: document.getElementById('radioError'),
            entryTimeInfo: document.getElementById('entryTimeInfo'),
            durationInfo: document.getElementById('durationInfo'),
            accessTypeInfo: document.getElementById('accessTypeInfo'),
            
            // Tarjeta de informaci√≥n de persona
            personInfoCard: document.getElementById('personInfoCard'),
            personCardName: document.getElementById('personCardName'),
            personCardCompany: document.getElementById('personCardCompany'),
            personCardCedula: document.getElementById('personCardCedula'),
            personCardEntryTime: document.getElementById('personCardEntryTime'),
            personCardDuration: document.getElementById('personCardDuration'),
            personCardAccessType: document.getElementById('personCardAccessType'),
            personCardComment: document.getElementById('personCardComment'),
            
            // Estad√≠sticas
            statsEntradasCounter: document.getElementById('statsEntradasCounter'),
            statsSalidasCounter: document.getElementById('statsSalidasCounter'),
            statsDentroCounter: document.getElementById('statsDentroCounter'),
            
            // Vista previa
            contenidoVistaPrevia: document.getElementById('contenidoVistaPrevia'),
            vistaPrevia: document.getElementById('vistaPrevia'),
            vistaPreviaHistorial: document.getElementById('vistaPreviaHistorial'),
            vistaPreviaHistorialContenido: document.getElementById('vistaPreviaHistorialContenido'),
            
            // Botones comunes
            btnEntry: document.getElementById('btnEntry'),
            btnExit: document.getElementById('btnExit'),
            btnComment: document.getElementById('btnComment'),
            btnEvacuation: document.getElementById('btnEvacuation'),
            closePreviewBtn: document.getElementById('closePreviewBtn'),
            
            // Spinners y elementos de carga
            loadingSpinner: document.querySelector('.loading-spinner'),
            customLoadingSpinner: document.getElementById('customLoadingSpinner'),
            
            // Elementos adicionales de la UI
            vistaPreviaHistorialContenido: document.getElementById('vistaPreviaHistorialContenido'),
            vistaPreviaHistorial: document.getElementById('vistaPreviaHistorial'),
            liveHistoryBody: document.getElementById('liveHistoryBody'),
            liveHistoryHeader: document.querySelector('.liveHistory-header'),
            liveHistoryContent: document.querySelector('.liveHistory-content'),
            miniChartDiv: document.getElementById('miniChart'),
            personalGridModerno: document.getElementById('personalGridModerno'),
            
            // Funci√≥n de ayuda para inicializar referencias adicionales 
            // que pudieran no estar disponibles en la carga inicial
            initLater: function(id) {
                if (!this[id] && document.getElementById(id)) {
                    this[id] = document.getElementById(id);
                    return true;
                }
                return false;
            },
            
            // Inputs y botones principales
            cedulaInput: document.getElementById('cedula'), // ID CORRECTO
            submitButton: document.querySelector('input[type="submit"]'),
            menuButton: document.getElementById('menuButton'),
            qrButton: document.getElementById('qrButton'),
            limpiarCedulaButton: document.getElementById('limpiarCedula'), // ID CORRECTO
            
            // Sonidos
            successSound: document.getElementById('successSound'),
            errorSound: document.getElementById('errorSound'),
            scanSound: document.getElementById('scanSound'),

            // Estad√≠sticas en tiempo real
            entradasLiveSpan: document.getElementById('entradasLive'),
            salidasLiveSpan: document.getElementById('salidasLive'),
            personasDentroLiveSpan: document.getElementById('personasDentroLive'),
            salidasSinEntradaLiveContainer: document.getElementById('salidasSinEntradaLive'),
            salidasSinEntradaLiveSpan: document.querySelector('#salidasSinEntradaLive .stat-value'),

            // Botones del men√∫
            botonInfo: document.getElementById('botonInfo'),
            botonFinalizar: document.getElementById('botonFinalizar'),
            botonLimpiar: document.getElementById('botonLimpiar'),
            limpiarHistorialCentral: document.getElementById('limpiarHistorialCentral'),
            botonHistorial: document.getElementById('botonHistorial'),
            botonTema: document.getElementById('botonTema'),
            botonLogs: document.getElementById('botonLogs'),
            botonEvacuacion: document.getElementById('botonEvacuacion'),
            botonSimulacros: document.getElementById('botonSimulacros'),
            
            // Elementos del modal de notificaci√≥n
            notificationIcon: document.getElementById('notificationIcon'),
            notificationTitle: document.getElementById('notificationTitle'),
            notificationMessage: document.getElementById('notificationMessage'),
            notificationButtons: document.getElementById('notificationButtons'),
            notificationHeader: null,

            // Elementos del modal de comentario general
            commentModalCedula: document.getElementById('commentModalCedula'),
            commentModalNombre: document.getElementById('commentModalNombre'),
            commentText: document.getElementById('commentText'),
            commentLoading: document.getElementById('commentLoading'),
            
            // Elementos del modal de comentario personalizado
            modalCedulaPersonalizado: document.getElementById('modalCedula'),
            modalTipoAccesoPersonalizado: document.getElementById('modalTipoAcceso'),
            personNameInput: document.getElementById('personName'),
            personCompanyInput: document.getElementById('personCompany'),
            visitReasonInput: document.getElementById('visitReason'),
            customCommentLoading: document.getElementById('customCommentLoading'),

            // Elementos del esc√°ner QR
            qrVideo: document.getElementById('qrVideo'),
            qrCanvas: document.getElementById('qrCanvas'),
            qrReaderDiv: document.getElementById('qr-reader'),
            qrModalContentDiv: document.getElementById('qrModalContent'),
            qrCloseButton: document.getElementById('qrCloseButton'),

            // Elementos del log
            logContent: document.getElementById('logContent'),
            closeLogOverlayButton: document.getElementById('closeLogOverlay'),
            logCloseButton: document.getElementById('logCloseButton'),
            
            // Elementos de conexi√≥n
            conexionIndicador: document.getElementById('conexionIndicador'),
            conexionTexto: null,

            // Elementos de evacuaci√≥n
            cerrarEvacuacionModalBtn: document.getElementById('cerrarEvacuacionModalBtn'),
            btnCerrarEvacuacion: document.getElementById('btnCerrarEvacuacion'),
            btnVolverEvacuacion: document.getElementById('btnVolverEvacuacion'),
            btnConfirmarSalidas: document.getElementById('btnConfirmarSalidas'),
            btnSimulacroModerno: document.getElementById('btnSimulacroModerno'),
            btnRealModerno: document.getElementById('btnRealModerno'),
            btnSeleccionarTodosModerno: document.getElementById('btnSeleccionarTodosModerno'),
            btnLimpiarSeleccionModerno: document.getElementById('btnLimpiarSeleccionModerno'),
            totalPersonasDentro: document.getElementById('totalPersonasDentro'),
            infoTipoSeleccionadoModerno: document.getElementById('infoTipoSeleccionadoModerno'),
            selectionCountModerno: document.getElementById('selectionCountModerno'),
            
            // Formulario principal
            accessForm: document.getElementById('accessForm'),
            
            // Hora de verificaci√≥n
            horaVerificacion: document.getElementById('horaVerificacion'),
            btnActualizarLista: document.getElementById('btnActualizarLista'),
            
            // Radio buttons y labels
            radioLabels: document.querySelectorAll('.access-option .access-label'), // SELECTOR CORREGIDO
        };

        // Asignar el elemento de texto de conexi√≥n si existe
        if (DOM.conexionIndicador) {
            DOM.conexionTexto = DOM.conexionIndicador.querySelector('.conexion-texto');
        }

        // =====================================================
        // PARTE 3: SISTEMA DE CACH√â LOCAL (LocalStorage)
        // =====================================================
        const SurPassCache = {
            guardarPersonalEnCache: function(personal) {
                try {
                    localStorage.setItem('surpass-personal', JSON.stringify(personal));
                    console.log('Personal guardado en cach√© local');
                } catch (error) {
                    console.error('Error al guardar personal en cach√©:', error);
                }
            },

            obtenerPersonalDesdeCache: function() {
                try {
                    const data = localStorage.getItem('surpass-personal');
                    return data ? JSON.parse(data) : [];
                } catch (error) {
                    console.error('Error al obtener personal desde cach√©:', error);
                    return [];
                }
            },

            guardarTransaccionPendiente: function(transaccion) {
                try {
                    let pendientes = this.obtenerTransaccionesPendientes();
                    pendientes.push({ ...transaccion, timestamp: new Date().getTime() });
                    localStorage.setItem('surpass-pendientes', JSON.stringify(pendientes));
                    console.log('Transacci√≥n guardada en pendientes');
                } catch (error) {
                    console.error('Error al guardar transacci√≥n pendiente:', error);
                }
            },

            obtenerTransaccionesPendientes: function() {
                try {
                    const data = localStorage.getItem('surpass-pendientes');
                    return data ? JSON.parse(data) : [];
                } catch (error) {
                    console.error('Error al obtener transacciones pendientes:', error);
                    return [];
                }
            },

            limpiarTransaccionesPendientes: function() {
                localStorage.removeItem('surpass-pendientes');
                console.log('Transacciones pendientes limpiadas.');
            }
        };

        // =====================================================
        // PARTE 4: FUNCIONES DE UTILIDAD GENERAL
        // =====================================================

        function showCustomNotification(message, type = 'info', withConfirmation = false, callback = null, customIcon = null, customTitle = null) {
// Reemplazo de notificaciones simples por showToast
// Ejemplo de uso:
// showToast('Acceso registrado', 'La entrada se registr√≥ correctamente.', 'success');
            const modal = DOM.customNotificationModal;
            if (!modal) {
                console.error('‚ùå Elemento customNotificationModal no encontrado.');
                return;
            }

            const header = modal.querySelector('.custom-modal-header');
            const icon = DOM.notificationIcon;
            const title = DOM.notificationTitle;
            const msg = DOM.notificationMessage;
            const buttonsDiv = DOM.notificationButtons;

            if (!header || !icon || !title || !msg || !buttonsDiv) {
                console.error('‚ùå Faltan elementos internos del modal de notificaci√≥n.');
                return;
            }

            // Limpiar clases de tipo anteriores
            header.classList.remove('success', 'error', 'warning', 'info', 'orange');

            let iconClass = customIcon || 'fas fa-info-circle';
            let defaultTitle = customTitle || 'Notificaci√≥n';

            const isAccesoTemporal = message.includes('ACCESO TEMPORAL');

            switch (type) {
                case 'success':
                    header.classList.add('success');
                    if (!customIcon) iconClass = 'fas fa-check-circle';
                    if (!customTitle) defaultTitle = '√âxito';
                    break;
                case 'error':
                    header.classList.add('error');
                    if (!customIcon) iconClass = 'fas fa-times-circle';
                    if (!customTitle) defaultTitle = 'Error';
                    break;
                case 'warning':
                    header.classList.add('warning');
                    if (!customIcon) iconClass = 'fas fa-exclamation-triangle';
                    if (!customTitle) defaultTitle = 'Advertencia';
                    break;
                case 'orange':
                    header.classList.add('orange');
                    if (!customIcon) iconClass = 'fas fa-exclamation-circle';
                    if (!customTitle) defaultTitle = 'Aviso';
                    break;
                case 'info':
                default:
                    header.classList.add('info');
                    if (!customIcon) iconClass = 'fas fa-info-circle';
                    if (!customTitle) defaultTitle = 'Informaci√≥n';
                    break;
            }

            icon.className = iconClass;
            title.textContent = defaultTitle;
            msg.textContent = message;

            buttonsDiv.innerHTML = '';

            if (withConfirmation) {
                if (isAccesoTemporal) {
                    const confirmBtn = document.createElement('button');
                    confirmBtn.className = 'btn-base btn-confirm-temporal';
                    confirmBtn.innerHTML = '<i class="fas fa-check-circle"></i> Confirmar Registro';
                    confirmBtn.addEventListener('click', function() {
                        modal.classList.remove('show');
                        if (callback) callback(true);
                    });
                    buttonsDiv.appendChild(confirmBtn);
                } else {
                    const yesBtn = document.createElement('button');
                    yesBtn.className = 'btn-base btn-success';
                    yesBtn.textContent = 'Continuar';
                    yesBtn.addEventListener('click', function() {
                        modal.classList.remove('show');
                        if (callback) callback(true);
                    });

                    const noBtn = document.createElement('button');
                    noBtn.className = 'btn-base btn-danger';
                    noBtn.textContent = 'Cancelar';
                    noBtn.addEventListener('click', function() {
                        modal.classList.remove('show');
                        if (callback) callback(false);
                    });

                    buttonsDiv.appendChild(yesBtn);
                    buttonsDiv.appendChild(noBtn);
                }
            } else {
                const okBtn = document.createElement('button');
                okBtn.className = 'btn-base btn-primary';
                okBtn.textContent = 'Aceptar';
                okBtn.addEventListener('click', function() {
                    modal.classList.remove('show');
                    if (callback) callback();
                });
                buttonsDiv.appendChild(okBtn);
            }

            modal.classList.add('show');

            if (isAccesoTemporal) {
                modal.querySelector('.custom-modal-content').style.animation = 'pulse 1s 3';
                if (sonidosActivados && DOM.successSound) {
                    setTimeout(() => {
                        reproducirSonido('successSound');
                    }, 300);
                }
            }
        }

        // Funci√≥n para notificaciones simples (toast) sin modal para resultados de QR
        function showSimpleNotification(message, type = 'info', duration = 3000) {
            // Prevenir notificaciones duplicadas r√°pidas
            const notificationKey = `${type}-${message}`;
            const now = Date.now();
            
            if (!window.lastNotifications) window.lastNotifications = {};
            
            // Si la misma notificaci√≥n se mostr√≥ hace menos de 2 segundos, ignorar
            if (window.lastNotifications[notificationKey] && 
                (now - window.lastNotifications[notificationKey]) < 2000) {
                return;
            }
            
            window.lastNotifications[notificationKey] = now;

            // Crear o reutilizar contenedor de toast
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 9999;
                    max-width: 400px;
                    pointer-events: none;
                `;
                document.body.appendChild(toastContainer);
            }

            // Limitar n√∫mero de toasts simult√°neos
            const existingToasts = toastContainer.children;
            if (existingToasts.length >= 3) {
                // Remover el m√°s antiguo
                if (existingToasts[0]) existingToasts[0].remove();
            }

            // Crear elemento toast
            const toast = document.createElement('div');
            toast.style.cssText = `
                background: ${type === 'success' ? '#43a047' : type === 'warning' ? '#ff9800' : '#2196f3'};
                color: white;
                padding: 12px 16px;
                border-radius: 8px;
                margin-bottom: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                transform: translateX(420px);
                transition: transform 0.3s ease, opacity 0.3s ease;
                opacity: 0;
                pointer-events: auto;
                font-size: 14px;
                font-weight: 500;
                display: flex;
                align-items: center;
                gap: 8px;
                max-width: 350px;
            `;

            // Agregar √≠cono seg√∫n el tipo
            const icon = type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            toast.innerHTML = `
                <span style="font-size: 16px;">${icon}</span>
                <span style="flex: 1; word-break: break-word;">${message}</span>
                <button onclick="this.parentElement.remove()" style="
                    background: none; 
                    border: none; 
                    color: white; 
                    cursor: pointer; 
                    font-size: 18px;
                    padding: 0;
                    width: 18px;
                    height: 18px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    border-radius: 50%;
                    opacity: 0.7;
                " onmouseover="this.style.opacity='1'; this.style.background='rgba(255,255,255,0.2)'" 
                onmouseout="this.style.opacity='0.7'; this.style.background='none'">√ó</button>
            `;

            toastContainer.appendChild(toast);

            // Animar entrada
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
                toast.style.opacity = '1';
            }, 10);

            // Reproducir sonido si est√° activado
            if (sonidosActivados) {
                const soundId = type === 'success' ? 'successSound' : 'scanSound';
                setTimeout(() => reproducirSonido(soundId), 100);
            }

            // Auto-remover despu√©s del tiempo especificado
            setTimeout(() => {
                toast.style.transform = 'translateX(420px)';
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.remove();
                    }
                }, 300);
            }, duration);
        }

        // ==== Helper est√°ndar para parsear errores backend (Apps Script) ====
        function parseBackendError(err, fallbackMsg = 'Ha ocurrido un error.') {
            try {
                if (!err) return { message: fallbackMsg };
                if (typeof err === 'string') {
                    try { const o = JSON.parse(err); return { message: o.message || fallbackMsg, code: o.code, details: o.details || o }; } catch (_) { return { message: err }; }
                }
                if (typeof err === 'object') {
                    const message = err.message || err.mensaje || fallbackMsg;
                    const code = err.code || err.codigo;
                    const details = err.details || err.detalles || null;
                    return { message, code, details };
                }
                return { message: fallbackMsg };
            } catch (e) {
                return { message: fallbackMsg };
            }
        }

        function reproducirSonido(audioId) {
            if (!sonidosActivados) {
                console.log(`Sonidos desactivados, no se reproduce ${audioId}`);
                return;
            }
            try {
                const sonido = DOM[audioId];
                if (!sonido) {
                    console.error(`Elemento de audio '${audioId}' no encontrado en DOM.`);
                    return;
                }

                if (sonido.readyState >= 2) {
                    sonido.pause();
                    sonido.currentTime = 0;
                    const playPromise = sonido.play();
                    if (playPromise !== undefined) {
                        playPromise
                            .then(() => {
                                console.log(`Sonido ${audioId} reproducido exitosamente`);
                            })
                            .catch(e => {
                                console.warn(`Error al reproducir sonido ${audioId}:`, e);
                                if (e.name === 'NotAllowedError') {
                                    const playOnClick = () => {
                                        sonido.play().catch(err => console.error('Error en segundo intento:', err));
                                        document.removeEventListener('click', playOnClick);
                                    };
                                    document.addEventListener('click', playOnClick, { once: true });
                                }
                            });
                    }
                } else {
                    console.warn(`Sonido ${audioId} no est√° listo (readyState: ${sonido.readyState}). Cargando...`);
                    sonido.load();
                    sonido.addEventListener('canplaythrough', () => {
                        sonido.play().catch(e => console.error('Error al reproducir tras cargar:', e));
                    }, { once: true });
                }
            } catch (e) {
                console.error(`Excepci√≥n al reproducir sonido ${audioId}:`, e);
            }
        }

        function bloquearFormulario() {
            formularioBloqueado = true;
            if (DOM.cedulaInput) DOM.cedulaInput.disabled = true;
            document.querySelectorAll('input[name="respuesta"]').forEach(radio => radio.disabled = true);
            if (DOM.submitButton) DOM.submitButton.disabled = true;
            if (DOM.qrButton) DOM.qrButton.disabled = true;
            if (DOM.limpiarCedulaButton) DOM.limpiarCedulaButton.disabled = true;
            console.log('Formulario bloqueado.');
        }

        function desbloquearFormulario() {
            formularioBloqueado = false;
            if (DOM.cedulaInput) DOM.cedulaInput.disabled = false;
            document.querySelectorAll('input[name="respuesta"]').forEach(radio => radio.disabled = false);
            if (DOM.submitButton) DOM.submitButton.disabled = false;
            if (DOM.qrButton) DOM.qrButton.disabled = false;
            if (DOM.limpiarCedulaButton) DOM.limpiarCedulaButton.disabled = false;
            console.log('Formulario desbloqueado.');
        }

        /**
         * Muestra un overlay de carga con un spinner y un mensaje personalizado
         * Versi√≥n mejorada con animaciones suaves y mejor UI
         * @param {string} message - Mensaje a mostrar durante la carga
         * @param {string} type - Tipo de carga ('normal', 'important', 'critical')
         */

    // Las funciones mostrarLoading/ocultarLoading ahora est√°n en utils.js.html y son globales

        function appendLog(logEntry) {
            if (!DOM.logContent) return;
            const p = document.createElement('p');
            p.className = logEntry.level ? logEntry.level.toLowerCase() : 'info';
            p.textContent = `${logEntry.timestamp} [${logEntry.level || 'INFO'}] ${logEntry.message}`;
            if (logEntry.details && Object.keys(logEntry.details).length > 0) {
                p.textContent += ` | Detalles: ${JSON.stringify(logEntry.details)}`;
            }
            DOM.logContent.appendChild(p);
            DOM.logContent.scrollTop = DOM.logContent.scrollHeight;
        }

        // =====================================================
        // FUNCIONES DE INFORMACI√ìN DE USUARIO
        // =====================================================
        
        // La funci√≥n mostrarTarjetaUsuario ha sido eliminada para optimizar el rendimiento
        
        /**
         * Oculta el display de datos de usuario
         * Esta funci√≥n es m√°s ligera y solo oculta el display principal
         */
        function ocultarTarjetaUsuario() {
            // Ya no necesitamos manipular userDataCard
            
            // Ocultar solo el display de datos de usuario
            const displayUsuario = document.getElementById('displayDatosUsuario');
            if (displayUsuario) {
                displayUsuario.style.display = 'none';
            }
        }
        
        function mostrarDisplayDatosUsuario(usuario) {
        if (!usuario) return;
        
        // Si no existe el elemento, lo creamos
        let displayUsuario = document.getElementById('displayDatosUsuario');
        
        if (!displayUsuario) {
            displayUsuario = document.createElement('div');
            displayUsuario.id = 'displayDatosUsuario';
            displayUsuario.className = 'display-datos-usuario';
            
            // Estilos inline para el display de datos
            displayUsuario.style.width = '100%';
            displayUsuario.style.padding = '12px 15px';
            displayUsuario.style.backgroundColor = 'var(--bg-secondary)';
            displayUsuario.style.border = '1px solid var(--border-color)';
            displayUsuario.style.borderRadius = '8px';
            displayUsuario.style.marginTop = '8px';
            displayUsuario.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
            
            // Insertar despu√©s del contenedor de sugerencias
            const inputContainer = document.querySelector('.cedula-input-container');
            if (inputContainer) {
                inputContainer.appendChild(displayUsuario);
            }
        }
        
        // Verificar entrada activa CORRECTAMENTE
        const cedulaLimpia = usuario.cedula ? usuario.cedula.trim() : '';
        
        // LLAMADA AL SERVIDOR para verificar entrada activa
        google.script.run
            .withSuccessHandler(function(resultado) {
                let tipoAcceso = 'entrada';
                let entradaActiva = null;
                
                if (resultado && resultado.found) {
                    // Hay entrada activa - sugerir SALIDA
                    tipoAcceso = 'salida';
                    entradaActiva = resultado;
                    console.log(`‚úÖ Entrada activa encontrada para ${usuario.nombre} - Sugiriendo SALIDA`);
                } else {
                    // No hay entrada activa - sugerir ENTRADA
                    tipoAcceso = 'entrada';
                    console.log(`üìù Sin entrada activa para ${usuario.nombre} - Sugiriendo ENTRADA`);
                }
                
                // La tarjeta de informaci√≥n se manejar√° por el sistema existente
            })
            .withFailureHandler(function(error) {
                const parsed = (typeof parseBackendError === 'function') ? parseBackendError(error, 'Error verificando entrada activa') : { message: 'Error verificando entrada activa' };
                const msg = parsed.code ? `${parsed.message} [${parsed.code}]` : parsed.message;
                if (typeof mostrarAlerta === 'function') {
                    mostrarAlerta(msg, 'error');
                } else if (typeof showSimpleNotification === 'function') {
                    showSimpleNotification(msg, 'warning', 4000);
                }
                if (console && console.error) console.error('Registro UI error (verificarEntradaActiva):', parsed);
            })
            .verificarEntradaActiva(cedulaLimpia);
    }

    function ocultarDisplayDatosUsuario() {
        const displayUsuario = document.getElementById('displayDatosUsuario');
        if (displayUsuario) {
            displayUsuario.style.display = 'none';
        }
    }

        // =====================================================
        // FUNCIONES DE TARJETA DE INFORMACI√ìN DE PERSONA
        // =====================================================

        function showPersonInfoCardWithComment(persona, accessType) {
        try {
            if (!DOM.personInfoCard || !persona || !persona.cedula || !accessType) {
                console.warn('showPersonInfoCardWithComment: Par√°metros inv√°lidos', { persona, accessType });
                return;
            }

            // Llenar datos b√°sicos
            if (DOM.personCardName) DOM.personCardName.textContent = persona.nombre || 'N/A';
            if (DOM.personCardCompany) DOM.personCardCompany.textContent = persona.empresa || 'N/A';
            if (DOM.personCardCedula) DOM.personCardCedula.textContent = persona.cedula || 'N/A';

            // Mostrar tipo de acceso
            if (DOM.personCardAccessType) {
                DOM.personCardAccessType.textContent = accessType === 'entrada' ? 'ENTRADA' : 'SALIDA';
                DOM.personCardAccessType.style.color = accessType === 'entrada' ? 'var(--success)' : 'var(--warning)';
            }

            // Para salidas, mostrar informaci√≥n adicional
            if (accessType === 'salida') {
                google.script.run
                    .withSuccessHandler(function(entradaPrevia) {
                        if (entradaPrevia && entradaPrevia.found) {
                            if (DOM.personCardEntryTime && DOM.entryTimeInfo) {
                                DOM.personCardEntryTime.textContent = entradaPrevia.horaEntrada || 'N/A';
                                DOM.entryTimeInfo.style.display = 'block';
                            }
                            
                            if (DOM.personCardDuration && DOM.durationInfo) {
                                const duracion = calcularDuracionDesdeTimestamp(entradaPrevia.timestamp);
                                DOM.personCardDuration.textContent = duracion;
                                DOM.durationInfo.style.display = 'block';
                            }
                        } else {
                            if (DOM.entryTimeInfo) DOM.entryTimeInfo.style.display = 'none';
                            if (DOM.durationInfo) DOM.durationInfo.style.display = 'none';
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.warn('No se pudo obtener entrada previa:', error);
                        if (DOM.entryTimeInfo) DOM.entryTimeInfo.style.display = 'none';
                        if (DOM.durationInfo) DOM.durationInfo.style.display = 'none';
                    })
                    .verificarEntradaActiva(persona.cedula);
            } else {
                if (DOM.entryTimeInfo) DOM.entryTimeInfo.style.display = 'none';
                if (DOM.durationInfo) DOM.durationInfo.style.display = 'none';
            }

            // Configurar bot√≥n de comentario con texto e √≠cono visibles
            if (DOM.personCardComment) {
                DOM.personCardComment.innerHTML = '<i class="fas fa-comment-plus"></i><span>Comentario</span>';
                DOM.personCardComment.title = 'Agregar comentario opcional';
                DOM.personCardComment.style.display = 'flex';
                DOM.personCardComment.style.visibility = 'visible';
                DOM.personCardComment.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    // Mostrar el modal de comentario opcional, pero NO registrar autom√°ticamente
                    showOptionalCommentModal(persona.cedula, persona.nombre, accessType);
                    // El usuario puede cancelar el modal y luego registrar manualmente si lo desea
                };
            }

            // Mostrar la tarjeta con animaci√≥n
            DOM.personInfoCard.style.display = 'block';
            DOM.personInfoCard.style.opacity = '0';
            DOM.personInfoCard.style.transform = 'translateY(10px)';
            
            setTimeout(() => {
                DOM.personInfoCard.style.transition = 'all 0.3s ease';
                DOM.personInfoCard.style.opacity = '1';
                DOM.personInfoCard.style.transform = 'translateY(0)';
            }, 10);

        } catch (error) {
            console.error('‚ùå Error mostrando tarjeta con comentario:', error);
        }
    }

        function hidePersonInfoCard() {
            if (DOM.personInfoCard) {
                DOM.personInfoCard.style.display = 'none';
                // Limpiar el contenido para evitar que se muestre informaci√≥n obsoleta
                DOM.personInfoCard.style.opacity = '0';
                DOM.personInfoCard.style.transform = 'translateY(10px)';
                
                // Limpiar contenido espec√≠fico para prevenir datos residuales
                if (DOM.personCardName) DOM.personCardName.textContent = '';
                if (DOM.personCardCompany) DOM.personCardCompany.textContent = '';
                if (DOM.personCardCedula) DOM.personCardCedula.textContent = '';
                if (DOM.personCardEntryTime) DOM.personCardEntryTime.textContent = '';
                if (DOM.personCardDuration) DOM.personCardDuration.textContent = '';
                if (DOM.personCardAccessType) DOM.personCardAccessType.textContent = '';
                
                // Ocultar elementos condicionales
                if (DOM.entryTimeInfo) DOM.entryTimeInfo.style.display = 'none';
                if (DOM.durationInfo) DOM.durationInfo.style.display = 'none';
                if (DOM.accessTypeInfo) DOM.accessTypeInfo.style.display = 'none';
                
                console.log('üßπ Tarjeta de informaci√≥n persona limpiada completamente');
            }
        }

        function actualizarDisplayConTipoAcceso(displayElement, usuario, tipoAcceso, entradaActiva) {
            if (!displayElement || !usuario) return;
            
            const iconoEntrada = tipoAcceso === 'entrada' ? 'fa-sign-in-alt' : 'fa-sign-out-alt';
            const colorTipo = tipoAcceso === 'entrada' ? '#10b981' : '#f59e0b';
            const textoTipo = tipoAcceso === 'entrada' ? 'ENTRADA' : 'SALIDA';
            
            let infoAdicional = '';
            if (tipoAcceso === 'salida' && entradaActiva) {
                const duracion = calcularDuracionDesdeTimestamp(entradaActiva.timestamp);
                infoAdicional = `
                    <div class="info-adicional">
                        <small><i class="fas fa-clock"></i> Entrada: ${entradaActiva.horaEntrada}</small>
                        <small><i class="fas fa-stopwatch"></i> Tiempo: ${duracion}</small>
                    </div>
                `;
            }
            
            displayElement.innerHTML = `
                <div class="usuario-info-compacta">
                    <div class="usuario-principal">
                        <span class="usuario-nombre">${usuario.nombre || 'N/A'}</span>
                        <span class="usuario-empresa">${usuario.empresa || 'N/A'}</span>
                    </div>
                    <div class="tipo-acceso-sugerido" style="color: ${colorTipo};">
                        <i class="fas ${iconoEntrada}"></i>
                        <span>${textoTipo} SUGERIDO</span>
                    </div>
                    ${infoAdicional}
                </div>
            `;
            
            displayElement.style.display = 'block';
        }
        
        // Funci√≥n para buscar todos los elementos DOM necesarios
        function actualizarReferenciasDOM() {
            // Ya no necesitamos referencias a los elementos de la tarjeta de usuario
            // Esta funci√≥n queda para futuras referencias a otros elementos que se agreguen
            console.log('üîÑ Referencias DOM actualizadas');
        }

        function calcularDuracionDesdeTimestamp(timestamp) {
        if (!timestamp) return 'N/A';
        
        try {
            const entrada = new Date(timestamp);
            const ahora = new Date();
            const diferencia = ahora - entrada;
            
            if (diferencia <= 0) return 'N/A';
            
            const horas = Math.floor(diferencia / (1000 * 60 * 60));
            const minutos = Math.floor((diferencia % (1000 * 60 * 60)) / (1000 * 60));
            
            if (horas > 0) {
                return `${horas}h ${minutos}m`;
            } else {
                return `${minutos}m`;
            }
        } catch (error) {
            console.warn('Error calculando duraci√≥n:', error);
            return 'N/A';
        }
    }

        function showOptionalCommentModal(cedula, nombre, tipoAcceso) {
        try {
            console.log(`üí¨ Abriendo modal de comentario opcional para: ${nombre} (${cedula})`);
            
            // Validar par√°metros
            if (!cedula || !nombre || !tipoAcceso) {
                console.error('‚ùå showOptionalCommentModal: Par√°metros faltantes');
                proceedWithRegistration(cedula || '', tipoAcceso || 'entrada', '');
                return;
            }
            
            // Crear modal din√°mico
            const modalHtml = `
                <div id="optionalCommentModal" class="comment-modal" style="display: flex; z-index: 2100;">
                    <div class="comment-modal-content" style="max-width: 600px; width: 90%;">
                        <div class="comment-modal-header">
                            <h2>
                                <i class="fas fa-comment-plus modal-icon"></i>
                                Comentario Opcional
                            </h2>
                            <p class="modal-subtitle">¬øDesea agregar observaciones a este registro?</p>
                            <p class="modal-description">Puede agregar comentarios adicionales o continuar sin comentario</p>
                        </div>
                        
                        <div class="comment-modal-body">
                            <div class="info-display">
                                <div class="info-display-row">
                                    <span class="info-label">C√©dula:</span>
                                    <span class="info-value">${cedula}</span>
                                </div>
                                <div class="info-display-row">
                                    <span class="info-label">Nombre:</span>
                                    <span class="info-value">${nombre}</span>
                                </div>
                                <div class="info-display-row">
                                    <span class="info-label">Acci√≥n:</span>
                                    <span class="info-value" style="color: ${tipoAcceso === 'entrada' ? 'var(--success)' : 'var(--warning)'}; font-weight: 600;">
                                        <i class="fas fa-${tipoAcceso === 'entrada' ? 'sign-in' : 'sign-out'}-alt"></i>
                                        ${tipoAcceso.toUpperCase()}
                                    </span>
                                </div>
                            </div>
                            
                            <form id="optionalCommentForm">
                                <div class="form-group">
                                    <label for="optionalCommentText">
                                        <i class="fas fa-pen"></i> Comentario (opcional):
                                    </label>
                                    <textarea id="optionalCommentText" 
                                            placeholder="Ejemplo: Hora extra, visita especial, reuni√≥n importante..."
                                            maxlength="500"
                                            rows="4"
                                            style="resize: vertical;"></textarea>
                                    <small style="color: var(--text-muted); font-size: 0.8rem; display: block; margin-top: 0.5rem;">
                                        <i class="fas fa-info-circle"></i> M√°ximo 500 caracteres. Este campo es opcional.
                                    </small>
                                </div>
                                
                                <div class="modal-buttons">
                                    <button type="button" id="skipOptionalComment" class="btn btn-outline">
                                        <i class="fas fa-forward"></i>
                                        Continuar sin comentario
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i>
                                        Guardar comentario y continuar
                                    </button>
                                </div>
                            </form>
                            
                            <!-- Loading indicator -->
                            <div id="optionalCommentLoading" class="comment-loading" style="display: none;">
                                <div class="unified-loader"></div>
                                <p class="unified-loader-message comment-loading-text">Procesando registro...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Agregar modal al DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Obtener referencias a elementos
            const modal = document.getElementById('optionalCommentModal');
            const form = document.getElementById('optionalCommentForm');
            const skipBtn = document.getElementById('skipOptionalComment');
            const commentText = document.getElementById('optionalCommentText');
            const loadingDiv = document.getElementById('optionalCommentLoading');
            
            // Funci√≥n para cerrar modal y limpiar
            function cerrarModal() {
                if (modal && modal.parentNode) {
                    modal.remove();
                }
            }
            
            // Event listener: Continuar sin comentario
            skipBtn.addEventListener('click', function() {
                console.log('‚è© Usuario eligi√≥ continuar sin comentario');
                cerrarModal();
                proceedWithRegistration(cedula, tipoAcceso, '');
            });
            
            // Event listener: Guardar comentario
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const comentario = commentText.value.trim();
                console.log(`üíæ Usuario agreg√≥ comentario: "${comentario.substring(0, 50)}..."`);
                
                // Mostrar loading
                if (loadingDiv) loadingDiv.style.display = 'flex';
                
                // Simular peque√±o delay para mejor UX
                setTimeout(() => {
                    cerrarModal();
                    proceedWithRegistration(cedula, tipoAcceso, comentario);
                }, 500);
            });
            
            // Event listener: Cerrar con click fuera del modal
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    console.log('‚ùå Usuario cerr√≥ modal haciendo click fuera');
                    cerrarModal();
                    proceedWithRegistration(cedula, tipoAcceso, '');
                }
            });
            
            // Event listener: Cerrar con Escape
            document.addEventListener('keydown', function escapeHandler(e) {
                if (e.key === 'Escape' && modal) {
                    console.log('‚ùå Usuario cerr√≥ modal con Escape');
                    document.removeEventListener('keydown', escapeHandler);
                    cerrarModal();
                    proceedWithRegistration(cedula, tipoAcceso, '');
                }
            });
            
            // Enfocar textarea despu√©s de un peque√±o delay
            setTimeout(() => {
                if (commentText) {
                    commentText.focus();
                    // Colocar cursor al final si hay texto
                    commentText.setSelectionRange(commentText.value.length, commentText.value.length);
                }
            }, 300);
            
            // Contador de caracteres din√°mico
            commentText.addEventListener('input', function() {
                const remaining = 500 - this.value.length;
                const small = this.parentElement.querySelector('small');
                if (small) {
                    small.innerHTML = `<i class="fas fa-info-circle"></i> ${remaining} caracteres restantes. Este campo es opcional.`;
                    if (remaining < 50) {
                        small.style.color = 'var(--warning)';
                    } else if (remaining < 10) {
                        small.style.color = 'var(--danger)';
                    } else {
                        small.style.color = 'var(--text-muted)';
                    }
                }
            });
            
            console.log('‚úÖ Modal de comentario opcional creado y configurado');
            
        } catch (error) {
            console.error('‚ùå Error creando modal de comentario opcional:', error);
            // En caso de error, continuar sin comentario
            proceedWithRegistration(cedula || '', tipoAcceso || 'entrada', '');
        }
    }

    function proceedWithRegistration(cedula, tipoAcceso, comentario) {
        try {
            console.log(`üìù Procediendo con registro: ${tipoAcceso} para ${cedula}${comentario ? ' con comentario' : ''}`);
            
            // Validar par√°metros
            if (!cedula || !tipoAcceso) {
                console.error('‚ùå proceedWithRegistration: Par√°metros inv√°lidos');
                showToast('Error de registro', 'Datos incompletos para procesar.', 'error');
                return;
            }

            // Limpiar la interfaz
            hidePersonInfoCard();
            
            // Actualizar el campo de c√©dula si no est√° ya actualizado
            if (DOM.cedulaInput && DOM.cedulaInput.value.trim() !== cedula) {
                DOM.cedulaInput.value = cedula;
            }

            // Marcar el radio button correspondiente si no est√° marcado
            const radioCorrespondiente = document.querySelector(`input[name="respuesta"][value="${tipoAcceso}"]`);
            if (radioCorrespondiente && !radioCorrespondiente.checked) {
                // Limpiar selecciones anteriores
                document.querySelectorAll('input[name="respuesta"]').forEach(r => r.checked = false);
                document.querySelectorAll('.access-option').forEach(opt => opt.classList.remove('selected'));
                
                // Marcar el correcto
                radioCorrespondiente.checked = true;
                const parentOption = radioCorrespondiente.closest('.access-option');
                if (parentOption) {
                    parentOption.classList.add('selected');
                }
            }

            // Continuar con el registro usando la funci√≥n con comentario
            if (comentario && comentario.trim()) {
                // Si hay comentario, usar la funci√≥n espec√≠fica
                enviarFormularioConComentario(cedula, tipoAcceso, comentario.trim());
            } else {
                // Si no hay comentario, usar la funci√≥n normal
                enviarFormularioConComentario(cedula, tipoAcceso, '');
            }
            
        } catch (error) {
            console.error('‚ùå Error en proceedWithRegistration:', error);
            showToast('Error de registro', 'Ocurri√≥ un error al procesar el registro. Intente nuevamente.', 'error');

            // Restaurar interfaz en caso de error
            desbloquearFormulario();
            if (DOM.cedulaInput) {
                DOM.cedulaInput.focus();
            }
        }
    }

        function limpiarFormularioPrincipal() {
            try {
                console.log('üßπ INICIANDO LIMPIEZA DEL FORMULARIO PRINCIPAL');

                formularioBloqueado = false;

                if (DOM.cedulaInput) {
                    DOM.cedulaInput.disabled = false;
                    DOM.cedulaInput.value = '';
                    setTimeout(() => {
                        DOM.cedulaInput.focus();
                        console.log('üéØ Campo de c√©dula enfocado para siguiente entrada');
                    }, 100);
                } else {
                    console.error('‚ùå CAMPO DE C√âDULA NO ENCONTRADO');
                }

                // Limpiar radio buttons y remover selecci√≥n visual
                document.querySelectorAll('input[name="respuesta"]').forEach(radio => {
                radio.checked = false;
                radio.disabled = false;
                });
                document.querySelectorAll('.access-option').forEach(option => {
                option.classList.remove('selected');
                });
                console.log('üìª Radio buttons habilitados y limpiados');

                if (DOM.infoSeleccionada) DOM.infoSeleccionada.innerHTML = '';
                if (DOM.radioError) DOM.radioError.style.display = 'none';
                if (DOM.cedulaSuggestions) DOM.cedulaSuggestions.classList.remove('show');
                if (DOM.limpiarCedulaButton) DOM.limpiarCedulaButton.style.display = 'none';
                
                // Ocultar display de datos de usuario
                const displayUsuario = document.getElementById('displayDatosUsuario');
                if (displayUsuario) {
                    displayUsuario.style.display = 'none';
                }
                
                // CORRECCI√ìN: Ocultar todas las tarjetas de informaci√≥n
                ocultarTarjetaUsuario();
                hidePersonInfoCard();

                // Limpiar campos de modales
                if (DOM.commentText) DOM.commentText.value = '';
                if (DOM.personNameInput) DOM.personNameInput.value = '';
                if (DOM.personCompanyInput) DOM.personCompanyInput.value = '';
                if (DOM.visitReasonInput) DOM.visitReasonInput.value = '';

                // Habilitar botones principales
                if (DOM.submitButton) DOM.submitButton.disabled = false;
                if (DOM.qrButton) DOM.qrButton.disabled = false;
                if (DOM.limpiarCedulaButton) DOM.limpiarCedulaButton.disabled = false;

                console.log('‚úÖ Formulario principal limpiado completamente para siguiente entrada');

            } catch (error) {
                console.error('‚ùå Error limpiando formulario principal:', error);
                try {
                    if (DOM.cedulaInput) {
                        DOM.cedulaInput.disabled = false;
                        DOM.cedulaInput.value = '';
                        DOM.cedulaInput.focus();
                        console.log('üîÑ Fallback: Campo de c√©dula limpiado por emergencia');
                    }
                    formularioBloqueado = false;
                } catch (fallbackError) {
                    console.error('‚ùå Error en fallback de limpieza:', fallbackError);
                }
            }
        }

        // =====================================================
        // PARTE 5: GESTI√ìN DE SONIDOS
        // =====================================================

        function gestionarSonidos() {
            try {
                sonidosActivados = localStorage.getItem('surpass-sounds') !== 'false';
            } catch (e) {
                console.error('Error al obtener configuraci√≥n de sonidos de localStorage:', e);
                sonidosActivados = true;
            }

            function actualizarUI() {
                const toggleSwitch = document.getElementById('toggleSounds');
                if (toggleSwitch) {
                    if (sonidosActivados) {
                        toggleSwitch.classList.add('active');
                    } else {
                        toggleSwitch.classList.remove('active');
                    }
                }
            }

            function toggle() {
                sonidosActivados = !sonidosActivados;
                try {
                    localStorage.setItem('surpass-sounds', sonidosActivados.toString());
                } catch (e) {
                    console.error('Error al guardar configuraci√≥n de sonidos en localStorage:', e);
                }
                actualizarUI();

                google.script.run
                    .withSuccessHandler(function(result) {
                        if (!result || result.success !== true) {
                            const parsed = (typeof parseBackendError === 'function') ? parseBackendError(result, 'Error al sincronizar sonidos') : { message: 'Error al sincronizar sonidos' };
                            showCustomNotification(`${parsed.message}${parsed.code ? ' [' + parsed.code + ']' : ''}`, 'warning');
                        } else {
                            console.log('‚úÖ Sonidos sincronizados con servidor:', result);
                        }
                    })
                    .withFailureHandler(function(error) {
                        const parsed = (typeof parseBackendError === 'function') ? parseBackendError(error, 'Error de conexi√≥n al sincronizar sonidos') : { message: 'Error de conexi√≥n al sincronizar sonidos' };
                        console.warn('‚ö†Ô∏è No se pudo sincronizar sonidos con servidor:', error);
                        showCustomNotification(`${parsed.message}${parsed.code ? ' [' + parsed.code + ']' : ''}`, 'error');
                    })
                    .toggleSonidos(sonidosActivados);

                showCustomNotification(`Sonidos ${sonidosActivados ? 'activados' : 'desactivados'}`, 'info');
                if (DOM.menuDropdown) DOM.menuDropdown.classList.remove('show');
            }

            window.toggleSonidos = toggle;
            window.actualizarEstadoSonidos = actualizarUI;

            actualizarUI();
        }

        // =====================================================
        // PARTE 6: FUNCIONES DEL FORMULARIO PRINCIPAL
        // =====================================================

        function limpiarCampoCedula() {
        if (formularioBloqueado) return;
        
        try {
            // Limpiar campo de entrada
            if (DOM.cedulaInput) {
                DOM.cedulaInput.value = '';
                DOM.cedulaInput.disabled = false;
            }
            
            // Limpiar informaci√≥n seleccionada
            if (DOM.infoSeleccionada) DOM.infoSeleccionada.innerHTML = '';
            
            // Ocultar sugerencias
            if (DOM.cedulaSuggestions) {
                DOM.cedulaSuggestions.classList.remove('show');
                DOM.cedulaSuggestions.innerHTML = '';
            }
            
            // Ocultar bot√≥n de limpiar
            if (DOM.limpiarCedulaButton) DOM.limpiarCedulaButton.style.display = 'none';
            
            // Ocultar display de datos usuario
            ocultarDisplayDatosUsuario();
            
            // Ocultar tarjeta de informaci√≥n de persona
            hidePersonInfoCard();
            
            // Limpiar radio buttons y sus estilos visuales
            document.querySelectorAll('input[name="respuesta"]').forEach(radio => {
                radio.checked = false;
                radio.disabled = false;
            });
            document.querySelectorAll('.access-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Ocultar error de radio si existe
            if (DOM.radioError) DOM.radioError.style.display = 'none';
            
            // Resetear variables globales
            selectedSuggestionIndex = -1;
            currentSuggestions = [];
            
            // ==========================================
            // RESETEAR VARIABLES GLOBALES DE QR - CLAVE PARA SOLUCIONAR EL PROBLEMA
            // ==========================================
            resetearEstadoQRCompleto(); // Llamar funci√≥n espec√≠fica para limpiar todo el estado QR
            
            // Limpiar timeout si existe
            if (timeoutIdCedula) {
                clearTimeout(timeoutIdCedula);
                timeoutIdCedula = null;
            }
            
            // Enfocar el campo de c√©dula
            setTimeout(() => {
                if (DOM.cedulaInput && !DOM.cedulaInput.disabled) {
                    DOM.cedulaInput.focus();
                }
            }, 100);
            
            console.log('‚úÖ Campo de c√©dula y estado QR limpiados COMPLETAMENTE');
            console.log('üîÑ Sistema listo para nuevo escaneo QR');
            
        } catch (error) {
            console.error('‚ùå Error limpiando campo de c√©dula:', error);
            // Limpieza de emergencia
            if (DOM.cedulaInput) {
                DOM.cedulaInput.value = '';
                DOM.cedulaInput.focus();
            }
        }
    }

        function buscarCedulas(query) {
        try {
            // Limpiar timeout anterior
            if (timeoutIdCedula) {
                clearTimeout(timeoutIdCedula);
                timeoutIdCedula = null;
            }
            
            if (!query || query.length < 2) {
                if (DOM.cedulaSuggestions) {
                    DOM.cedulaSuggestions.classList.remove('show');
                    DOM.cedulaSuggestions.innerHTML = '';
                }
                ocultarDisplayDatosUsuario();
                hidePersonInfoCard();
                selectedSuggestionIndex = -1;
                currentSuggestions = [];
                return;
            }
            
            const queryLimpia = query.toLowerCase().trim();
            
            // Buscar usuario exacto primero
            const usuarioExacto = personalGlobal.find(p => {
                if (!p || !p.cedula) return false;
                return p.cedula.toLowerCase() === queryLimpia || 
                    (p.cedulaNormalizada && p.cedulaNormalizada === queryLimpia.replace(/[^\d]/g, ''));
            });
            
            if (usuarioExacto) {
                mostrarDisplayDatosUsuario(usuarioExacto);
                console.log(`üë§ Usuario exacto encontrado: ${usuarioExacto.nombre}`);
            } else {
                ocultarDisplayDatosUsuario();
            }
            
            // Filtrar sugerencias
            const suggestions = personalGlobal.filter(item => {
                if (!item || !item.cedula) return false;
                
                const cedula = item.cedula.toLowerCase();
                const nombre = (item.nombre || '').toLowerCase();
                const empresa = (item.empresa || '').toLowerCase();
                const busqueda = (item.busqueda || '').toLowerCase();
                
                return cedula.includes(queryLimpia) ||
                    nombre.includes(queryLimpia) ||
                    empresa.includes(queryLimpia) ||
                    busqueda.includes(queryLimpia);
            }).slice(0, 15);

            currentSuggestions = suggestions;
            selectedSuggestionIndex = -1;

            if (!DOM.cedulaSuggestions) return;

            DOM.cedulaSuggestions.innerHTML = '';

            if (suggestions.length === 0) {
                DOM.cedulaSuggestions.classList.remove('show');
                return;
            }

            suggestions.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'suggestion-item';
                li.dataset.index = index;

                // Funci√≥n para destacar texto
                function highlightText(text, query) {
                    if (!text || !query) return text || '';
                    const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                    return text.replace(regex, '<span class="highlight">$1</span>');
                }

                const cedulaHighlighted = item.cedula && item.cedula.toLowerCase().includes(queryLimpia) ?
                    highlightText(item.cedula, queryLimpia) : (item.cedula || '');

                const nombreEmpresa = `${item.nombre || 'Sin nombre'} - ${item.empresa || 'Sin empresa'}`;
                const nombreEmpresaHighlighted = nombreEmpresa.toLowerCase().includes(queryLimpia) ?
                    highlightText(nombreEmpresa, queryLimpia) : nombreEmpresa;

                li.innerHTML = `
                    <span class="suggestion-cedula">${cedulaHighlighted}</span>
                    <span class="suggestion-nombre-empresa">${nombreEmpresaHighlighted}</span>
                `;

                li.addEventListener('click', function() {
                    selectCedula(item.cedula, item.nombre, item.empresa);
                });
                
                DOM.cedulaSuggestions.appendChild(li);
            });
            
            DOM.cedulaSuggestions.classList.add('show');
            
        } catch (error) {
            console.error('‚ùå Error en buscarCedulas:', error);
            if (DOM.cedulaSuggestions) {
                DOM.cedulaSuggestions.classList.remove('show');
            }
        }
    }

        function selectCedula(cedula, nombre, empresa) {
        try {
            if (!cedula) {
                console.warn('‚ö†Ô∏è selectCedula: C√©dula no proporcionada');
                return;
            }
            
            // Actualizar campo de entrada
            if (DOM.cedulaInput) DOM.cedulaInput.value = cedula;
            
            // Actualizar informaci√≥n seleccionada
            if (DOM.infoSeleccionada) {
                DOM.infoSeleccionada.innerHTML = `<strong>${nombre || 'N/A'}</strong> - ${empresa || 'N/A'}`;
            }
            
            // Ocultar sugerencias
            if (DOM.cedulaSuggestions) {
                DOM.cedulaSuggestions.classList.remove('show');
                DOM.cedulaSuggestions.innerHTML = '';
            }
            
            // Mostrar bot√≥n de limpiar
            if (DOM.limpiarCedulaButton) DOM.limpiarCedulaButton.style.display = 'block';
            
            // Encontrar usuario seleccionado
            const usuarioSeleccionado = personalGlobal.find(p => 
                p && p.cedula && p.cedula === cedula
            );
            
            if (usuarioSeleccionado) {
                mostrarDisplayDatosUsuario(usuarioSeleccionado);
                console.log(`‚úÖ Usuario seleccionado: ${usuarioSeleccionado.nombre}`);
            }
            
            // Limpiar variables de navegaci√≥n
            selectedSuggestionIndex = -1;
            currentSuggestions = [];
            
        } catch (error) {
            console.error('‚ùå Error en selectCedula:', error);
        }
    }

        /**
         * Sincroniza las entradas activas con el servidor
         * Esta funci√≥n debe llamarse despu√©s de cada operaci√≥n de entrada/salida
         * Utiliza la funci√≥n sincronizarEntradasActivas de registroB.js
         */
        function sincronizarEntradasActivasConServidor() {
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                console.log('üîÑ Sincronizando entradas activas despu√©s de operaci√≥n...');
                google.script.run
                    .withSuccessHandler(function(entradas) {
                        if (entradas && Array.isArray(entradas)) {
                            window.entradasActivas = entradas;
                            localStorage.setItem('entradasActivas', JSON.stringify(entradas));
                            console.log('‚úÖ Entradas activas actualizadas:', entradas.length);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('‚ùå Error sincronizando entradas activas:', error);
                    })
                    .sincronizarEntradasActivas();
            } else {
                console.warn('‚ö†Ô∏è No se puede sincronizar: API de Google no disponible');
            }
        }

        // Funciones para navegaci√≥n con teclado en autocompletado
        function navigateSuggestions(direction) {
            if (currentSuggestions.length === 0) return;

            // Remover clase active de la sugerencia actual
            const currentActive = DOM.cedulaSuggestions.querySelector('.suggestion-item.active');
            if (currentActive) currentActive.classList.remove('active');

            if (direction === 'down') {
                selectedSuggestionIndex = selectedSuggestionIndex < currentSuggestions.length - 1 
                    ? selectedSuggestionIndex + 1 
                    : 0;
            } else if (direction === 'up') {
                selectedSuggestionIndex = selectedSuggestionIndex > 0 
                    ? selectedSuggestionIndex - 1 
                    : currentSuggestions.length - 1;
            }

            // Agregar clase active a la nueva sugerencia
            const suggestions = DOM.cedulaSuggestions.querySelectorAll('.suggestion-item');
            if (suggestions[selectedSuggestionIndex]) {
                suggestions[selectedSuggestionIndex].classList.add('active');
                // Hacer scroll para que la sugerencia sea visible
                suggestions[selectedSuggestionIndex].scrollIntoView({ 
                    block: 'nearest',
                    behavior: 'smooth'
                });
            }
        }

        function selectCurrentSuggestion() {
            if (selectedSuggestionIndex >= 0 && currentSuggestions[selectedSuggestionIndex]) {
                const suggestion = currentSuggestions[selectedSuggestionIndex];
                selectCedula(suggestion.cedula, suggestion.nombre, suggestion.empresa);
            }
        }

        function closeSuggestions() {
            if (DOM.cedulaSuggestions) DOM.cedulaSuggestions.classList.remove('show');
            const hint = document.querySelector('.autocomplete-hint');
            if (hint) hint.style.display = 'none';
            currentSuggestions = [];
            selectedSuggestionIndex = -1;
        }

        function enviarFormulario() {
            console.log('üîÑ Ejecutando enviarFormulario...');
            
            // Verificar bloqueo de formulario
            if (formularioBloqueado) {
                showCustomNotification('Debe completar el proceso anterior antes de continuar.', 'warning');
                return;
            }
            
            // üîß [CONFIG-INTEGRATION] Validar horarios empresariales
            const validacionHorario = validarHorarioEmpresa();
            if (!validacionHorario.permitido) {
                showCustomNotification(`Acceso fuera de horario: ${validacionHorario.mensaje}`, 'warning');
                console.warn('‚è∞ [CONFIG-INTEGRATION] Acceso denegado por horario:', validacionHorario);
                return;
            }
            
            // CORRECCI√ìN CR√çTICA: Usar una variable local en lugar de global
            if (window._processingCurrentRequest) {
                console.log('‚ö†Ô∏è Ya hay una solicitud en proceso, ignorando este env√≠o');
                return;
            }
            
            // Marcar como procesando localmente
            window._processingCurrentRequest = true;
            
            // Auto-limpiar flag despu√©s de 10 segundos como seguridad
            const timeoutId = setTimeout(() => {
                if (window._processingCurrentRequest) {
                    console.warn('‚ö†Ô∏è Limpiando flag de procesamiento por timeout');
                    window._processingCurrentRequest = false;
                }
            }, 10000);

            try {
                // Validaciones existentes...
                const respuestaRadio = document.querySelector('input[name="respuesta"]:checked');
                if (!respuestaRadio) {
                    console.warn('‚ö†Ô∏è No hay respuesta seleccionada');
                    if (DOM.radioError) DOM.radioError.style.display = 'block';
                    clearTimeout(timeoutId);
                    window._processingCurrentRequest = false;
                    return;
                }

                let cedula = '';
                if (DOM.cedulaInput && DOM.cedulaInput.value !== null) {
                    cedula = String(DOM.cedulaInput.value).trim();
                }

                if (!cedula) {
                    showCustomNotification('Por favor ingrese una c√©dula v√°lida', 'warning');
                    if (DOM.cedulaInput) DOM.cedulaInput.focus();
                    clearTimeout(timeoutId);
                    window._processingCurrentRequest = false;
                    return;
                }

                console.log('‚úÖ Enviando al backend:', { cedula, tipoAcceso: respuestaRadio.value });
                
                mostrarLoading('Procesando...');

                google.script.run
                    .withSuccessHandler(function(result) {
                        clearTimeout(timeoutId);
                        window._processingCurrentRequest = false;
                        ocultarLoading();
                        procesarRespuestaBackend(result, cedula, respuestaRadio.value);
                    })
                    .withFailureHandler(function(error) {
                        clearTimeout(timeoutId);
                        window._processingCurrentRequest = false;
                        ocultarLoading();
                        console.error('‚ùå Error en handleHTMLFormSubmit:', error);
                        showCustomNotification('Error: ' + (error.message || 'Error desconocido'), 'error');
                    })
                    .handleHTMLFormSubmit(cedula, respuestaRadio.value);
                    
            } catch (error) {
                clearTimeout(timeoutId);
                window._processingCurrentRequest = false;
                console.error('‚ùå Error cr√≠tico en enviarFormulario:', error);
                showCustomNotification('Error interno del sistema', 'error');
            }
        }

    function procesarRespuestaBackend(result, cedula, tipoAcceso) {
        appendLog(result.log || { timestamp: new Date().toISOString(), level: 'INFO', message: 'Formulario procesado', details: {} });

        let colorMensaje = 'info';
        if (result.color) {
            if (result.color === 'red') colorMensaje = 'error';
            else if (result.color === 'orange') colorMensaje = 'orange';
            else if (result.color === 'green') colorMensaje = 'success';
            else colorMensaje = result.color;
        }

        const customIcon = result.icon || null;
        let customTitle = null;

        if (result.tipoFlujo) {
            switch (result.tipoFlujo) {
                case 'entrada_registrada': customTitle = 'Entrada Registrada'; break;
                case 'salida_normal': customTitle = 'Salida Registrada'; break;
                case 'salida_sin_entrada_previa': customTitle = 'Salida Sin Entrada Previa'; break;
                case 'entrada_persona_no_registrada': customTitle = 'Persona No Identificada'; break;
                case 'salida_persona_no_registrada_con_entrada_previa': customTitle = 'Salida Con Datos Previos'; break;
                case 'salida_sin_entrada_previa_persona_no_registrada': customTitle = 'Persona No Identificada'; break;
                case 'registro_pendiente_existente': customTitle = 'Registro Duplicado'; break;
            }
        }

        // Registro duplicado
        if (result.registroPendienteExistente) {
            showCustomNotification(result.message, 'error', false, null, customIcon, customTitle);
            return;
        }

        // Salida con entrada previa - persona no registrada
        if (result.salidaConEntradaPrevia) {
            if (result.message) {
                showCustomNotification(result.message, 'orange', false, null, customIcon, customTitle);
            }
            updateLiveHistory(result.cedula, 'salida');
            reproducirSonido('successSound');
            limpiarFormularioPrincipal();
            return;
        }

        // Salida sin entrada previa - registro directo
        if (result.tipoFlujo === 'salida_sin_entrada_previa_directa') {
            showCustomNotification(result.message, 'error', false, null, customIcon, customTitle);
            updateLiveHistory(cedula, tipoAcceso);
            reproducirSonido('successSound');
            limpiarFormularioPrincipal();
            return;
        }

        // Entrada/Salida normal - persona registrada
        if (result.color === 'green') {
            showCustomNotification(result.message, 'success', false, null, customIcon, customTitle);
            sincronizarEntradasActivasConServidor();
            updateLiveHistory(cedula, tipoAcceso);
            reproducirSonido('successSound');
            limpiarFormularioPrincipal();
            return;
        }

        // Casos con modal: Comentario obligatorio
        if (result.comentarioObligatorio) {
            window.modalData = {
                cedula: result.cedula,
                tipoAcceso: result.tipoAcceso,
                sessionId: result.sessionId,
                timestamp: result.timestamp,
                mensajeAviso: result.message,
                icon: result.icon,
                customTitle: customTitle,
                esPersonaRegistrada: result.esPersonaRegistrada,
                modalTipo: result.modalTipo
            };

            showCustomNotification(result.message, 'error');

            if (result.esPersonaRegistrada && result.modalTipo === 'justificacion') {
                abrirModalComentario();
                bloquearFormulario();
            } else if (result.modalTipo === 'registro' && !result.esPersonaRegistrada) {
                // Persona no registrada: abrir modal de registro temporal
                abrirModalComentarioPersonalizado(result.cedula, result.tipoAcceso);
            } else if (result.registroPendiente && !result.esPersonaRegistrada) {
                abrirModalComentarioPersonalizado(result.cedula, result.tipoAcceso);
            } else {
                abrirModalComentario();
                bloquearFormulario();
            }
            return;
        } else {
            // Caso por defecto
            let mensajeCompleto = result.message;
            if (result.nombre && result.empresa) {
                mensajeCompleto += `\nNombre: ${result.nombre}\nEmpresa: ${result.empresa}`;
            }
            showCustomNotification(mensajeCompleto, colorMensaje);
            updateLiveHistory(cedula, tipoAcceso);
            reproducirSonido('successSound');
            limpiarFormularioPrincipal();
        }
    }

        function enviarFormularioConComentario(cedula, tipoAcceso, comentarioOpcional = '') {
            console.log('üîÑ Ejecutando env√≠o con comentario opcional...');
            
            if (formularioBloqueado) {
                showCustomNotification('Debe completar el proceso anterior antes de continuar.', 'warning');
                return;
            }

            // VALIDACI√ìN ROBUSTA DE PAR√ÅMETROS
            if (!cedula || typeof cedula !== 'string' || cedula.trim() === '' || cedula === 'undefined' || cedula === 'null') {
                console.error('‚ùå Par√°metros faltantes para env√≠o con comentario:', { cedula, tipo: typeof cedula });
                showCustomNotification('Error: Datos incompletos', 'error');
                return;
            }

            if (!tipoAcceso || (tipoAcceso !== 'entrada' && tipoAcceso !== 'salida')) {
                console.error('‚ùå Tipo de acceso inv√°lido:', tipoAcceso);
                showCustomNotification('Error: Tipo de acceso inv√°lido', 'error');
                return;
            }

            // Limpiar c√©dula por seguridad
            const cedulaLimpia = String(cedula).trim();

            console.log('‚úÖ Enviando al backend con comentario:', { 
                cedula: cedulaLimpia, 
                tipoAcceso, 
                comentario: comentarioOpcional,
                cedulaLength: cedulaLimpia.length 
            });
            
            mostrarLoading('Procesando...');

            // Ocultar tarjeta de informaci√≥n
            hidePersonInfoCard();

            if (!navigator.onLine) {
                handleOfflineSubmit(cedulaLimpia, tipoAcceso);
                ocultarLoading();
                return;
            }

            google.script.run
                .withSuccessHandler(function(result) {
                    ocultarLoading();
                    console.log('üìä Respuesta del backend con comentario:', result);
                    
                    // Procesar respuesta igual que en enviarFormulario
                    appendLog(result.log || { 
                        timestamp: new Date().toISOString(), 
                        level: 'INFO', 
                        message: 'Formulario procesado con comentario', 
                        details: { cedula: cedulaLimpia, tipoAcceso, comentario: comentarioOpcional } 
                    });

                    let colorMensaje = 'info';
                    if (result.color) {
                        if (result.color === 'red') colorMensaje = 'error';
                        else if (result.color === 'orange') colorMensaje = 'orange';
                        else if (result.color === 'green') colorMensaje = 'success';
                        else colorMensaje = result.color;
                    }

                    const customIcon = result.icon || null;
                    let customTitle = result.customTitle || null;

                    // Manejar los diferentes tipos de flujo
                    if (result.success) {
                        let mensaje = result.message;
                        if (comentarioOpcional) {
                            mensaje += `\n\nüìù Comentario: ${comentarioOpcional}`;
                        }
                        
                        showCustomNotification(mensaje, 'success', false, null, customIcon, customTitle);
                        updateLiveHistory(cedulaLimpia, tipoAcceso);
                        reproducirSonido('successSound');
                        limpiarFormularioPrincipal();
                        
                        // Sincronizar entradas activas
                        sincronizarEntradasActivasConServidor();
                    } else {
                        // Manejar casos que requieren modal
                        if (result.comentarioObligatorio) {
                            window.modalData = {
                                cedula: result.cedula,
                                tipoAcceso: result.tipoAcceso,
                                sessionId: result.sessionId,
                                timestamp: result.timestamp,
                                mensajeAviso: result.message,
                                icon: result.icon,
                                customTitle: customTitle,
                                esPersonaRegistrada: result.esPersonaRegistrada,
                                modalTipo: result.modalTipo
                            };

                            showCustomNotification(result.message, colorMensaje);

                            if (result.esPersonaRegistrada && result.modalTipo === 'justificacion') {
                                abrirModalComentario();
                                bloquearFormulario();
                            } else if (result.registroPendiente && !result.esPersonaRegistrada) {
                                abrirModalComentarioPersonalizado(result.cedula, result.tipoAcceso);
                            }
                        } else {
                            showCustomNotification(result.message, colorMensaje);
                            limpiarFormularioPrincipal();
                        }
                    }
                })
                .withFailureHandler(function(error) {
                    ocultarLoading();
                    console.error('‚ùå Error en env√≠o con comentario:', error);
                    showCustomNotification('Error: ' + (error.message || 'Error desconocido'), 'error');
                    reproducirSonido('errorSound');
                    appendLog({ 
                        timestamp: new Date().toISOString(), 
                        level: 'ERROR', 
                        message: 'Error procesando formulario con comentario', 
                        details: { 
                            error: error.message || error,
                            cedula: cedulaLimpia,
                            tipoAcceso,
                            comentario: comentarioOpcional
                        } 
                    });
                })
                .handleHTMLFormSubmitWithComment(cedulaLimpia, tipoAcceso, comentarioOpcional);
        }

        function handleOfflineSubmit(cedula, respuestaValue) {
            // Validar par√°metros obligatorios
            if (!cedula || cedula.trim() === '' || !respuestaValue) {
                console.error('handleOfflineSubmit: Par√°metros inv√°lidos', { cedula, respuestaValue });
                showCustomNotification('Error: Datos incompletos para procesar offline', 'error');
                return;
            }

            const personaEncontrada = personalGlobal.find(p => p.cedula === cedula || p.cedula.toLowerCase() === cedula.toLowerCase());
            const resultado = {
                message: personaEncontrada ? 'Registro guardado localmente (sin conexi√≥n)' : 'Acceso Denegado - Verificar cuando haya conexi√≥n',
                nombre: personaEncontrada ? personaEncontrada.nombre : 'DENEGADO',
                empresa: personaEncontrada ? personaEncontrada.empresa : 'No registrada',
                estadoAcceso: personaEncontrada ? 'Acceso Permitido (Pendiente)' : 'Acceso Denegado',
                color: personaEncontrada ? 'warning' : 'error'
            };

            SurPassCache.guardarTransaccionPendiente({ cedula: cedula, respuesta: respuestaValue, offline: true });

            showCustomNotification(
                `${resultado.message}\nNombre: ${resultado.nombre}\nEmpresa: ${resultado.empresa}\nSe sincronizar√° cuando haya conexi√≥n.`,
                resultado.color
            );
            appendLog({ timestamp: new Date().toISOString(), level: 'WARNING', message: 'Registro offline guardado', details: { cedula, respuesta: respuestaValue } });

            if (resultado.estadoAcceso.includes('Permitido')) {
                limpiarFormularioPrincipal();
            } else if (resultado.estadoAcceso === 'Acceso Denegado') {
                window.modalData = {
                    cedula: cedula,
                    tipoAcceso: respuestaValue,
                    mensajeAviso: resultado.message,
                    icon: 'fas fa-times-circle',
                    customTitle: 'Acceso Denegado (Offline)',
                    esPersonaRegistrada: !!personaEncontrada,
                    modalTipo: 'justificacion'
                };
                abrirModalComentario();
                bloquearFormulario();
            }
        }

        // =====================================================
        // PARTE 7: MODALES DE COMENTARIOS Y REGISTRO TEMPORAL
        // =====================================================

        function abrirModalComentario() {
            try {
                const modal = DOM.commentModal;
                const cedulaSpan = DOM.commentModalCedula;
                const nombreSpan = DOM.commentModalNombre;
                const comentarioInput = DOM.commentText;
                const loadingDiv = DOM.commentLoading;

                if (!modal || !cedulaSpan || !nombreSpan || !comentarioInput || !loadingDiv) {
                    console.error('‚ùå Elementos del modal de comentario no encontrados.');
                    showCustomNotification('Error interno: No se pudo abrir el modal de comentarios', 'error');
                    return;
                }

                const cedula = DOM.cedulaInput ? DOM.cedulaInput.value.trim() : '';
                let nombrePersona = 'No disponible';
                let empresaPersona = 'No especificada';

                if (cedula) {
                    const personaEncontrada = personalGlobal.find(p =>
                        p.cedula === cedula || p.cedula.toLowerCase() === cedula.toLowerCase()
                    );

                    if (personaEncontrada) {
                        nombrePersona = personaEncontrada.nombre || 'Nombre no disponible';
                        empresaPersona = personaEncontrada.empresa || 'Empresa no especificada';
                        console.log('‚úÖ Persona encontrada para modal de comentario:', { cedula, nombre: nombrePersona, empresa: empresaPersona });
                    } else {
                        const infoSeleccionadaText = DOM.infoSeleccionada ? DOM.infoSeleccionada.textContent : '';
                        if (infoSeleccionadaText && !infoSeleccionadaText.includes('Persona no encontrada')) {
                            const partes = infoSeleccionadaText.split(' - ');
                            if (partes.length >= 2) {
                                nombrePersona = partes[0].trim();
                                empresaPersona = partes[1].trim();
                            }
                        }
                        console.log('‚ö†Ô∏è Persona no encontrada en base de datos para modal de comentario. Datos fallback:', { nombre: nombrePersona, empresa: empresaPersona });
                    }
                }

                cedulaSpan.textContent = cedula || 'No especificada';
                if (nombrePersona && nombrePersona !== 'No disponible' && nombrePersona !== 'Nombre no disponible') {
                    nombreSpan.textContent = nombrePersona;
                    nombreSpan.style.color = '#2e7d32';
                    nombreSpan.style.fontWeight = 'bold';
                } else {
                    nombreSpan.textContent = 'Persona no identificada';
                    nombreSpan.style.color = '#d32f2f';
                    nombreSpan.style.fontWeight = 'normal';
                }
                nombreSpan.title = `Empresa: ${empresaPersona}`;

                comentarioInput.value = '';
                loadingDiv.style.display = 'none';
                modal.classList.add('show');

                setTimeout(() => {
                    comentarioInput.focus();
                }, 300);

                console.log('‚úÖ Modal de comentario abierto para:', { cedula, nombre: nombrePersona, empresa: empresaPersona });

            } catch (error) {
                console.error('‚ùå Error abriendo modal de comentario:', error);
                showCustomNotification('No se pudo abrir el formulario de comentarios. Intente nuevamente.', 'error');
            }
        }

        function cerrarModalComentario() {
            try {
                if (DOM.commentModal) DOM.commentModal.classList.remove('show');
                if (DOM.commentText) DOM.commentText.value = '';
                if (DOM.commentLoading) DOM.commentLoading.style.display = 'none';

                window.modalData = null;

                console.log('üîí Cerrando modal de comentario y desbloqueando formulario principal...');
                desbloquearFormulario();
                limpiarFormularioPrincipal();

                console.log('‚úÖ Modal de comentario cerrado y formulario limpiado.');

            } catch (error) {
                console.error('‚ùå Error cerrando modal de comentario:', error);
                desbloquearFormulario();
                if (DOM.cedulaInput) DOM.cedulaInput.focus();
            }
        }

        function procesarComentarioModal() {
            try {
                const comentario = DOM.commentText ? DOM.commentText.value.trim() : '';
                const cedula = DOM.cedulaInput ? DOM.cedulaInput.value.trim() : '';
                const loadingDiv = DOM.commentLoading;

                if (!comentario || comentario.trim().length === 0) {
                    showCustomNotification('Por favor, ingrese un comentario describiendo la situaci√≥n', 'warning');
                    if (DOM.commentText) DOM.commentText.focus();
                    return;
                }

                // Eliminado el l√≠mite m√≠nimo de caracteres para mayor flexibilidad

                if (loadingDiv) loadingDiv.style.display = 'flex';
                console.log('üìù Enviando comentario:', { cedula, comentario });

                if (!navigator.onLine) {
                    console.log('‚ùå SIN CONEXI√ìN - Modo offline activado para comentario');
                    if (loadingDiv) loadingDiv.style.display = 'none';
                    showCustomNotification('No hay conexi√≥n a internet. El comentario se guardar√° cuando haya conexi√≥n.', 'warning');

                    SurPassCache.guardarTransaccionPendiente({
                        cedula: cedula,
                        comentario: comentario,
                        tipo: 'comentario',
                        offline: true
                    });
                    appendLog({
                        timestamp: new Date().toISOString(),
                        level: 'WARNING',
                        message: 'Comentario offline guardado',
                        details: { cedula, comentario }
                    });

                    cerrarModalComentario();
                    return;
                }

                console.log('‚úÖ Conexi√≥n verificada - Procediendo con env√≠o al servidor...');

                let timeoutId = setTimeout(() => {
                    console.error('‚è∞ TIMEOUT: El servidor no respondi√≥ en 30 segundos.');
                    if (loadingDiv) loadingDiv.style.display = 'none';
                    showCustomNotification('El servidor est√° tardando mucho en responder. Por favor, intente nuevamente.', 'warning');
                    desbloquearFormulario();
                    limpiarFormularioPrincipal();
                }, 30000);

                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('üéâ SUCCESS HANDLER EJECUTADO para comentario.');
                        console.log('üì• Respuesta del servidor:', result);

                        clearTimeout(timeoutId);
                        if (loadingDiv) loadingDiv.style.display = 'none';

                        if (result && result.success) {
                            console.log('‚úÖ Justificaci√≥n procesada exitosamente - APLICANDO METODOLOG√çA ESCENARIO 6');
                            cerrarModalComentario();
                            setTimeout(() => {
                                const tipoTexto = window.modalData.tipoAcceso === 'entrada' ? 'ENTRADA' : 'SALIDA';
                                let mensajeConfirmacion = '';
                                let customIcon = 'fas fa-exclamation-triangle';
                                let customTitle = '';

                                if (window.modalData && window.modalData.tipoAcceso === 'entrada') {
                                    mensajeConfirmacion = `‚ö†Ô∏è ENTRADA CON JUSTIFICACI√ìN PROCESADA\n\nüìÑ C√©dula: ${cedula}\nüë§ Nombre: ${window.modalData.nombre || 'N/A'}\nüíº Empresa: ${window.modalData.empresa || 'N/A'}\nüîÑ Tipo: ${tipoTexto}\nüìù Justificaci√≥n: ${comentario}\n‚ö° ACCESO CONDICIONADO\n\n‚úÖ Justificaci√≥n registrada para auditor√≠a`;
                                    customTitle = 'Entrada Justificada';
                                    customIcon = 'fas fa-user-check';
                                } else {
                                    mensajeConfirmacion = `‚ö†Ô∏è SALIDA SIN ENTRADA PREVIA JUSTIFICADA\n\nüìÑ C√©dula: ${cedula}\nüë§ Nombre: ${window.modalData ? window.modalData.nombre : 'N/A'}\nüíº Empresa: ${window.modalData ? window.modalData.empresa : 'N/A'}\nüîÑ Tipo: SALIDA\nüìù Justificaci√≥n: ${comentario}\n‚ö° ACCESO CONDICIONADO\n\n‚úÖ Justificaci√≥n registrada para auditor√≠a`;
                                    customTitle = 'Salida Justificada';
                                    customIcon = 'fas fa-exclamation-triangle';
                                }

                                showCustomNotification(mensajeConfirmacion, 'warning', true, function() {
                                    reproducirSonido('successSound');
                                }, customIcon, customTitle);

                                reproducirSonido('successSound');
                                updateLiveHistory(cedula, 'salida');
                                limpiarFormularioPrincipal();
                            }, 500);
                        } else {
                            console.log('‚ùå Respuesta no exitosa del ESCENARIO 3:', result);
                            showCustomNotification(result.message || 'Error procesando la justificaci√≥n', 'error');
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('üí• FAILURE HANDLER EJECUTADO para comentario.');
                        console.error('‚ùå Error completo:', error);

                        clearTimeout(timeoutId);
                        if (loadingDiv) loadingDiv.style.display = 'none';
                        showCustomNotification('Error de conexi√≥n: ' + (error.message || 'No se pudo procesar el comentario'), 'error');
                        appendLog({
                            timestamp: new Date().toISOString(),
                            level: 'ERROR',
                            message: 'Error enviando comentario',
                            details: { error: error.message || error, cedula: cedula, comentario: comentario }
                        });
                        console.log('üîì Forzando desbloqueo por error...');
                        desbloquearFormulario();
                        limpiarFormularioPrincipal();
                    })
                    .manejarComentarioPersonaRegistrada(cedula, comentario);

                console.log('üöÄ Llamada a google.script.run completada - esperando respuesta...');

            } catch (error) {
                console.error('‚ùå Error procesando comentario:', error);
                if (DOM.commentLoading) DOM.commentLoading.style.display = 'none';
                showCustomNotification('Ocurri√≥ un problema interno al procesar el comentario', 'error');
            }
        }

        function abrirModalComentarioPersonalizado(cedula, tipoAcceso) {
            try {
                const modal = DOM.customCommentModal;
                const modalCedula = DOM.modalCedulaPersonalizado;
                const modalTipoAcceso = DOM.modalTipoAccesoPersonalizado;
                const personName = DOM.personNameInput;
                const personCompany = DOM.personCompanyInput;
                const visitReason = DOM.visitReasonInput;
                const loadingDiv = DOM.customCommentLoading;

                if (!modal || !modalCedula || !modalTipoAcceso || !personName || !personCompany || !visitReason || !loadingDiv) {
                    console.error('‚ùå Faltan elementos del modal de comentario personalizado.');
                    showCustomNotification('Error interno: No se pudo abrir el formulario de registro temporal', 'error');
                    return;
                }

                const modalHeader = modal.querySelector('.comment-modal-header h2');
                const modalTitle = modal.querySelector('.modal-subtitle');
                const modalDescription = modal.querySelector('.modal-description');

                let customIcon = window.modalData && window.modalData.icon ? window.modalData.icon : null;
                let customTitle = window.modalData && window.modalData.customTitle ? window.modalData.customTitle : null;

                // Validar tipoAcceso y asignar valor por defecto si es necesario
                let tipo = (typeof tipoAcceso === 'string' && tipoAcceso.trim() !== '') ? tipoAcceso : 'entrada';
                if (tipo === 'entrada') {
                    modalHeader.innerHTML = `<i class="${customIcon || 'fas fa-user-slash'} modal-icon"></i>Registro de Acceso Temporal`;
                    modalTitle.textContent = customTitle || 'Entrada - Persona No Identificada';
                    modalDescription.textContent = 'Esta persona no est√° registrada en la base de datos del sistema. Complete la informaci√≥n solicitada para proceder con el registro del acceso temporal.';
                } else {
                    modalHeader.innerHTML = `<i class="${customIcon || 'fas fa-exclamation-triangle'} modal-icon"></i>Salida Sin Entrada Previa`;
                    modalTitle.textContent = customTitle || 'Salida - Persona No Identificada';
                    modalDescription.textContent = 'No se encontr√≥ un registro de entrada previa para esta persona. Complete la informaci√≥n solicitada para proceder con el registro de salida temporal.';
                }




                // Mostrar la c√©dula en el campo correspondiente
                modalCedula.textContent = cedula;
                modalTipoAcceso.textContent = tipo.toUpperCase();
                // Llenar los inputs ocultos del formulario
                const inputCedula = modal.querySelector('#customCedula');
                if (inputCedula) inputCedula.value = cedula;
                const inputTipoAcceso = modal.querySelector('#customTipoAcceso');
                if (inputTipoAcceso) inputTipoAcceso.value = tipo;

                personName.value = '';
                personCompany.value = '';
                visitReason.value = '';

                loadingDiv.style.display = 'none';
                modal.style.display = 'block';

                setTimeout(() => {
                    personName.focus();
                }, 300);

            } catch (error) {
                console.error('‚ùå Error abriendo modal personalizado:', error);
                showCustomNotification('No se pudo abrir el formulario de registro. Intente nuevamente.', 'warning');
            }
        }

        function cerrarModalComentarioPersonalizado() {
            try {
                if (DOM.customCommentModal) DOM.customCommentModal.style.display = 'none';
                window.modalData = null;
                limpiarFormularioPrincipal();
                desbloquearFormulario();
                console.log('‚úÖ Modal personalizado cerrado y formulario limpio');
            } catch (error) {
                console.error('Error cerrando modal personalizado:', error);
            }
        }

        function procesarComentarioPersonalizado() {
            try {
                const personName = DOM.personNameInput ? DOM.personNameInput.value.trim() : '';
                const personCompany = DOM.personCompanyInput ? DOM.personCompanyInput.value.trim() : '';
                const visitReason = DOM.visitReasonInput ? DOM.visitReasonInput.value.trim() : '';

                if (!personName || !visitReason) {
                    showCustomNotification('Por favor, complete el nombre y motivo de la visita', 'warning');
                    return;
                }

                if (!window.modalData) {
                    showCustomNotification('No hay datos de sesi√≥n. Intente nuevamente.', 'warning');
                    cerrarModalComentarioPersonalizado();
                    return;
                }

                const comentarioCompleto = `NOMBRE: ${personName} | EMPRESA: ${personCompany || 'No especificada'} | MOTIVO: ${visitReason}`;

                if (DOM.customCommentLoading) DOM.customCommentLoading.style.display = 'block';

                console.log('Enviando comentario personalizado:', { cedula: window.modalData.cedula, comentario: comentarioCompleto });

                if (!navigator.onLine) {
                    if (DOM.customCommentLoading) DOM.customCommentLoading.style.display = 'none';
                    showCustomNotification('No hay conexi√≥n a internet. El comentario se guardar√° cuando haya conexi√≥n.', 'warning');
                    SurPassCache.guardarTransaccionPendiente({
                        cedula: window.modalData.cedula,
                        comentario: comentarioCompleto,
                        tipo: 'comentario',
                        offline: true
                    });
                    appendLog({
                        timestamp: new Date().toISOString(),
                        level: 'WARNING',
                        message: 'Comentario offline guardado',
                        details: { cedula: window.modalData.cedula, comentario: comentarioCompleto }
                    });
                    cerrarModalComentarioPersonalizado();
                    desbloquearFormulario();
                    limpiarFormularioPrincipal();
                    return;
                }

                console.log('üî¥ ESCENARIO 3 PASO 2: Enviando justificaci√≥n desde modal:', { cedula: window.modalData.cedula, comentario: comentarioCompleto });

                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('üìã Respuesta del servidor:', result);
                        if (DOM.customCommentLoading) DOM.customCommentLoading.style.display = 'none';

                        if (result.success) {
                            console.log('‚úÖ Registro procesado exitosamente:', result);
                            cerrarModalComentarioPersonalizado();
                            setTimeout(() => {
                                const tipoTexto = window.modalData.tipoAcceso === 'entrada' ? 'ENTRADA' : 'SALIDA';
                                let mensajeConfirmacion = '';
                                let customIcon = window.modalData.icon || 'fas fa-exclamation-triangle';
                                let customTitle = '';

                                if (window.modalData.tipoAcceso === 'entrada') {
                                    mensajeConfirmacion = `üö´ ENTRADA NO REGISTRADA PROCESADA\n\nüìÑ C√©dula: ${window.modalData.cedula}\nüë§ Nombre: ${personName}\nüè¢ Empresa: ${personCompany || 'No especificada'}\nüìù Motivo: ${visitReason}\nüîÑ Tipo: ${tipoTexto}\n‚ùå ACCESO TEMPORAL\n\n‚úÖ Registro completado para auditor√≠a`;
                                    customTitle = 'Entrada Procesada';
                                    if (!window.modalData.icon) customIcon = 'fas fa-user-slash';
                                } else {
                                    mensajeConfirmacion = `üö´ SALIDA SIN ENTRADA PREVIA PROCESADA\n\nüìÑ C√©dula: ${window.modalData.cedula}\nüë§ Nombre: ${personName}\nüè¢ Empresa: ${personCompany || 'No especificada'}\nüìù Motivo: ${visitReason}\nüîÑ Tipo: ${tipoTexto}\n‚ùå ACCESO TEMPORAL\n\n‚úÖ Registro completado para auditor√≠a`;
                                    customTitle = 'Salida Procesada';
                                    if (!window.modalData.icon) customIcon = 'fas fa-exclamation-triangle';
                                }

                                showCustomNotification(mensajeConfirmacion, 'error', true, function() {
                                    reproducirSonido('successSound');
                                }, customIcon, customTitle || window.modalData.customTitle);

                                reproducirSonido('successSound');
                                updateLiveHistory(window.modalData.cedula, window.modalData.tipoAcceso);
                                limpiarFormularioPrincipal();
                            }, 500);
                        } else {
                            console.error('‚ùå Error procesando registro:', result);
                            const mensajeError = result.message || 'No se pudo procesar el registro';
                            showCustomNotification(`‚ùå Error: ${mensajeError}`, 'warning');
                        }
                    })
                    .withFailureHandler(function(error) {
                        if (DOM.customCommentLoading) DOM.customCommentLoading.style.display = 'none';
                        console.error('‚ùå Error de conexi√≥n al procesar comentario personalizado:', error);
                        showCustomNotification('‚ùå No hay conexi√≥n. Verifique su internet e intente nuevamente.', 'warning');
                    })
                    .procesarRegistroPersonaNoRegistrada({
                        cedula: window.modalData.cedula,
                        nombre: personName,
                        empresa: personCompany || 'No especificada',
                        motivo: visitReason,
                        tipoAcceso: window.modalData.tipoAcceso
                    });

            } catch (error) {
                console.error('Error procesando comentario personalizado:', error);
                if (DOM.customCommentLoading) DOM.customCommentLoading.style.display = 'none';
                showCustomNotification('Ocurri√≥ un problema interno. Intente nuevamente.', 'warning');
            }
        }

        // =====================================================
        // PARTE 8: ESC√ÅNER QR
        // =====================================================

        // Funci√≥n para detectar autom√°ticamente el mejor esc√°ner
        async function detectarMejorEscaner() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const cameras = devices.filter(device => device.kind === 'videoinput');
                
                const tieneVariasCamaras = cameras.length > 1;
                const tieneCamaraTrasera = cameras.some(cam => 
                    cam.label.toLowerCase().includes('back') || 
                    cam.label.toLowerCase().includes('rear') ||
                    cam.label.toLowerCase().includes('environment')
                );
                
                // Detectar tipo de dispositivo
                const esMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                const esTablet = /iPad|Android.*Tablet/i.test(navigator.userAgent);
                
                // L√≥gica de selecci√≥n autom√°tica
                let usarJsQR = false;
                let razon = '';
                
                if (esMobile && tieneCamaraTrasera && window.jsQR) {
                    usarJsQR = true;
                    razon = 'M√≥vil con c√°mara trasera - jsQR recomendado';
                } else if (tieneVariasCamaras && window.jsQR) {
                    usarJsQR = true;
                    razon = 'M√∫ltiples c√°maras - jsQR para mejor control';
                } else if (!window.Html5QrcodeScanner && window.jsQR) {
                    usarJsQR = true;
                    razon = 'HTML5-QRCode no disponible - usando jsQR';
                } else {
                    usarJsQR = false;
                    razon = 'HTML5-QRCode recomendado para este dispositivo';
                }
                
                console.log(`üéØ Detecci√≥n autom√°tica: ${usarJsQR ? 'jsQR' : 'HTML5-QRCode'} - ${razon}`);
                return { usarJsQR, razon, dispositivo: { esMobile, esTablet, camaras: cameras.length } };
                
            } catch (error) {
                console.warn('Error detectando c√°maras, usando configuraci√≥n por defecto:', error);
                return { 
                    usarJsQR: false, 
                    razon: 'Error en detecci√≥n - usando HTML5-QRCode por defecto',
                    dispositivo: { esMobile: false, esTablet: false, camaras: 0 }
                };
            }
        }

        async function iniciarEscanerQR() {
            if (isScannerActive) {
                console.log("El esc√°ner ya est√° activo, cerrando primero...");
                cerrarEscanerQR();
                return;
            }

            console.log("üöÄ Iniciando esc√°ner QR...");

            // PASO 1: VERIFICAR Y LIMPIAR RECURSOS DE C√ÅMARA ANTES DE INICIAR
            console.log("üîÑ Verificando estado de c√°mara antes de iniciar...");
            
            // Asegurar que todos los streams anteriores est√©n completamente liberados
            detenerTodosLosStreams();
            
            // Esperar un momento para que la c√°mara se libere completamente
            await new Promise(resolve => setTimeout(resolve, 300));
            
            // PASO 2: VERIFICAR DISPONIBILIDAD DE C√ÅMARA
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                console.log(`üìπ ${videoDevices.length} dispositivos de video disponibles`);
                
                if (videoDevices.length === 0) {
                    throw new Error('No hay dispositivos de c√°mara disponibles');
                }
            } catch (error) {
                console.error('‚ùå Error verificando dispositivos de c√°mara:', error);
                showToast('Error de c√°mara', 'No se puede acceder a la c√°mara.', 'error');
                return;
            }

            // PASO 3: MOSTRAR INTERFAZ DE LOADING
            if (DOM.qrScannerDiv) {
                DOM.qrScannerDiv.style.display = 'flex';
                const qrInfo = DOM.qrScannerDiv.querySelector('.qr-info');
                if (qrInfo) qrInfo.textContent = 'Iniciando esc√°ner...';
            }
            
            // PASO 4: CONFIGURAR VARIABLES DE ESTADO
            isScannerActive = true;
            window.scannerActive = true;
            window.qrProcessing = false; // Resetear flag de procesamiento
            
            if (DOM.menuButton) DOM.menuButton.style.display = 'none';
            try {
                // Detectar autom√°ticamente el mejor esc√°ner
                const deteccion = await detectarMejorEscaner();
                
                // Registrar tiempo de inicio para estad√≠sticas
                window.scanStartTime = Date.now();
                
                // Solo cambiar si la detecci√≥n sugiere algo diferente
                if (deteccion.usarJsQR !== useJsQR) {
                    useJsQR = deteccion.usarJsQR;
                    console.log(`üîÑ Cambiando a ${useJsQR ? 'jsQR' : 'HTML5-QRCode'}: ${deteccion.razon}`);
                    
                    // Guardar preferencia autom√°tica localmente
                    localStorage.setItem('surpass-autoScanner', JSON.stringify({
                        useJsQR: useJsQR,
                        razon: deteccion.razon,
                        timestamp: Date.now()
                    }));
                }

                // Actualizar la interfaz seg√∫n el esc√°ner seleccionado
                if (useJsQR) {
                    if (DOM.qrReaderDiv) DOM.qrReaderDiv.style.display = 'none';
                    if (DOM.qrModalContentDiv) DOM.qrModalContentDiv.style.display = 'block';
                    const qrInfo = DOM.qrScannerDiv.querySelector('.qr-info');
                    if (qrInfo) qrInfo.textContent = `Esc√°ner nativo activo - ${deteccion.razon}`;
                    startJsQRScanner();
                } else {
                    if (DOM.qrReaderDiv) DOM.qrReaderDiv.style.display = 'block';
                    if (DOM.qrModalContentDiv) DOM.qrModalContentDiv.style.display = 'none';
                    const qrInfo = DOM.qrScannerDiv.querySelector('.qr-info');
                    if (qrInfo) qrInfo.textContent = `Esc√°ner est√°ndar activo - ${deteccion.razon}`;
                    iniciarNuevoEscaner();
                }

            } catch (error) {
                console.error('Error en detecci√≥n autom√°tica:', error);
                // Fallback a la configuraci√≥n actual
                if (useJsQR) {
                    if (DOM.qrReaderDiv) DOM.qrReaderDiv.style.display = 'none';
                    if (DOM.qrModalContentDiv) DOM.qrModalContentDiv.style.display = 'block';
                    startJsQRScanner();
                } else {
                    if (DOM.qrReaderDiv) DOM.qrReaderDiv.style.display = 'block';
                    if (DOM.qrModalContentDiv) DOM.qrModalContentDiv.style.display = 'none';
                    iniciarNuevoEscaner();
                }
            }
        }

        // Archivo: registro.js.html

function switchQRMode() {
    // Limpiar configuraci√≥n autom√°tica ya que el usuario est√° eligiendo manualmente
    localStorage.removeItem('surpass-autoScanner');
    
    // Llamar a la nueva funci√≥n de backend que tambi√©n registra el cambio
    google.script.run
        .withSuccessHandler(function(result) {
            if (result && result.success) {
                useJsQR = result.usarJsQR;
                actualizarEstadoEscaner();
                showCustomNotification(result.message, 'info');
                if (DOM.menuDropdown) DOM.menuDropdown.classList.remove('show');
            } else {
                showCustomNotification(result.message || 'Error al cambiar de modo', 'error');
            }
        })
        .withFailureHandler(function(error) {
            const parsedError = parseBackendError(error, 'Error de conexi√≥n');
            showCustomNotification(parsedError.message, 'error');
        })
        .toggleEscaner(!useJsQR); // Enviamos el estado opuesto para alternarlo
}

               
        function cerrarEscanerQR() {
            console.log("üîÑ Cerrando esc√°ner QR unificado...");
            window.scannerActive = false;
            isScannerActive = false;
            window.qrProcessing = false;
            window.scanStartTime = null;

            // UI
            if (DOM.qrScannerDiv) DOM.qrScannerDiv.style.display = 'none';
            if (DOM.menuButton) DOM.menuButton.style.display = 'flex';

            // Intentar limpiar Html5QrcodeScanner correctamente
            if (html5QrCodeScanner) {
                try {
                    // clear() es el m√©todo oficial del wrapper Scanner
                    html5QrCodeScanner.clear().then(() => {
                        console.log('‚úÖ html5QrCodeScanner.clear() OK');
                        html5QrCodeScanner = null;
                        if (DOM.qrReaderDiv) DOM.qrReaderDiv.innerHTML = '';
                    }).catch(err => {
                        console.warn('‚ö†Ô∏è clear() fall√≥, intento de reset manual:', err);
                        // Fallbacks conocidos
                        try { html5QrCodeScanner._scanner && html5QrCodeScanner._scanner.stop(); } catch(_) {}
                        try { html5QrCodeScanner._element && (html5QrCodeScanner._element.innerHTML = ''); } catch(_) {}
                        html5QrCodeScanner = null;
                        if (DOM.qrReaderDiv) DOM.qrReaderDiv.innerHTML = '';
                    });
                } catch (e) {
                    console.warn('‚ö†Ô∏è Excepci√≥n al limpiar scanner:', e);
                    try { html5QrCodeScanner = null; } catch(_) {}
                    if (DOM.qrReaderDiv) DOM.qrReaderDiv.innerHTML = '';
                }
            }

            // Detener streams y limpiar video/canvas
            detenerTodosLosStreams();
            if (DOM.qrVideo) {
                try {
                    if (DOM.qrVideo.srcObject) {
                        DOM.qrVideo.srcObject.getTracks().forEach(t => t.stop());
                        DOM.qrVideo.srcObject = null;
                    }
                    DOM.qrVideo.pause();
                    DOM.qrVideo.currentTime = 0;
                    DOM.qrVideo.removeAttribute('data-scan-loop-active');
                } catch (e) { console.warn(e); }
            }
            if (DOM.qrCanvas) {
                try {
                    const ctx = DOM.qrCanvas.getContext('2d');
                    if (ctx) ctx.clearRect(0, 0, DOM.qrCanvas.width, DOM.qrCanvas.height);
                } catch (e) { console.warn(e); }
            }

            // Verificaci√≥n final
            setTimeout(detenerTodosLosStreams, 300);
            console.log("‚úÖ Esc√°ner QR cerrado completamente.");
        }
        // Funci√≥n especializada para detener TODOS los MediaStreams
        function detenerTodosLosStreams() {
            console.log("üõë Deteniendo todos los MediaStreams activos...");
            
            try {
                // === M√âTODO 1: DETENER STREAMS GLOBALES ===
                if (window.currentMediaStream) {
                    console.log("üîÑ Deteniendo currentMediaStream global...");
                    window.currentMediaStream.getTracks().forEach(track => {
                        if (track.readyState === 'live') {
                            track.stop();
                            console.log(`‚úÖ Track ${track.kind} detenido (estado: ${track.readyState})`);
                        }
                    });
                    window.currentMediaStream = null;
                }

                // === M√âTODO 2: DETENER TODOS LOS ELEMENTOS VIDEO ===
                const allVideoElements = document.querySelectorAll('video');
                allVideoElements.forEach((video, index) => {
                    if (video.srcObject) {
                        console.log(`üîÑ Limpiando video element ${index}...`);
                        try {
                            const stream = video.srcObject;
                            stream.getTracks().forEach(track => {
                                if (track.readyState === 'live') {
                                    track.stop();
                                    console.log(`‚úÖ Video track ${track.kind} detenido`);
                                }
                            });
                            video.srcObject = null;
                            video.load(); // Forzar recarga del video
                        } catch (e) {
                            console.warn(`‚ö†Ô∏è Error limpiando video ${index}:`, e);
                        }
                    }
                    
                    // Limpiar atributos y pausar
                    video.pause();
                    video.removeAttribute('data-scan-loop-active');
                    video.currentTime = 0;
                });

                // === M√âTODO 3: FORZAR LIBERACI√ìN DE C√ÅMARA CON NAVEGADOR ===
                // Usar API para obtener y detener todos los tracks activos
                if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
                    navigator.mediaDevices.enumerateDevices().then(devices => {
                        const videoDevices = devices.filter(device => device.kind === 'videoinput');
                        console.log(`üìπ ${videoDevices.length} dispositivos de video detectados`);
                    }).catch(e => {
                        console.warn('‚ö†Ô∏è Error enumerando dispositivos:', e);
                    });
                }

                // === M√âTODO 4: LIMPIAR CANVAS QR ===
                if (DOM.qrCanvas) {
                    try {
                        const ctx = DOM.qrCanvas.getContext('2d');
                        if (ctx) {
                            ctx.clearRect(0, 0, DOM.qrCanvas.width, DOM.qrCanvas.height);
                            console.log("‚úÖ Canvas QR limpiado");
                        }
                    } catch (e) {
                        console.warn("‚ö†Ô∏è Error limpiando canvas:", e);
                    }
                }

                // === M√âTODO 5: TIMEOUT DE SEGURIDAD ===
                setTimeout(() => {
                    // Verificaci√≥n final despu√©s de 500ms
                    const remainingStreams = document.querySelectorAll('video[srcObject]');
                    if (remainingStreams.length > 0) {
                        console.warn(`‚ö†Ô∏è ${remainingStreams.length} streams a√∫n activos despu√©s de limpieza`);
                        remainingStreams.forEach(video => {
                            video.srcObject = null;
                            video.load();
                        });
                    } else {
                        console.log("‚úÖ Todos los streams liberados correctamente");
                    }
                }, 500);

                console.log("üõë Finalizada limpieza de MediaStreams");
                
            } catch (error) {
                console.error("‚ùå Error en detenerTodosLosStreams:", error);
            }
        }

        function startJsQRScanner() {
            const video = DOM.qrVideo;
            const canvas = DOM.qrCanvas;
            if (!video || !canvas) {
                console.error('‚ùå Elementos de video o canvas para jsQR no encontrados.');
                showToast('Error de c√°mara', 'Elementos de c√°mara no disponibles.', 'error');
                return;
            }
            const context = canvas.getContext('2d');

            // Configuraci√≥n mejorada de c√°mara para mejor enfoque y campo de visi√≥n m√°s amplio
            const cameraConstraints = {
                video: {
                    facingMode: 'environment',
                    width: { ideal: 1920, min: 720 }, // Aumentar resoluci√≥n para mejor campo
                    height: { ideal: 1080, min: 540 },
                    // Configuraciones para ampliar √°ngulo de visi√≥n
                    focusMode: 'continuous',
                    whiteBalanceMode: 'continuous',
                    exposureMode: 'continuous',
                    // Configuraciones avanzadas para √°ngulo m√°s amplio
                    advanced: [
                        { focusMode: 'continuous' },
                        { focusDistance: { ideal: 0.3, min: 0.1, max: 1.0 } }, // Rango m√°s amplio
                        { zoom: { ideal: 0.8, min: 0.5, max: 2.0 } }, // Zoom out para m√°s campo
                        { fieldOfView: { ideal: 90, min: 60 } }, // Campo de visi√≥n m√°s amplio
                        { torch: false } // Sin flash para mejor visibilidad natural
                    ]
                }
            };

            // Intentar primero con configuraci√≥n avanzada, fallback a b√°sica
            navigator.mediaDevices.getUserMedia(cameraConstraints)
                .then(stream => {
                    console.log('‚úÖ Configuraci√≥n avanzada de c√°mara exitosa');
                    initializeVideoStream(stream, video, context);
                })
                .catch(err => {
                    console.warn('‚ö†Ô∏è Configuraci√≥n avanzada fall√≥, intentando configuraci√≥n intermedia:', err.message);
                    // Fallback 1: Configuraci√≥n intermedia
                    return navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1280, min: 720 },
                            height: { ideal: 960, min: 540 },
                            focusMode: 'continuous'
                        } 
                    });
                })
                .then(stream => {
                    if (stream) {
                        console.log('‚úÖ Configuraci√≥n intermedia de c√°mara exitosa');
                        initializeVideoStream(stream, video, context);
                    }
                })
                .catch(err => {
                    console.warn('‚ö†Ô∏è Configuraci√≥n intermedia fall√≥, intentando configuraci√≥n b√°sica:', err.message);
                    // Fallback 2: Configuraci√≥n b√°sica
                    return navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 854 },
                            height: { ideal: 480 }
                        } 
                    });
                })
                .then(stream => {
                    if (stream) {
                        console.log('‚úÖ Configuraci√≥n b√°sica de c√°mara exitosa');
                        initializeVideoStream(stream, video, context);
                    }
                })
                .catch(err => {
                    console.error('‚ùå Error final accediendo a la c√°mara:', err);
                    showCustomNotification('Error al acceder a la c√°mara: ' + err.message, 'error');
                    cerrarEscanerQR();
                });

            function initializeVideoStream(stream, video, context) {
                try {
                    // LIMPIAR STREAM ANTERIOR ANTES DE ASIGNAR NUEVO
                    if (window.currentMediaStream && window.currentMediaStream !== stream) {
                        console.log("üîÑ Limpiando stream anterior antes de inicializar nuevo...");
                        window.currentMediaStream.getTracks().forEach(track => {
                            if (track.readyState === 'live') {
                                track.stop();
                            }
                        });
                    }
                    
                    // Asignar nuevo stream
                    window.currentMediaStream = stream;
                    video.srcObject = stream;
                    
                    // Configurar eventos de video
                    video.addEventListener('loadedmetadata', () => {
                        console.log(`üìπ Video inicializado: ${video.videoWidth}x${video.videoHeight}`);
                        console.log(`üìπ Stream tracks: ${stream.getTracks().length}`);
                        stream.getTracks().forEach(track => {
                            console.log(`üìπ Track: ${track.kind}, Estado: ${track.readyState}, ID: ${track.id}`);
                        });
                    }, { once: true });
                    
                    // Manejar errores del stream
                    stream.getTracks().forEach(track => {
                        track.addEventListener('ended', () => {
                            console.warn(`‚ö†Ô∏è Track ${track.kind} terminado inesperadamente`);
                            // Reintentar si es necesario
                            if (isScannerActive) {
                                console.log("üîÑ Reintentando reconexi√≥n de c√°mara...");
                                setTimeout(() => {
                                    if (isScannerActive) {
                                        cerrarEscanerQR();
                                        setTimeout(() => iniciarEscanerQR(), 1000);
                                    }
                                }, 500);
                            }
                        });
                        
                        track.addEventListener('mute', () => {
                            console.warn(`‚ö†Ô∏è Track ${track.kind} silenciado`);
                        });
                    });
                    
                    // Iniciar reproducci√≥n
                    const playPromise = video.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            console.log("‚úÖ Video reproduciendo correctamente");
                            if (!video.dataset.scanLoopActive) {
                                video.dataset.scanLoopActive = 'true';
                                jsQRtick();
                            }
                        }).catch(error => {
                            console.error("‚ùå Error al reproducir video:", error);
                            showCustomNotification('Error al iniciar c√°mara: ' + error.message, 'error');
                        });
                    } else {
                        // Fallback para navegadores m√°s antiguos
                        if (!video.dataset.scanLoopActive) {
                            video.dataset.scanLoopActive = 'true';
                            jsQRtick();
                        }
                    }
                    
                } catch (error) {
                    console.error("‚ùå Error en initializeVideoStream:", error);
                    showCustomNotification('Error inicializando c√°mara: ' + error.message, 'error');
                    cerrarEscanerQR();
                }
            }

            function jsQRtick() {
                if (!isScannerActive || video.dataset.scanLoopActive !== 'true') return;
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    try {
                        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                        const code = jsQR(imageData.data, imageData.width, imageData.height);

                        if (code) {
                            onQRCodeSuccess(code.data);
                            return;
                        }
                    } catch (e) {
                        console.warn('Error al procesar imagen para QR:', e);
                    }
                }
                requestAnimationFrame(jsQRtick);
            }
        }

/**
 * FUNCI√ìN PRINCIPAL: onQRCodeSuccess - Maneja el QR escaneado correctamente
 * Versi√≥n corregida para QR paname√±o con formato pipe
 */
function onQRCodeSuccess(decodedText) {
    console.log("üîç QR detectado - Iniciando procesamiento:", decodedText);
    
    // PASO 1: Prevenir m√∫ltiples lecturas simult√°neas
    if (window.qrProcessing) {
        console.log("‚ö†Ô∏è QR ya en procesamiento, ignorando lectura duplicada");
        return;
    }
    
    // PASO 2: Marcar como procesando INMEDIATAMENTE
    window.qrProcessing = true;
    
    try {
        // PASO 3: Reproducir sonido de escaneo exitoso
        if (typeof reproducirSonido === 'function') {
            reproducirSonido('scanSound');
        }
        
        // PASO 4: Extraer c√©dula del formato paname√±o con pipes
        let cedulaExtraida = null;
        
        // Formato espec√≠fico de Panam√°: datos separados por pipes |
        if (decodedText.includes('|')) {
            const partes = decodedText.split('|');
            // La c√©dula est√° en la primera posici√≥n
            if (partes[0]) {
                cedulaExtraida = partes[0].trim();
                console.log("‚úÖ C√©dula extra√≠da del formato pipe:", cedulaExtraida);
            }
        }
        
        // Si no se pudo extraer con pipes, intentar otros m√©todos
        if (!cedulaExtraida) {
            // Buscar patrones de c√©dula paname√±a directamente
            const patronesCedula = [
                /\b(\d{1,2}-\d{1,4}-\d{1,6})\b/,  // Formato N-NNN-NNNNNN
                /\b([A-Z]{1,2}-\d{1,4}-\d{1,6})\b/, // Formato con letras
                /^(\d{1,2}-\d{1,4}-\d{1,6})/,      // Al inicio del string
                /^([A-Z]{1,2}-\d{1,4}-\d{1,6})/    // Al inicio con letras
            ];
            
            for (const patron of patronesCedula) {
                const match = decodedText.match(patron);
                if (match) {
                    cedulaExtraida = match[1];
                    console.log("‚úÖ C√©dula encontrada con patr√≥n:", cedulaExtraida);
                    break;
                }
            }
        }
        
        if (!cedulaExtraida) {
            console.warn("‚ùå No se pudo extraer c√©dula del QR");
            showToast('QR No V√°lido', 'No se pudo leer la c√©dula del documento', 'warning');
            
            // CR√çTICO: Desbloquear el procesamiento para permitir nuevos escaneos
            setTimeout(() => {
                window.qrProcessing = false;
                console.log("üîì Sistema QR desbloqueado para nuevos escaneos");
            }, 2000);
            return;
        }
        
        // PASO 5: Colocar c√©dula en el campo de entrada
        const cedulaInput = document.getElementById('cedula');
        if (cedulaInput) {
            cedulaInput.value = cedulaExtraida;
            console.log("‚úÖ C√©dula colocada en campo:", cedulaExtraida);
            
            // Disparar evento de input para activar funcionalidades del sistema
            const inputEvent = new Event('input', { bubbles: true });
            cedulaInput.dispatchEvent(inputEvent);
        } else {
            console.error("‚ùå Campo de c√©dula no encontrado en el DOM");
        }
        
        // PASO 6: Mostrar bot√≥n de limpiar si existe
        const limpiarBtn = document.getElementById('limpiarCedula');
        if (limpiarBtn) {
            limpiarBtn.style.display = 'block';
        }
        
        // PASO 7: Buscar informaci√≥n de la persona
        let personaEncontrada = null;
        let nombrePersona = "Persona no encontrada";
        let empresaPersona = "Verificar base de datos";
        
        if (typeof personalGlobal !== 'undefined' && personalGlobal.length > 0) {
            personaEncontrada = personalGlobal.find(p =>
                p && p.cedula && p.cedula.toLowerCase() === cedulaExtraida.toLowerCase()
            );
            
            if (personaEncontrada) {
                nombrePersona = personaEncontrada.nombre || nombrePersona;
                empresaPersona = personaEncontrada.empresa || empresaPersona;
            }
        }
        
        // Si el QR tiene el formato completo, extraer el nombre tambi√©n
        if (decodedText.includes('|')) {
            const partes = decodedText.split('|');
            if (partes[1] && partes[2] && !personaEncontrada) {
                // Combinar nombre y apellido
                nombrePersona = `${partes[1].trim()} ${partes[2].trim()}`;
                console.log("üìã Nombre extra√≠do del QR:", nombrePersona);
            }
        }
        
        // PASO 8: Mostrar notificaci√≥n de √©xito
        showToast('QR Le√≠do', `‚úÖ ${cedulaExtraida} - ${nombrePersona}`, 'success');
        
        // Mostrar informaci√≥n de usuario si existe la funci√≥n
        if (personaEncontrada && typeof mostrarDisplayDatosUsuario === 'function') {
            mostrarDisplayDatosUsuario(personaEncontrada);
        }
        
        // PASO 9: Cerrar el esc√°ner DESPU√âS de procesar completamente
        setTimeout(() => {
            if (typeof cerrarEscanerQR === 'function') {
                cerrarEscanerQR();
            }
            
            // Enfocar el campo de c√©dula
            if (cedulaInput) {
                cedulaInput.focus();
            }
        }, 1500);
        
        // PASO 10: Registrar estad√≠sticas de √©xito
        if (typeof google !== 'undefined' && google.script && google.script.run) {
            google.script.run
                .withFailureHandler(error => console.warn('Error registrando estad√≠sticas QR:', error))
                .registrarEscaneoQR('HTML5-QRCode', true, Date.now() - (window.scanStartTime || Date.now()), 'Cedula_Panama', cedulaExtraida);
        }
        
    } catch (error) {
        console.error("‚ùå Error cr√≠tico procesando QR:", error);
        showToast('Error QR', 'Error interno procesando el c√≥digo QR', 'error');
    } finally {
        // PASO 11: CR√çTICO - Siempre desbloquear despu√©s de un tiempo
        setTimeout(() => {
            window.qrProcessing = false;
            console.log("üîì Procesamiento QR finalizado y desbloqueado");
        }, 3000);
    }
}

/**
 * FUNCI√ìN DE RESETEO COMPLETO DEL ESTADO QR
 * Soluciona el problema de bloqueo del sistema
 */
function resetearEstadoQRCompleto() {
    try {
        console.log("üîÑ Reseteando estado QR completamente...");
        
        // Resetear todas las variables globales de QR
        window.scannerActive = false;
        window.qrProcessing = false;
        window.scanStartTime = null;
        
        if (typeof isScannerActive !== 'undefined') {
            isScannerActive = false;
        }
        
        // Limpiar timeouts del QR
        if (window.qrScannerTimeout) {
            clearTimeout(window.qrScannerTimeout);
            window.qrScannerTimeout = null;
        }
        
        // Detener todos los MediaStreams activos
        if (typeof detenerTodosLosStreams === 'function') {
            detenerTodosLosStreams();
        }
        
        // Limpiar el esc√°ner HTML5-QRCode si existe
        if (typeof html5QrCodeScanner !== 'undefined' && html5QrCodeScanner) {
            try {
                html5QrCodeScanner.clear().then(() => {
                    console.log("‚úÖ HTML5-QRCode limpiado correctamente");
                }).catch(error => {
                    console.warn("‚ö†Ô∏è Error limpiando HTML5-QRCode:", error);
                });
            } catch (e) {
                console.warn("‚ö†Ô∏è Error en clear() de HTML5-QRCode:", e);
            }
            html5QrCodeScanner = null;
        }
        
        // Limpiar elementos DOM del QR
        const qrReaderDiv = document.getElementById('qr-reader');
        if (qrReaderDiv) {
            qrReaderDiv.innerHTML = '';
        }
        
        console.log("‚úÖ Estado QR reseteado completamente - Sistema listo para nuevo escaneo");
        
    } catch (error) {
        console.error("‚ùå Error reseteando estado QR:", error);
    }
}

/**
 * FUNCI√ìN MEJORADA: Funci√≥n para limpiar campo de c√©dula que incluye reset QR
 */
function limpiarCampoCedulaConResetQR() {
    // Ejecutar la limpieza normal del campo
    if (typeof limpiarCampoCedula === 'function') {
        limpiarCampoCedula();
    }
    
    // IMPORTANTE: Resetear completamente el estado QR
    resetearEstadoQRCompleto();
    
    console.log("üßπ Campo de c√©dula limpiado con reset QR completo");
}

        function onQRCodeError(error) {
            if (error && error.message && error.message.includes("No MultiFormat Readers were able to detect the code.")) {
                // Ignorar errores comunes
            } else {
                console.warn('Error de escaneo QR:', error);
            }
        }

/**
 * Inicia el esc√°ner QR de html5-qrcode con una configuraci√≥n de alta resoluci√≥n
 * para un campo de visi√≥n amplio y una imagen m√°s n√≠tida.
 */
function iniciarNuevoEscaner() {
    try {
        // Configuraciones para un escaneo robusto y de √°ngulo amplio
        const qrConfig = {
            fps: 15, // Un buen balance entre rendimiento y fluidez
            qrbox: { width: 350, height: 350 }, // Un √°rea de escaneo mucho m√°s grande y c√≥moda
            rememberLastUsedCamera: true,
            aspectRatio: 1.7777778, // Proporci√≥n 16:9, com√∫n en c√°maras de celular
            videoConstraints: {
                facingMode: 'environment',    // Priorizar c√°mara trasera
                focusMode: 'continuous',      // Activar auto-enfoque continuo
                width: { ideal: 1280 },       // Solicitar resoluci√≥n HD
                height: { ideal: 720 }
            },
            formatsToSupport: [Html5QrcodeSupportedFormats.QR_CODE]
        };

        console.log("üì∏ Iniciando HTML5-QRCode con configuraci√≥n mejorada:", qrConfig);

        html5QrCodeScanner = new Html5QrcodeScanner("qr-reader", qrConfig, false);
        html5QrCodeScanner.render(
            (decodedText) => onQRCodeSuccess(decodedText),
            (error) => onQRCodeError(error)
        );

    } catch (error) {
        console.error("Error al iniciar el nuevo esc√°ner QR:", error);
        showToast('Error de esc√°ner', 'No se pudo iniciar el esc√°ner. Verifique los permisos de la c√°mara.', 'error');
        cerrarEscanerQR();
    }
}

        // =====================================================
        // FUNCIONES DE MEJORA DEL ESC√ÅNER QR
        // =====================================================

        /**
         * Ajusta el tama√±o del √°rea de escaneo QR
         * @param {number} nuevoTama√±o - Nuevo tama√±o del √°rea de escaneo (m√≠n: 200, m√°x: 500)
         */
        function ajustarTama√±oEscaneo(nuevoTama√±o) {
            // Validar rango
            nuevoTama√±o = Math.max(200, Math.min(500, nuevoTama√±o));
            
            // Guardar en localStorage
            localStorage.setItem('surpass-qrBoxSize', nuevoTama√±o.toString());
            
            console.log(`üìè Tama√±o de √°rea de escaneo ajustado a: ${nuevoTama√±o}x${nuevoTama√±o}`);
            
            // Mostrar notificaci√≥n
            showCustomNotification(`üìè √Årea de escaneo ajustada: ${nuevoTama√±o}x${nuevoTama√±o}px`, 'info');
            
            // Si hay un esc√°ner activo, reiniciarlo con el nuevo tama√±o
            if (isScannerActive && !useJsQR) {
                cerrarEscanerQR();
                setTimeout(() => {
                    abrirEscanerQR();
                }, 500);
            }
        }

        /**
         * Funci√≥n para reiniciar completamente la c√°mara cuando hay problemas
         */
        function reiniciarCamara() {
            console.log("üîÑ REINICIANDO C√ÅMARA COMPLETAMENTE...");
            
            return new Promise((resolve) => {
                // Paso 1: Cerrar todo
                cerrarEscanerQR();
                
                // Paso 2: Esperar liberaci√≥n completa
                setTimeout(() => {
                    console.log("‚è≥ Esperando liberaci√≥n completa de recursos...");
                    
                    // Paso 3: Limpiar agresivamente
                    detenerTodosLosStreams();
                    
                    // Paso 4: Esperar m√°s tiempo para asegurar liberaci√≥n
                    setTimeout(() => {
                        console.log("‚úÖ C√°mara lista para reinicio");
                        resolve();
                    }, 1000);
                }, 500);
            });
        }

        /**
         * Detecta y reporta la calidad de la c√°mara y √°ngulo de visi√≥n
         */
        async function diagnosticarCalidadCamara() {
            try {
                // Probar configuraci√≥n avanzada primero
                const streamAvanzado = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                }).catch(() => null);

                const stream = streamAvanzado || await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                
                const video = document.createElement('video');
                video.srcObject = stream;
                video.play();
                
                video.addEventListener('loadedmetadata', () => {
                    const resolution = `${video.videoWidth}x${video.videoHeight}`;
                    const aspectRatio = (video.videoWidth / video.videoHeight).toFixed(2);
                    
                    console.log(`üìπ Diagn√≥stico de c√°mara y √°ngulo:`);
                    console.log(`   Resoluci√≥n: ${resolution}`);
                    console.log(`   Aspect Ratio: ${aspectRatio}`);
                    
                    let diagnostico = `üìπ Diagn√≥stico de C√°mara y √Ångulo:\n\n`;
                    diagnostico += `Resoluci√≥n: ${resolution}\n`;
                    diagnostico += `Proporci√≥n: ${aspectRatio}:1\n\n`;
                    
                    // Evaluaci√≥n de √°ngulo de visi√≥n basada en resoluci√≥n
                    if (video.videoWidth >= 1920) {
                        diagnostico += `‚úÖ Excelente resoluci√≥n - √Ångulo muy amplio\n`;
                        diagnostico += `üìê Campo de visi√≥n: Muy amplio (~85-90¬∞)\n`;
                        diagnostico += `üéØ Ideal para QR a 20-35cm de distancia`;
                    } else if (video.videoWidth >= 1280) {
                        diagnostico += `‚úÖ Buena resoluci√≥n - √Ångulo amplio\n`;
                        diagnostico += `üìê Campo de visi√≥n: Amplio (~70-85¬∞)\n`;
                        diagnostico += `üéØ Ideal para QR a 15-30cm de distancia`;
                    } else if (video.videoWidth >= 854) {
                        diagnostico += `‚ö†Ô∏è Resoluci√≥n media - √Ångulo moderado\n`;
                        diagnostico += `üìê Campo de visi√≥n: Moderado (~60-70¬∞)\n`;
                        diagnostico += `üéØ QR a 10-25cm de distancia`;
                    } else {
                        diagnostico += `‚ö†Ô∏è Resoluci√≥n b√°sica - √Ångulo limitado\n`;
                        diagnostico += `üìê Campo de visi√≥n: Estrecho (~45-60¬∞)\n`;
                        diagnostico += `üéØ QR a 8-20cm de distancia`;
                    }
                    
                    showCustomNotification(diagnostico, 'info', 6000);
                    
                    // Limpiar recursos
                    stream.getTracks().forEach(track => track.stop());
                });
                
            } catch (error) {
                console.error('‚ùå Error en diagn√≥stico de c√°mara:', error);
                showCustomNotification('‚ùå No se pudo acceder a la c√°mara para diagn√≥stico', 'error');
            }
        }

        // =====================================================
        // PARTE 9: ESTAD√çSTICAS
        // =====================================================

        function togglePanelEstadisticas() {
            // Cambio inmediato para mejor UX
            mostrarEstadisticas = !mostrarEstadisticas;
            actualizarVisibilidadEstadisticas();
            
            // Mostrar mensaje inmediato
            showCustomNotification(
                mostrarEstadisticas ? 'Estad√≠sticas activadas' : 'Estad√≠sticas desactivadas', 
                'info'
            );
            
            if (DOM.menuDropdown) DOM.menuDropdown.classList.remove('show');
            
            // Sincronizar con servidor en segundo plano
            google.script.run
                .withSuccessHandler(function(result) {
                    if (!result || result.success !== true) {
                        // Revertir cambio si falla
                        mostrarEstadisticas = !mostrarEstadisticas;
                        actualizarVisibilidadEstadisticas();
                        const parsed = (typeof parseBackendError === 'function') ? parseBackendError(result, 'Error al sincronizar estad√≠sticas') : { message: 'Error al sincronizar estad√≠sticas' };
                        showCustomNotification(`${parsed.message}${parsed.code ? ' [' + parsed.code + ']' : ''}`, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    // Revertir cambio si falla
                    mostrarEstadisticas = !mostrarEstadisticas;
                    actualizarVisibilidadEstadisticas();
                    const parsed = (typeof parseBackendError === 'function') ? parseBackendError(error, 'Error de conexi√≥n al cambiar estad√≠sticas') : { message: 'Error de conexi√≥n al cambiar estad√≠sticas' };
                    showCustomNotification(`${parsed.message}${parsed.code ? ' [' + parsed.code + ']' : ''}`, 'warning');
                })
                .toggleEstadisticas(mostrarEstadisticas);
        }

        function actualizarVisibilidadEstadisticas() {
            if (DOM.statsPanelDiv) {
                DOM.statsPanelDiv.style.display = mostrarEstadisticas ? 'block' : 'none';
            }
            const toggleStats = document.getElementById('toggleStats');
            if (toggleStats) {
                if (mostrarEstadisticas) {
                    toggleStats.classList.add('active');
                } else {
                    toggleStats.classList.remove('active');
                }
            }
        }

        function actualizarEstadoEscaner() {
            const toggleScanner = document.getElementById('toggleScanner');
            const scannerModeIndicator = document.getElementById('scannerModeIndicator');
            const qrButton = document.getElementById('qrButton');
            
            if (toggleScanner) {
                if (useJsQR) {
                    toggleScanner.classList.add('active');
                } else {
                    toggleScanner.classList.remove('active');
                }
            }

            // Actualizar indicador de modo autom√°tico
            const autoScanner = localStorage.getItem('surpass-autoScanner');
            let esAutoMode = false;
            
            if (autoScanner) {
                try {
                    const config = JSON.parse(autoScanner);
                    const tiempoTranscurrido = Date.now() - config.timestamp;
                    const unaHora = 60 * 60 * 1000;
                    
                    if (tiempoTranscurrido < unaHora) {
                        esAutoMode = true;
                        if (scannerModeIndicator) {
                            scannerModeIndicator.textContent = '(Auto)';
                            scannerModeIndicator.title = `Selecci√≥n autom√°tica: ${config.razon}`;
                        }
                    } else {
                        // Limpiar configuraci√≥n expirada
                        localStorage.removeItem('surpass-autoScanner');
                    }
                } catch (e) {
                    localStorage.removeItem('surpass-autoScanner');
                }
            }
            
            if (!esAutoMode && scannerModeIndicator) {
                scannerModeIndicator.textContent = '';
                scannerModeIndicator.title = '';
            }

            // Actualizar bot√≥n QR con indicador visual
            if (qrButton) {
                if (esAutoMode) {
                    qrButton.classList.add('auto-mode');
                    qrButton.title = 'Escanear QR - Modo autom√°tico activo';
                } else {
                    qrButton.classList.remove('auto-mode');
                    qrButton.title = 'Escanear QR - Auto-detecta mejor esc√°ner';
                }
            }
        }

        function updateStatsPanel() {
            if (!mostrarEstadisticas) {
                console.log('üìä Panel de estad√≠sticas deshabilitado, saltando actualizaci√≥n...');
                return;
            }

            console.log('üìä Iniciando actualizaci√≥n de estad√≠sticas...');

            // Verificar disponibilidad de google.script.run
            if (typeof google === 'undefined' || !google.script || !google.script.run) {
                console.error('‚ùå Google Apps Script no est√° disponible');
                setTimeout(() => updateStatsPanel(), 5000);
                return;
            }

            try {
                google.script.run
                    .withSuccessHandler(function(stats) {
                        console.log('üìä Respuesta del servidor recibida:', stats);
                        
                        if (!stats || typeof stats !== 'object') {
                            console.error('‚ùå Datos de estad√≠sticas inv√°lidos:', stats);
                            // Mostrar estad√≠sticas en cero para evitar interfaz rota
                            mostrarEstadisticasPorDefecto();
                            return;
                        }

                        console.log('‚úÖ Estad√≠sticas v√°lidas recibidas:', stats);

                        // Actualizar elementos del DOM con validaci√≥n
                        try {
                            if (DOM.entradasLiveSpan) {
                                DOM.entradasLiveSpan.textContent = stats.entradas || 0;
                            }
                            if (DOM.salidasLiveSpan) {
                                DOM.salidasLiveSpan.textContent = stats.salidas || 0;
                            }
                            if (DOM.personasDentroLiveSpan) {
                                DOM.personasDentroLiveSpan.textContent = stats.personasDentro || 0;
                            }

                            // Manejar salidas sin entrada
                            if (DOM.salidasSinEntradaLiveSpan) {
                                DOM.salidasSinEntradaLiveSpan.textContent = stats.salidasSinEntrada || 0;
                                if (DOM.salidasSinEntradaLiveContainer) {
                                    DOM.salidasSinEntradaLiveContainer.style.display = (stats.salidasSinEntrada > 0) ? 'block' : 'none';
                                    if (stats.salidasSinEntrada > 0) {
                                        DOM.salidasSinEntradaLiveContainer.setAttribute('title', `Se han registrado ${stats.salidasSinEntrada} salida(s) sin entrada correspondiente. Esto no afecta el conteo de personas dentro.`);
                                    } else {
                                        DOM.salidasSinEntradaLiveContainer.removeAttribute('title');
                                    }
                                }
                            }

                            // Actualizar gr√°fico si est√° disponible
                            if (typeof google !== 'undefined' && google.charts && typeof drawMiniChart === 'function') {
                                try {
                                    drawMiniChart(stats.entradas || 0, stats.salidas || 0);
                                } catch (chartError) {
                                    console.warn('‚ö†Ô∏è Error actualizando gr√°fico:', chartError);
                                }
                            }

                            // Actualizar historial en vivo
                            if (stats.recentRecords && typeof updateLiveHistoryFromStats === 'function') {
                                try {
                                    updateLiveHistoryFromStats(stats.recentRecords);
                                } catch (historyError) {
                                    console.warn('‚ö†Ô∏è Error actualizando historial:', historyError);
                                }
                            }

                            // Guardar estad√≠sticas actuales
                            ultimasEstadisticas = {
                                entradas: stats.entradas || 0,
                                salidas: stats.salidas || 0,
                                salidasValidas: stats.salidasValidas || 0,
                                personasDentro: stats.personasDentro || 0,
                                salidasSinEntrada: stats.salidasSinEntrada || 0
                            };

                            console.log('‚úÖ Interfaz de estad√≠sticas actualizada correctamente');
                            
                        } catch (domError) {
                            console.error('‚ùå Error actualizando DOM:', domError);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('‚ùå Error al obtener estad√≠sticas del servidor:', error);
                        console.error('Tipo de error:', typeof error, error);
                        
                        // Mostrar estad√≠sticas por defecto para mantener la interfaz funcional
                        mostrarEstadisticasPorDefecto();
                        
                        // Reintentar despu√©s de un tiempo
                        setTimeout(() => {
                            console.log('üîÑ Reintentando obtener estad√≠sticas...');
                            updateStatsPanel();
                        }, 15000); // Aumentar tiempo de reintento
                    })
                    .obtenerEstadisticas();
                    
            } catch (callError) {
                console.error('‚ùå Error cr√≠tico llamando obtenerEstadisticas:', callError);
                mostrarEstadisticasPorDefecto();
                
                setTimeout(() => {
                    console.log('üîÑ Reintentando despu√©s de error cr√≠tico...');
                    updateStatsPanel();
                }, 20000);
            }
        }

        // Funci√≥n auxiliar para mostrar estad√≠sticas por defecto
                function mostrarEstadisticasPorDefecto() {
            console.log('üìä Mostrando estad√≠sticas por defecto debido a error...');
            
            try {
                if (DOM.entradasLiveSpan) DOM.entradasLiveSpan.textContent = '0';
                if (DOM.salidasLiveSpan) DOM.salidasLiveSpan.textContent = '0';
                if (DOM.personasDentroLiveSpan) DOM.personasDentroLiveSpan.textContent = '0';
                if (DOM.salidasSinEntradaLiveSpan) DOM.salidasSinEntradaLiveSpan.textContent = '0';
                if (DOM.salidasSinEntradaLiveContainer) {
                    DOM.salidasSinEntradaLiveContainer.style.display = 'none';
                }
                
                console.log('‚úÖ Estad√≠sticas por defecto aplicadas');
            } catch (defaultError) {
                console.error('‚ùå Error aplicando estad√≠sticas por defecto:', defaultError);
            }
        }

        function initializeStatsSystem() {
            try {
                if (window.statsInitialized) {
                    console.log('üîÑ Sistema de estad√≠sticas ya inicializado, limpiando intervalo anterior...');
                    if (updateStatsInterval) {
                        clearInterval(updateStatsInterval);
                        updateStatsInterval = null;
                    }
                }

                console.log('üöÄ Inicializando sistema de estad√≠sticas robusto...');

                // Verificar elementos DOM requeridos
                const elementosRequeridos = [
                    DOM.entradasLiveSpan, 
                    DOM.salidasLiveSpan, 
                    DOM.personasDentroLiveSpan,
                    DOM.statsPanelDiv
                ];

                const elementosFaltantes = elementosRequeridos.filter(el => !el);

                if (elementosFaltantes.length > 0) {
                    console.error('‚ùå Elementos DOM faltantes para estad√≠sticas:', {
                        total: elementosRequeridos.length,
                        faltantes: elementosFaltantes.length,
                        elementos: {
                            entradasLive: !!DOM.entradasLiveSpan,
                            salidasLive: !!DOM.salidasLiveSpan,
                            personasDentro: !!DOM.personasDentroLiveSpan,
                            statsPanel: !!DOM.statsPanelDiv
                        }
                    });
                    
                    // Intentar inicializar de nuevo despu√©s de un tiempo
                    setTimeout(() => {
                        console.log('üîÑ Reintentando inicializaci√≥n de estad√≠sticas...');
                        initializeStatsSystem();
                    }, 5000);
                    return;
                } else {
                    console.log('‚úÖ Todos los elementos DOM para estad√≠sticas est√°n presentes');
                }

                // Verificar disponibilidad de Google Apps Script
                if (typeof google === 'undefined' || !google.script || !google.script.run) {
                    console.error('‚ùå Google Apps Script no est√° disponible para estad√≠sticas');
                    
                    // Mostrar estad√≠sticas por defecto
                    mostrarEstadisticasPorDefecto();
                    
                    // Reintentar despu√©s
                    setTimeout(() => {
                        console.log('üîÑ Reintentando inicializaci√≥n tras verificar Google Script...');
                        initializeStatsSystem();
                    }, 10000);
                    return;
                }

                // Primera actualizaci√≥n inmediata
                console.log('üìä Ejecutando primera actualizaci√≥n de estad√≠sticas...');
                updateStatsPanel();

                // Configurar actualizaciones peri√≥dicas
                updateStatsInterval = setInterval(() => {
                    try {
                        updateStatsPanel();
                    } catch (intervalError) {
                        console.error('‚ùå Error en actualizaci√≥n peri√≥dica:', intervalError);
                        // Limpiar intervalo si hay errores persistentes
                        clearInterval(updateStatsInterval);
                        updateStatsInterval = null;
                        
                        // Reinicializar despu√©s de un tiempo
                        setTimeout(() => {
                            console.log('üîÑ Reinicializando tras error en intervalo...');
                            initializeStatsSystem();
                        }, 15000);
                    }
                }, 5000); // Aumentado a 5 segundos para reducir carga

                window.statsInitialized = true;
                console.log('‚úÖ Sistema de estad√≠sticas inicializado correctamente (actualizaci√≥n cada 5 segundos)');
                
            } catch (initError) {
                console.error('‚ùå Error cr√≠tico inicializando sistema de estad√≠sticas:', initError);
                window.statsInitialized = false;
                
                // Mostrar estad√≠sticas por defecto
                try {
                    mostrarEstadisticasPorDefecto();
                } catch (defaultError) {
                    console.error('‚ùå Error mostrando estad√≠sticas por defecto:', defaultError);
                }
                
                // Reintentar despu√©s de un tiempo
                setTimeout(() => {
                    console.log('üîÑ Reintentando inicializaci√≥n tras error cr√≠tico...');
                    initializeStatsSystem();
                }, 20000);
            }
        }

        function drawMiniChart(entradas, salidas) {
        console.log('üìä Dibujando gr√°fico con:', { entradas, salidas });
        
        if (!DOM.miniChartDiv) {
            console.warn('‚ö†Ô∏è miniChartDiv no disponible para dibujar gr√°fico.');
            return;
        }
        
        if (typeof google === 'undefined') {
            console.warn('‚ö†Ô∏è Google Charts no disponible.');
            DOM.miniChartDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">Gr√°fico no disponible</div>';
            return;
        }
        
        if (!window._chartsLoaded) {
            console.log('üìä Cargando Google Charts...');
            google.charts.load('current', { 'packages': ['corechart'] });
            google.charts.setOnLoadCallback(function() {
                window._chartsLoaded = true;
                console.log('‚úÖ Google Charts cargado, dibujando gr√°fico...');
                drawMiniChart(entradas, salidas);
            });
            return;
        }
        
        const total = entradas + salidas;
        if (total === 0) {
            DOM.miniChartDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.875rem;">Sin datos hoy</div>';
            return;
        }
        
        const data = google.visualization.arrayToDataTable([
            ['Acci√≥n', 'Cantidad'],
            ['Entradas', entradas],
            ['Salidas', salidas]
        ]);
        
        const options = {
            pieHole: 0.4,
            width: DOM.miniChartDiv.offsetWidth || 200,
            height: 120,
            legend: 'none',
            colors: ['#10b981', '#f59e0b'],
            backgroundColor: 'transparent',
            chartArea: { 
                width: '85%', 
                height: '85%',
                left: '7.5%',
                top: '7.5%'
            },
            pieSliceText: 'value',
            pieSliceTextStyle: {
                color: 'white',
                fontSize: 12,
                bold: true
            },
            tooltip: { 
                trigger: 'selection',
                text: 'both'
            }
        };
        
        try {
            const chart = new google.visualization.PieChart(DOM.miniChartDiv);
            chart.draw(data, options);
            console.log('‚úÖ Gr√°fico dibujado exitosamente');
        } catch (error) {
            console.error('‚ùå Error al dibujar gr√°fico:', error);
            DOM.miniChartDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--danger);">Error al cargar gr√°fico</div>';
        }
    }

        function updateLiveHistoryFromStats(records) {
        try {
            if (!Array.isArray(records)) {
                console.warn('‚ö†Ô∏è updateLiveHistoryFromStats: records no es un array v√°lido');
                records = [];
            }
            
            historyCache = records.slice(0, 10);

            if (!DOM.liveHistoryBody) {
                console.warn('‚ö†Ô∏è liveHistoryBody no encontrado');
                return;
            }

            DOM.liveHistoryBody.innerHTML = '';
            
            if (historyCache.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td colspan="6" style="text-align: center; padding: 20px; color: var(--text-muted);">
                        <i class="fas fa-info-circle"></i> No hay registros recientes
                    </td>
                `;
                DOM.liveHistoryBody.appendChild(tr);
                return;
            }

            historyCache.forEach((record, index) => {
                const tr = document.createElement('tr');
                
                let fecha = '';
                let hora = '';
                
                // Procesamiento de timestamp/fechaHora
                if (record.timestamp || record.fechaHora || record.fecha) {
                    const fechaObj = new Date(record.timestamp || record.fechaHora || record.fecha);
                    if (!isNaN(fechaObj.getTime())) {
                        fecha = fechaObj.toLocaleDateString('es-PA', {
                            day: '2-digit',
                            month: '2-digit',
                            year: '2-digit'
                        });
                        hora = record.hora || fechaObj.toLocaleTimeString('es-PA', {
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false
                        });
                    }
                } else if (record.hora) {
                    hora = record.hora;
                    fecha = new Date().toLocaleDateString('es-PA', {
                        day: '2-digit',
                        month: '2-digit',
                        year: '2-digit'
                    });
                }
                
                // CORRECCI√ìN: Usar duracion de forma coherente
                let duracion = '-';
                try {
                    if (record.duracion && record.duracion !== 'undefined' && record.duracion !== '0:00:00') {
                        duracion = record.duracion;
                    }
                } catch (error) {
                    console.warn('Error procesando duraci√≥n:', error);
                    duracion = '-';
                }
                
                const cedulaPrivada = record.cedula ? 
                    record.cedula.substring(0, Math.min(15, record.cedula.length)): 
                    'N/A';
                
                // Obtener nombre con fallback mejorado
                let nombreMostrar = 'Sin nombre';
                if (record.nombre && typeof record.nombre === 'string' && record.nombre.trim() !== '') {
                    nombreMostrar = record.nombre.trim();
                } else if (record.cedula && personalGlobal && personalGlobal.length > 0) {
                    const personaEncontrada = personalGlobal.find(p => 
                        p && p.cedula && p.cedula === record.cedula
                    );
                    if (personaEncontrada && personaEncontrada.nombre) {
                        nombreMostrar = personaEncontrada.nombre.trim();
                    }
                }
                
                // Determinar el tipo de acci√≥n
                const esEntrada = 
                    record.accion === 'entrada' || 
                    record.tipo === 'entrada' || 
                    record.tipoRegistro === 'entrada';
                    
                const accion = esEntrada ? 'ENTRADA' : 'SALIDA';
                const iconClass = esEntrada ? 'sign-in' : 'sign-out';
                const badgeClass = esEntrada ? 'success' : 'warning';
                
                tr.innerHTML = `
                    <td style="padding: 8px; font-family: monospace;">${cedulaPrivada}</td>
                    <td style="padding: 8px; font-size: 0.85rem; font-weight: 500;">${nombreMostrar}</td>
                    <td style="padding: 8px;">
                        <span class="status-badge ${badgeClass}">
                            <i class="fas fa-${iconClass}-alt"></i>
                            ${accion}
                        </span>
                    </td>
                    <td style="padding: 8px; font-size: 0.8rem; color: var(--text-secondary);">${fecha}</td>
                    <td style="padding: 8px; font-family: monospace; font-weight: 600;">${hora}</td>
                    <td style="padding: 8px; font-size: 0.8rem; color: var(--text-muted);">${duracion}</td>
                `;
                DOM.liveHistoryBody.appendChild(tr);
            });

            // Animar nueva informaci√≥n si el historial est√° oculto
            if (DOM.liveHistoryHeader && DOM.liveHistoryContent && !DOM.liveHistoryContent.classList.contains('show')) {
                DOM.liveHistoryHeader.classList.add('has-new-records');
                setTimeout(() => {
                    if (DOM.liveHistoryHeader) {
                        DOM.liveHistoryHeader.classList.remove('has-new-records');
                    }
                }, 3000);
            }
            
        } catch (error) {
            console.error('‚ùå Error actualizando historial en vivo:', error);
            if (DOM.liveHistoryBody) {
                DOM.liveHistoryBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px; color: var(--danger);">
                            <i class="fas fa-exclamation-triangle"></i> Error cargando historial
                        </td>
                    </tr>
                `;
            }
        }
    }

        function updateLiveHistory(cedula, accion) {
            const now = new Date().toLocaleTimeString();
            historyCache.unshift({ cedula, accion, hora: now });
            if (historyCache.length > 10) historyCache.pop();

            if (!DOM.liveHistoryBody) return;

            DOM.liveHistoryBody.innerHTML = '';
            historyCache.forEach(record => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="padding: 5px;">${record.cedula}</td>
                    <td style="padding: 5px;">${record.accion}</td>
                    <td style="padding: 5px;">${record.hora}</td>
                `;
                DOM.liveHistoryBody.appendChild(tr);
            });

            if (DOM.liveHistoryHeader && DOM.liveHistoryContent && !DOM.liveHistoryContent.classList.contains('show')) {
                DOM.liveHistoryHeader.classList.add('has-new-records');
                setTimeout(() => {
                    DOM.liveHistoryHeader.classList.remove('has-new-records');
                }, 2000);
            }
        }

        function toggleLiveHistory() {
            if (!DOM.liveHistoryContent || !document.querySelector('.liveHistory-toggle')) return;

            const isVisible = DOM.liveHistoryContent.classList.toggle('show');
            document.querySelector('.liveHistory-toggle').classList.toggle('active', isVisible);

            try {
                localStorage.setItem('surpass-showLiveHistory', isVisible ? 'true' : 'false');
            } catch (e) {
                console.error('Error al guardar preferencia de historial en vivo:', e);
            }
        }

        function makeStatsPanelDraggable() {
            const statsPanel = DOM.statsPanelDiv;
            if (!statsPanel) return;

            const header = statsPanel.querySelector('.stats-panel-header');
            const toggleButton = statsPanel.querySelector('.stats-panel-toggle');

            let isDragging = false;
            let initialX;
            let initialY;
            let isMinimized = false;

            if (!statsPanel.style.left) statsPanel.style.left = '20px';
            if (!statsPanel.style.bottom) statsPanel.style.bottom = '20px';

            function startDragging(clientX, clientY) {
                isDragging = true;
                initialX = clientX - parseInt(statsPanel.style.left || 0);
                initialY = clientY - (window.innerHeight - parseInt(statsPanel.style.bottom || 0) - statsPanel.offsetHeight);
                statsPanel.style.transition = 'none';
            }

            function drag(clientX, clientY) {
                if (!isDragging) return;
                let newX = clientX - initialX;
                let newY = window.innerHeight - (clientY - initialY) - statsPanel.offsetHeight;

                const maxX = window.innerWidth - statsPanel.offsetWidth;
                const maxY = window.innerHeight - statsPanel.offsetHeight;

                newX = Math.max(0, Math.min(newX, maxX));
                newY = Math.max(0, Math.min(newY, maxY));

                statsPanel.style.left = newX + 'px';
                statsPanel.style.bottom = newY + 'px';
                statsPanel.style.top = 'auto';
            }

            function stopDragging() {
                isDragging = false;
                statsPanel.style.transition = 'all 0.3s ease';
            }

            if (header) {
                header.addEventListener('mousedown', function(e) {
                    if (e.target === toggleButton) return;
                    startDragging(e.clientX, e.clientY);
                });
            }
            document.addEventListener('mousemove', function(e) {
                if (isDragging) e.preventDefault();
                drag(e.clientX, e.clientY);
            });
            document.addEventListener('mouseup', stopDragging);

            if (header) {
                header.addEventListener('touchstart', function(e) {
                    if (e.target === toggleButton) return;
                    const touch = e.touches[0];
                    startDragging(touch.clientX, touch.clientY);
                    e.preventDefault();
                }, { passive: false });
            }
            document.addEventListener('touchmove', function(e) {
                if (isDragging) {
                    const touch = e.touches[0];
                    drag(touch.clientX, touch.clientY);
                    e.preventDefault();
                }
            }, { passive: false });
            document.addEventListener('touchend', stopDragging);

            if (toggleButton) {
                toggleButton.addEventListener('click', function() {
                    isMinimized = !isMinimized;
                    if (isMinimized) {
                        statsPanel.classList.add('minimized');
                        toggleButton.innerHTML = '<i class="fas fa-plus"></i>';
                        toggleButton.title = 'Maximizar panel';
                        statsPanel.style.width = 'auto';
                    } else {
                        statsPanel.classList.remove('minimized');
                        toggleButton.innerHTML = '<i class="fas fa-minus"></i>';
                        toggleButton.title = 'Minimizar panel';
                        statsPanel.style.width = window.innerWidth <= 768 ? '90%' : '300px';
                    }
                });
            }

            function adjustPanelSize() {
        if (!isMinimized) {
            if (window.innerWidth <= 768) {
                statsPanel.style.width = 'auto';
                statsPanel.style.left = '15px';
                statsPanel.style.right = '15px';
            } else {
                statsPanel.style.width = '300px';
                statsPanel.style.left = '20px';
                statsPanel.style.right = 'auto';
            }
            statsPanel.style.maxHeight = window.innerWidth <= 768 ? '50vh' : '80vh';
        } else {
            // Panel minimizado
            statsPanel.style.width = window.innerWidth <= 480 ? '50px' : '60px';
            statsPanel.style.height = window.innerWidth <= 480 ? '50px' : '60px';
            statsPanel.style.right = 'auto';
        }
        
        // Mantener dentro de los l√≠mites de pantalla
        const maxX = window.innerWidth - statsPanel.offsetWidth;
        const maxY = window.innerHeight - statsPanel.offsetHeight;
        const currentLeft = parseInt(statsPanel.style.left) || 20;
        const currentBottom = parseInt(statsPanel.style.bottom) || 20;
        
        statsPanel.style.left = Math.min(currentLeft, maxX) + 'px';
        statsPanel.style.bottom = Math.min(currentBottom, maxY) + 'px';
    }
            adjustPanelSize();
            window.addEventListener('resize', adjustPanelSize);

            if (DOM.liveHistoryHeader) {
                DOM.liveHistoryHeader.addEventListener('click', toggleLiveHistory);
            }

            if (DOM.liveHistoryContent && document.querySelector('.liveHistory-toggle')) {
                DOM.liveHistoryContent.classList.remove('show');
                document.querySelector('.liveHistory-toggle').classList.remove('active');
                try {
                    const showLiveHistory = localStorage.getItem('surpass-showLiveHistory') === 'true';
                    if (showLiveHistory) {
                        DOM.liveHistoryContent.classList.add('show');
                        document.querySelector('.liveHistory-toggle').classList.add('active');
                    }
                } catch (e) {
                    console.error('Error al cargar preferencias de historial en vivo:', e);
                }
            }

            actualizarVisibilidadEstadisticas();
        }

        // =====================================================
        // PARTE 10: EVACUACI√ìN
        // =====================================================

        function configurarEventListenersModalEvacuacion() {
            console.log('üîß Configurando event listeners del modal de evacuaci√≥n...');
            
            // Limpiar listeners anteriores
            document.removeEventListener('click', handleModalEvacuacionClick);
            document.addEventListener('click', handleModalEvacuacionClick);
            
            console.log('‚úÖ Event listeners configurados correctamente');
        }

        function handleModalEvacuacionClick(event) {
            // Solo procesar clicks dentro del modal de evacuaci√≥n
            if (!event.target.closest('#evacuationModal')) return;
            
            const target = event.target;

            // Selecci√≥n de tipo de evacuaci√≥n
            if (target.closest('#btnSimulacroModerno')) {
                event.preventDefault();
                event.stopPropagation();
                seleccionarTipoEvacuacion('simulacro', target.closest('#btnSimulacroModerno'));
                return;
            }

            if (target.closest('#btnRealModerno')) {
                event.preventDefault();
                event.stopPropagation();
                seleccionarTipoEvacuacion('real', target.closest('#btnRealModerno'));
                return;
            }

            // Controles de selecci√≥n
            if (target.closest('#btnSeleccionarTodosModerno')) {
                event.preventDefault();
                event.stopPropagation();
                seleccionarTodosModerno();
                return;
            }

            if (target.closest('#btnLimpiarSeleccionModerno')) {
                event.preventDefault();
                event.stopPropagation();
                limpiarSeleccionModerno();
                return;
            }

            if (target.closest('#btnConfirmarSalidas')) {
                event.preventDefault();
                event.stopPropagation();
                ejecutarEvacuacion();
                return;
            }

            // Checkboxes de personas
            if (target.matches('.person-card-modern input[type="checkbox"]')) {
                const checkbox = target;
                const cedula = checkbox.dataset.cedula;
                const card = checkbox.closest('.person-card-modern');
                
                console.log(`üìù Checkbox cambiado - C√©dula: ${cedula}, Checked: ${checkbox.checked}`);
                
                if (checkbox.checked) {
                    if (!personasSeleccionadasEvacuacion.includes(cedula)) {
                        personasSeleccionadasEvacuacion.push(cedula);
                    }
                    card.classList.add('selected');
                } else {
                    personasSeleccionadasEvacuacion = personasSeleccionadasEvacuacion.filter(c => c !== cedula);
                    card.classList.remove('selected');
                }
                
                console.log(`üìä Personas seleccionadas: [${personasSeleccionadasEvacuacion.join(', ')}]`);
                
                // Actualizar contador y bot√≥n ejecutar
                actualizarContadorSeleccionEvacuacion();
                
                // CORECCI√ìN: Asegurar que el bot√≥n se actualice correctamente
                setTimeout(() => {
                    actualizarBotonEjecutar();
                }, 10);
                
                return;
            }
        }

        function mostrarEvacuacionChecklist() {
    console.log('üö® Iniciando evacuaci√≥n unificada desde el cliente...');
    
    // Prevenir m√∫ltiples llamadas simult√°neas
    if (window.cargandoEvacuacion) {
        console.log('‚ö†Ô∏è Ya se est√° cargando la evacuaci√≥n, ignorando llamada duplicada');
        return;
    }
    window.cargandoEvacuacion = true;
    
    if (DOM.menuDropdown) DOM.menuDropdown.classList.remove('show');
    if (DOM.menuButton) DOM.menuButton.style.display = 'none';

    resetearModalEvacuacion();

    mostrarLoading('Cargando datos de evacuaci√≥n...');

    google.script.run
        .withSuccessHandler(function(datosEvacuacion) {
            window.cargandoEvacuacion = false; // Release lock
            console.log('‚úÖ Datos de evacuaci√≥n recibidos del servidor:', datosEvacuacion);
            ocultarLoading();

            // IMPROVED: Handle null/undefined/malformed responses
            if (!datosEvacuacion) {
                console.error('‚ùå Respuesta nula del servidor');
                appendLog({
                    timestamp: new Date().toLocaleString(),
                    level: 'ERROR',
                    message: 'Respuesta nula del servidor de evacuaci√≥n',
                    details: { datosRecibidos: datosEvacuacion }
                });
                showCustomNotification('Error: No se recibieron datos del servidor. Verifique la configuraci√≥n de las hojas.', 'error');
                restaurarInterfazEvacuacion();
                return;
            }

            // IMPROVED: Handle cases where success is false but there might be data
            if (datosEvacuacion.success === false) {
                console.warn('‚ö†Ô∏è Servidor report√≥ fallo pero continuando con datos disponibles:', datosEvacuacion);
                
                if (!Array.isArray(datosEvacuacion.personasDentro)) {
                    console.error('‚ùå Datos de personas dentro no v√°lidos');
                    showCustomNotification('Error en formato de datos: ' + (datosEvacuacion.message || 'Datos malformados'), 'error');
                    restaurarInterfazEvacuacion();
                    return;
                }
            }

            // IMPROVED: Validate essential data structure
            if (!datosEvacuacion.personasDentro || !Array.isArray(datosEvacuacion.personasDentro)) {
                console.error('‚ùå Estructura de datos inv√°lida:', datosEvacuacion);
                appendLog({
                    timestamp: new Date().toLocaleString(),
                    level: 'ERROR',
                    message: 'Estructura de datos de evacuaci√≥n inv√°lida',
                    details: { 
                        tipoRecibido: typeof datosEvacuacion,
                        propiedades: Object.keys(datosEvacuacion || {}),
                        datosCompletos: datosEvacuacion
                    }
                });
                showCustomNotification('Error: Estructura de datos inv√°lida. ' + (datosEvacuacion.message || 'Verifique la configuraci√≥n del sistema.'), 'error');
                restaurarInterfazEvacuacion();
                return;
            }

            // IMPROVED: Additional validation for data integrity
            const personasDentroValidas = datosEvacuacion.personasDentro.filter(persona => {
                return persona && 
                       typeof persona === 'object' && 
                       persona.cedula && 
                       typeof persona.cedula === 'string' &&
                       persona.cedula.trim() !== '';
            });

            if (personasDentroValidas.length !== datosEvacuacion.personasDentro.length) {
                console.warn('‚ö†Ô∏è Se encontraron datos de personas inv√°lidos, usando solo datos v√°lidos:', {
                    original: datosEvacuacion.personasDentro.length,
                    validas: personasDentroValidas.length
                });
                datosEvacuacion.personasDentro = personasDentroValidas;
                datosEvacuacion.totalDentro = personasDentroValidas.length;
            }

            // Success path - proceed normally
            evacuationData = datosEvacuacion;
            inicializarSimulacro(datosEvacuacion.personasDentro);
            renderEvacuationListModern(datosEvacuacion.personasDentro);
            if (DOM.totalPersonasDentro) {
                DOM.totalPersonasDentro.textContent = datosEvacuacion.totalDentro || datosEvacuacion.personasDentro.length;
            }
            if (DOM.evacuationModal) DOM.evacuationModal.classList.add('show');
            configurarEventListenersModalEvacuacion();
            console.log('‚úÖ Modal de evacuaci√≥n mostrado.');
            
            // Show debug info if available
            if (datosEvacuacion.debug) {
                console.log('üêõ Debug info:', datosEvacuacion.debug);
            }

            // Show informational message if there were issues but data is available
            if (datosEvacuacion.message && datosEvacuacion.message !== 'Sin datos disponibles') {
                setTimeout(() => {
                    showCustomNotification('Info: ' + datosEvacuacion.message, 'info');
                }, 1000);
            }
        })
        .withFailureHandler(function(error) {
            window.cargandoEvacuacion = false; // Release lock in case of error
            console.error('‚ùå Error al llamar a getEvacuacionDataForClient:', error);
            
            // Enhanced error logging with more details
            const errorDetails = {
                mensaje: error.message || error,
                tipo: typeof error,
                stack: error.stack,
                timestamp: new Date().toISOString(),
                function: 'getEvacuacionDataForClient'
            };
            
            // Register the connection error in system log
            appendLog({
                timestamp: new Date().toLocaleString(),
                level: 'ERROR',
                message: 'Error de conexi√≥n al cargar datos de evacuaci√≥n',
                details: errorDetails
            });
            
            ocultarLoading();
            
            // Enhanced error message with more helpful information
            let errorMessage = 'Error de conexi√≥n al cargar evacuaci√≥n.';
            if (error.message) {
                if (error.message.includes('timeout')) {
                    errorMessage += ' El servidor tard√≥ demasiado en responder.';
                } else if (error.message.includes('permission')) {
                    errorMessage += ' Problema de permisos en Google Sheets.';
                } else if (error.message.includes('not found')) {
                    errorMessage += ' Hoja de datos no encontrada.';
                } else {
                    errorMessage += ' Detalles: ' + error.message;
                }
            }
            errorMessage += ' Verifique la configuraci√≥n del sistema y intente nuevamente.';
            
            showCustomNotification(errorMessage, 'error');
            restaurarInterfazEvacuacion();
            
            // Offer retry option for connection errors
            if (error.message && (error.message.includes('timeout') || error.message.includes('connection'))) {
                setTimeout(() => {
                    showCustomNotification('¬øDesea reintentar cargar los datos de evacuaci√≥n?', 'warning', true, function(retry) {
                        if (retry) {
                            mostrarEvacuacionChecklist();
                        }
                    });
                }, 2000);
            }
        })
        .getEvacuacionDataForClient();
}

        function resetearModalEvacuacion() {
            console.log('üîÑ Reseteando modal de evacuaci√≥n...');

            tipoEvacuacionSeleccionado = null;
            personasSeleccionadasEvacuacion = [];

            document.querySelectorAll('.type-card-modern').forEach(btn => {
                btn.classList.remove('selected');
                btn.style.removeProperty('border-color');
                btn.style.removeProperty('background');
                btn.style.removeProperty('transform');
                btn.style.removeProperty('box-shadow');
            });

            if (DOM.infoTipoSeleccionadoModerno) {
                DOM.infoTipoSeleccionadoModerno.style.display = 'none';
                DOM.infoTipoSeleccionadoModerno.innerHTML = '';
            }
            if (DOM.selectionCountModerno) DOM.selectionCountModerno.textContent = '0';
            
            // Usar la funci√≥n centralizada para actualizar el bot√≥n
            actualizarBotonEjecutar();
            
            if (DOM.personalGridModerno) DOM.personalGridModerno.innerHTML = '';
            
            // Ocultar bot√≥n de volver
            if (DOM.btnVolverEvacuacion) {
                DOM.btnVolverEvacuacion.style.display = 'none';
            }

            console.log('‚úÖ Modal de evacuaci√≥n reseteado completamente.');
        }

        function renderEvacuationListModern(personas) {
    if (!DOM.personalGridModerno) {
        console.error('‚ùå personalGridModerno no encontrado');
        return;
    }

    console.log('üóÇÔ∏è Renderizando lista de evacuaci√≥n con:', personas);
    
    DOM.personalGridModerno.innerHTML = '';
    personasSeleccionadasEvacuacion = [];

    if (!personas || personas.length === 0) {
        DOM.personalGridModerno.innerHTML = `
            <div style="text-align: center; padding: 60px; color: #10b981; grid-column: 1 / -1;">
                <div style="font-size: 4rem; margin-bottom: 20px;">‚úÖ</div>
                <h3 style="color: #10b981; margin-bottom: 8px;">¬°Edificio Completamente Evacuado!</h3>
                <p style="color: #6b7280;">No hay personal registrado dentro del edificio</p>
            </div>
        `;
        return;
    }

    personas.forEach((persona, index) => {
        try {
            const cedula = String(persona.cedula || 'N/A').trim();
            const nombre = String(persona.nombre || 'Sin nombre').trim();
            const empresa = String(persona.empresa || 'Sin empresa').trim();
            const horaEntrada = persona.horaEntrada || 'N/A';
            
            console.log(`üë§ Creando tarjeta ${index + 1}: ${nombre} (${cedula})`);

            // Crear contenedor principal
            const personCard = document.createElement('div');
            personCard.className = 'person-card-modern';
            personCard.dataset.cedula = cedula;
            
            // Estilos forzados para garantizar visualizaci√≥n
            personCard.style.cssText = `
                border: 2px solid #e2e8f0 !important;
                border-radius: 12px !important;
                padding: 20px !important;
                margin-bottom: 16px !important;
                cursor: pointer !important;
                transition: all 0.3s ease !important;
                display: flex !important;
                align-items: flex-start !important;
                gap: 16px !important;
                background: #ffffff !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
                width: 100% !important;
                box-sizing: border-box !important;
                position: relative !important;
            `;
            
            // Crear checkbox con ID √∫nico
            const checkboxId = `evac-checkbox-${index}`;
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = checkboxId;
            checkbox.dataset.cedula = cedula;
            checkbox.dataset.nombre = nombre;
            checkbox.dataset.empresa = empresa;
            checkbox.style.cssText = `
                width: 20px !important;
                height: 20px !important;
                margin: 4px 0 0 0 !important;
                cursor: pointer !important;
                flex-shrink: 0 !important;
                transform: scale(1.2) !important;
            `;
            
            // Crear contenedor de informaci√≥n
            const infoContainer = document.createElement('div');
            infoContainer.style.cssText = `
                flex: 1 !important;
                min-width: 0 !important;
                overflow: hidden !important;
            `;
            
            // HTML interno del contenedor
            infoContainer.innerHTML = `
                <div style="font-size: 18px; font-weight: 700; color: #1e293b; margin-bottom: 12px; line-height: 1.4;">${nombre}</div>
                <div style="font-size: 14px; color: #64748b; margin-bottom: 6px; display: flex; align-items: center;">
                    <i class="fas fa-id-card" style="margin-right: 8px; color: #3b82f6; width: 16px;"></i>
                    <span>${cedula}</span>
                </div>
                <div style="font-size: 14px; color: #64748b; margin-bottom: 6px; display: flex; align-items: center;">
                    <i class="fas fa-building" style="margin-right: 8px; color: #10b981; width: 16px;"></i>
                    <span>${empresa}</span>
                </div>
                <div style="font-size: 13px; color: #64748b; margin-bottom: 8px; display: flex; align-items: center;">
                    <i class="fas fa-clock" style="margin-right: 8px; color: #f59e0b; width: 16px;"></i>
                    <span>Entrada: ${horaEntrada}</span>
                </div>
                <div style="font-size: 12px; color: #10b981; font-weight: 600; display: flex; align-items: center;">
                    <i class="fas fa-circle" style="font-size: 8px; margin-right: 8px; color: #10b981; animation: pulse 2s infinite;"></i>
                    <span>Dentro del edificio</span>
                </div>
            `;
            
            // Ensamblar tarjeta
            personCard.appendChild(checkbox);
            personCard.appendChild(infoContainer);
            
            // Event listener para click en tarjeta (activa checkbox)
            personCard.addEventListener('click', function(e) {
                if (e.target !== checkbox) {
                    checkbox.checked = !checkbox.checked;
                    // Disparar evento change manualmente
                    const changeEvent = new Event('change', { bubbles: true });
                    checkbox.dispatchEvent(changeEvent);
                }
            });
            
            // Event listener espec√≠fico para el checkbox
            checkbox.addEventListener('change', function() {
                const isChecked = this.checked;
                const cedula = this.dataset.cedula;
                
                console.log(`üîò Checkbox ${cedula} cambi√≥ a: ${isChecked ? 'SELECCIONADO' : 'DESELECCIONADO'}`);
                
                if (isChecked) {
                    if (!personasSeleccionadasEvacuacion.includes(cedula)) {
                        personasSeleccionadasEvacuacion.push(cedula);
                    }
                    personCard.style.borderColor = '#3b82f6';
                    personCard.style.backgroundColor = '#f0f9ff';
                    personCard.classList.add('selected');
                } else {
                    personasSeleccionadasEvacuacion = personasSeleccionadasEvacuacion.filter(c => c !== cedula);
                    personCard.style.borderColor = '#e2e8f0';
                    personCard.style.backgroundColor = '#ffffff';
                    personCard.classList.remove('selected');
                }
                
                // Actualizar contador
                actualizarContadorSeleccionEvacuacion();
                
                console.log(`üìä Seleccionadas: [${personasSeleccionadasEvacuacion.join(', ')}]`);
            });
            
            // Efectos hover
            personCard.addEventListener('mouseenter', function() {
                if (!checkbox.checked) {
                    this.style.borderColor = '#3b82f6';
                    this.style.backgroundColor = '#f8fafc';
                }
            });
            
            personCard.addEventListener('mouseleave', function() {
                if (!checkbox.checked) {
                    this.style.borderColor = '#e2e8f0';
                    this.style.backgroundColor = '#ffffff';
                }
            });
            
            DOM.personalGridModerno.appendChild(personCard);
            
            console.log(`‚úÖ Tarjeta creada para: "${nombre}" (${cedula})`);
            
        } catch (error) {
            console.error(`‚ùå Error creando tarjeta para persona ${index}:`, error);
        }
    });

    // Actualizar contador final
    actualizarContadorSeleccionEvacuacion();
    
    console.log(`‚úÖ Lista renderizada completamente: ${personas.length} personas`);
}

        function seleccionarTipoEvacuacion(tipo, clickedButton) {
            tipoEvacuacionSeleccionado = tipo;
            window.evacuacionSimulacro.tipo = tipo;

            // Limpiar selecciones anteriores
            document.querySelectorAll('.type-card-modern').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Marcar seleccionado
            clickedButton.classList.add('selected');

            // Mostrar informaci√≥n del tipo seleccionado
            if (DOM.infoTipoSeleccionadoModerno) {
                DOM.infoTipoSeleccionadoModerno.style.display = 'block';
                DOM.infoTipoSeleccionadoModerno.className = `info-tipo-seleccionado info-${tipo}`;
                
                if (tipo === 'simulacro') {
                    DOM.infoTipoSeleccionadoModerno.innerHTML = `
                        <h5><i class="fas fa-theater-masks"></i> SIMULACRO Seleccionado</h5>
                        <p>‚úÖ No modificar√° registros reales<br>
                        ‚úÖ Permitir√° rastrear progreso<br>
                        ‚úÖ Ideal para entrenamientos</p>
                    `;
                    
                    // Mostrar panel de estado para simulacros
                    const estadoPanel = document.getElementById('estadoEvacuacionSimulacro');
                    if (estadoPanel) {
                        estadoPanel.style.display = 'block';
                        actualizarEstadoSimulacro();
                    }
                } else {
                    DOM.infoTipoSeleccionadoModerno.innerHTML = `
                        <h5><i class="fas fa-exclamation-triangle"></i> EVACUACI√ìN REAL Seleccionada</h5>
                        <p>‚ö†Ô∏è Modificar√° registros permanentemente<br>
                        ‚ö†Ô∏è Registrar√° salidas reales<br>
                        ‚ö†Ô∏è Solo usar en emergencias reales</p>
                    `;
                    
                    // Ocultar panel de estado para evacuaciones reales
                    const estadoPanel = document.getElementById('estadoEvacuacionSimulacro');
                    if (estadoPanel) {
                        estadoPanel.style.display = 'none';
                    }
                }
            }
            
            // Mostrar bot√≥n de volver cuando se selecciona un tipo
            if (DOM.btnVolverEvacuacion) {
                DOM.btnVolverEvacuacion.style.display = 'inline-flex';
            }
            
            actualizarBotonEjecutar();
        }

        function seleccionarTodosModerno() {
            personasSeleccionadasEvacuacion = [];
            document.querySelectorAll('.person-card-modern input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = true;
                personasSeleccionadasEvacuacion.push(checkbox.dataset.cedula);
                checkbox.closest('.person-card-modern').classList.add('selected');
            });
            actualizarContadorSeleccionEvacuacion();
        }

        function limpiarSeleccionModerno() {
            personasSeleccionadasEvacuacion = [];
            document.querySelectorAll('.person-card-modern input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
                checkbox.closest('.person-card-modern').classList.remove('selected');
            });
            actualizarContadorSeleccionEvacuacion();
        }

        function actualizarContadorSeleccionEvacuacion() {
            if (DOM.selectionCountModerno) {
                DOM.selectionCountModerno.textContent = personasSeleccionadasEvacuacion.length;
            }
            
            // IMPORTANTE: Actualizar el bot√≥n cada vez que cambie la selecci√≥n
            // El bot√≥n se habilita tan pronto como haya al menos UNA persona seleccionada Y un tipo de evacuaci√≥n
            actualizarBotonEjecutar();
            
            // Si es simulacro, actualizar estado
            if (tipoEvacuacionSeleccionado === 'simulacro') {
                actualizarEstadoSimulacro();
            }
        }

        // NUEVA FUNCI√ìN: actualizarBotonEjecutar
        function actualizarBotonEjecutar() {
            const btnEjecutar = DOM.btnConfirmarSalidas;
            if (!btnEjecutar) {
                console.log('‚ö†Ô∏è btnConfirmarSalidas no encontrado');
                return;
            }
            
            // Verificar si hay al menos una persona seleccionada (NO es necesario seleccionar todas)
            const tieneSeleccion = personasSeleccionadasEvacuacion.length > 0;
            const tieneTipo = tipoEvacuacionSeleccionado !== null;
            
            console.log(`üîÑ Actualizando bot√≥n - Selecci√≥n: ${tieneSeleccion} (${personasSeleccionadasEvacuacion.length}), Tipo: ${tieneTipo} (${tipoEvacuacionSeleccionado})`);
            
            // El bot√≥n solo se muestra si hay tipo y al menos una persona seleccionada
            const debeMostrar = tieneTipo;
            btnEjecutar.style.display = debeMostrar ? 'inline-flex' : 'none';

            // El bot√≥n se habilita si hay al menos una persona seleccionada y tipo
            const debeHabilitarse = tieneSeleccion && tieneTipo;
            btnEjecutar.disabled = !debeHabilitarse;

            if (debeHabilitarse) {
                btnEjecutar.className = 'btn btn-primary';
                btnEjecutar.innerHTML = `<i class="fas fa-play"></i> Ejecutar ${tipoEvacuacionSeleccionado === 'simulacro' ? 'Simulacro' : 'Evacuaci√≥n'}`;
                console.log('‚úÖ Bot√≥n HABILITADO - Se puede evacuar con las personas seleccionadas');
            } else {
                btnEjecutar.className = 'btn btn-secondary';
                btnEjecutar.innerHTML = '<i class="fas fa-play"></i> Ejecutar';
                console.log('‚ùå Bot√≥n DESHABILITADO - Necesita seleccionar tipo y al menos una persona');
            }
        }

        // NUEVA FUNCI√ìN: actualizarEstadoSimulacro
        function actualizarEstadoSimulacro() {
            if (tipoEvacuacionSeleccionado !== 'simulacro') return;
            
            const contadorEvacuados = document.getElementById('contadorEvacuados');
            const contadorRestantes = document.getElementById('contadorRestantes');
            const listaRestantes = document.getElementById('listaRestantes');
            
            if (!contadorEvacuados || !contadorRestantes || !listaRestantes) return;
            
            const totalOriginal = window.evacuacionSimulacro.personasOriginales.length;
            const evacuados = window.evacuacionSimulacro.personasEvacuadas.length;
            const restantes = totalOriginal - evacuados;
            
            contadorEvacuados.textContent = evacuados;
            contadorRestantes.textContent = restantes;
            
            // Mostrar lista de personas restantes
            if (restantes > 0) {
                const nombresRestantes = window.evacuacionSimulacro.personasRestantes
                    .map(p => p.nombre)
                    .slice(0, 5) // Solo mostrar primeros 5
                    .join(', ');
                
                listaRestantes.innerHTML = `
                    <strong>Faltan por evacuar:</strong><br>
                    ${nombresRestantes}
                    ${restantes > 5 ? ` y ${restantes - 5} m√°s...` : ''}
                `;
            } else {
                listaRestantes.innerHTML = '<strong style="color: #4caf50;">‚úÖ Todos evacuados exitosamente</strong>';
            }
        }

        function cerrarEvacuacionChecklist() {
            if (DOM.evacuationModal) DOM.evacuationModal.classList.remove('show');
            restaurarInterfazEvacuacion();
            resetearModalEvacuacion();
            
            // NUEVO: Resetear simulacro al cerrar
            resetearSimulacro();
        }

        function restaurarInterfazEvacuacion() {
            if (DOM.menuButton) DOM.menuButton.style.display = 'flex';
        }

        function volverEnEvacuacion() {
            console.log('üîÑ Volviendo al inicio del modal de evacuaci√≥n...');
            
            // Resetear selecci√≥n de tipo de evacuaci√≥n
            tipoEvacuacionSeleccionado = null;
            
            // Limpiar selecciones de personas
            personasSeleccionadasEvacuacion = [];
            
            // Ocultar informaci√≥n del tipo seleccionado
            if (DOM.infoTipoSeleccionadoModerno) {
                DOM.infoTipoSeleccionadoModerno.style.display = 'none';
                DOM.infoTipoSeleccionadoModerno.innerHTML = '';
            }
            
            // Resetear tarjetas de tipo de evacuaci√≥n
            const typeCards = document.querySelectorAll('.type-card-modern');
            typeCards.forEach(card => {
                card.classList.remove('selected');
            });
            
            // Limpiar grid de personal
            if (DOM.personalGridModerno) {
                DOM.personalGridModerno.innerHTML = '';
            }
            
            // Ocultar estado de simulacro
            const estadoSimulacro = document.getElementById('estadoEvacuacionSimulacro');
            if (estadoSimulacro) {
                estadoSimulacro.style.display = 'none';
            }
            
            // Ocultar bot√≥n de volver
            if (DOM.btnVolverEvacuacion) {
                DOM.btnVolverEvacuacion.style.display = 'none';
            }
            
            // Resetear contador de selecci√≥n
            actualizarContadorSeleccionEvacuacion();
            
            // Usar la funci√≥n centralizada para actualizar el bot√≥n
            actualizarBotonEjecutar();
            
            // Mostrar mensaje de √©xito
            showCustomNotification('Se ha regresado al inicio del modo evacuaci√≥n', 'success');
            
            console.log('‚úÖ Modal de evacuaci√≥n reseteado correctamente');
        }

        // FUNCI√ìN CORREGIDA: ejecutarEvacuacion (reemplaza procesarEvacuacionDirecta)
        function ejecutarEvacuacion() {
            if (!tipoEvacuacionSeleccionado) {
                showCustomNotification('Por favor, seleccione primero un tipo de evacuaci√≥n (Simulacro o Evacuaci√≥n Real).', 'warning');
                // Hacer scroll hacia los botones de tipo de evacuaci√≥n para ayudar al usuario
                const tiposContainer = document.querySelector('.types-container-modern');
                if (tiposContainer) {
                    tiposContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Agregar un efecto visual temporal para resaltar los botones
                    tiposContainer.style.animation = 'pulse 2s';
                    setTimeout(() => {
                        tiposContainer.style.animation = '';
                    }, 2000);
                }
                return;
            }
            
            if (personasSeleccionadasEvacuacion.length === 0) {
                showCustomNotification('Por favor, seleccione al menos una persona para evacuar.', 'warning');
                return;
            }

            const esSimulacro = tipoEvacuacionSeleccionado === 'simulacro';
            
            if (esSimulacro) {
                ejecutarSimulacro();
            } else {
                ejecutarEvacuacionReal();
            }
        }

        // NUEVA FUNCI√ìN: ejecutarSimulacro con hoja dedicada
        function ejecutarSimulacro() {
            if (!tipoEvacuacionSeleccionado || tipoEvacuacionSeleccionado !== 'simulacro') {
                showCustomNotification('Error: Tipo de evacuaci√≥n inv√°lido para simulacro', 'error');
                return;
            }
            
            if (personasSeleccionadasEvacuacion.length === 0) {
                showCustomNotification('Seleccione al menos una persona para el simulacro', 'warning');
                return;
            }
            
            const mensaje = `üé≠ SIMULACRO CON HOJA DEDICADA

    Procesar√° ${personasSeleccionadasEvacuacion.length} persona(s) en una hoja separada.

    ‚úÖ VENTAJAS:
    ‚Ä¢ Crea hoja "Simulacro_XXX" independiente
    ‚Ä¢ Registro original permanece intacto
    ‚Ä¢ Evidencia completa del simulacro
    ‚Ä¢ Sin riesgo de datos reales

    ¬øContinuar con el simulacro?`;
            
            showCustomNotification(mensaje, 'info', true, function(confirmar) {
                if (!confirmar) return;
                
                console.log('üé≠ Ejecutando simulacro para:', personasSeleccionadasEvacuacion);
                
                mostrarLoading('Creando hoja de simulacro...');
                
                google.script.run
                    .withSuccessHandler(function(resultado) {
                        ocultarLoading();
                        
                        if (resultado && resultado.success) {
                            console.log('‚úÖ Simulacro completado:', resultado);
                            
                            // Mostrar resultado espec√≠fico del simulacro
                            mostrarNotificacionSimulacroConHoja(resultado);
                            
                            // Actualizar interfaz local si existe estado de simulacro
                            if (window.evacuacionSimulacro && window.evacuacionSimulacro.activa) {
                                actualizarEstadoPostSimulacro(resultado);
                            }
                            
                            // Actualizar estad√≠sticas
                            updateStatsPanel();
                            
                            // Cerrar modal despu√©s de un tiempo
                            setTimeout(() => {
                                cerrarEvacuacionChecklist();
                                resetearSimulacro();
                            }, 4000);
                            
                        } else {
                            const errorMsg = resultado?.message || 'Error desconocido en simulacro';
                            showCustomNotification(`‚ùå Error: ${errorMsg}`, 'error');
                            console.error('Error en simulacro:', resultado);
                        }
                    })
                    .withFailureHandler(function(error) {
                        ocultarLoading();
                        const errorMsg = error?.message || error || 'Error de conexi√≥n';
                        showCustomNotification(`‚ùå Error de conexi√≥n: ${errorMsg}`, 'error');
                        console.error('Error de conexi√≥n en simulacro:', error);
                    })
                    .registrarSalidasMasivas(personasSeleccionadasEvacuacion, 'SIMULACRO');
            });
        }

        // NUEVA FUNCI√ìN: procesarEvacuadosSimulacro
        function procesarEvacuadosSimulacro(cedulasEvacuadas) {
            // Agregar a la lista de evacuados
            cedulasEvacuadas.forEach(cedula => {
                if (!window.evacuacionSimulacro.personasEvacuadas.includes(cedula)) {
                    window.evacuacionSimulacro.personasEvacuadas.push(cedula);
                }
            });
            
            // Actualizar lista de restantes
            window.evacuacionSimulacro.personasRestantes = window.evacuacionSimulacro.personasOriginales.filter(
                persona => !window.evacuacionSimulacro.personasEvacuadas.includes(persona.cedula)
            );
            
            console.log('üìä Estado simulacro actualizado:', {
                evacuados: window.evacuacionSimulacro.personasEvacuadas.length,
                restantes: window.evacuacionSimulacro.personasRestantes.length
            });
        }

        // NUEVA FUNCI√ìN: actualizarEstadoPostSimulacro
        function actualizarEstadoPostSimulacro(resultadoSimulacro) {
            try {
                if (!window.evacuacionSimulacro || !window.evacuacionSimulacro.activa) {
                    return;
                }
                
                // Actualizar personas evacuadas en el estado local
                const personasEvacuadas = resultadoSimulacro.personasEvacuadas || [];
                
                personasEvacuadas.forEach(persona => {
                    if (persona.cedula && !window.evacuacionSimulacro.personasEvacuadas.includes(persona.cedula)) {
                        window.evacuacionSimulacro.personasEvacuadas.push(persona.cedula);
                    }
                });
                
                // Recalcular personas restantes
                window.evacuacionSimulacro.personasRestantes = window.evacuacionSimulacro.personasOriginales.filter(
                    persona => !window.evacuacionSimulacro.personasEvacuadas.includes(persona.cedula)
                );
                
                // Actualizar UI si el modal sigue abierto
                if (DOM.evacuationModal && DOM.evacuationModal.classList.contains('show')) {
                    actualizarEstadoSimulacro();
                    limpiarSeleccionModerno();
                }
                
                console.log('‚úÖ Estado post-simulacro actualizado:', {
                    evacuados: window.evacuacionSimulacro.personasEvacuadas.length,
                    restantes: window.evacuacionSimulacro.personasRestantes.length
                });
                
            } catch (error) {
                console.error('Error actualizando estado post-simulacro:', error);
            }
        }

        // NUEVA FUNCI√ìN: actualizarListaPersonasRestantes
        function actualizarListaPersonasRestantes() {
            const grid = DOM.personalGridModerno;
            if (!grid) return;
            
            grid.innerHTML = '';
            
            if (window.evacuacionSimulacro.personasRestantes.length === 0) {
                grid.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: #4caf50; grid-column: 1 / -1;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">‚úÖ</div>
                        <h3>¬°Simulacro Completado!</h3>
                        <p>Todas las personas han sido evacuadas exitosamente</p>
                    </div>
                `;
                return;
            }
            
            // Mostrar solo las personas restantes
            window.evacuacionSimulacro.personasRestantes.forEach((persona, index) => {
                const personCard = crearTarjetaPersona(persona, index);
                grid.appendChild(personCard);
            });
            
            actualizarContadorSeleccionEvacuacion();
        }

        // FUNCI√ìN CORREGIDA: ejecutarEvacuacionReal
        function ejecutarEvacuacionReal() {
            const mensaje = `¬°ALERTA! Va a registrar la SALIDA REAL de ${personasSeleccionadasEvacuacion.length} persona(s). Esta acci√≥n es IRREVERSIBLE y modificar√° permanentemente los registros. ¬øEst√° completamente seguro?`;
            
            showCustomNotification(mensaje, 'error', true, function(confirmar) {
                if (!confirmar) return;
                
                mostrarLoading('Procesando evacuaci√≥n real...');

                google.script.run
                    .withSuccessHandler(function(result) {
                        ocultarLoading();
                        if (result.success) {
                            showCustomNotification(result.message, 'success');
                            updateStatsPanel();
                            cerrarEvacuacionChecklist();
                        } else {
                            showCustomNotification(result.message, 'error');
                        }
                    })
                    .withFailureHandler(function(error) {
                        ocultarLoading();
                        showCustomNotification('Error procesando evacuaci√≥n real: ' + error.message, 'error');
                    })
                    .registrarSalidasMasivas(personasSeleccionadasEvacuacion, 'REAL');
            });
        }

        // NUEVA FUNCI√ìN: inicializarSimulacro
        function inicializarSimulacro(personasDentro) {
            window.evacuacionSimulacro = {
                activa: true,
                tipo: null,
                personasOriginales: [...personasDentro], // Copia de las personas iniciales
                personasEvacuadas: [],
                personasRestantes: [...personasDentro] // Inicialmente todas est√°n dentro
            };
            
            console.log('üé≠ Simulacro inicializado con', personasDentro.length, 'personas');
        }

        // NUEVA FUNCI√ìN: resetearSimulacro
        function resetearSimulacro() {
            window.evacuacionSimulacro = {
                activa: false,
                tipo: null,
                personasOriginales: [],
                personasEvacuadas: [],
                personasRestantes: []
            };
            
            console.log('üîÑ Simulacro reseteado');
        }

        /**
         * Funci√≥n para generar reporte detallado de simulacro
         * @param {Object} datosSimulacro - Datos del simulacro ejecutado
         * @return {string} HTML del reporte
         */
        function generarReporteSimulacro(datosSimulacro) {
            try {
                const { 
                    personasOriginales, 
                    personasEvacuadas, 
                    personasRestantes,
                    tiempoInicio,
                    tiempoFin 
                } = datosSimulacro;
                
                const porcentajeEvacuacion = personasOriginales.length > 0 ? 
                    ((personasEvacuadas.length / personasOriginales.length) * 100).toFixed(1) : 0;
                
                const tiempoTotal = tiempoFin && tiempoInicio ? 
                    Math.round((tiempoFin - tiempoInicio) / 1000) : 0;
                
                let html = `
                    <div style="padding: 20px; font-family: 'Inter', sans-serif;">
                        <h2 style="color: #1e293b; margin-bottom: 20px;">
                            <i class="fas fa-theater-masks"></i> Reporte de Simulacro de Evacuaci√≥n
                        </h2>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                <h3 style="margin: 0; font-size: 2rem;">${personasOriginales.length}</h3>
                                <p style="margin: 5px 0 0 0; opacity: 0.9;">Total Inicial</p>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                <h3 style="margin: 0; font-size: 2rem;">${personasEvacuadas.length}</h3>
                                <p style="margin: 5px 0 0 0; opacity: 0.9;">Evacuadas</p>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <i class="fas fa-clock" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                <h3 style="margin: 0; font-size: 2rem;">${porcentajeEvacuacion}%</h3>
                                <p style="margin: 5px 0 0 0; opacity: 0.9;">Completado</p>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <i class="fas fa-stopwatch" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                <h3 style="margin: 0; font-size: 2rem;">${tiempoTotal}s</h3>
                                <p style="margin: 5px 0 0 0; opacity: 0.9;">Duraci√≥n</p>
                            </div>
                        </div>
                `;
                
                if (personasRestantes.length > 0) {
                    html += `
                        <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <h3 style="color: #dc2626; margin-bottom: 15px;">
                                <i class="fas fa-exclamation-triangle"></i> Personas No Evacuadas (${personasRestantes.length})
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px;">
                    `;
                    
                    personasRestantes.forEach(persona => {
                        html += `
                            <div style="background: white; padding: 10px; border-radius: 6px; border-left: 4px solid #dc2626;">
                                <strong>${persona.nombre}</strong><br>
                                <small style="color: #6b7280;">${persona.cedula} - ${persona.empresa}</small>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                html += `
                        <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 12px; padding: 20px;">
                            <h3 style="color: #0369a1; margin-bottom: 10px;">
                                <i class="fas fa-info-circle"></i> Informaci√≥n del Simulacro
                            </h3>
                            <p style="color: #075985; margin: 0;">
                                Este fue un <strong>simulacro de evacuaci√≥n</strong>. No se modificaron los registros reales del sistema.
                                El objetivo es identificar √°reas de mejora en el proceso de evacuaci√≥n.
                            </p>
                        </div>
                    </div>
                `;
                
                return html;
                
            } catch (error) {
                console.error('Error generando reporte de simulacro:', error);
                return '<div style="padding: 20px; color: #ef4444;">Error generando reporte</div>';
            }
        }

        /**
         * NUEVA FUNCI√ìN: Mostrar notificaci√≥n de simulacro con hoja creada (MEJORADA)
         * @param {Object} resultadoSimulacro - Resultado del simulacro ejecutado
         */
        function mostrarNotificacionSimulacroConHoja(resultadoSimulacro) {
            try {
                const {
                    nombreHojaSimulacro,
                    numeroSimulacro,
                    totalProcesadas,
                    totalSeleccionadas,
                    totalNoEncontradas,
                    personasEvacuadas
                } = resultadoSimulacro;
                
                const porcentajeCompletado = totalSeleccionadas > 0 ? 
                    ((totalProcesadas / totalSeleccionadas) * 100).toFixed(1) : 0;
                
                // Crear lista de personas evacuadas para mostrar
                let listaPersonas = '';
                if (personasEvacuadas && personasEvacuadas.length > 0) {
                    const primeras5 = personasEvacuadas.slice(0, 5);
                    listaPersonas = primeras5.map(p => `‚Ä¢ ${p.nombre || 'N/A'} (${p.cedula})`).join('\n');
                    if (personasEvacuadas.length > 5) {
                        listaPersonas += `\n‚Ä¢ ... y ${personasEvacuadas.length - 5} m√°s`;
                    }
                }
                
                const mensaje = `üé≠ SIMULACRO #${numeroSimulacro || 'N/A'} COMPLETADO

    üìã Hoja Creada: ${nombreHojaSimulacro}
    ‚úÖ Personas Evacuadas: ${totalProcesadas}/${totalSeleccionadas}
    üìä Completado: ${porcentajeCompletado}%
    ${totalNoEncontradas > 0 ? `‚ö†Ô∏è No encontradas: ${totalNoEncontradas}` : ''}

    ${listaPersonas ? `üë• Personas evacuadas:\n${listaPersonas}\n\n` : ''}‚ÑπÔ∏è INFORMACI√ìN:
    ‚Ä¢ Registro original NO modificado
    ‚Ä¢ Evidencia guardada en: ${nombreHojaSimulacro}
    ‚Ä¢ Puede revisar la hoja para an√°lisis

    üéâ ¬°Simulacro ejecutado exitosamente!`;
                
                showCustomNotification(mensaje, 'success');
                
            } catch (error) {
                console.error('Error mostrando notificaci√≥n de simulacro:', error);
                showCustomNotification('Simulacro completado exitosamente', 'success');
            }
        }

        /**
         * NUEVA FUNCI√ìN: Consultar simulacros existentes
         */
        function consultarSimulacrosExistentes() {
            try {
                mostrarLoading('Consultando simulacros existentes...');
                
                google.script.run
                    .withSuccessHandler(function(resultado) {
                        ocultarLoading();
                        
                        if (resultado.success) {
                            mostrarListaSimulacros(resultado);
                        } else {
                            showCustomNotification(`Error consultando simulacros: ${resultado.message}`, 'error');
                        }
                    })
                    .withFailureHandler(function(error) {
                        ocultarLoading();
                        showCustomNotification(`Error de conexi√≥n: ${error.message}`, 'error');
                        console.error('Error consultando simulacros:', error);
                    })
                    .getSimulacrosInfo();
                    
            } catch (error) {
                ocultarLoading();
                console.error('Error en consultarSimulacrosExistentes:', error);
                showCustomNotification('Error interno consultando simulacros', 'error');
            }
        }

        /**
         * NUEVA FUNCI√ìN: Mostrar lista de simulacros en modal DOM
         * @param {Object} datosSimulacros - Datos de simulacros del backend
         */
        function mostrarListaSimulacros(datosSimulacros) {
            try {
                const { simulacros, totalSimulacros } = datosSimulacros;
                
                // Crear modal container
                const modalContainer = document.createElement('div');
                modalContainer.className = 'modal-overlay';
                modalContainer.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.7);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 2000;
                    padding: 20px;
                    box-sizing: border-box;
                `;
                
                // Crear contenido del modal
                const modalContent = document.createElement('div');
                modalContent.className = 'simulacros-modal-content';
                modalContent.style.cssText = `
                    background: var(--bg-primary);
                    border-radius: 12px;
                    width: 100%;
                    max-width: 800px;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                    position: relative;
                `;
                
                // Header del modal
                const modalHeader = document.createElement('div');
                modalHeader.style.cssText = `
                    padding: 24px;
                    border-bottom: 1px solid var(--border);
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    background: var(--primary);
                    color: white;
                    border-radius: 12px 12px 0 0;
                `;
                
                const modalTitle = document.createElement('h2');
                modalTitle.style.cssText = `
                    margin: 0;
                    font-size: 1.5rem;
                    font-weight: 600;
                `;
                modalTitle.innerHTML = `<i class="fas fa-theater-masks"></i> Historial de Simulacros (${totalSimulacros})`;
                
                const closeButton = document.createElement('button');
                closeButton.style.cssText = `
                    background: none;
                    border: none;
                    color: white;
                    font-size: 1.5rem;
                    cursor: pointer;
                    padding: 8px;
                    border-radius: 4px;
                    min-width: 44px;
                    min-height: 44px;
                `;
                closeButton.innerHTML = '<i class="fas fa-times"></i>';
                closeButton.onclick = () => document.body.removeChild(modalContainer);
                
                modalHeader.appendChild(modalTitle);
                modalHeader.appendChild(closeButton);
                
                // Body del modal
                const modalBody = document.createElement('div');
                modalBody.style.cssText = `
                    padding: 24px;
                    color: var(--text-primary);
                `;
                
                if (totalSimulacros === 0) {
                    // No hay simulacros
                    const emptyState = document.createElement('div');
                    emptyState.style.cssText = `
                        text-align: center;
                        padding: 40px 20px;
                        color: var(--text-secondary);
                    `;
                    emptyState.innerHTML = `
                        <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.5;"></i>
                        <h3 style="margin: 0 0 10px 0; color: var(--text-primary);">No hay simulacros registrados</h3>
                        <p style="margin: 0;">Los simulacros realizados aparecer√°n aqu√≠ con su evidencia correspondiente.</p>
                    `;
                    modalBody.appendChild(emptyState);
                } else {
                    // Lista de simulacros
                    const simulacrosList = document.createElement('div');
                    simulacrosList.style.cssText = `
                        display: grid;
                        gap: 16px;
                    `;
                    
                    simulacros.forEach(simulacro => {
                        const simulacroCard = document.createElement('div');
                        simulacroCard.style.cssText = `
                            border: 1px solid var(--border);
                            border-radius: 8px;
                            padding: 20px;
                            background: var(--bg-secondary);
                            transition: transform 0.2s ease, box-shadow 0.2s ease;
                        `;
                        
                        // Header de la card
                        const cardHeader = document.createElement('div');
                        cardHeader.style.cssText = `
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 16px;
                            flex-wrap: wrap;
                            gap: 8px;
                        `;
                        
                        const cardTitle = document.createElement('h3');
                        cardTitle.style.cssText = `
                            margin: 0;
                            color: var(--text-primary);
                            font-size: 1.1rem;
                        `;
                        cardTitle.innerHTML = `<i class="fas fa-file-alt"></i> ${simulacro.nombre}`;
                        
                        const statusBadge = document.createElement('span');
                        const estado = simulacro.disponible ? 'Disponible' : 'Error';
                        const colorEstado = simulacro.disponible ? '#10b981' : '#ef4444';
                        statusBadge.style.cssText = `
                            background: ${colorEstado};
                            color: white;
                            padding: 4px 12px;
                            border-radius: 20px;
                            font-size: 0.8rem;
                            font-weight: 500;
                        `;
                        statusBadge.textContent = estado;
                        
                        cardHeader.appendChild(cardTitle);
                        cardHeader.appendChild(statusBadge);
                        
                        // Grid de informaci√≥n
                        const infoGrid = document.createElement('div');
                        infoGrid.style.cssText = `
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                            gap: 16px;
                            margin-bottom: 16px;
                        `;
                        
                        // Crear campos de informaci√≥n
                        const campos = [
                            { label: 'N√∫mero', value: `#${simulacro.numero}` },
                            { label: 'Fecha Creaci√≥n', value: new Date(simulacro.fechaCreacion).toLocaleString() }
                        ];
                        
                        if (simulacro.resumen) {
                            campos.push({ label: 'Procesadas', value: simulacro.resumen.procesadas, color: '#10b981' });
                        }
                        
                        campos.forEach(campo => {
                            const campoDiv = document.createElement('div');
                            campoDiv.innerHTML = `
                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px;">${campo.label}</div>
                                <div style="font-weight: 600; color: ${campo.color || 'var(--text-primary)'};">${campo.value}</div>
                            `;
                            infoGrid.appendChild(campoDiv);
                        });
                        
                        // Footer de la card
                        const cardFooter = document.createElement('div');
                        cardFooter.style.cssText = `
                            margin-top: 16px;
                            padding-top: 16px;
                            border-top: 1px solid var(--border);
                            font-size: 0.9rem;
                            color: var(--text-secondary);
                        `;
                        cardFooter.innerHTML = `
                            <i class="fas fa-info-circle" style="margin-right: 6px;"></i>
                            Hoja de evidencia disponible en Google Sheets
                        `;
                        
                        simulacroCard.appendChild(cardHeader);
                        simulacroCard.appendChild(infoGrid);
                        simulacroCard.appendChild(cardFooter);
                        
                        simulacrosList.appendChild(simulacroCard);
                    });
                    
                    modalBody.appendChild(simulacrosList);
                }
                
                // Footer del modal
                const modalFooter = document.createElement('div');
                modalFooter.style.cssText = `
                    padding: 20px 24px;
                    border-top: 1px solid var(--border);
                    text-align: center;
                    background: var(--bg-secondary);
                    border-radius: 0 0 12px 12px;
                `;
                
                const closeFooterButton = document.createElement('button');
                closeFooterButton.style.cssText = `
                    background: var(--text-secondary);
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 1rem;
                    min-height: 44px;
                    min-width: 100px;
                `;
                closeFooterButton.textContent = 'Cerrar';
                closeFooterButton.onclick = () => document.body.removeChild(modalContainer);
                
                modalFooter.appendChild(closeFooterButton);
                
                // Ensamblar modal
                modalContent.appendChild(modalHeader);
                modalContent.appendChild(modalBody);
                modalContent.appendChild(modalFooter);
                modalContainer.appendChild(modalContent);
                
                // Agregar al DOM
                document.body.appendChild(modalContainer);
                
                // Event listener para cerrar con Esc
                const handleEscape = (e) => {
                    if (e.key === 'Escape') {
                        document.body.removeChild(modalContainer);
                        document.removeEventListener('keydown', handleEscape);
                    }
                };
                document.addEventListener('keydown', handleEscape);
                
                // Event listener para cerrar clickeando fuera
                modalContainer.addEventListener('click', (e) => {
                    if (e.target === modalContainer) {
                        document.body.removeChild(modalContainer);
                    }
                });
                
                console.log('‚úÖ Modal de simulacros mostrado correctamente');
                
            } catch (error) {
                console.error('Error mostrando lista de simulacros:', error);
                showCustomNotification('Error mostrando lista de simulacros', 'error');
            }
        }

        /**
         * UTILIDADES FRONTEND: Funci√≥n para validar integridad de datos de evacuaci√≥n
         * @param {Array} personasDentro - Lista de personas dentro
         * @return {Object} Resultado de validaci√≥n
         */
        function validarDatosEvacuacion(personasDentro) {
            try {
                const errores = [];
                const advertencias = [];
                
                if (!Array.isArray(personasDentro)) {
                    errores.push('personasDentro no es un array v√°lido');
                    return { valido: false, errores, advertencias };
                }
                
                if (personasDentro.length === 0) {
                    advertencias.push('No hay personas dentro del edificio');
                }
                
                // Validar estructura de cada persona
                personasDentro.forEach((persona, index) => {
                    if (!persona.cedula) {
                        errores.push(`Persona ${index + 1}: falta c√©dula`);
                    }
                    if (!persona.nombre) {
                        advertencias.push(`Persona ${index + 1}: falta nombre`);
                    }
                    if (!persona.empresa) {
                        advertencias.push(`Persona ${index + 1}: falta empresa`);
                    }
                });
                
                // Verificar duplicados
                // Validaci√≥n de duplicados debe realizarse en backend o usando funci√≥n utilitaria centralizada
                // errores.push(...) si se detectan duplicados desde backend
                
                return {
                    valido: errores.length === 0,
                    errores,
                    advertencias,
                    totalPersonas: personasDentro.length,
                    personasConDatos: personasDentro.filter(p => p.cedula && p.nombre).length
                };
                
            } catch (error) {
                return {
                    valido: false,
                    errores: [`Error en validaci√≥n: ${error.message}`],
                    advertencias: []
                };
            }
        }

        /**
         * UTILIDADES FRONTEND: Funci√≥n para optimizar lista de evacuaci√≥n
         * Elimina duplicados y ordena por prioridad
         * @param {Array} personasDentro - Lista original
         * @return {Array} Lista optimizada
         */
        function optimizarListaEvacuacion(personasDentro) {
            try {
                // Eliminar duplicados por c√©dula
                const personasUnicas = personasDentro.filter((persona, index, arr) => 
                    arr.findIndex(p => p.cedula === persona.cedula) === index
                );
                
                // Ordenar por prioridad (nombre alfab√©tico como criterio base)
                const personasOrdenadas = personasUnicas.sort((a, b) => {
                    // Prioridad 1: Personas con datos completos
                    const completaA = a.cedula && a.nombre && a.empresa;
                    const completaB = b.cedula && b.nombre && b.empresa;
                    
                    if (completaA && !completaB) return -1;
                    if (!completaA && completaB) return 1;
                    
                    // Prioridad 2: Orden alfab√©tico por nombre
                    const nombreA = (a.nombre || '').toLowerCase();
                    const nombreB = (b.nombre || '').toLowerCase();
                    
                    return nombreA.localeCompare(nombreB);
                });
                
                console.log(`üìä Optimizaci√≥n frontend: ${personasDentro.length} ‚Üí ${personasOrdenadas.length} personas`);
                
                return personasOrdenadas;
                
            } catch (error) {
                console.error('Error optimizando lista de evacuaci√≥n:', error);
                return personasDentro; // Retornar original en caso de error
            }
        }

        // NUEVA FUNCI√ìN: actualizarInterfazPostEvacuacion
        function actualizarInterfazPostEvacuacion() {
            actualizarEstadoSimulacro();
            actualizarContadorSeleccionEvacuacion();
            
            // Actualizar contador total
            if (DOM.totalPersonasDentro) {
                DOM.totalPersonasDentro.textContent = window.evacuacionSimulacro.personasRestantes.length;
            }
        }

        // FUNCI√ìN AUXILIAR: crearTarjetaPersona
        function crearTarjetaPersona(persona, index) {
            if (!persona || !persona.cedula) {
                console.error('‚ùå Datos de persona inv√°lidos:', persona);
                return null;
            }
            
            const personCard = document.createElement('div');
            personCard.className = 'person-card-modern';
            personCard.dataset.cedula = persona.cedula;
            
            // Estilos CSS inline para garantizar renderizado
            personCard.style.cssText = `
                border: 2px solid #e2e8f0;
                border-radius: 8px;
                padding: 16px;
                margin-bottom: 12px;
                cursor: pointer;
                transition: all 0.2s ease;
                display: flex;
                align-items: flex-start;
                gap: 12px;
                background: white;
                min-height: 80px;
            `;
            
            // Checkbox
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `evac-persona-${index}`;
            checkbox.dataset.cedula = persona.cedula;
            checkbox.dataset.nombre = persona.nombre || 'Sin nombre';
            checkbox.dataset.empresa = persona.empresa || 'Sin empresa';
            checkbox.style.cssText = `
                margin: 4px 0 0 0;
                transform: scale(1.3);
                cursor: pointer;
                flex-shrink: 0;
            `;
            
            // Container de informaci√≥n
            const infoContainer = document.createElement('div');
            infoContainer.style.cssText = 'flex: 1; min-width: 0;';
            
            // Validar y limpiar datos
            const nombre = String(persona.nombre || 'Sin nombre').trim();
            const cedula = String(persona.cedula || 'N/A').trim();
            const empresa = String(persona.empresa || 'Sin empresa').trim();
            const horaEntrada = persona.horaEntrada || 'N/A';
            
            infoContainer.innerHTML = `
                <div style="font-weight: 700; margin-bottom: 8px; color: #1e293b;">${nombre}</div>
                <div style="font-size: 13px; color: #64748b; margin-bottom: 4px;">
                    <i class="fas fa-id-card" style="margin-right: 6px;"></i>${cedula}
                </div>
                <div style="font-size: 13px; color: #64748b; margin-bottom: 4px;">
                    <i class="fas fa-building" style="margin-right: 6px;"></i>${empresa}
                </div>
                <div style="font-size: 12px; color: #64748b; margin-bottom: 6px;">
                    <i class="fas fa-clock" style="margin-right: 6px;"></i>Entrada: ${horaEntrada}
                </div>
                <div style="font-size: 11px; color: #10b981; font-weight: 600;">
                    <i class="fas fa-circle" style="font-size: 6px; margin-right: 6px;"></i>Dentro del edificio
                </div>
            `;
            
            personCard.appendChild(checkbox);
            personCard.appendChild(infoContainer);
            
            // Event listeners
            personCard.addEventListener('click', function(e) {
                if (e.target !== checkbox) {
                    checkbox.checked = !checkbox.checked;
                    // Disparar evento de cambio para que sea manejado por el listener principal
                    const changeEvent = new Event('change', { bubbles: true });
                    checkbox.dispatchEvent(changeEvent);
                }
            });
            
            // Efectos hover
            personCard.addEventListener('mouseenter', function() {
                this.style.borderColor = '#3b82f6';
                this.style.backgroundColor = '#f8fafc';
            });
            
            personCard.addEventListener('mouseleave', function() {
                if (!checkbox.checked) {
                    this.style.borderColor = '#e2e8f0';
                    this.style.backgroundColor = 'white';
                }
            });
            
            return personCard;
        }

        function marcarEvacuacionRealOcurrida() {
            window.TIMESTAMP_ULTIMA_EVACUACION = new Date().getTime();
            console.log('üö® Evacuaci√≥n real marcada - simulando comportamiento de registro normal');

            personasSeleccionadasEvacuacion.forEach(cedula => {
                updateLiveHistory(cedula, 'salida');
            });

            reproducirSonido('successSound');

            setTimeout(() => {
                updateStatsPanel();
            }, 500);

            console.log('‚úÖ Evacuaci√≥n real procesada con comportamiento completo de registro.');
        }

        function verificarPersonasNoEvacuadas(resultadoEvacuacion) {
            console.log('üîç Verificando personas no evacuadas:', resultadoEvacuacion);
            
            // Mostrar modal de confirmaci√≥n para reiniciar evacuaci√≥n
            const mensaje = `Se evacuaron ${resultadoEvacuacion.totalProcesadas} de ${resultadoEvacuacion.totalSeleccionadas} personas seleccionadas.\n\n¬øDesea abrir nuevamente el checklist para verificar las personas que no fueron evacuadas?`;
            
            showCustomNotification(mensaje, 'warning', true, function(reiniciar) {
                if (reiniciar) {
                    // Reabrir modal de evacuaci√≥n para mostrar solo las no evacuadas
                    console.log('üîÑ Reabriendo checklist de evacuaci√≥n para personas restantes');
                    
                    // Limpiar selecci√≥n anterior y recargar datos
                    personasSeleccionadasEvacuacion = [];
                    
                    // Reabrir modal
                    setTimeout(() => {
                        mostrarEvacuacionChecklist();
                        
                        // Mostrar mensaje informativo
                        setTimeout(() => {
                            showCustomNotification('Checklist reabierto. Verifique las personas que a√∫n est√°n dentro del edificio.', 'info');
                        }, 500);
                    }, 500);
                }
            });
        }

        // =====================================================
        // PARTE 10B: OPTIMIZACI√ìN DE MEMORIA
        // =====================================================

        function optimizarMemoriaFrontend() {
            try {
                // Limpiar logs antiguos del DOM
                if (DOM.logContent && DOM.logContent.children.length > 100) {
                    const logs = Array.from(DOM.logContent.children);
                    logs.slice(0, logs.length - 50).forEach(log => log.remove());
                    console.log('üßπ Logs DOM limpiados');
                }
                
                // Limpiar historial en vivo si es muy grande
                if (historyCache && historyCache.length > 50) {
                    historyCache = historyCache.slice(-25);
                    console.log('üßπ Cache de historial optimizado');
                }
                
                // Limpiar notificaciones duplicadas
                if (window.lastNotifications) {
                    const now = Date.now();
                    for (const key in window.lastNotifications) {
                        if (now - window.lastNotifications[key] > 300000) { // 5 minutos
                            delete window.lastNotifications[key];
                        }
                    }
                }
                
                // Forzar garbage collection si est√° disponible
                if (window.gc && typeof window.gc === 'function') {
                    window.gc();
                }
                
            } catch (error) {
                console.error('Error en optimizaci√≥n de memoria:', error);
            }
        }

        // =====================================================
        // PARTE 11: CONEXI√ìN Y SINCRONIZACI√ìN DE PENDIENTES
        // =====================================================

        function procesarPendientes() {
            if (!navigator.onLine) {
                console.log('Sin conexi√≥n. No se procesar√°n pendientes.');
                return;
            }
            const pendientes = SurPassCache.obtenerTransaccionesPendientes();
            if (pendientes.length === 0) {
                console.log('No hay transacciones pendientes para procesar.');
                return;
            }

            console.log(`Procesando ${pendientes.length} transacciones pendientes...`);
            showCustomNotification(`Sincronizando ${pendientes.length} registros pendientes...`, 'warning');

            let procesados = 0;
            const totalPendientes = pendientes.length;

            async function processQueue() {
                for (const transaccion of pendientes) {
                    try {
                        await new Promise(resolve => setTimeout(resolve, 500));

                        if (transaccion.tipo === 'comentario') {
                            await google.script.run
                                .withSuccessHandler(res => {
                                    console.log(`Comentario procesado: ${transaccion.cedula}`);
                                    procesados++;
                                })
                                .withFailureHandler(err => {
                                    console.error(`Error al procesar comentario pendiente para ${transaccion.cedula}:`, err);
                                    showCustomNotification(`Error al sincronizar comentario de ${transaccion.cedula}.`, 'error');
                                })
                                .manejarComentarioPersonaRegistrada(transaccion.cedula, transaccion.comentario);
                        } else {
                            await google.script.run
                                .withSuccessHandler(res => {
                                    console.log(`Transacci√≥n procesada: ${transaccion.cedula}`);
                                    procesados++;
                                })
                                .withFailureHandler(err => {
                                    console.error(`Error al procesar transacci√≥n pendiente para ${transaccion.cedula}:`, err);
                                    showCustomNotification(`Error al sincronizar registro de ${transaccion.cedula}.`, 'error');
                                })
                                .handleHTMLFormSubmit(transaccion.cedula, transaccion.respuesta);
                        }
                    } catch (e) {
                        console.error('Excepci√≥n durante el procesamiento de pendientes:', e);
                        showCustomNotification('Error inesperado al sincronizar algunos registros.', 'error');
                    }
                }

                if (procesados === totalPendientes) {
                    SurPassCache.limpiarTransaccionesPendientes();
                    showCustomNotification('Sincronizaci√≥n completada.', 'success');
                } else {
                    showCustomNotification(`Sincronizaci√≥n finalizada. ${procesados} de ${totalPendientes} registros procesados.`, 'warning');
                }
            }
            processQueue();
        }

        function actualizarEstadoConexion() {
            if (!DOM.conexionIndicador || !DOM.conexionTexto) return;

            if (navigator.onLine) {
                DOM.conexionIndicador.classList.remove('offline');
                DOM.conexionIndicador.classList.add('online');
                DOM.conexionTexto.textContent = 'En l√≠nea';
                procesarPendientes();
            } else {
                DOM.conexionIndicador.classList.remove('online');
                DOM.conexionIndicador.classList.add('offline');
                DOM.conexionTexto.textContent = 'Sin conexi√≥n';
                showCustomNotification('No hay conexi√≥n a internet. Los registros se guardar√°n localmente.', 'error');
                appendLog({ timestamp: new Date().toISOString(), level: 'WARNING', message: 'Sin conexi√≥n a internet', details: {} });
            }
        }

        // =====================================================
        // PARTE 12: VISTA PREVIA Y TEMAS
        // =====================================================

        function mostrarVistaPrevia(pagina = 1, registrosPorPagina = 100) {
        console.log('üîÑ Iniciando vista previa del historial...');
        
        // Validar par√°metros
        if (!pagina || pagina < 1) pagina = 1;
        if (!registrosPorPagina || registrosPorPagina < 10) registrosPorPagina = 100;
        
        mostrarLoading('Cargando historial...');
        
        // Obtener par√°metros de paginaci√≥n del localStorage si existen
        const savedRegistrosPorPagina = localStorage.getItem('registrosPorPagina');
        if (savedRegistrosPorPagina && !isNaN(parseInt(savedRegistrosPorPagina))) {
            registrosPorPagina = parseInt(savedRegistrosPorPagina);
        }
        
        // Obtener c√©dula del input si existe
        const cedulaBusqueda = DOM.cedulaInput ? DOM.cedulaInput.value.trim() : '';
        
        console.log('üìä Par√°metros de vista previa:', { 
            pagina, 
            registrosPorPagina, 
            cedulaBusqueda,
            hasConnection: navigator.onLine 
        });
        
        // Verificar conexi√≥n
        if (!navigator.onLine) {
            ocultarLoading();
            showCustomNotification('No hay conexi√≥n a internet para cargar el historial.', 'error');
            return;
        }
        
        // Verificar que google.script est√© disponible
        if (typeof google === 'undefined' || !google.script || !google.script.run) {
            console.error('‚ùå Google Apps Script API no disponible');
            ocultarLoading();
            showCustomNotification('Error: API de Google Apps Script no disponible.', 'error');
            return;
        }
        
        // Timeout de seguridad
        const timeoutId = setTimeout(() => {
            console.error('‚è∞ Timeout cargando historial');
            ocultarLoading();
            showCustomNotification('Timeout: El servidor tard√≥ demasiado en responder.', 'warning');
        }, 30000); // 30 segundos
        
        google.script.run
            .withSuccessHandler(function(html) {
                clearTimeout(timeoutId);
                ocultarLoading();
                
                console.log('‚úÖ HTML del historial recibido');
                
                if (!html || typeof html !== 'string') {
                    console.error('‚ùå HTML inv√°lido recibido:', html);
                    showCustomNotification('Error: Datos de historial inv√°lidos recibidos.', 'error');
                    return;
                }
                
                try {
                    if (DOM.contenidoVistaPrevia) {
                        DOM.contenidoVistaPrevia.innerHTML = html;
                        DOM.contenidoVistaPrevia.id = 'contenidoVistaPrevia';
                    }
                    
                    if (DOM.vistaPrevia) {
                        DOM.vistaPrevia.style.display = 'block';
                    }
                    
                    if (DOM.menuDropdown) {
                        DOM.menuDropdown.classList.remove('show');
                    }
                    
                    if (DOM.menuButton) {
                        DOM.menuButton.style.display = 'none';
                    }

                    // Aplicar tema actual
                    const isDarkTheme = document.body.classList.contains('dark-theme');
                    applyThemeToElement(DOM.contenidoVistaPrevia, isDarkTheme ? 'dark' : 'light');

                    console.log('‚úÖ Vista previa mostrada correctamente');
                    
                    appendLog({ 
                        timestamp: new Date().toISOString(), 
                        level: 'INFO', 
                        message: 'Vista previa de historial mostrada', 
                        details: { pagina, registrosPorPagina, cedula: cedulaBusqueda } 
                    });
                    
                } catch (uiError) {
                    console.error('‚ùå Error actualizando UI:', uiError);
                    showCustomNotification('Error mostrando el historial en la interfaz.', 'error');
                }
            })
            .withFailureHandler(function(error) {
                clearTimeout(timeoutId);
                ocultarLoading();
                
                console.error('‚ùå Error llamando mostrarVistaPreviaRondas:', error);
                
                let errorMessage = 'Error desconocido';
                if (error && error.message) {
                    errorMessage = error.message;
                } else if (typeof error === 'string') {
                    errorMessage = error;
                }
                
                showCustomNotification('Error al cargar historial: ' + errorMessage, 'error');
                
                appendLog({ 
                    timestamp: new Date().toISOString(), 
                    level: 'ERROR', 
                    message: 'Error cargando vista previa', 
                    details: { 
                        error: errorMessage, 
                        pagina, 
                        registrosPorPagina,
                        cedula: cedulaBusqueda
                    } 
                });
            })
            .mostrarVistaPreviaRondas(cedulaBusqueda, pagina, registrosPorPagina);
    }

        function cerrarVistaPrevia() {
            if (DOM.vistaPrevia) DOM.vistaPrevia.style.display = 'none';
            if (DOM.menuButton) DOM.menuButton.style.display = 'flex';
        }
        
        // Funci√≥n para cambiar la cantidad de registros por p√°gina y guardarla en localStorage
        function cambiarRegistrosPorPagina(valor) {
            const registrosPorPagina = parseInt(valor) || 100;
            localStorage.setItem('registrosPorPagina', registrosPorPagina);
            mostrarVistaPrevia(1, registrosPorPagina); // Volver a la p√°gina 1 con el nuevo valor
        }

        // =====================================================
        // FUNCIONES DE HISTORIAL POR C√âDULA
        // =====================================================
        
        function abrirHistorial() {
            console.log('üìã Abriendo modal de historial...');
            
            // Mostrar modal
            if (DOM.historialModal) {
                DOM.historialModal.classList.add('show');
            }
            
            // Ocultar men√∫
            if (DOM.menuDropdown) {
                DOM.menuDropdown.classList.remove('show');
            }
            if (DOM.menuButton) {
                DOM.menuButton.style.display = 'none';
            }
            
            // Limpiar contenido anterior
            limpiarHistorial();
            
            // Mostrar loader global
            mostrarLoading('Obteniendo historial...');
            
            // Obtener c√©dula del input
            const cedula = DOM.cedulaInput ? DOM.cedulaInput.value.trim() : '';
            
            // Determinar el tipo de b√∫squeda
            const esBusquedaGeneral = !cedula;
            const mensajeBusqueda = esBusquedaGeneral ? 
                'Obteniendo historial completo...' : 
                `Obteniendo historial para c√©dula: ${cedula}`;
            
            console.log(`üìã ${mensajeBusqueda}`);
            
            // Actualizar el t√≠tulo del modal
            const titulo = document.querySelector('.historial-modal-title span');
            if (titulo) {
                titulo.textContent = esBusquedaGeneral ? 'Historial Completo' : 'Historial de Registros';
            }
            
            // Timeout de seguridad
            const timeoutId = setTimeout(() => {
                console.error('‚è∞ Timeout obteniendo historial');
                ocultarLoading();
                mostrarHistorialMessage('Timeout: El servidor tard√≥ demasiado en responder.', 'error');
            }, 30000);
            
            google.script.run
                .withSuccessHandler(function(datos) {
                    clearTimeout(timeoutId);
                    llenarTablaHistorial(datos, esBusquedaGeneral);
                })
                .withFailureHandler(function(error) {
                    clearTimeout(timeoutId);
                    handleHistorialFailure(error);
                })
                .getHistorialPorCedula(cedula); // Enviar c√©dula (puede estar vac√≠a)
        }
        
        function llenarTablaHistorial(datos, esBusquedaGeneral = false) {
            console.log('üìã Llenando tabla de historial:', datos);
            
            ocultarLoading();
            
            if (datos && datos.length > 0) {
                // Construir t√≠tulo din√°mico
                var tituloSpan = document.querySelector('.historial-modal-title span');
                var titulo;
                if (esBusquedaGeneral) {
                    titulo = 'Historial Completo (' + datos.length + ' registros)';
                } else {
                    titulo = 'Historial de ' + datos[0][2] + ' (CC: ' + datos[0][1] + ')';
                }
                if (tituloSpan) {
                    tituloSpan.textContent = titulo;
                }
                
                // Mostrar tabla
                if (DOM.historialTable) {
                    DOM.historialTable.style.display = 'table';
                }
                
                // Limpiar tbody
                if (DOM.tablaHistorialBody) {
                    DOM.tablaHistorialBody.innerHTML = '';
                    
                    // Agregar filas con el nuevo formato
                    datos.forEach(function(fila, index) {
                        const row = document.createElement('tr');
                        
                        // Nuevo orden de datos: fecha, cedula, nombre, estado, entrada, salida, duraci√≥n, empresa
                        row.innerHTML = `
                            <td class="fecha-cell">${fila[0] || 'N/A'}</td>
                            <td class="cedula-cell">${fila[1] || 'N/A'}</td>
                            <td class="nombre-cell">${fila[2] || 'N/A'}</td>
                            <td class="estado-cell">
                                <span class="status-badge ${getStatusClass(fila[3])}">
                                    ${fila[3] || 'N/A'}
                                </span>
                            </td>
                            <td class="entrada-cell">${fila[4] || 'N/A'}</td>
                            <td class="salida-cell">${fila[5] || 'N/A'}</td>
                            <td class="duracion-cell">${fila[6] || 'N/A'}</td>
                            <td class="empresa-cell">${fila[7] || 'N/A'}</td>
                        `;
                        
                        // Alternar colores de filas para mejor legibilidad
                        if (index % 2 === 0) {
                            row.classList.add('row-even');
                        }
                        
                        DOM.tablaHistorialBody.appendChild(row);
                    });
                }
                
                const tipoConsulta = esBusquedaGeneral ? 'registros generales' : 'registros espec√≠ficos';
                console.log(`‚úÖ Tabla de historial llenada con ${datos.length} ${tipoConsulta}`);
                
                // Mostrar mensaje informativo sobre la cantidad de registros
                if (esBusquedaGeneral && datos.length > 50) {
                    mostrarHistorialInfo(`Mostrando ${datos.length} registros de todos los usuarios. Los registros est√°n ordenados por fecha m√°s reciente.`);
                }
                
            } else {
                const mensaje = esBusquedaGeneral ? 
                    'No se encontraron registros en el sistema.' : 
                    'No se encontraron registros para esta c√©dula.';
                mostrarHistorialMessage(mensaje, 'info');
            }
        }
        
        function mostrarHistorialInfo(mensaje) {
            // Crear un elemento de informaci√≥n si no existe
            let infoElement = document.getElementById('historialInfo');
            if (!infoElement) {
                infoElement = document.createElement('div');
                infoElement.id = 'historialInfo';
                infoElement.className = 'historial-info';
                infoElement.style.cssText = `
                    background: var(--bg-tertiary);
                    border: 1px solid var(--border);
                    border-radius: var(--radius);
                    padding: var(--space-md);
                    margin-bottom: var(--space-md);
                    color: var(--text-secondary);
                    font-size: 0.875rem;
                    display: flex;
                    align-items: center;
                    gap: var(--space-sm);
                `;
                
                // Insertar antes de la tabla
                const container = DOM.historialTable.parentNode;
                container.insertBefore(infoElement, DOM.historialTable);
            }
            
            infoElement.innerHTML = `
                <i class="fas fa-info-circle" style="color: var(--info);"></i>
                <span>${mensaje}</span>
            `;
            infoElement.style.display = 'flex';
        }
        
        function handleHistorialFailure(error) {
            console.error('‚ùå Error obteniendo historial:', error);
            
            ocultarLoading();
            
            let errorMessage = 'Error desconocido';
            if (error && error.message) {
                errorMessage = error.message;
            } else if (typeof error === 'string') {
                errorMessage = error;
            }
            
            mostrarHistorialMessage('Hubo un error al obtener el historial: ' + errorMessage, 'error');
        }
        

        
        function mostrarHistorialMessage(mensaje, tipo) {
            if (DOM.historialMessage) {
                DOM.historialMessage.style.display = 'block';
                DOM.historialMessage.className = `historial-${tipo}`;
                DOM.historialMessage.innerHTML = `<p>${mensaje}</p>`;
            }
            
            if (DOM.historialTable) {
                DOM.historialTable.style.display = 'none';
            }
        }
        
        function limpiarHistorial() {
            // Limpiar tabla
            if (DOM.tablaHistorialBody) {
                DOM.tablaHistorialBody.innerHTML = '';
            }
            
            // Ocultar elementos
            if (DOM.historialTable) {
                DOM.historialTable.style.display = 'none';
            }
            if (DOM.historialMessage) {
                DOM.historialMessage.style.display = 'none';
            }
            
            // Ocultar elemento de informaci√≥n si existe
            const infoElement = document.getElementById('historialInfo');
            if (infoElement) {
                infoElement.style.display = 'none';
            }
        }
        
        function cerrarHistorial() {
            console.log('üìã Cerrando modal de historial...');
            
            if (DOM.historialModal) {
                DOM.historialModal.classList.remove('show');
            }
            
            if (DOM.menuButton) {
                DOM.menuButton.style.display = 'flex';
            }
            
            limpiarHistorial();
        }
        
        function getStatusClass(estado) {
            if (!estado) return 'status-default';
            
            const estadoLower = estado.toLowerCase();
            if (estadoLower.includes('permitido')) return 'status-permitido';
            if (estadoLower.includes('temporal')) return 'status-temporal';
            if (estadoLower.includes('denegado')) return 'status-denegado';
            
            return 'status-default';
        }

        function mostrarInformacion() {
            mostrarLoading('Cargando informaci√≥n del sistema...');
            google.script.run
                .withSuccessHandler(function(html) {
                    ocultarLoading();
                    if (DOM.vistaPreviaHistorialContenido) DOM.vistaPreviaHistorialContenido.innerHTML = html;
                    if (DOM.vistaPreviaHistorial) DOM.vistaPreviaHistorial.style.display = 'block';
                    if (DOM.menuDropdown) DOM.menuDropdown.classList.remove('show');
                    if (DOM.menuButton) DOM.menuButton.style.display = 'none';

                    applyThemeToElement(DOM.vistaPreviaHistorialContenido, document.body.classList.contains('dark-theme') ? 'dark' : 'light');

                    appendLog({ timestamp: new Date().toISOString(), level: 'INFO', message: 'Informaci√≥n del sistema mostrada', details: {} });
                })
                .withFailureHandler(function(error) {
                    ocultarLoading();
                    showCustomNotification('Error al cargar informaci√≥n: ' + error.message, 'error');
                    appendLog({ timestamp: new Date().toISOString(), level: 'ERROR', message: 'Error cargando informaci√≥n', details: { error: error.message } });
                })
                .mostrarInformacionSistema();
        }

        function cerrarVistaPreviaHistorial() {
            if (DOM.vistaPreviaHistorial) DOM.vistaPreviaHistorial.style.display = 'none';
            if (DOM.menuButton) DOM.menuButton.style.display = 'flex';
        }

        function cambiarTema() {
            const body = document.body;
            const isDark = body.classList.contains('dark-theme');
            if (isDark) {
                body.classList.remove('dark-theme');
                localStorage.setItem('surpass-theme', 'light');
                showCustomNotification('Tema claro activado', 'success');
                applyThemeToAllContent('light');
            } else {
                body.classList.add('dark-theme');
                localStorage.setItem('surpass-theme', 'dark');
                showCustomNotification('Tema oscuro activado', 'success');
                applyThemeToAllContent('dark');
            }
            if (DOM.menuDropdown) DOM.menuDropdown.classList.remove('show');
            appendLog({ timestamp: new Date().toISOString(), level: 'INFO', message: 'Tema cambiado', details: { tema: body.classList.contains('dark-theme') ? 'oscuro' : 'claro' } });
        }

        function applyThemeToAllContent(theme) {
            applyThemeToElement(DOM.contenidoVistaPrevia, theme);
            applyThemeToElement(DOM.vistaPreviaHistorialContenido, theme);
        }

        function applyThemeToElement(element, theme) {
            if (!element) return;

            element.style.backgroundColor = '';
            element.style.color = '';

            if (theme === 'dark' && !element.classList.contains('dark-theme')) {
                element.classList.add('dark-theme');
            } else if (theme === 'light' && element.classList.contains('dark-theme')) {
                element.classList.remove('dark-theme');
            }

            const elementsToStyle = element.querySelectorAll('table, th, td, p, h1, h2, h3, h4, h5, h6, li, span, div, strong, em');
            elementsToStyle.forEach(el => {
                el.style.backgroundColor = '';
                el.style.color = '';
                el.style.borderColor = '';

                if (theme === 'dark') {
                    if (el.tagName.match(/^H[1-6]$/)) {
                        el.style.setProperty('color', '#f0f6fc', 'important');
                    } else if (el.tagName.match(/^(P|DIV|SPAN|LI)$/)) {
                        el.style.setProperty('color', '#d1d9e0', 'important');
                    } else if (el.tagName.match(/^(STRONG|EM)$/)) {
                        el.style.setProperty('color', '#f0f6fc', 'important');
                    } else if (el.tagName.match(/^(TD|TH)$/)) {
                        el.style.setProperty('color', '#d1d9e0', 'important');
                        el.style.setProperty('background-color', 'rgba(21, 25, 30, 0.8)', 'important');
                        el.style.setProperty('border-color', 'rgba(255, 255, 255, 0.15)', 'important');
                    }
                }
            });

            element.offsetHeight;
        }

        // =====================================================
        // =====================================================
        // SISTEMA DE OPTIMIZACI√ìN DE RENDIMIENTO
        // =====================================================
        
        /**
         * Modo de alto rendimiento para el frontend
         * Reduce actualizaciones autom√°ticas y optimiza la interfaz
         */
        window.SurPassPerformance = {
            modoAltoRendimiento: false,
            intervalosActualizacion: {
                estadisticas: null,
                historial: null
            },
            
            /**
             * Activa el modo de alto rendimiento
             */
            activarModoAltoRendimiento: function() {
                this.modoAltoRendimiento = true;
                
                // Reducir frecuencia de actualizaci√≥n de estad√≠sticas
                if (window.statusUpdateInterval) {
                    clearInterval(window.statusUpdateInterval);
                    window.statusUpdateInterval = setInterval(updateStatsPanel, 10000); // Cada 10 segundos en lugar de 5
                }
                
                // Desactivar animaciones CSS costosas temporalmente
                document.body.style.setProperty('--animation-speed', '0s');
                
                console.log('üöÄ Modo de alto rendimiento activado');
                showCustomNotification('Modo de alto rendimiento activado - Procesamiento m√°s r√°pido', 'success');
            },
            
            /**
             * Desactiva el modo de alto rendimiento
             */
            desactivarModoAltoRendimiento: function() {
                this.modoAltoRendimiento = false;
                
                // Restaurar frecuencia normal de actualizaci√≥n
                if (window.statusUpdateInterval) {
                    clearInterval(window.statusUpdateInterval);
                    window.statusUpdateInterval = setInterval(updateStatsPanel, 5000); // Volver a 5 segundos
                }
                
                // Restaurar animaciones
                document.body.style.removeProperty('--animation-speed');
                
                console.log('üé® Modo de alto rendimiento desactivado');
                showCustomNotification('Modo normal restaurado', 'info');
            },
            
            /**
             * Detecta autom√°ticamente si se debe activar modo de alto rendimiento
             */
            detectarRendimiento: function() {
                try {
                    // Detectar dispositivos de bajo rendimiento
                    const esBajoRendimiento = navigator.hardwareConcurrency < 4 || 
                                             navigator.deviceMemory < 4 ||
                                             /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    
                    if (esBajoRendimiento && !this.modoAltoRendimiento) {
                        console.log('‚ö° Dispositivo de bajo rendimiento detectado, activando optimizaciones...');
                        setTimeout(() => {
                            this.activarModoAltoRendimiento();
                        }, 2000);
                    }
                } catch (error) {
                    console.warn('No se pudo detectar capacidad del dispositivo:', error);
                }
            }
        };

        // Funci√≥n global para activar/desactivar modo de alto rendimiento manualmente
        function toggleModoAltoRendimiento() {
            if (window.SurPassPerformance.modoAltoRendimiento) {
                window.SurPassPerformance.desactivarModoAltoRendimiento();
            } else {
                window.SurPassPerformance.activarModoAltoRendimiento();
            }
        }

        // FUNCIONES DE INICIALIZACI√ìN FALTANTES
        // =====================================================

        function initializeTheme() {
            try {
                // Aplicar tema guardado
                const temaGuardado = localStorage.getItem('surpass-theme');
                if (temaGuardado === 'dark') {
                    document.body.classList.add('dark-theme');
                }
                
                // Verificar preferencia del sistema si no hay tema guardado
                if (!temaGuardado && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.body.classList.add('dark-theme');
                    localStorage.setItem('surpass-theme', 'dark');
                }
                
                console.log('‚úÖ Tema inicializado correctamente');
            } catch (error) {
                console.error('Error inicializando tema:', error);
            }
        }

        function initQRScanner() {
            try {
                // Verificar disponibilidad de APIs de c√°mara
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    console.warn('‚ö†Ô∏è APIs de c√°mara no disponibles');
                    return false;
                }
                
                // Inicializar variables globales del esc√°ner
                window.scannerActive = false;
                window.qrProcessing = false;
                if (typeof isScannerActive !== 'undefined') {
                    isScannerActive = false;
                }
                
                console.log('‚úÖ Esc√°ner QR inicializado');
                return true;
            } catch (error) {
                console.error('Error inicializando esc√°ner QR:', error);
                return false;
            }
        }

        function cargarPersonal() {
            google.script.run
                .withSuccessHandler(function(data) {
                    personalGlobal = data;
                    SurPassCache.guardarPersonalEnCache(personalGlobal);
                    console.log("Personal recargado desde servidor:", personalGlobal.length, "registros");
                })
                .withFailureHandler(function(error) {
                    console.error('Error al recargar el personal:', error);
                    showCustomNotification('Error al recargar la lista de personal: ' + error.message, 'error');
                })
                .obtenerTodoElPersonal();
        }

        function finalizarTurno() {
            if (DOM.menuDropdown) DOM.menuDropdown.classList.remove('show');
            showCustomNotification('¬øEst√° seguro de que desea finalizar el turno?', 'warning', true, function(confirm) {
                if (!confirm) return;
                if (!navigator.onLine) {
                    showCustomNotification('No hay conexi√≥n a internet.', 'error');
                    return;
                }
                mostrarLoading('Finalizando turno...');
                google.script.run
                    .withSuccessHandler(function(result) {
                        ocultarLoading();
                        showCustomNotification('Turno finalizado correctamente. Por favor, limpie el historial.', 'success');
                        if (DOM.limpiarHistorialCentral) DOM.limpiarHistorialCentral.style.display = 'block';
                        if (DOM.botonLimpiar) DOM.botonLimpiar.style.display = 'none';
                        appendLog({ timestamp: new Date().toISOString(), level: 'INFO', message: 'Turno finalizado', details: {} });
                    })
                    .withFailureHandler(function(error) {
                        ocultarLoading();
                        showCustomNotification('Error al finalizar turno: ' + error.message, 'error');
                        appendLog({ timestamp: new Date().toISOString(), level: 'ERROR', message: 'Error al finalizar turno', details: { error: error.message } });
                    })
                    .finalizarTurno();
            });
        }

        function limpiarTodo() {
            showCustomNotification('¬øEst√° seguro de que desea limpiar el historial?', 'warning', true, function(confirm) {
                if (!confirm) return;
                limpiarFormularioPrincipal();

                mostrarLoading('Limpiando registros...');
                google.script.run
                    .withSuccessHandler(function(result) {
                        ocultarLoading();
                        if (result.exito) {
                            showCustomNotification(result.mensaje, 'success');
                            if (DOM.limpiarHistorialCentral) DOM.limpiarHistorialCentral.style.display = 'none';
                            if (DOM.botonLimpiar) DOM.botonLimpiar.style.display = 'none';
                            updateStatsPanel();
                            updateLiveHistoryFromStats([]);
                        } else {
                            showCustomNotification(result.mensaje, 'error');
                        }
                        appendLog({ timestamp: new Date().toISOString(), level: 'INFO', message: 'Intento de limpieza de historial', details: { resultado: result.exito } });
                    })
                    .withFailureHandler(function(error) {
                        ocultarLoading();
                        showCustomNotification('Error al limpiar: ' + error.message, 'error');
                        appendLog({ timestamp: new Date().toISOString(), level: 'ERROR', message: 'Error al limpiar historial', details: { error: error.message } });
                    })
                    .limpiarRegistros();
                if (DOM.menuDropdown) DOM.menuDropdown.classList.remove('show');
            });
        }

        function showLogOverlay() {
            if (DOM.logOverlay) DOM.logOverlay.style.display = 'flex';
            if (DOM.menuButton) DOM.menuButton.style.display = 'none';
            if (DOM.menuDropdown) DOM.menuDropdown.classList.remove('show');
        }

        /* === MEN√ö: construcci√≥n din√°mica, overlay y accesibilidad === */
        function buildMenuDropdown() {
            try {
                if (!DOM.menuDropdown) return;

                // Contenido del men√∫ con los IDs esperados por el c√≥digo
                DOM.menuDropdown.innerHTML = `
                    <div class="menu-dropdown-item" id="botonInfo">
                        <div class="nav-item-left"><i class="fas fa-info-circle"></i><span>Informaci√≥n</span></div>
                    </div>
                    <div class="menu-dropdown-item" id="botonHistorial">
                        <div class="nav-item-left"><i class="fas fa-history"></i><span>Historial</span></div>
                    </div>
                    <div class="menu-dropdown-item" id="botonLimpiar">
                        <div class="nav-item-left"><i class="fas fa-broom"></i><span>Limpiar</span></div>
                    </div>
                    <div class="menu-dropdown-item" id="botonFinalizar">
                        <div class="nav-item-left"><i class="fas fa-flag-checkered"></i><span>Finalizar</span></div>
                    </div>

                    <div class="menu-divider"></div>

                    <div class="menu-dropdown-item nav-item-setting">
                        <div class="nav-item-left"><i class="fas fa-chart-line"></i><span>Panel Estad√≠sticas</span></div>
                        <div id="toggleStats" class="switch${mostrarEstadisticas ? ' active' : ''}">
                            <div class="switch-thumb"></div>
                        </div>
                    </div>

                    <div class="menu-dropdown-item nav-item-setting">
                        <div class="nav-item-left"><i class="fas fa-qrcode"></i><span>Modo Esc√°ner</span></div>
                        <div id="toggleScanner" class="switch${useJsQR ? ' active' : ''}">
                            <div class="switch-thumb"></div>
                        </div>
                    </div>

                    <div class="menu-dropdown-item nav-item-setting">
                        <div class="nav-item-left"><i class="fas fa-volume-up"></i><span>Sonidos</span></div>
                        <div id="toggleSounds" class="switch${sonidosActivados ? ' active' : ''}">
                            <div class="switch-thumb"></div>
                        </div>
                    </div>

                    <div class="menu-dropdown-item" id="botonTema">
                        <div class="nav-item-left"><i class="fas fa-adjust"></i><span>Cambiar Tema</span></div>
                    </div>

                    <div class="menu-dropdown-item" id="botonLogs">
                        <div class="nav-item-left"><i class="fas fa-terminal"></i><span>Logs</span></div>
                    </div>

                    <div class="menu-divider"></div>

                    <div class="menu-dropdown-item highlighted" id="botonEvacuacion">
                        <div class="nav-item-left"><i class="fas fa-exclamation-triangle"></i><strong>Modo Evacuaci√≥n</strong></div>
                    </div>
                    <div class="menu-dropdown-item" id="botonSimulacros">
                        <div class="nav-item-left"><i class="fas fa-theater-masks"></i><span>Simulacros</span></div>
                    </div>

                    <button class="menu-close-button" id="menuCloseBtn">Cerrar</button>
                `;

                // Wire up eventos sin duplicar
                const safeOn = (id, handler) => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    el.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        handler();
                        closeMenu();
                    };
                };

                safeOn('botonInfo', mostrarInformacion);
                safeOn('botonHistorial', abrirHistorial);
                safeOn('botonLimpiar', limpiarTodo);
                safeOn('botonFinalizar', finalizarTurno);
                safeOn('botonTema', cambiarTema);
                safeOn('botonLogs', showLogOverlay);
                safeOn('botonEvacuacion', mostrarEvacuacionChecklist);
                safeOn('botonSimulacros', consultarSimulacrosExistentes);

                // Toggles (no cerrar el men√∫ al pulsar un switch)
                const toggleStats = document.getElementById('toggleStats');
                const toggleScanner = document.getElementById('toggleScanner');
                const toggleSounds = document.getElementById('toggleSounds');

                if (toggleStats) {
                    toggleStats.onclick = (e) => {
                        e.preventDefault(); e.stopPropagation();
                        togglePanelEstadisticas();
                        toggleStats.classList.toggle('active', mostrarEstadisticas);
                    };
                }
                if (toggleScanner) {
                    toggleScanner.onclick = (e) => {
                        e.preventDefault(); e.stopPropagation();
                        switchQRMode();
                        setTimeout(() => {
                            toggleScanner.classList.toggle('active', useJsQR);
                        }, 100);
                    };
                }
                if (toggleSounds) {
                    toggleSounds.onclick = (e) => {
                        e.preventDefault(); e.stopPropagation();
                        if (typeof toggleSonidos === 'function') toggleSonidos();
                        toggleSounds.classList.toggle('active', sonidosActivados);
                    };
                }

                const closeBtn = document.getElementById('menuCloseBtn');
                if (closeBtn) {
                    closeBtn.onclick = (e) => { e.preventDefault(); e.stopPropagation(); closeMenu(); };
                }
            } catch (e) {
                console.error('Error construyendo men√∫:', e);
            }
        }

        function openMenu() {
            if (DOM.menuDropdown) DOM.menuDropdown.classList.add('show');
            const overlay = document.getElementById('menuOverlay');
            if (overlay) overlay.classList.add('show');
            if (DOM.menuButton) DOM.menuButton.setAttribute('aria-expanded', 'true');
        }
        
        function closeMenu() {
            if (DOM.menuDropdown) DOM.menuDropdown.classList.remove('show');
            const overlay = document.getElementById('menuOverlay');
            if (overlay) overlay.classList.remove('show');
            if (DOM.menuButton) DOM.menuButton.setAttribute('aria-expanded', 'false');
        }
        
        function toggleMenu() {
            if (!DOM.menuDropdown) return;
            const isOpen = DOM.menuDropdown.classList.contains('show');
            if (isOpen) closeMenu(); else openMenu();
        }

        // Inicializaci√≥n del men√∫ UI
        (function initMenuUI() {
            // Construir men√∫ al inicio
            setTimeout(() => {
                buildMenuDropdown();
            }, 100);

            // Overlay click
            const overlay = document.getElementById('menuOverlay');
            if (overlay) {
                overlay.onclick = (e) => { if (e.target === overlay) closeMenu(); };
            }

            // Escape para cerrar
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeMenu();
            });
        })();

        function aplicarIdioma() {
            const language = localStorage.getItem('surpass-language') || 'es';
            const traducciones = {
                es: {
                    title: 'SurPass - Control de Acceso',
                    placeholderCedula: 'Ingrese c√©dula o nombre',
                    entrada: 'Entrada',
                    salida: 'Salida',
                    registrar: 'Registrar',
                    informacion: 'Informaci√≥n',
                    historial: 'Historial',
                    limpiar: 'Limpiar',
                    finalizar: 'Finalizar',
                    opcion_estadisticas: 'Panel Estad√≠sticas',
                    opcion_escaner: 'Escaner Nativo',
                    tema: 'Cambiar Tema',
                    logs: 'Logs',
                    evacuacion: 'Modo Evacuaci√≥n'
                },
                en: {
                    title: 'SurPass - Access Control',
                    placeholderCedula: 'Enter ID or name',
                    entrada: 'Entry',
                    salida: 'Exit',
                    registrar: 'Register',
                    informacion: 'Information',
                    historial: 'History',
                    limpiar: 'Clear',
                    finalizar: 'Finish',
                    opcion_estadisticas: 'Statistics Panel',
                    opcion_escaner: 'Native Scan',
                    tema: 'Change Theme',
                    logs: 'Logs',
                    evacuacion: 'Evacuation Mode'
                }
            };

            document.title = traducciones[language].title;
            if (DOM.cedulaInput) DOM.cedulaInput.placeholder = traducciones[language].placeholderCedula;

            if (DOM.radioLabels.length >= 2) {
                DOM.radioLabels[0].textContent = traducciones[language].entrada;
                DOM.radioLabels[1].textContent = traducciones[language].salida;
            }
            if (DOM.submitButton) DOM.submitButton.value = traducciones[language].registrar;
            if (DOM.botonEvacuacion) {
                const strongElement = DOM.botonEvacuacion.querySelector('strong');
                if (strongElement) {
                    strongElement.textContent = traducciones[language].evacuacion;
                }
            }
            const menuItems = {
                'botonInfo': 'informacion',
                'botonHistorial': 'historial',
                'botonLimpiar': 'limpiar',
                'botonFinalizar': 'finalizar',
                'botonToggleEstadisticas': 'opcion_estadisticas',
                'botonCambiarEscaner': 'opcion_escaner',
                'botonTema': 'tema',
                'botonLogs': 'logs'
            };
            for (const id in menuItems) {
                const element = document.getElementById(id);
                if (element) {
                    const span = element.querySelector('span');
                    if (span) span.textContent = traducciones[language][menuItems[id]];
                }
            }
        }

        // =====================================================
        // PARTE 13: INICIALIZACI√ìN DEL DOM Y EVENT LISTENERS
        // =====================================================

        console.log('üöÄ Iniciando SurPass - Sistema Unificado v3.0');

        // Inicializaci√≥n de conexi√≥n
        actualizarEstadoConexion();
        window.addEventListener('online', actualizarEstadoConexion);
        window.addEventListener('offline', actualizarEstadoConexion);

        // Inicializaci√≥n de gesti√≥n de sonidos
        gestionarSonidos();

        // Asignar Event Listeners principales
        if (DOM.menuButton) DOM.menuButton.addEventListener('click', toggleMenu);
        
        // Los dem√°s event listeners del men√∫ se manejan en buildMenuDropdown()
        // Solo mantenemos los que no est√°n en el men√∫
        if (DOM.limpiarHistorialCentral) DOM.limpiarHistorialCentral.addEventListener('click', limpiarTodo);
        if (DOM.closeLogOverlayButton) {
            DOM.closeLogOverlayButton.addEventListener('click', function() {
                if (DOM.logOverlay) DOM.logOverlay.style.display = 'none';
                if (DOM.menuButton) DOM.menuButton.style.display = 'flex';
            });
        }
        if (DOM.qrButton) {
            DOM.qrButton.addEventListener('click', async function() {
                try {
                    // Si ya est√° activo, cerrar normalmente
                    if (isScannerActive) {
                        cerrarEscanerQR();
                        return;
                    }
                    
                    // Intentar iniciar esc√°ner
                    await iniciarEscanerQR();
                    
                } catch (error) {
                    console.error("‚ùå Error al iniciar esc√°ner QR:", error);
                    
                    // Si hay error, intentar reinicio completo de c√°mara
                    showCustomNotification('Problema con la c√°mara, reiniciando...', 'warning');
                    
                    try {
                        await reiniciarCamara();
                        // Reintentar despu√©s del reinicio
                        setTimeout(async () => {
                            try {
                                await iniciarEscanerQR();
                                showCustomNotification('‚úÖ C√°mara reiniciada correctamente', 'success');
                            } catch (retryError) {
                                console.error("‚ùå Error despu√©s de reiniciar c√°mara:", retryError);
                                showCustomNotification('‚ùå No se puede acceder a la c√°mara. Verifique permisos.', 'error');
                            }
                        }, 500);
                    } catch (restartError) {
                        console.error("‚ùå Error reiniciando c√°mara:", restartError);
                        showCustomNotification('‚ùå Error cr√≠tico con la c√°mara', 'error');
                    }
                }
            });
        }
        if (DOM.qrCloseButton) DOM.qrCloseButton.addEventListener('click', cerrarEscanerQR);
        if (DOM.limpiarCedulaButton) DOM.limpiarCedulaButton.addEventListener('click', limpiarCampoCedula);
        if (DOM.logCloseButton) {
            DOM.logCloseButton.addEventListener('click', function() {
                if (DOM.logOverlay) DOM.logOverlay.style.display = 'none';
                if (DOM.menuButton) DOM.menuButton.style.display = 'flex';
            });
        }
        // ELIMINADO: DOM.botonEvacuacion addEventListener para evitar duplicaci√≥n (se maneja m√°s abajo con onclick)
        if (DOM.cerrarEvacuacionModalBtn) DOM.cerrarEvacuacionModalBtn.addEventListener('click', cerrarEvacuacionChecklist);
        if (DOM.btnCerrarEvacuacion) DOM.btnCerrarEvacuacion.addEventListener('click', cerrarEvacuacionChecklist);
        if (DOM.btnVolverEvacuacion) DOM.btnVolverEvacuacion.addEventListener('click', volverEnEvacuacion);
        
        // Event listeners para el modal de historial
        if (DOM.historialModalClose) DOM.historialModalClose.addEventListener('click', cerrarHistorial);
        if (DOM.historialModal) {
            DOM.historialModal.addEventListener('click', function(e) {
                if (e.target === DOM.historialModal) {
                    cerrarHistorial();
                }
            });
        }

        // Event listeners para toggles del men√∫
        const toggleStats = document.getElementById('toggleStats');
        const toggleScanner = document.getElementById('toggleScanner');  
        const toggleSounds = document.getElementById('toggleSounds');

        if (toggleStats) {
            toggleStats.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                togglePanelEstadisticas();
            });
        }

        if (toggleSounds) {
            toggleSounds.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                if (typeof toggleSonidos === 'function') {
                    toggleSonidos();
                }
            });
        }

        // Event listeners para modales de comentarios - CORREGIDOS
        const cancelComment = document.getElementById('cancelComment');
        const commentForm = document.getElementById('commentForm');
        const closeCommentModal = document.getElementById('closeCommentModal');
        
        if (cancelComment) cancelComment.addEventListener('click', cerrarModalComentario);
        if (closeCommentModal) closeCommentModal.addEventListener('click', cerrarModalComentario);
        if (commentForm) {
            commentForm.addEventListener('submit', function(e) {
                e.preventDefault();
                procesarComentarioModal();
            });
        }

        // Modal de comentario personalizado (persona no registrada)
        const cancelCustomComment = document.getElementById('cancelCustomComment');
        const customCommentForm = document.getElementById('customCommentForm');
        
        if (cancelCustomComment) cancelCustomComment.addEventListener('click', cerrarModalComentarioPersonalizado);
        if (customCommentForm) {
            customCommentForm.addEventListener('submit', function(e) {
                e.preventDefault();
                procesarComentarioPersonalizado();
            });
        }

        // Cerrar modales con click en overlay
        if (DOM.commentModal) {
            DOM.commentModal.addEventListener('click', function(e) {
                if (e.target === DOM.commentModal) {
                    cerrarModalComentario();
                }
            });
        }

        if (DOM.customCommentModal) {
            DOM.customCommentModal.addEventListener('click', function(e) {
                if (e.target === DOM.customCommentModal) {
                    cerrarModalComentarioPersonalizado();
                }
            });
        }

        // Cerrar modal de notificaci√≥n personalizada con click en overlay
        if (DOM.customNotificationModal) {
            DOM.customNotificationModal.addEventListener('click', function(e) {
                if (e.target === DOM.customNotificationModal) {
                    DOM.customNotificationModal.classList.remove('show');
                }
            });
        }

        // Formulario principal
        if (DOM.accessForm) {
            DOM.accessForm.addEventListener('submit', function(event) {
                event.preventDefault();
                enviarFormulario();
            });
        }

        // Input de c√©dula
        if (DOM.cedulaInput) {
            DOM.cedulaInput.addEventListener('input', function() {
                if (formularioBloqueado) return;
                
                // Limpiar tarjeta de informaci√≥n al cambiar c√©dula
                hidePersonInfoCard();
                
                clearTimeout(timeoutIdCedula);
                timeoutIdCedula = setTimeout(() => {
                    buscarCedulas(this.value);
                }, 300);
                if (DOM.limpiarCedulaButton) {
                    DOM.limpiarCedulaButton.style.display = this.value ? 'block' : 'none';
                }
            });

            // Navegaci√≥n con teclado en autocompletado
            DOM.cedulaInput.addEventListener('keydown', function(e) {
                if (!DOM.cedulaSuggestions.classList.contains('show')) return;

                switch(e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        navigateSuggestions('down');
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        navigateSuggestions('up');
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (selectedSuggestionIndex >= 0) {
                            selectCurrentSuggestion();
                        }
                        break;
                    case 'Escape':
                        e.preventDefault();
                        closeSuggestions();
                        break;
                }
            });
        }

        // Botones de cerrar vistas previas
        const cerrarVistaPreviaBtn = document.querySelector('#vistaPrevia .btn-regresar');
        if (cerrarVistaPreviaBtn) {
            cerrarVistaPreviaBtn.addEventListener('click', cerrarVistaPrevia);
        }
        const cerrarVistaPreviaHistorialBtn = document.querySelector('#vistaPreviaHistorial .btn-regresar');
        if (cerrarVistaPreviaHistorialBtn) {
            cerrarVistaPreviaHistorialBtn.addEventListener('click', cerrarVistaPreviaHistorial);
        }

        // Click outside handlers para cerrar sugerencias y men√∫
        document.addEventListener('click', function(event) {
            if (DOM.cedulaInput && DOM.cedulaSuggestions && event.target !== DOM.cedulaInput && !DOM.cedulaSuggestions.contains(event.target)) {
                DOM.cedulaSuggestions.classList.remove('show');
            }
            if (DOM.menuDropdown && DOM.menuButton && event.target !== DOM.menuButton && !DOM.menuButton.contains(event.target) && !DOM.menuDropdown.contains(event.target) && DOM.menuDropdown.classList.contains('show')) {
                closeMenu(); // usar la funci√≥n completa en lugar de solo remover la clase
            }
        });

        // Funci√≥n espec√≠fica para actualizar lista de evacuaci√≥n
        function actualizarListaEvacuacion() {
            console.log('üîÑ Actualizando lista de evacuaci√≥n...');
            
            // Prevenir m√∫ltiples llamadas simult√°neas
            if (window.actualizandoEvacuacion) {
                console.log('‚ö†Ô∏è Ya se est√° actualizando la lista de evacuaci√≥n, ignorando llamada duplicada');
                return;
            }
            window.actualizandoEvacuacion = true;
            
            mostrarLoading('Actualizando lista...');

            google.script.run
                .withSuccessHandler(function(datosEvacuacion) {
                    window.actualizandoEvacuacion = false;
                    ocultarLoading();
                    
                    if (datosEvacuacion && datosEvacuacion.success) {
                        evacuationData = datosEvacuacion;
                        renderEvacuationListModern(datosEvacuacion.personasDentro);
                        if (DOM.totalPersonasDentro) DOM.totalPersonasDentro.textContent = datosEvacuacion.totalDentro;
                        if (DOM.horaVerificacion) {
                            DOM.horaVerificacion.textContent = new Date().toLocaleTimeString('es-PA');
                        }
                        console.log('‚úÖ Lista de evacuaci√≥n actualizada');
                    } else {
                        showCustomNotification('Error al actualizar: ' + (datosEvacuacion?.message || 'Error desconocido'), 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    window.actualizandoEvacuacion = false;
                    ocultarLoading();
                    console.error('‚ùå Error actualizando lista:', error);
                    showCustomNotification('Error de conexi√≥n al actualizar lista', 'error');
                })
                .getEvacuacionDataForClient();
        }

        // Hora de verificaci√≥n
        if (DOM.horaVerificacion) {
            DOM.horaVerificacion.textContent = new Date().toLocaleTimeString('es-PA');
        }
        if (DOM.btnActualizarLista) {
            DOM.btnActualizarLista.addEventListener('click', function() {
                actualizarListaEvacuacion();
            });
        }

        // Cerrar esc√°ner QR con bot√≥n flotante
        const qrCloseButtonFloat = document.querySelector('.qr-close-button');
        if (qrCloseButtonFloat) {
            qrCloseButtonFloat.addEventListener('click', cerrarEscanerQR);
        }

        // =====================================================
    // GESTI√ìN DE SELECCI√ìN DE BOTONES ENTRADA/SALIDA
    // =====================================================

    function configurarBotonesAcceso() {
        const accessOptions = document.querySelectorAll('.access-option');
        const radioInputs = document.querySelectorAll('input[name="respuesta"]');

        // Limpiar listeners previos de manera segura
        accessOptions.forEach(option => {
            const newOption = option.cloneNode(true);
            if (option.parentNode) {
                option.parentNode.replaceChild(newOption, option);
            }
        });

        // Configurar nuevos listeners
        const newAccessOptions = document.querySelectorAll('.access-option');
        const newRadioInputs = document.querySelectorAll('input[name="respuesta"]');

        newAccessOptions.forEach(option => {
            option.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                if (formularioBloqueado) return;
                
                const radio = this.querySelector('input[type="radio"]');
                if (radio) {
                    // Desmarcar todos
                    newAccessOptions.forEach(opt => opt.classList.remove('selected'));
                    newRadioInputs.forEach(r => r.checked = false);
                    
                    // Marcar el seleccionado
                    radio.checked = true;
                    this.classList.add('selected');
                    
                    // Ocultar error si existe
                    if (DOM.radioError) DOM.radioError.style.display = 'none';
                    
                    // Mostrar tarjeta de informaci√≥n si hay usuario seleccionado
                    const cedulaValue = DOM.cedulaInput?.value?.trim();
                    if (cedulaValue && cedulaValue !== '') {
                        const personaEncontrada = personalGlobal.find(p => 
                            p && p.cedula && (
                                p.cedula === cedulaValue || 
                                p.cedula.toLowerCase() === cedulaValue.toLowerCase() ||
                                (p.nombre && p.nombre.toLowerCase().includes(cedulaValue.toLowerCase()))
                            )
                        );
                        
                        if (personaEncontrada && personaEncontrada.cedula) {
                            // Usar la nueva funci√≥n con comentario
                            showPersonInfoCardWithComment(personaEncontrada, radio.value);
                        }
                    }
                    
                    console.log(`‚úÖ Opci√≥n seleccionada: ${radio.value}`);
                }
            });
        });

        // Listener para cambios directos en radio buttons
        newRadioInputs.forEach(radio => {
            radio.addEventListener('change', function(e) {
                if (this.checked && !formularioBloqueado) {
                    newAccessOptions.forEach(opt => opt.classList.remove('selected'));
                    const parentOption = this.closest('.access-option');
                    if (parentOption) {
                        parentOption.classList.add('selected');
                    }
                    if (DOM.radioError) DOM.radioError.style.display = 'none';
                    
                    // Mostrar tarjeta con informaci√≥n del usuario
                    const cedulaValue = DOM.cedulaInput?.value?.trim();
                    if (cedulaValue && cedulaValue !== '') {
                        const personaEncontrada = personalGlobal.find(p => 
                            p && p.cedula && p.cedula === cedulaValue
                        );
                        
                        if (personaEncontrada && personaEncontrada.cedula) {
                            showPersonInfoCardWithComment(personaEncontrada, this.value);
                        }
                    }
                }
            });
        });

        console.log('‚úÖ Botones de acceso configurados correctamente con tarjetas mejoradas');
    }

        // =====================================================
        // INICIALIZACI√ìN DE COMPONENTES AL CARGAR EL DOM
        // =====================================================
        try {
            // Panel estad√≠sticas arrastrable
            makeStatsPanelDraggable();
            // Configurar botones de entrada/salida
            configurarBotonesAcceso();

            // Asegurarse de que el esc√°ner est√© cerrado al inicio
            if (typeof html5QrCodeScanner !== 'undefined' && html5QrCodeScanner) {
                cerrarEscanerQR();
            }

            mostrarLoading('Cargando datos...');
            if (DOM.cedulaInput) DOM.cedulaInput.disabled = true;
            const personalCache = SurPassCache.obtenerPersonalDesdeCache();
            if (personalCache && personalCache.length > 0) {
                personalGlobal = personalCache;
                console.log("Personal cargado desde cach√©:", personalGlobal.length, "registros");
                ocultarLoading();
                if (DOM.cedulaInput) DOM.cedulaInput.disabled = false;
            }

            const temaGuardado = localStorage.getItem('surpass-theme');
            if (temaGuardado === 'dark') {
                document.body.classList.add('dark-theme');
            }

            // Cargar datos del personal desde el servidor
            google.script.run
                .withSuccessHandler(function(personal) {
                    personalGlobal = personal;
                    console.log("Personal actualizado desde servidor:", personalGlobal.length, "registros");
                    SurPassCache.guardarPersonalEnCache(personal);
                    ocultarLoading();
                    if (DOM.cedulaInput) DOM.cedulaInput.disabled = false;

                    if (!window.statsInitialized) {
                        initializeStatsSystem();
                    }
                    if (navigator.onLine) {
                        procesarPendientes();
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Error al cargar el personal desde el servidor:', error);
                    if (personalCache && personalCache.length > 0) {
                        showCustomNotification('No se pudo actualizar la base de datos. Usando datos en cach√©.', 'warning');
                    } else {
                        showCustomNotification('Error al cargar el personal: ' + error.message, 'error');
                    }
                    ocultarLoading();
                    if (DOM.cedulaInput) DOM.cedulaInput.disabled = false;
                })
                .obtenerTodoElPersonal();

            // Cargar opciones del men√∫ desde el servidor
            google.script.run
                .withSuccessHandler(function(opciones) {
                    mostrarEstadisticas = opciones.mostrarEstadisticas || true;
                    useJsQR = opciones.usarJsQR || false;
                    sonidosActivados = opciones.hasOwnProperty('sonidosActivados') ? opciones.sonidosActivados : true;
                    
                    // Verificar si hay configuraci√≥n autom√°tica guardada
                    const autoScanner = localStorage.getItem('surpass-autoScanner');
                    if (autoScanner) {
                        try {
                            const config = JSON.parse(autoScanner);
                            const tiempoTranscurrido = Date.now() - config.timestamp;
                            const unaHora = 60 * 60 * 1000; // 1 hora en milisegundos
                            
                            // Si la configuraci√≥n autom√°tica es reciente (menos de 1 hora), usarla
                            if (tiempoTranscurrido < unaHora) {
                                useJsQR = config.useJsQR;
                                console.log(`üì± Usando configuraci√≥n autom√°tica: ${useJsQR ? 'jsQR' : 'HTML5-QRCode'} (${config.razon})`);
                            } else {
                                console.log('‚è∞ Configuraci√≥n autom√°tica expirada, usando configuraci√≥n del servidor');
                            }
                        } catch (e) {
                            console.warn('Error parseando configuraci√≥n autom√°tica:', e);
                        }
                    }
                    
                    localStorage.setItem('surpass-sounds', sonidosActivados.toString());
                    actualizarVisibilidadEstadisticas();
                    actualizarEstadoEscaner();
                    if (typeof window.actualizarEstadoSonidos === 'function') {
                        window.actualizarEstadoSonidos();
                    }
                    console.log('Opciones cargadas:', { mostrarEstadisticas, useJsQR, sonidosActivados });
                })
                .withFailureHandler(function(error) {
                    console.error('Error al cargar opciones del men√∫:', error);
                    sonidosActivados = localStorage.getItem('surpass-sounds') !== 'false';
                    if (typeof window.actualizarEstadoSonidos === 'function') {
                        window.actualizarEstadoSonidos();
                    }
                    showCustomNotification('No se pudieron cargar las opciones del servidor. Usando configuraci√≥n local.', 'warning');
                })
                .obtenerOpcionesMenu();

            // Inicializar estad√≠sticas como respaldo si no se inicializaron antes
            setTimeout(() => {
                if (!window.statsInitialized) {
                    console.log('üîÑ Inicializando estad√≠sticas como respaldo...');
                    initializeStatsSystem();
                }
            }, 2000);

            // Funci√≥n temporal de debug para estad√≠sticas (solo para testing)
            window.debugEstadisticas = function() {
                console.log('üîß Iniciando debug de estad√≠sticas...');
                
                google.script.run
                    .withSuccessHandler(function(resultado) {
                        console.log('‚úÖ Resultado del diagn√≥stico:', resultado);
                        if (resultado.exito) {
                            const msg = `Diagn√≥stico exitoso:\n` +
                                        `- Hoja: ${resultado.diagnostico.hojaRegistro ? 'Encontrada' : 'No encontrada'}\n` +
                                        `- Registros: ${resultado.diagnostico.totalFilas}\n` +
                                        `- Entradas: ${resultado.diagnostico.estadisticas.entradas}\n` +
                                        `- Salidas: ${resultado.diagnostico.estadisticas.salidas}\n` +
                                        `- Personas dentro: ${resultado.diagnostico.estadisticas.personasDentro}`;
                            if (typeof showCustomNotification === 'function') {
                                showCustomNotification(msg, 'info');
                            } else {
                                console.info(msg);
                            }
                        } else {
                            if (typeof showCustomNotification === 'function') {
                                showCustomNotification(`Error en diagn√≥stico: ${resultado.error}`, 'error');
                            } else {
                                console.error(`Error en diagn√≥stico: ${resultado.error}`);
                            }
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('‚ùå Error en debug:', error);
                        if (typeof showCustomNotification === 'function') {
                            showCustomNotification('Error ejecutando diagn√≥stico: ' + error.message, 'error');
                        } else {
                            console.error('Error ejecutando diagn√≥stico: ' + error.message);
                        }
                    })
                    .diagnosticarEstadisticas();
            };

            // Funci√≥n para reinicializar estad√≠sticas manualmente
            window.reiniciarEstadisticas = function() {
                console.log('üîÑ Reiniciando sistema de estad√≠sticas manualmente...');
                
                // Limpiar intervalo actual
                if (updateStatsInterval) {
                    clearInterval(updateStatsInterval);
                    updateStatsInterval = null;
                }
                
                window.statsInitialized = false;
                
                // Mostrar mensaje de reinicio
                if (DOM.entradasLiveSpan) DOM.entradasLiveSpan.textContent = '...';
                if (DOM.salidasLiveSpan) DOM.salidasLiveSpan.textContent = '...';
                if (DOM.personasDentroLiveSpan) DOM.personasDentroLiveSpan.textContent = '...';
                
                // Reinicializar despu√©s de un breve retraso
                setTimeout(() => {
                    initializeStatsSystem();
                    if (typeof showCustomNotification === 'function') {
                        showCustomNotification('Sistema de estad√≠sticas reiniciado', 'success');
                    } else {
                        console.info('Sistema de estad√≠sticas reiniciado');
                    }
                }, 1000);
            };

            // Agregar comando debug en consola
            console.log('üîß Debug disponible: ejecuta debugEstadisticas() en la consola');
            console.log('üîÑ Reinicio disponible: ejecuta reiniciarEstadisticas() en la consola');

            // Aplicar tema a los contenedores de contenido si ya tienen contenido
            applyThemeToAllContent(document.body.classList.contains('dark-theme') ? 'dark' : 'light');
            aplicarIdioma(); // Aplicar idioma al cargar

            // Enfocar el campo de c√©dula al cargar
            setTimeout(() => {
                if (DOM.cedulaInput && !DOM.cedulaInput.disabled) {
                    DOM.cedulaInput.focus();
                    console.log('üéØ Campo de c√©dula enfocado al cargar la aplicaci√≥n');
                }
            }, 500);

        } catch (initError) {
            console.error('Error en inicializaci√≥n general:', initError);
            ocultarLoading();
            showCustomNotification('Error al inicializar el sistema: ' + initError.message, 'error');
            // Asegurar que el campo de c√©dula est√© habilitado incluso si hay error
            if (DOM.cedulaInput) {
                DOM.cedulaInput.disabled = false;
                DOM.cedulaInput.focus();
            }
        }

        // Optimizaci√≥n de rendimiento: precargar datos cr√≠ticos
    /**
     * Precarga datos cr√≠ticos del sistema para mejorar la experiencia de usuario
     * Esta funci√≥n implementa carga progresiva con prioridades
     */
    async function precargarDatosCriticos() {
        try {
            console.log('ÔøΩ Iniciando precarga de datos cr√≠ticos...');
            mostrarLoading('Inicializando sistema...', 'important');
            
            // PASO 1: Inicializar configuraci√≥n del sistema (prioridad alta)
            console.log('üîÑ PASO 1: Inicializando configuraci√≥n del sistema...');
            const configResult = await new Promise((resolve) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler((error) => {
                        console.error('‚ùå Error inicializando configuraci√≥n:', error);
                        resolve({ success: false, error });
                    })
                    .inicializarConfiguracionSistema();
            });
            
            if (configResult && configResult.success) {
                console.log('‚úÖ Configuraci√≥n inicializada correctamente');
            } else {
                console.warn('‚ö†Ô∏è Problema inicializando configuraci√≥n:', configResult);
            }
            
            // PASO 2: Inicializar tema y elementos visuales (prioridad alta)
            console.log('üîÑ PASO 2: Inicializando tema y elementos visuales...');
            initializeTheme();
            
            // PASO 3: Cargar estad√≠sticas iniciales (prioridad media)
            console.log('üîÑ PASO 3: Cargando estad√≠sticas iniciales...');
            mostrarLoading('Cargando estad√≠sticas...', 'normal');
            if (!window.statsInitialized) {
                await new Promise((resolve) => {
                    initializeStatsSystem();
                    setTimeout(resolve, 500);
                });
            }
            
            // PASO 4: Inicializar esc√°ner QR si est√° disponible (prioridad media)
            console.log('üîÑ PASO 4: Inicializando esc√°ner QR...');
            if (typeof initQRScanner === 'function') {
                initQRScanner();
            }
            
            // PASO 5: Cargar datos de personal (prioridad baja)
            console.log('üîÑ PASO 5: Cargando datos de personal en segundo plano...');
            setTimeout(() => {
                if (navigator.onLine) {
                    google.script.run
                        .withSuccessHandler(function(personal) {
                            if (personal && personal.length > 0) {
                                personalGlobal = personal;
                                SurPassCache.guardarPersonalEnCache(personal);
                                console.log(`‚úÖ Datos de personal cargados: ${personal.length} registros`);
                            }
                        })
                        .obtenerTodoElPersonal();
                }
            }, 2000);
            
            // PASO 6: Finalizar inicializaci√≥n y activar optimizaciones
            console.log('‚úÖ Precarga de datos cr√≠ticos completada');
            ocultarLoading();
            
            // Detectar autom√°ticamente si se necesita modo de alto rendimiento
            if (window.SurPassPerformance) {
                window.SurPassPerformance.detectarRendimiento();
            }
            
            // Establecer intervalos de actualizaci√≥n autom√°tica
            
            // Optimizar el cache del personal cada 5 minutos
            setInterval(() => {
                if (navigator.onLine && personalGlobal.length > 0) {
                    google.script.run
                        .withSuccessHandler(function(personal) {
                            if (personal && personal.length > 0) {
                                personalGlobal = personal;
                                SurPassCache.guardarPersonalEnCache(personal);
                                console.log('üîÑ Cache de personal actualizado autom√°ticamente');
                            }
                        })
                        .withFailureHandler(function(error) {
                            console.warn('‚ö†Ô∏è Error actualizando cache autom√°tico:', error);
                        })
                        .obtenerTodoElPersonal();
                }
            }, 300000); // 5 minutos
            
            // Limpiar logs antiguos del frontend cada hora
            setInterval(() => {
                if (DOM.logContent && DOM.logContent.children.length > 100) {
                    const logs = Array.from(DOM.logContent.children);
                    logs.slice(0, logs.length - 50).forEach(log => log.remove());
                    console.log('üßπ Logs del frontend limpiados autom√°ticamente');
                }
            }, 3600000); // 1 hora
            
        } catch (error) {
            console.error('‚ùå Error en precarga de datos cr√≠ticos:', error);
        }
    }

    // Ejecutar precarga
    precargarDatosCriticos();

    // Optimizaci√≥n de memoria: limpiar referencias no utilizadas
    window.addEventListener('beforeunload', function() {
        // Detener TODOS los MediaStreams antes de salir
        detenerTodosLosStreams();
        
        if (html5QrCodeScanner) {
            try {
                html5QrCodeScanner.clear();
            } catch (e) {
                console.warn('Error limpiando esc√°ner:', e);
            }
        }
        
        // Limpiar intervalos
        if (updateStatsInterval) {
            clearInterval(updateStatsInterval);
        }
    });

    // Sistema listo para producci√≥n - sin datos de prueba
    console.log('‚úÖ Sistema SurPass V6 inicializado correctamente');

        // Optimizaciones de memoria
        // Limpieza de registros de log en el frontend cada hora para evitar consumo excesivo de memoria
        const optimizacionMemoriaInterval = setInterval(() => {
            try {
                // Limpiar logs del frontend si son demasiados
                if (DOM.liveHistoryBody && DOM.liveHistoryBody.children.length > 100) {
                    console.log('üßπ Optimizando memoria: Limpiando exceso de logs en frontend...');
                    const logs = Array.from(DOM.liveHistoryBody.children);
                    logs.slice(0, logs.length - 50).forEach(log => log.remove());
                }
                
                // Limpiar cach√© de sugerencias si es demasiado grande
                if (window.cedulasSugeridas && window.cedulasSugeridas.length > 200) {
                    window.cedulasSugeridas = window.cedulasSugeridas.slice(-100);
                }
                
                // Comprobar uso de memoria si el navegador lo soporta
                if (window.performance && window.performance.memory) {
                    const memoryInfo = window.performance.memory;
                    const usedHeapSizeMB = Math.round(memoryInfo.usedJSHeapSize / (1024 * 1024));
                    const totalHeapSizeMB = Math.round(memoryInfo.totalJSHeapSize / (1024 * 1024));
                    
                    console.log(`üìä Uso de memoria: ${usedHeapSizeMB}MB / ${totalHeapSizeMB}MB`);
                    
                    // Si el uso de memoria es alto, forzar limpieza m√°s agresiva
                    if (usedHeapSizeMB > totalHeapSizeMB * 0.8) {
                        console.warn('‚ö†Ô∏è Uso de memoria alto, forzando limpieza...');
                        if (window.gc) window.gc(); // Force garbage collection if available
                        
                        // Limpiar variables grandes que pueden ser reconstruidas
                        if (window.personalGlobal && window.personalGlobal.length > 100) {
                            window.personalGlobal = window.personalGlobal.slice(-50);
                        }
                    }
                }
            } catch (error) {
                console.error('‚ùå Error en optimizaci√≥n de memoria:', error);
            }
        }, 3600000); // Cada hora (3600000ms)

        // Limpiar recursos antes de cerrar la p√°gina
        window.addEventListener('beforeunload', function() {
            // Detener intervalos
            if (window.statusUpdateInterval) clearInterval(window.statusUpdateInterval);
            if (window.chartUpdateInterval) clearInterval(window.chartUpdateInterval);
            if (optimizacionMemoriaInterval) clearInterval(optimizacionMemoriaInterval);
            
            // Liberar recursos de gr√°ficos
            if (window.personChart) window.personChart.clearChart();
            if (window.miniChart) window.miniChart.clearChart();
            
            // Desregistrar event listeners principales
            if (DOM.cedulaInput) DOM.cedulaInput.onkeyup = null;
            if (DOM.btnEntry) DOM.btnEntry.onclick = null;
            if (DOM.btnExit) DOM.btnExit.onclick = null;
        });

        // Manejo de visibilidad de la p√°gina para la c√°mara
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // P√°gina oculta - cerrar c√°mara si est√° activa
                if (window.scannerActive || isScannerActive) {
                    console.log("üìµ P√°gina oculta - cerrando c√°mara para liberar recursos");
                    detenerTodosLosStreams();
                }
            }
        });

        // Manejo de p√©rdida de foco de la ventana
        window.addEventListener('blur', function() {
            if (window.scannerActive || isScannerActive) {
                console.log("üìµ Ventana perdi√≥ foco - verificando cierre de c√°mara");
                setTimeout(() => {
                    detenerTodosLosStreams();
                }, 1000); // Delay para evitar cerrar accidentalmente
            }
        });

        // Funci√≥n de debug del frontend
        function debugEvacuacionFrontend() {
            console.log('üîß Ejecutando debug de evacuaci√≥n...');
            
            // Prevenir m√∫ltiples llamadas de debug simult√°neas
            if (window.ejecutandoDebug) {
                console.log('‚ö†Ô∏è Ya se est√° ejecutando debug, ignorando llamada duplicada');
                return;
            }
            window.ejecutandoDebug = true;
            
            mostrarLoading('Ejecutando diagn√≥stico...');

            google.script.run
                .withSuccessHandler(function(resultado) {
                    window.ejecutandoDebug = false; // Liberar bloqueo
                    ocultarLoading();
                    console.log('‚úÖ Debug completado:', resultado);
                    
                    let mensaje = `Debug de evacuaci√≥n:\n\n`;
                    mensaje += `Estado: ${resultado.success ? '‚úÖ OK' : '‚ùå ERROR'}\n`;
                    mensaje += `Mensaje: ${resultado.message}\n`;
                    
                    if (resultado.estadisticas) {
                        mensaje += `\nEstad√≠sticas:\n`;
                        mensaje += `- Total registros: ${resultado.estadisticas.totalRegistros}\n`;
                        mensaje += `- Con entrada: ${resultado.estadisticas.registrosConEntrada}\n`;
                        mensaje += `- Con salida: ${resultado.estadisticas.registrosConSalida}\n`;
                        mensaje += `- Dentro: ${resultado.estadisticas.registrosDentro}\n`;
                        mensaje += `\nEncabezados: ${resultado.estadisticas.encabezados.join(', ')}\n`;
                    }
                    
                    alert(mensaje);
                    
                    if (resultado.success && confirm('¬øContinuar con el modal de evacuaci√≥n?')) {
                        // Reintentar mostrar evacuaci√≥n despu√©s del debug
                        mostrarEvacuacionChecklist();
                    }
                })
                .withFailureHandler(function(error) {
                    window.ejecutandoDebug = false; // Liberar bloqueo en caso de error
                    ocultarLoading();
                    console.error('‚ùå Error en debug:', error);
                    alert('Error en debug: ' + (error.message || error));
                })
                .debugEvacuacion();
        }

        // Agregar bot√≥n temporal de debug al men√∫ (temporalmente para testing)
        if (DOM.botonEvacuacion) {
            const originalClick = DOM.botonEvacuacion.onclick;
            DOM.botonEvacuacion.onclick = function(e) {
                e.preventDefault();
                if (e.ctrlKey || e.shiftKey) {
                    // Con Ctrl o Shift, ejecutar debug
                    debugEvacuacionFrontend();
                } else {
                    // Click normal, mostrar evacuaci√≥n
                    mostrarEvacuacionChecklist();
                }
            };
        }

        console.log('üöÄ Sistema SurPass V2.2 inicializado con optimizaciones de memoria');
        console.log('üí° Tip: Usa Ctrl+Click en el bot√≥n Evacuaci√≥n para ejecutar debug');
    });
  </script>