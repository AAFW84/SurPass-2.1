<script>
        // *** VARIABLES GLOBALES ***
        let activeTabId = 'personal';
        window.currentPermissions = {
            personal: { ver: true, editar: true },
            configuracion: { ver: true, editar: true },
            usuarios: { ver: true, editar: true },
            logs: { ver: true, editar: true },
            evacuacion: { ver: true, editar: true },
            diagnostico: { ver: true, ejecutar: true }
        };
        window.currentCargo = 'Administrador';
        window.currentUser = null;

        // *** FUNCIONES DE UTILIDAD ***
        let loaderTimeout = null;
        

        // Usar loader global unificado
        // Las funciones mostrarLoading/ocultarLoading están en utils.gs
        
        // Sistema de Toasts Moderno
        // Usar el sistema de toast moderno de utils.js.html
        function showToast(message, type = 'info', duration = 4000) {
            // Si existe la función global de utils, úsala
            if (typeof window.showToast === 'function' && window.showToast.length >= 3) {
                window.showToast('', message, type, duration);
                return;
            }
            // Fallback mínimo visual
            const container = document.getElementById('toast-container');
            if (!container) return alert(message);
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `<div class="toast-message">${message}</div>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), duration);
        }

        // Reemplazo global de showNotification por showToast
        function showNotification(message, type = 'info') {
            showToast(message, type);
        }
        
        // ==== Helper estándar para parsear errores backend (Apps Script) ====
        function parseBackendError(err, fallbackMsg = 'Ha ocurrido un error.') {
            try {
                if (!err) return { message: fallbackMsg };
                if (typeof err === 'string') {
                    try { const o = JSON.parse(err); return { message: o.message || fallbackMsg, code: o.code, details: o.details || o }; } catch (_) { return { message: err }; }
                }
                if (typeof err === 'object') {
                    const message = err.message || err.mensaje || fallbackMsg;
                    const code = err.code || err.codigo;
                    const details = err.details || err.detalles || null;
                    return { message, code, details };
                }
                return { message: fallbackMsg };
            } catch (e) {
                return { message: fallbackMsg };
            }
        }

        // Orquestador para cargar configuración en la vista de categorías
        function setupSystemConfigUI() {
            try {
                mostrarLoading('Cargando configuración del sistema...');
                if (typeof google !== 'undefined' && google.script && google.script.run) {
                    // Nombre genérico del método en Apps Script; ajustar si el backend usa otro nombre
                    google.script.run
                        .withSuccessHandler((response) => {
                            try {
                                if (typeof onConfigurationLoaded === 'function') {
                                    onConfigurationLoaded(response);
                                }
                            } finally {
                                ocultarLoading();
                            }
                        })
                        .withFailureHandler((error) => {
                            try {
                                const parsed = parseBackendError(error, 'Error al cargar configuración');
                                if (typeof onConfigurationError === 'function') {
                                    onConfigurationError(parsed);
                                }
                                if (typeof showNotification === 'function') {
                                    const msg = parsed.code ? `${parsed.message} [${parsed.code}]` : parsed.message;
                                    showNotification(msg || 'Error al cargar configuración', 'error');
                                }
                                if (console && console.error) console.error('Admin UI error (obtenerConfiguracion):', parsed);
                            } finally {
                                ocultarLoading();
                            }
                        })
                        .obtenerConfiguracion();
                } else {
                    // Modo desarrollo: datos simulados mínimos
                    const mock = { success: true, configuraciones: [
                        { clave: 'EMPRESA_NOMBRE', valor: 'SurPass', descripcion: 'Nombre de la empresa' },
                        { clave: 'EVACUACION_ACTIVA', valor: 'NO', descripcion: 'Evacuación activa' },
                        { clave: 'UI_TEMA', valor: '#C41E3A', descripcion: 'Color principal' }
                    ]};
                    if (typeof onConfigurationLoaded === 'function') {
                        onConfigurationLoaded(mock);
                    }
                    ocultarLoading();
                }
            } catch (e) {
                ocultarLoading();
                console.error('Error en setupSystemConfigUI:', e);
                if (typeof showNotification === 'function') showNotification('Error al cargar configuración', 'error');
            }
        }

        // Guardar cambios desde el modal de configuración por categorías
        function saveConfigurationChanges() {
            try {
                // Si existe un formulario generado por renderConfigForm, disparar su submit
                const form = document.getElementById('config-form');
                if (form) {
                    form.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
                    return;
                }
                // Si no existe, intentar usar la función existente saveConfiguration()
                if (typeof saveConfiguration === 'function') {
                    saveConfiguration();
                }
            } catch (e) {
                console.error('Error guardando cambios de configuración:', e);
                if (typeof showNotification === 'function') showNotification('Error al guardar configuración', 'error');
            }
        }

        // Cerrar modal de edición de configuración
        function closeConfigModal() {
            const modal = document.getElementById('edit-config-modal');
            if (modal) modal.classList.add('hidden');
        }

        // *** MANEJO DE LOGIN ***
        function handleLogin(e) {
        e.preventDefault();

        const cedula = document.getElementById('cedula-input').value.trim();
        const password = document.getElementById('password-input').value.trim();
        const loginButton = document.getElementById('login-button');
        const errorMessage = document.getElementById('login-error');

        if (!cedula || !password) {
            showLoginError('Por favor, ingresa tu cédula y contraseña.');
            return;
        }

        loginButton.disabled = true;
    mostrarLoading('Validando credenciales...');
        errorMessage.classList.add('hidden');

        const credenciales = JSON.stringify({ usuario: cedula, clave: password });
        
        // La llamada ahora es a la nueva función de autenticación
        google.script.run
            .withSuccessHandler(onLoginSuccess)
            .withFailureHandler(onLoginFailure)
            .autenticarAdminYCrearSesion(credenciales); // <--- NUEVA FUNCIÓN
    }

        function onLoginSuccess(response) {
    console.log('Respuesta de login recibida:', response);
    ocultarLoading();
    
    const loginButton = document.getElementById('login-button');
    if (loginButton) loginButton.disabled = false;

    if (response && response.success) {
        // Guardar datos de sesión
        if (response.token) {
            sessionStorage.setItem('surpassAdminToken', response.token);
        }

        // Configurar permisos del usuario
        if (response.admin) {
            window.currentUser = response.admin;
            window.currentCedula = response.admin.cedula || '';
            window.currentCargo = response.admin.cargo || 'Administrador';
            
            // Parsear permisos si vienen como string
            let permisos = {};
            if (response.admin.permisos) {
                try {
                    if (typeof response.admin.permisos === 'string') {
                        permisos = JSON.parse(response.admin.permisos);
                    } else {
                        permisos = response.admin.permisos;
                    }
                } catch (e) {
                    console.error('Error parseando permisos:', e);
                    // Permisos por defecto
                    permisos = {
                        personal: { ver: true, editar: true },
                        configuracion: { ver: true, editar: true },
                        usuarios: { ver: true, editar: true },
                        logs: { ver: true, editar: true },
                        evacuacion: { ver: true, editar: true },
                        diagnostico: { ver: true, ejecutar: true }
                    };
                }
            }
            window.currentPermissions = permisos;
        }

        // Ocultar login y mostrar dashboard
        document.getElementById('login-container').classList.add('hidden');
        document.getElementById('dashboard-container').classList.remove('hidden');

        showNotification('¡Login exitoso! Bienvenido al panel.', 'success');

        // Inicializar dashboard
        setTimeout(() => {
            initializeDashboard();
        }, 100);

    } else {
        showLoginError(response?.message || 'Error en la autenticación. Verifique sus credenciales.');
    }
}

        function onLoginFailure(error) {
            ocultarLoading();
            const loginButton = document.getElementById('login-button');
            if (loginButton) loginButton.disabled = false;
            let parsed = {};
            if (typeof error === 'object' && error !== null) {
                parsed.message = error.message || JSON.stringify(error);
                parsed.code = error.code || undefined;
            } else if (typeof error === 'string') {
                parsed.message = error;
            } else {
                parsed.message = 'Error de conexión. Inténtalo de nuevo.';
            }
            if (typeof showNotification === 'function') {
                const msg = parsed.code ? `${parsed.message} [${parsed.code}]` : parsed.message;
                showNotification(msg, 'error');
            }
            showLoginError(parsed.message || 'Error de conexión. Inténtalo de nuevo.');
            if (console && console.error) console.error('Admin UI login error:', error);
        }

        function showLoginError(message) {
            const errorMessage = document.getElementById('login-error');
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        // Handler estándar para guardar configuración (referenciado en .withFailureHandler)
        function onConfigSaveError(error) {
            const parsed = (typeof parseBackendError === 'function') ? parseBackendError(error, 'Error al guardar configuración') : { message: 'Error al guardar configuración' };
            if (typeof showNotification === 'function') {
                const msg = parsed.code ? `${parsed.message} [${parsed.code}]` : parsed.message;
                showNotification(msg, 'error');
            }
            if (console && console.error) console.error('Admin UI error (guardarConfiguracion):', parsed);
        }

        // Handler para errores mostrados en modal de configuración
        function handleConfigErrorModal(error) {
            const parsed = (typeof parseBackendError === 'function') ? parseBackendError(error, 'Error procesando la configuración') : { message: 'Error procesando la configuración' };
            if (typeof showNotification === 'function') {
                const msg = parsed.code ? `${parsed.message} [${parsed.code}]` : parsed.message;
                showNotification(msg, 'error');
            }
            if (console && console.error) console.error('Admin UI modal config error:', parsed);
        }

        // *** FUNCIONES DEL DASHBOARD ***
        function initializeDashboard() {
    try {
        console.log('Iniciando dashboard...');
        
        // Mostrar loader durante inicialización
        mostrarLoading('Iniciando panel administrativo...', 10000);
        
        // Actualizar información del usuario en el nuevo header
        const userInfo = document.getElementById('user-info');
        if (userInfo) {
            userInfo.textContent = `${window.currentCargo || 'Usuario'}`;
        }
        
        // También actualizar el elemento antiguo si existe (compatibilidad)
        const oldUserInfo = document.getElementById('current-user-info');
        if (oldUserInfo) {
            oldUserInfo.textContent = `Cargo: ${window.currentCargo}`;
        }
        
        // Configurar tabs según permisos
        configureTabs();
        
        // Mostrar el primer tab disponible
        const firstTab = document.querySelector('.tab-button:not([style*="display: none"])');
        if (firstTab) {
            const tabName = firstTab.id.replace('tab-', '');
            showTab(tabName);
            // Datos del primer tab serán cargados por showTab()
            ocultarLoading();
        } else {
            // Si no hay tabs disponibles
            ocultarLoading();
            showNotification('No hay secciones disponibles para su perfil', 'info');
        }
        
    } catch (error) {
        console.error('Error inicializando dashboard:', error);
        ocultarLoading();
        showNotification('Error inicializando el panel administrativo', 'error');
    }
}

function configureTabs() {
    console.log('Configurando tabs según permisos:', JSON.stringify(window.currentPermissions));
    const permisos = window.currentPermissions;
    
    // Reset visibility of all tabs before applying new permissions
    const allTabIds = ['personal','configuracion','usuarios','logs','evacuacion','diagnostico'];
    allTabIds.forEach(id => {
        const el = document.getElementById(`tab-${id}`);
        if (el) el.style.display = '';
    });
    
    // Mostrar/ocultar tabs según permisos
    if (!permisos.personal?.ver) {
        document.getElementById('tab-personal').style.display = 'none';
    }
    if (!permisos.configuracion?.ver) {
        document.getElementById('tab-configuracion').style.display = 'none';
    }
    if (!permisos.usuarios?.ver) {
        document.getElementById('tab-usuarios').style.display = 'none';
    }
    if (!permisos.logs?.ver) {
        document.getElementById('tab-logs').style.display = 'none';
    }
    if (!permisos.evacuacion?.ver) {
        document.getElementById('tab-evacuacion').style.display = 'none';
    }
    if (!permisos.diagnostico?.ejecutar) {
        document.getElementById('tab-diagnostico').style.display = 'none';
    }
    
    console.log('Tabs configurados correctamente');
}

        function hideAllTabs() {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        }

        function showTab(tabId) {
            // Actualizar botones
            hideAllTabs();
            document.getElementById(`tab-${tabId}`).classList.add('active');
            activeTabId = tabId;
            
            // Actualizar contenido
            updateContentContainer(tabId);
            
            // Cargar datos del tab si no se han cargado
            loadTabData(tabId);
        }

        function updateContentContainer(tabId) {
            const container = document.getElementById('content-container');
            
            switch(tabId) {
                case 'personal':
                    container.innerHTML = `
                        <div class="mb-6">
                            <h3 class="text-xl font-bold mb-4 flex items-center">
                                <i class="fas fa-users-line mr-2"></i>Gestión de Personal
                            </h3>
                            
                            <!-- Estadísticas adaptadas a Base de Datos actual -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6" id="personal-stats">
                                <div class="card-new stat-card">
                                    <div class="card-new-body">
                                        <div class="card-new-stat-number" id="stat-total">0</div>
                                        <div class="card-new-stat-label">Total Personal</div>
                                    </div>
                                </div>
                                <div class="card-new stat-card">
                                    <div class="card-new-body">
                                        <div class="card-new-stat-number text-green-500" id="stat-activos">0</div>
                                        <div class="card-new-stat-label">Activos</div>
                                    </div>
                                </div>
                                <div class="card-new stat-card">
                                    <div class="card-new-body">
                                        <div class="card-new-stat-number text-red-500" id="stat-inactivos">0</div>
                                        <div class="card-new-stat-label">Inactivos</div>
                                    </div>
                                </div>
                                <div class="card-new stat-card">
                                    <div class="card-new-body">
                                        <div class="card-new-stat-number text-blue-500" id="stat-areas">0</div>
                                        <div class="card-new-stat-label">Áreas</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Barra de herramientas -->
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                                <div class="flex space-x-2">
                                    <button onclick="openPersonModal()" class="btn-primary">
                                        <i class="fas fa-plus mr-2"></i>Agregar Persona
                                    </button>
                                    <button onclick="loadPersonnel()" class="btn-secondary">
                                        <i class="fas fa-sync mr-2"></i>Actualizar Lista
                                    </button>
                                    <button onclick="exportPersonalData()" class="btn-secondary">
                                        <i class="fas fa-download mr-2"></i>Exportar
                                    </button>
                                </div>
                                
                                <!-- Buscador dinámico -->
                                <div class="flex items-center space-x-2">
                                    <div class="relative">
                                        <input type="text" id="search-personal" placeholder="Buscar por cédula, nombre, cargo..." 
                                               class="pl-10 pr-4 py-2 border rounded-lg w-80 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                    </div>
                                    <select id="search-field" class="border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Todos los campos</option>
                                        <option value="cedula">Cédula</option>
                                        <option value="nombre">Nombre</option>
                                        <option value="empresa">Empresa</option>
                                        <option value="area">Área</option>
                                        <option value="cargo">Cargo</option>
                                        <option value="estado">Estado</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Filtros rápidos -->
                            <div class="flex flex-wrap gap-2 mb-4" id="quick-filters">
                                <button class="filter-btn active" data-filter="all">Todos</button>
                                <button class="filter-btn" data-filter="activo">Activos</button>
                                <button class="filter-btn" data-filter="inactivo">Inactivos</button>
                            </div>
                        </div>

                        <!-- Tabla de personal -->
                        <div id="personal-table-container" class="overflow-x-auto">
                            <!-- Loader eliminado: ahora solo loader global -->
                        </div>
                        
                        <!-- Paginación -->
                        <div id="pagination-container" class="flex justify-between items-center mt-6 hidden">
                            <div class="text-sm text-gray-600">
                                Mostrando <span id="showing-from">1</span>-<span id="showing-to">10</span> de <span id="total-records">0</span> registros
                            </div>
                            <div class="flex space-x-2" id="pagination-buttons">
                                <!-- Botones de paginación se generarán dinámicamente -->
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'configuracion':
                    container.innerHTML = `
                        <div class="bg-[#161b22] p-6 rounded-xl shadow-lg border border-[#30363d] mb-8">
                            <div class="flex justify-between items-center mb-4 border-b border-[#30363d] pb-4">
                                <h2 class="text-2xl font-semibold text-[#c9d1d9]"><i class="fas fa-cogs mr-2"></i>Configuración del Sistema</h2>
                                <div class="flex space-x-2">
                                    <button onclick="setupSystemConfigUI()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-full transition-colors">
                                        <i class="fas fa-sync-alt mr-2"></i>Recargar
                                    </button>
                                </div>
                            </div>
                            <div id="config-categories-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <!-- Las categorías de configuración se renderizarán aquí -->
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'usuarios':
                    container.innerHTML = `
                        <div class="mb-6">
                            <h3 class="text-xl font-bold mb-4">Usuarios Administradores</h3>
                            <button onclick="openAdminModal()" class="btn-primary">
                                <i class="fas fa-user-plus mr-2"></i>Agregar Administrador
                            </button>
                        </div>
                        <div id="users-table-container" class="space-y-4">
                            <!-- Loader eliminado: ahora solo loader global -->
                        </div>
                    `;
                    break;
                    
                case 'logs':
                    container.innerHTML = `
                        <div class="mb-6">
                            <h3 class="text-xl font-bold mb-4">Logs del Sistema</h3>
                            <div class="flex space-x-4 mb-4">
                                <button onclick="loadLogs()" class="btn-secondary">
                                    <i class="fas fa-sync mr-2"></i>Actualizar Logs
                                </button>
                                <button onclick="testBackendConnection()" class="btn-primary">
                                    <i class="fas fa-plug mr-2"></i>Probar Conexión
                                </button>
                                <button onclick="confirmClearLogs()" class="btn-danger">
                                    <i class="fas fa-trash mr-2"></i>Limpiar Logs
                                </button>
                            </div>
                        </div>
                        <div id="logs-table-container" class="space-y-4">
                            <!-- Loader eliminado: ahora solo loader global -->
                        </div>
                    `;
                    break;
                    
                case 'evacuacion':
                    container.innerHTML = `
                        <div class="mb-6">
                            <h3 class="text-xl font-bold mb-4">Estado de Evacuación</h3>
                            <div class="flex space-x-4 mb-4">
                                <button onclick="toggleEvacuation()" class="btn-warning">
                                    <i class="fas fa-bell mr-2"></i>Activar/Desactivar Evacuación
                                </button>
                                <button onclick="loadEvacuationStatus()" class="btn-secondary">
                                    <i class="fas fa-sync mr-2"></i>Actualizar Estado
                                </button>
                            </div>
                        </div>
                        <div id="evacuation-status-container" class="space-y-4">
                            <!-- Loader eliminado: ahora solo loader global -->
                        </div>
                    `;
                    break;
                    
                case 'diagnostico':
                    container.innerHTML = `
                        <div class="mb-6">
                            <h3 class="text-xl font-bold mb-4">Centro de Diagnóstico del Sistema</h3>
                            
                            <!-- Controles de modo -->
                            <div class="bg-gray-700 p-4 rounded-lg mb-4">
                                <h4 class="font-semibold mb-3">Modo de Diagnóstico</h4>
                                <div class="flex items-center space-x-4">
                                    <label class="flex items-center">
                                        <input type="radio" name="modo-diagnostico" value="estatico" checked 
                                            onchange="cambiarModoDiagnostico('estatico')" class="mr-2">
                                        <span>Estático (Manual)</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="modo-diagnostico" value="activo" 
                                            onchange="cambiarModoDiagnostico('activo')" class="mr-2">
                                        <span>Activo (Automático cada 5 min)</span>
                                    </label>
                                </div>
                                <div id="modo-diagnostico-status" class="mt-2 text-sm text-gray-400">
                                    Modo actual: <span id="modo-actual">Estático</span>
                                </div>
                            </div>
                            
                            <!-- Botones de acción -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <button onclick="runDiagnosis()" class="btn-primary">
                                    <i class="fas fa-play mr-2"></i>Ejecutar Diagnóstico
                                </button>
                                <button onclick="mostrarFormularioErrorManual()" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg">
                                    <i class="fas fa-plus-circle mr-2"></i>Reportar Error
                                </button>
                                <button onclick="buscarError()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">
                                    <i class="fas fa-search mr-2"></i>Buscar Error
                                </button>
                            </div>
                            
                            <!-- Formulario para reportar errores manuales -->
                            <div id="formulario-error-manual" class="bg-gray-700 p-4 rounded-lg mb-4 hidden">
                                <h4 class="font-semibold mb-3">Reportar Error Detectado Manualmente</h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Descripción del Error</label>
                                        <textarea id="descripcion-error" rows="3" 
                                            class="w-full bg-gray-600 px-3 py-2 rounded-lg border border-gray-500" 
                                            placeholder="Describe el error que detectaste..."></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Ubicación/Archivo</label>
                                        <input type="text" id="ubicacion-error" 
                                            class="w-full bg-gray-600 px-3 py-2 rounded-lg border border-gray-500" 
                                            placeholder="Ej: admin.html, línea 123, función loadPersonnel()">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Categoría</label>
                                        <select id="categoria-error" class="w-full bg-gray-600 px-3 py-2 rounded-lg border border-gray-500">
                                            <option value="USUARIO">Error General</option>
                                            <option value="CONFIGURACION">Problema de Configuración</option>
                                            <option value="FUNCION">Función No Disponible</option>
                                            <option value="DATOS">Error en Datos</option>
                                            <option value="CONECTIVIDAD">Problema de Conectividad</option>
                                            <option value="INTERFAZ">Problema de Interfaz</option>
                                        </select>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button onclick="guardarErrorManual()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">
                                            <i class="fas fa-save mr-2"></i>Guardar Error
                                        </button>
                                        <button onclick="cancelarErrorManual()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">
                                            Cancelar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="diagnostico-result-container" class="space-y-4">
                            <!-- Loader eliminado: ahora solo loader global -->
                        </div>
                    `;
                    break;
            }
        }

        function loadTabData(tabId) {
            try {
                console.log(`Cargando datos para tab: ${tabId}`);
                
                switch(tabId) {
                    case 'personal':
                        loadPersonnel();
                        break;
                    case 'configuracion':
                        setupSystemConfigUI();
                        break;
                    case 'usuarios':
                        loadAdminUsers();
                        break;
                    case 'logs':
                        loadLogs();
                        break;
                    case 'evacuacion':
                        loadEvacuationStatus();
                        break;
                    case 'diagnostico':
                        // El diagnóstico se carga bajo demanda
                        document.getElementById('diagnostico-result-container').innerHTML = 
                            '<p class="text-gray-500">Haga clic en "Ejecutar Diagnóstico" para comenzar</p>';
                        break;
                    default:
                        console.warn(`Tab no reconocido: ${tabId}`);
                        break;
                }
            } catch (error) {
                console.error(`Error cargando tab ${tabId}:`, error);
                showNotification(`Error cargando la sección ${tabId}`, 'error');
            }
        }


        // *** FUNCIONES DE CARGA DE DATOS ***
        let personalData = []; // Cache global de datos de personal
        let filteredPersonal = []; // Datos filtrados
        let currentPage = 1;
        let globalConfig = {}; // Global variable to store configuration data
        let recordsPerPage = 10;

        function loadPersonnel() {
            const container = document.getElementById('personal-table-container');
            
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                mostrarLoading('Cargando personal...');
                
                google.script.run
                    .withSuccessHandler((data) => {
                        console.log('Personal data received:', data);
                        ocultarLoading();
                        
                        if (data && data.success) {
                            personalData = data.personal || [];
                            filteredPersonal = [...personalData];
                            
                            // Actualizar estadísticas
                            updatePersonalStats(data.stats || {});
                            
                            // Renderizar tabla
                            renderPersonalTable(filteredPersonal);
                            
                            // Configurar buscador
                            setupPersonalSearch();
                            
                            showNotification(`${personalData.length} registros de personal cargados`, 'success');
                        } else {
                            container.innerHTML = '<div class="p-4 text-center text-gray-500">No se pudieron cargar los datos de personal.</div>';
                            showNotification(data?.message || 'Error cargando personal', 'error');
                        }
                    })
                    .withFailureHandler((error) => {
                        console.error('Error loading personnel:', error);
                        ocultarLoading();
                        container.innerHTML = '<div class="p-4 text-center text-red-500">Error cargando personal: ' + error.message + '</div>';
                        showNotification('Error cargando personal: ' + error.message, 'error');
                    })
                    .loadPersonnel();
            } else {
                // Modo de desarrollo - datos simulados
                console.warn('Google Apps Script no disponible, usando datos simulados');
                personalData = generateMockPersonalData();
                filteredPersonal = [...personalData];
                const stats = calculateMockStats(personalData);
                updatePersonalStats(stats);
                renderPersonalTable(filteredPersonal);
                setupPersonalSearch();
            }
        }

        function updatePersonalStats(stats) {
            document.getElementById('stat-total').textContent = stats.total || 0;
            document.getElementById('stat-activos').textContent = stats.activos || 0;
            document.getElementById('stat-inactivos').textContent = stats.inactivos || 0;
            document.getElementById('stat-areas').textContent = stats.totalAreas || 0;
        }

        function renderPersonalTable(data, page = 1) {
            const container = document.getElementById('personal-table-container');
            
            if (!data || data.length === 0) {
                container.innerHTML = `
                    <div class="p-8 text-center">
                        <i class="fas fa-users text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">No hay personal registrado</h3>
                        <p class="text-gray-500 mb-4">Comienza agregando el primer registro de personal.</p>
                        <button onclick="openPersonModal()" class="btn-primary">
                            <i class="fas fa-plus mr-2"></i>Agregar Primera Persona
                        </button>
                    </div>
                `;
                document.getElementById('pagination-container').classList.add('hidden');
                return;
            }

            // Paginación
            const totalPages = Math.ceil(data.length / recordsPerPage);
            const startIndex = (page - 1) * recordsPerPage;
            const endIndex = startIndex + recordsPerPage;
            const pageData = data.slice(startIndex, endIndex);

            let tableHTML = `
                <table class="personal-table">
                    <thead>
                        <tr>
                            <th>Cédula</th>
                            <th>Nombre</th>
                            <th>Empresa</th>
                            <th>Área</th>
                            <th>Cargo</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            pageData.forEach(persona => {
                const statusClass = persona.estado?.toLowerCase() === 'activo' ? 'status-active' : 'status-inactive';
                
                tableHTML += `
                    <tr data-cedula="${typeof persona.cedula !== 'undefined' ? persona.cedula : ''}">
                        <td><strong>${typeof persona.cedula !== 'undefined' ? persona.cedula : 'N/A'}</strong></td>
                        <td>${persona.nombre || 'N/A'}</td>
                        <td>${persona.empresa || 'N/A'}</td>
                        <td>${persona.area || 'N/A'}</td>
                        <td>${persona.cargo || 'N/A'}</td>
                        <td><span class="status-badge ${statusClass} text-sm font-semibold px-3 py-1 rounded-full">${persona.estado || 'Activo'}</span></td>
                        <td>
                            <div class="flex gap-2">
                                <button class="action-btn action-edit bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm" onclick="editPerson('${typeof persona.cedula !== 'undefined' ? persona.cedula : ''}')" title="Editar">
                                    <i class="fas fa-edit mr-1"></i>Editar
                                </button>
                                <button class="action-btn action-toggle ${persona.estado?.toLowerCase() === 'activo' ? 'bg-orange-600 hover:bg-orange-700' : 'bg-green-600 hover:bg-green-700'} text-white px-3 py-2 rounded text-sm" onclick="togglePersonStatus('${typeof persona.cedula !== 'undefined' ? persona.cedula : ''}', '${persona.estado}')" title="Cambiar Estado">
                                    <i class="fas fa-toggle-${persona.estado?.toLowerCase() === 'activo' ? 'off' : 'on'} mr-1"></i>${persona.estado?.toLowerCase() === 'activo' ? 'Desactivar' : 'Activar'}
                                </button>
                                <button class="action-btn action-delete bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm" onclick="confirmDeletePerson('${typeof persona.cedula !== 'undefined' ? persona.cedula : ''}', '${persona.nombre}')" title="Eliminar">
                                    <i class="fas fa-trash mr-1"></i>Eliminar
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;

            // Actualizar paginación
            updatePagination(data.length, page);
        }

        function setupPersonalSearch() {
            const searchInput = document.getElementById('search-personal');
            const searchField = document.getElementById('search-field');
            const quickFilters = document.querySelectorAll('.filter-btn');

            if (!searchInput) return; // Si no existe el elemento, salir

            // Búsqueda en tiempo real
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                const field = searchField.value;
                
                if (searchTerm === '') {
                    filteredPersonal = [...personalData];
                } else {
                    filteredPersonal = personalData.filter(persona => {
                        if (field) {
                            // Buscar en campo específico
                            const fieldValue = String(persona[field] || '').toLowerCase();
                            return fieldValue.includes(searchTerm);
                        } else {
                            // Buscar en todos los campos principales de la Base de Datos
                            const searchFields = ['cedula', 'nombre', 'empresa', 'area', 'cargo', 'estado'];
                            return searchFields.some(f => 
                                String(persona[f] || '').toLowerCase().includes(searchTerm)
                            );
                        }
                    });
                }
                
                currentPage = 1;
                renderPersonalTable(filteredPersonal, currentPage);
            });

            // Filtros rápidos
            quickFilters.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // Actualizar botones activos
                    quickFilters.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const filter = btn.getAttribute('data-filter');
                    
                    if (filter === 'all') {
                        filteredPersonal = [...personalData];
                    } else {
                        filteredPersonal = personalData.filter(persona => {
                            const estado = (persona.estado || '').toLowerCase();
                            
                            switch (filter) {
                                case 'activo':
                                    return estado === 'activo';
                                case 'inactivo':
                                    return estado === 'inactivo';
                                default:
                                    return true;
                            }
                        });
                    }
                    
                    currentPage = 1;
                    renderPersonalTable(filteredPersonal, currentPage);
                });
            });
        }

        function updatePagination(totalRecords, currentPageNum) {
            const paginationContainer = document.getElementById('pagination-container');
            if (!paginationContainer) return;
            
            const totalPages = Math.ceil(totalRecords / recordsPerPage);
            
            if (totalPages <= 1) {
                paginationContainer.classList.add('hidden');
                return;
            }
            
            paginationContainer.classList.remove('hidden');
            
            // Actualizar información de registros
            const startRecord = (currentPageNum - 1) * recordsPerPage + 1;
            const endRecord = Math.min(currentPageNum * recordsPerPage, totalRecords);
            
            document.getElementById('showing-from').textContent = startRecord;
            document.getElementById('showing-to').textContent = endRecord;
            document.getElementById('total-records').textContent = totalRecords;
            
            // Generar botones de paginación
            const buttonsContainer = document.getElementById('pagination-buttons');
            let buttonsHTML = '';
            
            // Botón anterior
            if (currentPageNum > 1) {
                buttonsHTML += `<button class="pagination-btn" onclick="goToPage(${currentPageNum - 1})">
                    <i class="fas fa-chevron-left"></i>
                </button>`;
            }
            
            // Números de página
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPageNum - 2 && i <= currentPageNum + 2)) {
                    const activeClass = i === currentPageNum ? 'active' : '';
                    buttonsHTML += `<button class="pagination-btn ${activeClass}" onclick="goToPage(${i})">${i}</button>`;
                } else if (i === currentPageNum - 3 || i === currentPageNum + 3) {
                    buttonsHTML += `<span class="pagination-btn">...</span>`;
                }
            }
            
            // Botón siguiente
            if (currentPageNum < totalPages) {
                buttonsHTML += `<button class="pagination-btn" onclick="goToPage(${currentPageNum + 1})">
                    <i class="fas fa-chevron-right"></i>
                </button>`;
            }
            
            buttonsContainer.innerHTML = buttonsHTML;
        }

        function goToPage(page) {
            currentPage = page;
            renderPersonalTable(filteredPersonal, currentPage);
        }

        // *** FUNCIONES CRUD PARA PERSONAL ***
        function editPerson(cedula) {
            const persona = personalData.find(p => p.cedula === cedula);
            if (persona) {
                openPersonModal(persona);
            } else {
                showNotification('Persona no encontrada', 'error');
            }
        }

        // Variables globales para modales
        let currentPersonToToggle = null;
        let currentPersonToDelete = null;

        function togglePersonStatus(cedula, currentStatus) {
            const persona = personalData.find(p => p.cedula === cedula);
            if (!persona) {
                showNotification('Persona no encontrada', 'error');
                return;
            }

            const newStatus = currentStatus?.toLowerCase() === 'activo' ? 'inactivo' : 'activo';
            currentPersonToToggle = { cedula, newStatus };
            
            // Mostrar modal personalizado
            const message = document.getElementById('status-change-message');
            const confirmBtn = document.getElementById('confirm-status-btn');
            
            message.textContent = `¿Está seguro de cambiar el estado de "${persona.nombre}" de "${currentStatus}" a "${newStatus.toUpperCase()}"?`;
            confirmBtn.textContent = newStatus === 'activo' ? 'Activar Persona' : 'Desactivar Persona';
            confirmBtn.className = `px-4 py-2 ${newStatus === 'activo' ? 'bg-green-600 hover:bg-green-700' : 'bg-orange-600 hover:bg-orange-700'} text-white rounded transition-colors`;
            
            document.getElementById('status-change-modal').classList.remove('hidden');
        }

        function closeStatusModal() {
            document.getElementById('status-change-modal').classList.add('hidden');
            currentPersonToToggle = null;
        }

        function confirmStatusChange() {
            if (!currentPersonToToggle) return;

            const { cedula, newStatus } = currentPersonToToggle;
            
            // Mostrar loading
            showLoadingModal('Cambiando estado...');
            closeStatusModal();

            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler((result) => {
                        hideLoadingModal();
                        if (result.success) {
                            showNotification(result.message, 'success');
                            loadPersonnel(); // Recargar la lista
                        } else {
                            showNotification(result.message, 'error');
                        }
                    })
                    .withFailureHandler((error) => {
                        hideLoadingModal();
                        showNotification('Error cambiando estado: ' + error.message, 'error');
                    })
                    .cambiarEstadoPersonal(cedula, newStatus);
            } else {
                // Modo simulación
                setTimeout(() => {
                    const persona = personalData.find(p => p.cedula === cedula);
                    if (persona) {
                        persona.estado = newStatus;
                        filteredPersonal = [...personalData];
                        renderPersonalTable(filteredPersonal, currentPage);
                        const stats = calculateMockStats(personalData);
                        updatePersonalStats(stats);
                        showNotification(`Estado cambiado a ${newStatus} exitosamente`, 'success');
                    }
                    hideLoadingModal();
                }, 1000);
            }
        }

        function confirmDeletePerson(cedula, nombre) {
            const persona = personalData.find(p => p.cedula === cedula);
            if (!persona) {
                showNotification('Persona no encontrada', 'error');
                return;
            }

            currentPersonToDelete = cedula;
            
            // Mostrar modal personalizado
            const message = document.getElementById('delete-message');
            message.innerHTML = `¿Está seguro de que desea eliminar permanentemente a <strong>"${nombre || persona.nombre}"</strong> con cédula <strong>"${cedula}"</strong>?`;
            
            document.getElementById('delete-modal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.add('hidden');
            // También cerrar el modal viejo si existe
            const oldModal = document.getElementById('delete-confirm-modal');
            if (oldModal) {
                oldModal.remove();
            }
            currentPersonToDelete = null;
        }

        function confirmDelete() {
            if (!currentPersonToDelete) return;

            const cedula = currentPersonToDelete;
            
            // Mostrar loading
            showLoadingModal('Eliminando persona...');
            closeDeleteModal();

            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler((result) => {
                        hideLoadingModal();
                        if (result.success) {
                            showNotification(result.message, 'success');
                            loadPersonnel(); // Recargar la lista
                        } else {
                            showNotification(result.message, 'error');
                        }
                    })
                    .withFailureHandler((error) => {
                        hideLoadingModal();
                        showNotification('Error eliminando persona: ' + error.message, 'error');
                    })
                    .eliminarPersonal(cedula);
            } else {
                // Modo simulación
                setTimeout(() => {
                    const index = personalData.findIndex(p => p.cedula === cedula);
                    if (index !== -1) {
                        personalData.splice(index, 1);
                        filteredPersonal = [...personalData];
                        renderPersonalTable(filteredPersonal, currentPage);
                        const stats = calculateMockStats(personalData);
                        updatePersonalStats(stats);
                        showNotification('Persona eliminada exitosamente', 'success');
                    }
                    hideLoadingModal();
                }, 1000);
            }
        }


        // Usar solo el loader global unificado
        // Reemplazo de showLoadingModal/hideLoadingModal por mostrarLoading/ocultarLoading
        function showLoadingModal(message) {
            mostrarLoading(message || 'Cargando...');
        }
        function hideLoadingModal() {
            ocultarLoading();
        }

        function deletePerson(cedula) {
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                mostrarLoading('Eliminando persona...');
                
                google.script.run
                    .withSuccessHandler((result) => {
                        ocultarLoading();
                        if (result.success) {
                            showNotification(result.message, 'success');
                            loadPersonnel(); // Recargar la lista
                        } else {
                            showNotification(result.message, 'error');
                        }
                    })
                    .withFailureHandler((error) => {
                        ocultarLoading();
                        showNotification('Error eliminando persona: ' + error.message, 'error');
                    })
                    .deletePerson(cedula);
            } else {
                // Modo simulación
                const index = personalData.findIndex(p => p.cedula === cedula);
                if (index !== -1) {
                    const persona = personalData[index];
                    personalData.splice(index, 1);
                    filteredPersonal = [...personalData];
                    renderPersonalTable(filteredPersonal, currentPage);
                    showNotification(`${persona.nombre} eliminado correctamente`, 'success');
                    
                    // Actualizar estadísticas
                    const stats = calculateMockStats(personalData);
                    updatePersonalStats(stats);
                }
            }
        }

        function closeDeleteModal() {
            const modal = document.getElementById('delete-confirm-modal');
            if (modal) {
                modal.remove();
            }
        }

        function exportPersonalData() {
            if (filteredPersonal.length === 0) {
                showNotification('No hay datos para exportar', 'warning');
                return;
            }
            
            // Crear CSV
            const headers = ['Cédula', 'Nombre', 'Cargo', 'Departamento', 'Tipo', 'Estado', 'Email', 'Fecha Registro'];
            const csvContent = [
                headers.join(','),
                ...filteredPersonal.map(persona => [
                    typeof persona.cedula !== 'undefined' ? persona.cedula : '',
                    persona.nombre || '',
                    persona.cargo || '',
                    persona.departamento || '',
                    persona.tipo || '',
                    persona.estado || '',
                    persona.email || '',
                    persona.fecha_registro ? new Date(persona.fecha_registro).toLocaleDateString() : ''
                ].join(','))
            ].join('\n');
            
            // Descargar archivo
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `personal_surpass_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('Datos exportados correctamente', 'success');
        }

        // *** DATOS SIMULADOS PARA DESARROLLO ***
        function generateMockPersonalData() {
            return [
                {
                    cedula: '8-123-456',
                    nombre: 'Juan Carlos Pérez',
                    empresa: 'TechCorp S.A.',
                    area: 'Tecnología',
                    cargo: 'Desarrollador Senior',
                    estado: 'activo',
                    fila: 2
                },
                {
                    cedula: '8-789-012',
                    nombre: 'María Elena García',
                    empresa: 'TechCorp S.A.',
                    area: 'Tecnología',
                    cargo: 'Analista de Sistemas',
                    estado: 'activo',
                    fila: 3
                },
                {
                    cedula: '8-345-678',
                    nombre: 'Roberto Silva',
                    empresa: 'AdminCorp S.A.',
                    area: 'Administración',
                    cargo: 'Gerente de Proyectos',
                    estado: 'activo',
                    fila: 4
                },
                {
                    cedula: '8-901-234',
                    nombre: 'Ana Sofía López',
                    empresa: 'DesignCorp S.A.',
                    area: 'Diseño',
                    cargo: 'Diseñadora UX',
                    estado: 'inactivo',
                    fila: 5
                },
                {
                    cedula: '8-567-890',
                    nombre: 'Carlos Mendoza',
                    empresa: 'Consultores S.A.',
                    area: 'Consultoría',
                    cargo: 'Consultor Externo',
                    estado: 'activo',
                    fila: 6
                }
            ];
        }

        function calculateMockStats(data) {
            const areas = new Set();
            const stats = { total: data.length, activos: 0, inactivos: 0, totalAreas: 0 };
            
            data.forEach(persona => {
                if (persona.estado?.toLowerCase() === 'activo') stats.activos++;
                else stats.inactivos++;
                
                if (persona.area) {
                    areas.add(persona.area);
                }
            });
            
            stats.totalAreas = areas.size;
            
            return stats;
        }

        function renderPersonnelTable(data) {
            const container = document.getElementById('personal-table-container');
            
            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">No hay personal registrado.</p>';
                return;
            }

            let tableHTML = `
                <div class="overflow-x-auto rounded-lg border border-gray-700">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Cédula</th>
                                <th>Nombre</th>
                                <th>Empresa</th>
                                <th>Cargo</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach(person => {
                // Manejar tanto formatos nuevos como antiguos
                const cedula = person.cedula || person.Cédula || person.cédula || 'N/A';
                const nombre = person.nombre || person.Nombre || 'N/A';
                const empresa = person.empresa || person.Empresa || 'N/A';
                const cargo = person.cargo || person.Cargo || 'N/A';
                const estado = person.estado || person.Estado || 'Activo';
                
                tableHTML += `
                    <tr>
                        <td>${cedula}</td>
                        <td>${nombre}</td>
                        <td>${empresa}</td>
                        <td>${cargo}</td>
                        <td><span class="px-2 py-1 text-xs rounded-full ${estado === 'Activo' ? 'bg-green-600 text-white' : 'bg-gray-600 text-white'}">${estado}</span></td>
                        <td class="whitespace-nowrap">
                            <button onclick="editPerson('${cedula}')" class="action-button bg-blue-600 hover:bg-blue-700 text-white mr-2">
                                <i class="fa-solid fa-edit"></i>
                            </button>
                            <button onclick="confirmDeletePerson('${cedula}')" class="action-button bg-red-600 hover:bg-red-700 text-white">
                                <i class="fa-solid fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHTML;
        }

        // 🔧 [FIX] Función mejorada para limpiar logs con confirmación
        window.confirmClearLogs = function() {
            // Mostrar diálogo de confirmación personalizado
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-lg shadow-xl max-w-md w-full p-6">
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle text-5xl text-yellow-500 mb-4"></i>
                        <h3 class="text-xl font-bold text-white mb-2">¿Eliminar todos los logs?</h3>
                        <p class="text-gray-300 mb-6">Esta acción eliminará permanentemente todos los registros del sistema. Esta operación no se puede deshacer.</p>
                        
                        <div class="flex justify-center space-x-4">
                            <button id="cancel-clear-logs" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-md transition-colors">
                                <i class="fas fa-times mr-2"></i>Cancelar
                            </button>
                            <button id="confirm-clear-logs" class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-md transition-colors">
                                <i class="fas fa-trash-alt mr-2"></i>Eliminar todo
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Configurar manejadores de eventos
            document.getElementById('cancel-clear-logs').addEventListener('click', () => {
                modal.remove();
            });
            
            document.getElementById('confirm-clear-logs').addEventListener('click', () => {
                modal.remove();
                clearLogs();
            });
        };

        // 🔧 [FIX] Función mejorada para limpiar logs
        function clearLogs() {
            mostrarLoading('Limpiando registros del sistema...');
            
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler((response) => {
                        ocultarLoading();
                        if (response && response.success) {
                            showNotification(response.message || 'Todos los logs han sido eliminados correctamente', 'success');
                            // Recargar logs después de limpiar
                            if (typeof loadLogs === 'function') loadLogs();
                        } else {
                            showNotification(response?.message || 'Error al limpiar los logs', 'error');
                        }
                    })
                    .withFailureHandler((error) => {
                        ocultarLoading();
                        console.error('❌ Error al limpiar logs:', error);
                        
                        // Mostrar mensaje de error detallado
                        showNotification('Error al conectar con el servidor para limpiar los logs', 'error');
                        
                        // Mostrar botón de reparación si el error es de conexión
                        const container = document.getElementById('logs-table-container');
                        if (container) {
                            const errorHtml = `
                                <div class="text-center py-8">
                                    <i class="fas fa-exclamation-triangle text-5xl text-red-400 mb-4"></i>
                                    <h3 class="text-xl font-semibold text-red-300 mb-2">Error de conexión</h3>
                                    <p class="text-red-200 mb-6">No se pudo conectar con el servidor para limpiar los logs.</p>
                                    <div class="space-x-4">
                                        <button onclick="clearLogs()" class="btn-secondary">
                                            <i class="fas fa-sync mr-2"></i>Reintentar
                                        </button>
                                        <button onclick="repararSistema()" class="btn-primary">
                                            <i class="fas fa-wrench mr-2"></i>Reparar Sistema
                                        </button>
                                    </div>
                                </div>
                            `;
                            container.innerHTML = errorHtml;
                        }
                    })
                    .limpiarLogsAdmin(); // Usar limpiarLogsAdmin en lugar de limpiarLogs
            } else {
                // Modo desarrollo - simular limpieza
                setTimeout(() => {
                    ocultarLoading();
                    showNotification('Logs limpiados (modo desarrollo)', 'success');
                    
                    // Actualizar la interfaz
                    const container = document.getElementById('logs-table-container');
                    if (container) {
                        container.innerHTML = `
                            <div class="p-8 text-center">
                                <i class="fas fa-check-circle text-5xl text-green-400 mb-4"></i>
                                <h3 class="text-xl font-semibold text-gray-200">Logs eliminados</h3>
                                <p class="text-gray-400 mt-2">Se han eliminado todos los registros del sistema.</p>
                                <button onclick="loadLogs()" class="mt-6 btn-secondary">
                                    <i class="fas fa-sync mr-2"></i>Actualizar
                                </button>
                            </div>
                        `;
                    }
                }, 1500);
            }
        }

        // Mapeo de status para colores mejorado
        const statusConfigMap = {
            'cargado': { text: '✅ Configuración cargada correctamente', color: 'text-green-500' },
            'error': { text: '❌ Error al cargar configuración', color: 'text-red-500' },
            'cargando': { text: '⏳ Cargando configuración...', color: 'text-yellow-500' }
        };

        function updateConfigStatus(status, message = null) {
            // Actualizar estado visual si existe elemento de estado
            const statusElement = document.getElementById('config-status');
            if (statusElement) {
                const statusInfo = statusConfigMap[status];
                statusElement.textContent = message || statusInfo.text;
                statusElement.className = 'text-lg font-medium ' + statusInfo.color;
            }
        }

        

        /**
         * Manejador de éxito mejorado para la carga de configuración.
         * @param {Object} response - El objeto de configuración retornado por el backend.
         */
        function onConfigurationLoaded(response) {
            console.log('✅ [FRONTEND] Configuración recibida:', response);

            if (response && response.success && response.configuraciones) {
                updateConfigStatus('cargado');
                const configuraciones = response.configuraciones;

                const categorias = {
                    'EMPRESA': [], 'INTERFAZ': [], 'CAMARA_QR': [], 'SEGURIDAD': [],
                    'NOTIFICACIONES': [], 'CACHE': [], 'REPORTES': [], 'EVACUACION': [],
                    'ARCHIVO': [], 'PERSONALIZACION': [], 'INTEGRACION': [], 'GENERAL': []
                };

                configuraciones.forEach(config => {
                    let categoria = 'GENERAL';
                    const clave = config.clave;
                    if (clave.startsWith('EMPRESA_')) categoria = 'EMPRESA';
                    else if (clave.startsWith('UI_')) categoria = 'INTERFAZ';
                    else if (clave.startsWith('QR_')) categoria = 'CAMARA_QR';
                    else if (clave.includes('CONTRASEÑA') || clave.includes('SESION') || clave.includes('BLOQUEO') || clave.includes('AUDIT')) categoria = 'SEGURIDAD';
                    else if (clave.startsWith('NOTIF') || clave.includes('EMAIL') || clave === 'SONIDOS_ACTIVADOS') categoria = 'NOTIFICACIONES';
                    else if (clave.startsWith('CACHE_')) categoria = 'CACHE';
                    else if (clave.startsWith('REPORTE_') || clave.startsWith('ESTADISTICAS_')) categoria = 'REPORTES';
                    else if (clave.startsWith('EVACUACION_')) categoria = 'EVACUACION';
                    else if (clave.includes('BACKUP') || clave.includes('ARCHIVO') || clave.includes('LIMPIAR') || clave.includes('OPTIMIZAR')) categoria = 'ARCHIVO';
                    else if (clave.startsWith('TEMA_') || clave.includes('IDIOMA') || clave.includes('MOSTRAR') || clave.includes('DASHBOARD')) categoria = 'PERSONALIZACION';
                    else if (clave.startsWith('INTEGRACION_') || clave.startsWith('WEBHOOK_')) categoria = 'INTEGRACION';
                    categorias[categoria].push(config);
                });

                // Store config data globally for modal access
                globalConfig = {
                    categorias: categorias,
                    configuraciones: configuraciones
                };
                
                renderConfigCategories(categorias, configuraciones);
            } else {
                console.error('❌ [FRONTEND] Error en respuesta de configuración:', response?.message);
                updateConfigStatus('error', response?.message || 'Error desconocido al cargar configuración');
                const container = document.getElementById('config-form-container');
                container.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-red-500 mb-4">${response?.message || 'Error al cargar configuración'}</p>
                        <button onclick="setupSystemConfigUI()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                            <i class="fas fa-sync-alt mr-2"></i>Reintentar
                        </button>
                    </div>
                `;
            }
        }

        /**
         * Manejador de fallo mejorado para la carga de configuración.
         * @param {Object} error - El objeto de error retornado por Google Apps Script.
         */
        function openConfigModal(categoria) {
            const modal = document.getElementById('config-modal');
            const title = document.getElementById('config-modal-title');
            const body = document.getElementById('config-modal-body');
            const categoriaTitulos = {
                'EMPRESA': '🏢 Configuración de Empresa',
                'INTERFAZ': '🎨 Interfaz de Usuario',
                'CAMARA_QR': '📸 Cámara QR',
                'SEGURIDAD': '🔐 Seguridad',
                'NOTIFICACIONES': '🔔 Notificaciones',
                'CACHE': '⏱️ Cache y Rendimiento',
                'REPORTES': '📊 Reportes',
                'EVACUACION': '🚨 Sistema de Evacuación',
                'ARCHIVO': '🗂️ Archivo y Limpieza',
                'PERSONALIZACION': '🎨 Personalización',
                'INTEGRACION': '⚡ Integraciones',
                'GENERAL': '⚙️ Configuración General'
            };

            title.textContent = categoriaTitulos[categoria] || 'Editar Configuración';

            // Get configurations for this category
            const configs = globalConfig.categorias[categoria];
            let formHTML = `
                <form id="modal-config-form" class="space-y-4">
                    <input type="hidden" name="categoria" value="${categoria}">
            `;

            configs.forEach(config => {
                const label = config.descripcion || config.clave.replace(/_/g, ' ').toLowerCase()
                    .replace(/\b\w/g, l => l.toUpperCase());
                
                if (config.valor === 'SI' || config.valor === 'NO' || typeof config.valor === 'boolean') {
                    const isChecked = config.valor === 'SI' || config.valor === true;
                    formHTML += `
                        <div class="mb-4">
                            <label class="flex items-center space-x-3">
                                <input type="checkbox" name="${config.clave}" 
                                    ${isChecked ? 'checked' : ''} value="SI"
                                    class="w-4 h-4 text-red-600 bg-gray-700 border-gray-600 rounded focus:ring-red-500">
                                <span class="text-sm font-medium text-gray-300">${label}</span>
                            </label>
                            <small class="text-gray-500 ml-7">${config.clave}</small>
                        </div>
                    `;
                } else {
                    formHTML += `
                        <div class="mb-4">
                            <label for="modal-config-${config.clave}" class="block text-sm font-medium text-gray-300 mb-1">${label}</label>
                            <input type="text" id="modal-config-${config.clave}" 
                                   name="${config.clave}" 
                                   value="${config.valor || ''}"
                                   class="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-red-600 text-white">
                            <small class="text-gray-500">${config.clave}</small>
                        </div>
                    `;
                }
            });

            formHTML += `
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="document.getElementById('config-modal').classList.add('hidden')" 
                                class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg">
                            Cancelar
                        </button>
                        <button type="submit" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">
                            Guardar Cambios
                        </button>
                    </div>
                </form>
            `;

            body.innerHTML = formHTML;
            modal.classList.remove('hidden');

            // Add form submission handler
            const form = document.getElementById('modal-config-form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveCategoryConfig(categoria, new FormData(form));
                });
            }
        }

        function saveCategoryConfig(categoria, formData) {
            const configs = [];
            const formDataObj = Object.fromEntries(formData.entries());
            
            // Convert form data back to config format
            for (const [key, value] of Object.entries(formDataObj)) {
                if (key !== 'categoria') {
                    configs.push({
                        clave: key,
                        valor: value,
                        descripcion: '' // Will be filled in from original config
                    });
                }
            }

            // Show loading state
            const submitBtn = document.querySelector('#config-modal button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';

            // In a real implementation, you would send this to your backend
            console.log('Saving config for category:', categoria, configs);
            
            // Simulate API call
            setTimeout(() => {
                // Close modal and show success message
                document.getElementById('config-modal').classList.add('hidden');
                showNotification('Configuración guardada exitosamente', 'success');
                
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                
                // Optional: Refresh the config view
                // setupSystemConfigUI();
            }, 1000);
        }

        function renderConfigCategories(categorias, configuraciones) {
            const container = document.getElementById('config-form-container');
            const categoriaTitulos = {
                'EMPRESA': '🏢 Configuración de Empresa',
                'INTERFAZ': '🎨 Interfaz de Usuario',
                'CAMARA_QR': '📸 Cámara QR',
                'SEGURIDAD': '🔐 Seguridad',
                'NOTIFICACIONES': '🔔 Notificaciones',
                'CACHE': '⏱️ Cache y Rendimiento',
                'REPORTES': '📊 Reportes',
                'EVACUACION': '🚨 Sistema de Evacuación',
                'ARCHIVO': '🗂️ Archivo y Limpieza',
                'PERSONALIZACION': '🎨 Personalización',
                'INTEGRACION': '⚡ Integraciones',
                'GENERAL': '⚙️ Configuración General'
            };

            let contentHTML = `
                <div class="bg-blue-900/30 p-4 rounded-lg border border-blue-600/30 mb-6">
                    <h3 class="text-lg font-semibold text-blue-300 mb-2">
                        📋 Sistema de Configuración SurPass V6.2
                    </h3>
                    <p class="text-blue-200">
                        Total: <span class="font-bold">${configuraciones.length}</span> configuraciones organizadas en 
                        <span class="font-bold">${Object.keys(categorias).filter(cat => categorias[cat].length > 0).length}</span> categorías. 
                        <span class="text-sm">Haga clic en una categoría para editar.</span>
                    </p>
                </div>
                <div id="config-categories-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            `;

            for (const categoria in categorias) {
                if (categorias[categoria].length > 0) {
                    contentHTML += `
                        <div class="config-card bg-gray-800/50 p-4 rounded-lg border border-gray-700 hover:bg-gray-700/60 hover:border-blue-500 cursor-pointer transition-all duration-300 flex flex-col justify-between"
                             onclick="openConfigModal('${categoria}')">
                            <div>
                                <h4 class="text-md font-semibold text-gray-200 flex items-center mb-2">
                                    ${categoriaTitulos[categoria] || categoria}
                                </h4>
                                <p class="text-xs text-gray-400">${categorias[categoria].length} opciones</p>
                            </div>
                            <div class="text-right mt-2">
                                <span class="text-blue-400 text-xs font-bold">Clic para editar &rarr;</span>
                            </div>
                        </div>
                    `;
                }
            }

            contentHTML += '</div>';
            container.innerHTML = contentHTML;
        }

        function onConfigurationError(error) {
            console.error('❌ [FRONTEND] Error crítico en carga de configuración:', error);
            updateConfigStatus('error', 'Error de conexión con el servidor');
            const container = document.getElementById('config-form-container');
            container.innerHTML = `
                <div class="text-center py-8">
                    <div class="bg-red-900/30 border border-red-600 rounded-lg p-4 mb-4">
                        <i class="fas fa-exclamation-triangle text-red-400 text-xl mb-2"></i>
                        <p class="text-red-300 font-medium">Error de conexión</p>
                        <p class="text-red-200 text-sm mt-1">${error?.message || 'No se pudo conectar con el servidor'}</p>
                    </div>
                    <button onclick="setupSystemConfigUI()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">
                        <i class="fas fa-sync-alt mr-2"></i>Reintentar Carga
                    </button>
                </div>
            `;
        }

        function renderConfigForm(response) {
            const container = document.getElementById('config-form-container');
            
            if (!response || !response.success) {
                container.innerHTML = `<p class="text-red-500">${response?.message || 'Error al cargar configuración'}</p>`;
                return;
            }

            const configuraciones = response.configuraciones || [];
            const categorias = response.categorias || {};

            const categoriaTitulos = {
                'EMPRESA': '🏢 Configuración de Empresa',
                'INTERFAZ': '🎨 Interfaz de Usuario', 
                'CAMARA_QR': '📸 Cámara QR',
                'SEGURIDAD': '🔐 Seguridad',
                'NOTIFICACIONES': '🔔 Notificaciones',
                'CACHE': '⏱️ Cache y Rendimiento',
                'REPORTES': '📊 Reportes',
                'EVACUACION': '🚨 Sistema de Evacuación',
                'ARCHIVO': '🗂️ Archivo y Limpieza',
                'PERSONALIZACION': '🎨 Personalización',
                'INTEGRACION': '⚡ Integraciones',
                'GENERAL': '⚙️ Configuración General'
            };

            let formHTML = `<form id="config-form" class="space-y-6">`;
            
            // Mostrar contador total
            formHTML += `
                <div class="bg-blue-900/30 p-4 rounded-lg border border-blue-600/30">
                    <h3 class="text-lg font-semibold text-blue-300 mb-2">
                        📋 Sistema de Configuración SurPass V6.2
                    </h3>
                    <p class="text-blue-200">
                        Total: <span class="font-bold">${configuraciones.length}</span> configuraciones organizadas en 
                        <span class="font-bold">${Object.keys(categorias).filter(cat => categorias[cat].length > 0).length}</span> categorías
                    </p>
                </div>
            `;
            
            // Generar secciones por categoría
            Object.keys(categorias).forEach(categoria => {
                if (categorias[categoria].length === 0) return;
                
                formHTML += `
                    <div class="bg-gray-800/50 p-4 rounded-lg border border-gray-600">
                        <h3 class="text-lg font-semibold text-gray-200 mb-4 flex items-center">
                            ${categoriaTitulos[categoria] || categoria}
                            <span class="ml-2 bg-gray-600 text-xs px-2 py-1 rounded-full">${categorias[categoria].length}</span>
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                `;
                
                categorias[categoria].forEach(config => {
                    const label = config.descripcion || config.clave.replace(/_/g, ' ').toLowerCase()
                        .replace(/\b\w/g, l => l.toUpperCase());
                    
                    let inputType = 'text';
                    if (config.valor === 'SI' || config.valor === 'NO' || config.valor === true || config.valor === false) {
                        // Campo tipo toggle para valores SI/NO
                        const isChecked = config.valor === 'SI' || config.valor === true;
                        formHTML += `
                            <div>
                                <label class="flex items-center space-x-3">
                                    <input type="checkbox" id="config-${config.clave}" name="${config.clave}" 
                                        ${isChecked ? 'checked' : ''} value="SI"
                                        class="w-4 h-4 text-red-600 bg-gray-700 border-gray-600 rounded focus:ring-red-500">
                                    <span class="text-sm font-medium text-gray-300">${label}</span>
                                </label>
                                <small class="text-gray-500 ml-7">${config.clave}</small>
                            </div>
                        `;
                    } else {
                        // Campo de texto normal
                        if (config.clave.includes('EMAIL') || config.clave.includes('URL')) inputType = 'url';
                        if (config.clave.includes('TELEFONO')) inputType = 'tel';
                        if (config.clave.includes('NUMERO') || config.clave.includes('DURACION') || config.clave.includes('CAMPO_VISION')) inputType = 'number';
                        if (config.clave.includes('COLOR')) inputType = 'color';
                        
                        formHTML += `
                            <div>
                                <label for="config-${config.clave}" class="block text-sm font-medium text-gray-300 mb-1">${label}</label>
                                <input type="${inputType}" id="config-${config.clave}" name="${config.clave}" 
                                    value="${config.valor || ''}"
                                    placeholder="${config.clave.includes('URL') ? 'https://...' : config.clave.includes('EMAIL') ? 'ejemplo@dominio.com' : ''}"
                                    class="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-red-600 text-white">
                                <small class="text-gray-500">${config.clave}</small>
                            </div>
                        `;
                    }
                });
                
                formHTML += `
                        </div>
                    </div>
                `;
            });

            formHTML += `
                    <div class="flex space-x-4">
                        <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg flex items-center">
                            <i class="fa-solid fa-save mr-2"></i>Guardar Configuración
                        </button>
                        <button type="button" onclick="setupSystemConfigUI()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg flex items-center">
                            <i class="fa-solid fa-refresh mr-2"></i>Recargar
                        </button>
                    </div>
                </form>`;
            
            container.innerHTML = formHTML;
            
            // Añadir evento de submit
            document.getElementById('config-form').addEventListener('submit', handleConfigSave);
        }

        // Función mejorada para guardar configuración (llamada desde el botón)
        function saveConfiguration() {
            console.log('💾 [FRONTEND] Iniciando guardado de configuración...');
            
            // Verificar si estamos usando el nuevo sistema de configuración
            const newSystemContainer = document.getElementById('config-categories-container');
            const oldSystemForm = document.getElementById('config-form');
            
            if (newSystemContainer && newSystemContainer.children.length > 0) {
                // Estamos usando el nuevo sistema, mostrar mensaje informativo
                console.log('ℹ️ [FRONTEND] Usando nuevo sistema de configuración - editar por categorías');
                
                // Usar showGeneralMessage si está disponible
                if (typeof showGeneralMessage === 'function') {
                    showGeneralMessage(
                        'Nuevo Sistema de Configuración', 
                        'Para guardar configuraciones, haga clic en una categoría y edite los valores en el modal que se abre.',
                        'info'
                    );
                } else {
                    // Fallback: mostrar alerta simple
                    alert('Nuevo Sistema de Configuración:\n\nPara guardar configuraciones, haga clic en una categoría y edite los valores en el modal que se abre.');
                }
                return;
            }
            
            if (oldSystemForm) {
                // Sistema antiguo - usar formulario tradicional
                console.log('🔄 [FRONTEND] Usando sistema antiguo de configuración');
                
                // Solo llamar updateConfigStatus si existe
                if (typeof updateConfigStatus === 'function') {
                    updateConfigStatus('cargando', '💾 Guardando configuración...');
                }
                
                oldSystemForm.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
            } else {
                // No hay sistema disponible
                console.error('❌ [FRONTEND] No se encontró sistema de configuración disponible');
                
                // Intentar usar showGeneralMessage si existe, si no usar showNotification
                if (typeof showGeneralMessage === 'function') {
                    showGeneralMessage('Error', 'Sistema de configuración no disponible', 'error');
                } else if (typeof showNotification === 'function') {
                    showNotification('Sistema de configuración no disponible', 'error');
                } else {
                    alert('Error: Sistema de configuración no disponible');
                }
            }
        }

        // Función auxiliar para asegurar que showGeneralMessage esté siempre disponible
        if (typeof showGeneralMessage !== 'function') {
            function showGeneralMessage(title, message, type) {
                console.log(`${title}: ${message} (${type})`);
                
                // Buscar si existe el modal de mensaje
                const modal = document.getElementById('message-modal');
                if (modal) {
                    const titleElement = document.getElementById('message-title');
                    const textElement = document.getElementById('message-text');
                    const iconContainer = document.getElementById('message-icon-container');
                    
                    if (titleElement) titleElement.textContent = title;
                    if (textElement) textElement.textContent = message;
                    if (iconContainer) {
                        iconContainer.innerHTML = '';
                        if (type === 'success') {
                            iconContainer.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
                        } else if (type === 'error') {
                            iconContainer.innerHTML = '<i class="fas fa-times-circle text-red-500"></i>';
                        } else if (type === 'warning') {
                            iconContainer.innerHTML = '<i class="fas fa-exclamation-triangle text-yellow-500"></i>';
                        } else {
                            iconContainer.innerHTML = '<i class="fas fa-info-circle text-blue-500"></i>';
                        }
                    }
                    
                    modal.classList.remove('hidden');
                } else {
                    // Fallback a alert
                    alert(`${title}\n\n${message}`);
                }
            }
        }

        function handleConfigSave(e) {
            e.preventDefault();
            const form = e.target;
            const newConfig = {};
            
            // Procesar todos los inputs del formulario
            const formInputs = form.querySelectorAll('input[name]');
            formInputs.forEach(input => {
                if (input.type === 'checkbox') {
                    // Para checkboxes, usar SI/NO
                    newConfig[input.name] = input.checked ? 'SI' : 'NO';
                } else {
                    // Para otros tipos de input, usar el valor directamente
                    newConfig[input.name] = input.value;
                }
            });
            
            console.log('💾 [FRONTEND] Datos a guardar:', newConfig);
            mostrarLoading('Guardando configuración...');
            
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler(onConfigSaveSuccess)
                    .withFailureHandler(onConfigSaveError)
                    .actualizarConfiguracionMultiple(newConfig);
            } else {
                setTimeout(() => {
                    ocultarLoading();
                    updateConfigStatus('cargado', '✅ Configuración guardada (modo demo)');
                    showNotification('Configuración guardada (modo demo)', 'success');
                }, 1000);
            }
        }

        /**
         * Manejador de éxito para guardado de configuración.
         * @param {Object} response - Respuesta del servidor.
         */
        function onConfigSaveSuccess(response) {
            ocultarLoading();
            console.log('✅ [FRONTEND] Respuesta de guardado:', response);
            
            if (response?.success) {
                const mensaje = `✅ Configuración guardada exitosamente${response.lastSaved ? ` - ${response.lastSaved}` : ''}`;
                updateConfigStatus('cargado', mensaje);
                showNotification(mensaje, 'success');
                
                // Recargar configuración después de guardar para mostrar cambios
                setTimeout(() => setupSystemConfigUI(), 1500);
            } else {
                const mensajeError = response?.message || 'Error desconocido al guardar';
                updateConfigStatus('error', `❌ Error: ${mensajeError}`);
                showNotification(`Error al guardar: ${mensajeError}`, 'error');
            }
        }

        /**
         * Manejador de error para guardado de configuración.
         * @param {Object} error - Error del servidor.
         */
        function onConfigSaveError(error) {
            ocultarLoading();
            console.error('❌ [FRONTEND] Error crítico guardando configuración:', error);
            updateConfigStatus('error', '❌ Error de conexión al guardar');
            showNotification('Error de conexión al guardar configuración', 'error');
        }

        function loadAdminUsers() {
            const container = document.getElementById('users-table-container');
            
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler((response) => {
                        console.log('Admin users data received:', response);
                        if (response && response.success && response.admins) {
                            renderAdminUsersTable(response.admins);
                            
                            // Mostrar estadísticas si están disponibles
                            if (response.stats) {
                                const statsHTML = `
                                    <div class="mb-4 grid grid-cols-3 gap-4">
                                        <div class="bg-gray-700 p-3 rounded-lg text-center">
                                            <div class="text-2xl font-bold text-blue-400">${response.stats.total}</div>
                                            <div class="text-sm text-gray-400">Total</div>
                                        </div>
                                        <div class="bg-gray-700 p-3 rounded-lg text-center">
                                            <div class="text-2xl font-bold text-green-400">${response.stats.activos}</div>
                                            <div class="text-sm text-gray-400">Activos</div>
                                        </div>
                                        <div class="bg-gray-700 p-3 rounded-lg text-center">
                                            <div class="text-2xl font-bold text-yellow-400">${response.stats.permisos_completos || 0}</div>
                                            <div class="text-sm text-gray-400">Admin Completo</div>
                                        </div>
                                    </div>
                                `;
                                document.getElementById('users-table-container').insertAdjacentHTML('afterbegin', statsHTML);
                            }
                        } else {
                            document.getElementById('users-table-container').innerHTML = `
                                <div class="text-center">
                                    <p class="text-red-500 mb-4">Error al cargar usuarios admin</p>
                                    <button onclick="repararSistema()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                                        <i class="fa-solid fa-wrench mr-2"></i>Reparar Sistema
                                    </button>
                                </div>
                            `;
                        }
                    })
                    .withFailureHandler((error) => {
                        console.error('Error cargando usuarios:', error);
                        document.getElementById('users-table-container').innerHTML = `
                            <div class="text-center">
                                <p class="text-red-500 mb-4">Error al cargar usuarios admin</p>
                                <button onclick="repararSistema()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                                    <i class="fa-solid fa-wrench mr-2"></i>Reparar Sistema
                                </button>
                            </div>
                        `;
                    })
                    .doLoadAdminUsers();
            } else {
                // Datos de demostración
                const mockAdmins = [
                    { 
                        cedula: '8-779-1613', 
                        nombre: 'ARTURO FERNÁNDEZ', 
                        cargo: 'Administrador', 
                        email: 'admin@surpass.com', 
                        estado: 'activo' 
                    },
                    { 
                        cedula: '12345678', 
                        nombre: 'Juan Pérez', 
                        cargo: 'Supervisor', 
                        email: 'juan@empresa.com', 
                        estado: 'activo' 
                    },
                    { 
                        cedula: '123456', 
                        nombre: 'pedro', 
                        cargo: 'Operador', 
                        email: 'maria@empresa.com', 
                        estado: 'activo' 
                    },
                    { 
                        cedula: '987654321', 
                        nombre: 'lucas', 
                        cargo: 'Operador', 
                        email: 'maria@empresa.com', 
                        estado: 'inactivo' 
                    }
                ];
                
                // Calcular estadísticas correctas
                const stats = {
                    total: mockAdmins.length,
                    activos: mockAdmins.filter(admin => admin.estado === 'activo').length,
                    permisos_completos: mockAdmins.filter(admin => admin.cargo === 'Administrador').length
                };
                
                // Mostrar estadísticas
                const statsHTML = `
                    <div class="mb-4 grid grid-cols-3 gap-4">
                        <div class="bg-gray-700 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-400">${stats.total}</div>
                            <div class="text-sm text-gray-400">Total</div>
                        </div>
                        <div class="bg-gray-700 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-400">${stats.activos}</div>
                            <div class="text-sm text-gray-400">Activos</div>
                        </div>
                        <div class="bg-gray-700 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-yellow-400">${stats.permisos_completos}</div>
                            <div class="text-sm text-gray-400">Admin Completo</div>
                        </div>
                    </div>
                `;
                
                const container = document.getElementById('users-table-container');
                container.innerHTML = statsHTML;
                renderAdminUsersTable(mockAdmins);
            }
        }

        function renderAdminUsersTable(data) {
    const container = document.getElementById('users-table-container');
    
    if (!data || data.length === 0) {
        // Solo reemplazar si no hay estadísticas previas
        const hasStats = container.querySelector('.grid');
        if (!hasStats) {
            container.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-user-shield text-6xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-600 mb-2">No hay administradores registrados</h3>
                    <p class="text-gray-500 mb-4">Comience creando el primer usuario administrador.</p>
                    <button onclick="openAdminModal()" class="btn-primary">
                        <i class="fas fa-user-plus mr-2"></i>Crear Primer Administrador
                    </button>
                </div>
            `;
        } else {
            // Solo añadir el mensaje de no hay datos después de las estadísticas
            const existingStats = container.innerHTML;
            container.innerHTML = existingStats + `
                <div class="text-center py-8">
                    <i class="fas fa-user-shield text-6xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-600 mb-2">No hay administradores registrados</h3>
                    <p class="text-gray-500 mb-4">Comience creando el primer usuario administrador.</p>
                    <button onclick="openAdminModal()" class="btn-primary">
                        <i class="fas fa-user-plus mr-2"></i>Crear Primer Administrador
                    </button>
                </div>
            `;
        }
        return;
    }
    
    let tableHTML = `
        <div class="overflow-x-auto rounded-lg border border-gray-700">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Cédula/Usuario</th>
                        <th>Nombre</th>
                        <th>Cargo</th>
                        <th>Email</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    data.forEach(admin => {
        const estado = String(admin.estado || 'activo').toLowerCase();
        const statusClass = estado === 'activo' ? 'status-active' : 'status-inactive';
        
        tableHTML += `
            <tr data-cedula="${admin && typeof admin.cedula !== 'undefined' ? admin.cedula : ''}">
                <td><strong>${admin && typeof admin.cedula !== 'undefined' ? admin.cedula : 'N/A'}</strong></td>
                <td>${admin && typeof admin.nombre !== 'undefined' ? admin.nombre : 'N/A'}</td>
                <td>${admin && typeof admin.cargo !== 'undefined' ? admin.cargo : 'Administrador'}</td>
                <td>${admin && typeof admin.email !== 'undefined' ? admin.email : 'N/A'}</td>
                <td><span class="status-badge ${statusClass}">${estado === 'activo' ? 'ACTIVO' : 'INACTIVO'}</span></td>
                <td>
                    <div class="flex gap-2">
                        <button class="action-btn action-edit bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm" 
                                onclick="editAdmin('${admin && typeof admin.cedula !== 'undefined' ? admin.cedula : ''}')" title="Editar">
                            <i class="fas fa-edit mr-1"></i>Editar
                        </button>
                        <button class="action-btn action-toggle ${estado === 'activo' ? 'bg-orange-600 hover:bg-orange-700' : 'bg-green-600 hover:bg-green-700'} text-white px-3 py-2 rounded text-sm" 
                                onclick="toggleAdminStatus('${admin && typeof admin.cedula !== 'undefined' ? admin.cedula : ''}', '${estado}')" title="Cambiar Estado">
                            <i class="fas fa-toggle-${estado === 'activo' ? 'off' : 'on'} mr-1"></i>${estado === 'activo' ? 'Desactivar' : 'Activar'}
                        </button>
                        <button class="action-btn action-delete bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm" 
                                onclick="confirmDeleteAdmin('${admin && typeof admin.cedula !== 'undefined' ? admin.cedula : ''}', '${admin && typeof admin.nombre !== 'undefined' ? admin.nombre : ''}')" title="Eliminar">
                            <i class="fas fa-trash mr-1"></i>Eliminar
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    tableHTML += `
                </tbody>
            </table>
        </div>
    `;
    
    // Si ya hay estadísticas, añadir la tabla después de ellas
    const hasStats = container.querySelector('.grid');
    if (hasStats) {
        container.insertAdjacentHTML('beforeend', tableHTML);
    } else {
        container.innerHTML = tableHTML;
    }
}

/**
 * Abre modal para editar administrador
 */
function editAdmin(cedula) {
    console.log('Editando administrador:', cedula);
    // Por ahora, usar el modal genérico
    openAdminModal(cedula);
}

        // 🔧 [DEBUG] Función de prueba de conectividad
        function testBackendConnection() {
            console.log('🔍 [DEBUG] Probando conexión con backend...');
            
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler((response) => {
                        console.log('✅ [DEBUG] Test connection response:', response);
                        if (response && response.success) {
                            showNotification('✅ Conexión con backend OK: ' + response.message, 'success');
                        } else {
                            showNotification('⚠️ Backend respondió pero con error: ' + (response?.message || 'Sin mensaje'), 'warning');
                        }
                    })
                    .withFailureHandler((error) => {
                        console.error('❌ [DEBUG] Test connection error:', error);
                        showNotification('❌ Error de conexión: ' + error.message, 'error');
                    })
                    .doTestConnection();
            } else {
                console.log('⚠️ [DEBUG] Google Apps Script no disponible - modo desarrollo');
                showNotification('⚠️ Modo desarrollo - Google Apps Script no disponible', 'warning');
            }
        }

        // 🔧 [FIX] Función mejorada para cargar logs con mejor manejo de errores
        function loadLogs() {
            const container = document.getElementById('logs-table-container');
            mostrarLoading('Cargando logs del sistema...');
            container.innerHTML = '';
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler((response) => {
                        console.log('✅ Logs data received:', response);
                        console.log('✅ Response type:', typeof response);
                        console.log('✅ Response success:', response?.success);
                        console.log('✅ Response logs:', response?.logs);
                        // Manejar respuesta nula o vacía
                        if (!response || response === null || response === undefined) {
                            ocultarLoading();
                            container.innerHTML = `
                                <div class="text-center py-8">
                                    <i class="fas fa-exclamation-triangle text-6xl text-red-400 mb-4"></i>
                                    <h3 class="text-xl font-semibold text-red-300 mb-2">Error al cargar logs</h3>
                                    <p class="text-red-200 mb-4">El servidor no devolvió datos válidos. Posible problema de permisos o configuración.</p>
                                    <div class="mt-4 text-left bg-gray-800 p-4 rounded-lg text-sm">
                                        <strong>Diagnóstico:</strong><br>
                                        - Respuesta recibida: ${response}<br>
                                        - Tipo: ${typeof response}<br>
                                        - Timestamp: ${new Date().toISOString()}
                                    </div>
                                    <button onclick="loadLogs()" class="btn-secondary mt-4">
                                        <i class="fas fa-sync mr-2"></i>Reintentar
                                    </button>
                                </div>
                            `;
                            showNotification('Error: El servidor no devolvió datos válidos', 'error');
                            return;
                        }
                        if (response && response.success) {
                            console.log('✅ [DEBUG] Response.logs:', response.logs);
                            console.log('✅ [DEBUG] Response.logs type:', typeof response.logs);
                            console.log('✅ [DEBUG] Response.logs is array:', Array.isArray(response.logs));
                            
                            // Procesar logs recibidos - ADAPTADOR DE FORMATO
                            let allLogs = [];
                            
                            if (Array.isArray(response.logs)) {
                                // Adaptar el formato de logs del backend al formato esperado por el frontend
                                allLogs = response.logs.map(log => ({
                                    id: log.id || `log_${Date.now()}_${Math.random()}`,
                                    fecha: log.fecha || log.timestamp || new Date().toISOString(),
                                    nivel: (log.nivel || log.tipo || log.level || 'INFO').toString().toUpperCase(),
                                    mensaje: log.mensaje || log.message || 'Sin mensaje',
                                    usuario: log.usuario || log.user || 'Sistema',
                                    detalles: log.detalles || log.datos || log.details || log.data || '',
                                    ip: log.ip || 'N/A'
                                }));
                                
                                console.log('✅ [DEBUG] Logs adaptados:', allLogs);
                            } else {
                                console.warn('⚠️ [DEBUG] response.logs no es un array:', response.logs);
                                allLogs = [];
                            }
                            
                            // Unir errores de la hoja "Errores" si vienen separados
                            const errores = response.errors || response.errores;
                            if (Array.isArray(errores) && errores.length) {
                                const mapped = errores.map(e => ({
                                    id: `error_${Date.now()}_${Math.random()}`,
                                    fecha: e.fecha || e.timestamp || e.fechaHora || new Date().toISOString(),
                                    nivel: 'ERROR',
                                    mensaje: e.mensaje || e.message || JSON.stringify(e),
                                    usuario: e.usuario || 'Sistema',
                                    detalles: e.detalles || '',
                                    ip: 'N/A'
                                }));
                                allLogs = allLogs.concat(mapped);
                            }

                            console.log('✅ [DEBUG] All logs final:', allLogs);
                            renderLogsTable(allLogs);
                            // Mostrar estadísticas si están disponibles
                            if (response.stats) {
                                const statsHTML = `
                                    <div class="mb-4 grid grid-cols-4 gap-4">
                                        <div class="bg-gray-700 p-3 rounded-lg text-center">
                                            <div class="text-2xl font-bold text-blue-400">${response.stats.total}</div>
                                            <div class="text-sm text-gray-400">Total</div>
                                        </div>
                                        <div class="bg-gray-700 p-3 rounded-lg text-center">
                                            <div class="text-2xl font-bold text-red-400">${response.stats.errores}</div>
                                            <div class="text-sm text-gray-400">Errores</div>
                                        </div>
                                        <div class="bg-gray-700 p-3 rounded-lg text-center">
                                            <div class="text-2xl font-bold text-yellow-400">${response.stats.warnings}</div>
                                            <div class="text-sm text-gray-400">Warnings</div>
                                        </div>
                                        <div class="bg-gray-700 p-3 rounded-lg text-center">
                                            <div class="text-2xl font-bold text-green-400">${response.stats.info}</div>
                                            <div class="text-sm text-gray-400">Info</div>
                                        </div>
                                    </div>
                                `;
                                container.insertAdjacentHTML('afterbegin', statsHTML);
                            }
                            ocultarLoading();
                            showNotification(`${allLogs.length} logs cargados exitosamente`, 'success');
                        } else {
                            console.error('❌ [DEBUG] Response no válida o sin success:', response);
                            
                            // Verificar si hay logs directamente en response (formato alternativo)
                            if (Array.isArray(response)) {
                                console.log('✅ [DEBUG] Response es array directo, adaptando...');
                                const adaptedLogs = response.map(log => ({
                                    id: log.id || `log_${Date.now()}_${Math.random()}`,
                                    fecha: log.fecha || log.timestamp || new Date().toISOString(),
                                    nivel: (log.nivel || log.tipo || 'INFO').toString().toUpperCase(),
                                    mensaje: log.mensaje || log.message || 'Sin mensaje',
                                    usuario: log.usuario || log.user || 'Sistema',
                                    detalles: log.detalles || log.datos || '',
                                    ip: log.ip || 'N/A'
                                }));
                                renderLogsTable(adaptedLogs);
                                ocultarLoading();
                                showNotification(`${adaptedLogs.length} logs cargados (formato directo)`, 'success');
                                return;
                            }
                            
                            ocultarLoading();
                            container.innerHTML = `
                                <div class="text-center py-8">
                                    <i class="fas fa-exclamation-triangle text-6xl text-red-400 mb-4"></i>
                                    <h3 class="text-xl font-semibold text-red-300 mb-2">Error al cargar logs</h3>
                                    <p class="text-red-200 mb-4">${response?.message || 'El servidor no devolvió datos válidos'}</p>
                                    <button onclick="loadLogs()" class="btn-secondary">
                                        <i class="fas fa-sync mr-2"></i>Reintentar
                                    </button>
                                </div>
                            `;
                            showNotification(response?.message || 'Error cargando logs', 'error');
                        }
                    })
                    .withFailureHandler((error) => {
                        console.error('❌ Error loading logs:', error);
                        ocultarLoading();
                        container.innerHTML = `
                            <div class="text-center py-8">
                                <i class="fas fa-exclamation-circle text-6xl text-red-400 mb-4"></i>
                                <h3 class="text-xl font-semibold text-red-300 mb-2">Error de conexión</h3>
                                <p class="text-red-200 mb-4">No se pudo conectar con el servidor para cargar los logs</p>
                                <div class="space-x-2">
                                    <button onclick="loadLogs()" class="btn-secondary">
                                        <i class="fas fa-sync mr-2"></i>Reintentar
                                    </button>
                                    <button onclick="repararSistema()" class="btn-primary">
                                        <i class="fas fa-wrench mr-2"></i>Reparar Sistema
                                    </button>
                                </div>
                            </div>
                        `;
                        showNotification('Error de conexión al cargar logs', 'error');
                    })
                    .doLoadLogs(50);
            } else {
                // Modo desarrollo - logs simulados
                mostrarLoading('Cargando logs del sistema...');
                setTimeout(() => {
                    const mockLogs = [
                        {
                            fecha: new Date(),
                            nivel: 'INFO',
                            mensaje: 'Sistema iniciado en modo desarrollo',
                            usuario: 'Sistema',
                            detalles: 'Modo demo activo'
                        },
                        {
                            fecha: new Date(Date.now() - 60000),
                            nivel: 'WARNING',
                            mensaje: 'Modo desarrollo detectado',
                            usuario: 'Sistema',
                            detalles: 'Google Apps Script no disponible'
                        }
                    ];
                    renderLogsTable(mockLogs);
                    ocultarLoading();
                    showNotification('Logs cargados (modo desarrollo)', 'info');
                }, 1000);
            }
        }

        // 🔧 [FIX] Función corregida para renderizar logs en admin.html
        function renderLogsTable(data) {
            const container = document.getElementById('logs-table-container');
            
            if (!data || data.length === 0) {
                container.innerHTML = `
                    <div class="p-8 text-center">
                        <i class="fas fa-file-alt text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">No hay logs registrados</h3>
                        <p class="text-gray-500 mb-4">Los logs del sistema aparecerán aquí cuando se generen eventos.</p>
                        <button onclick="loadLogs()" class="btn-secondary">
                            <i class="fas fa-sync mr-2"></i>Actualizar
                        </button>
                    </div>
                `;
                return;
            }
            
            let tableHTML = `
                <div class="overflow-x-auto rounded-lg border border-gray-700">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Nivel</th>
                                <th>Usuario</th>
                                <th>Mensaje</th>
                                <th>Detalles</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach(log => {
                // Determinar clase de color según el nivel
                let levelClass = 'text-gray-400';
                let levelIcon = 'fa-info-circle';
                
                const nivel = String(log.nivel || '').toUpperCase();
                switch (nivel) {
                    case 'ERROR':
                        levelClass = 'text-red-400';
                        levelIcon = 'fa-exclamation-circle';
                        break;
                    case 'WARNING':
                    case 'WARN':
                    case 'ADVERTENCIA':
                        levelClass = 'text-yellow-400';
                        levelIcon = 'fa-exclamation-triangle';
                        break;
                    case 'INFO':
                        levelClass = 'text-blue-400';
                        levelIcon = 'fa-info-circle';
                        break;
                    case 'DEBUG':
                        levelClass = 'text-purple-400';
                        levelIcon = 'fa-bug';
                        break;
                }
                
                // Formatear fecha de manera robusta
                let fechaFormateada = 'N/A';
                try {
                    if (log.fecha instanceof Date) {
                        fechaFormateada = log.fecha.toLocaleString('es-CO');
                    } else if (log.fecha) {
                        const fecha = new Date(log.fecha);
                        if (!isNaN(fecha.getTime())) {
                            fechaFormateada = fecha.toLocaleString('es-CO');
                        } else {
                            fechaFormateada = String(log.fecha);
                        }
                    }
                } catch (error) {
                    fechaFormateada = String(log.fecha || 'N/A');
                }
                
                // Truncar mensaje si es muy largo
                const mensaje = String(log.mensaje || 'N/A');
                const mensajeTruncado = mensaje.length > 100 ? mensaje.substring(0, 100) + '...' : mensaje;
                
                // Truncar detalles si es muy largo
                const detalles = String(log.detalles || '');
                const detallesTruncados = detalles.length > 50 ? detalles.substring(0, 50) + '...' : detalles;
                
                tableHTML += `
                    <tr class="hover:bg-gray-800/50 transition-colors">
                        <td class="whitespace-nowrap text-sm">${fechaFormateada}</td>
                        <td class="whitespace-nowrap">
                            <span class="${levelClass} font-medium flex items-center">
                                <i class="fas ${levelIcon} mr-2"></i>${nivel}
                            </span>
                        </td>
                        <td class="text-sm">${log.usuario || 'Sistema'}</td>
                        <td class="max-w-md">
                            <span class="text-sm" title="${mensaje}">${mensajeTruncado}</span>
                        </td>
                        <td class="max-w-xs">
                            ${detalles ? `<span class="text-xs text-gray-500" title="${detalles}">${detallesTruncados}</span>` : '<span class="text-xs text-gray-600">-</span>'}
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
                
                <!-- Información adicional -->
                <div class="mt-4 flex justify-between items-center text-sm text-gray-400">
                    <span>Total de registros: ${data.length}</span>
                    <div class="flex space-x-4">
                        <span class="text-red-400">
                            <i class="fas fa-exclamation-circle mr-1"></i>
                            Errores: ${data.filter(l => l.nivel === 'ERROR').length}
                        </span>
                        <span class="text-yellow-400">
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            Warnings: ${data.filter(l => ['WARNING', 'WARN', 'ADVERTENCIA'].includes(l.nivel)).length}
                        </span>
                        <span class="text-blue-400">
                            <i class="fas fa-info-circle mr-1"></i>
                            Info: ${data.filter(l => l.nivel === 'INFO').length}
                        </span>
                    </div>
                </div>
            `;
            
            container.innerHTML = tableHTML;
        }

        function loadEvacuationStatus() {
            const container = document.getElementById('evacuation-status-container');
            
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler((response) => {
                        console.log('Evacuation data received:', response);
                        if (response && response.success && response.data) {
                            renderEvacuationStatus(response.data);
                        } else {
                            container.innerHTML = '<p class="text-red-500">Error al cargar el estado de evacuación</p>';
                        }
                    })
                    .withFailureHandler((error) => {
                        console.error('Error cargando estado de evacuación:', error);
                        container.innerHTML = '<p class="text-red-500">Error al cargar el estado de evacuación</p>';
                    })
                    .loadEvacuationStatus();
            } else {
                // Datos de demostración
                renderEvacuationStatus({
                    general: { total: 100, evacuadas: 50, restantes: 50 },
                    completado: false
                });
            }
        }

        function renderEvacuationStatus(data) {
            const container = document.getElementById('evacuation-status-container');
            
            if (!data) {
                container.innerHTML = '<p class="text-red-500">Error: Datos de evacuación no disponibles</p>';
                return;
            }
            
            // El nuevo adminB.js devuelve una estructura diferente
            const total = data.total || 0;
            const evacuadas = data.evacuadas || 0;
            const restantes = data.restantes || total;
            const estado = data.estado || 'DESCONOCIDO';
            
            container.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gray-700 p-4 rounded-lg">
                            <p class="text-gray-400 text-sm">Total de personas</p>
                            <p class="text-2xl font-bold">${total}</p>
                        </div>
                        <div class="bg-gray-700 p-4 rounded-lg">
                            <p class="text-gray-400 text-sm">Personas evacuadas</p>
                            <p class="text-2xl font-bold text-green-500">${evacuadas}</p>
                        </div>
                        <div class="bg-gray-700 p-4 rounded-lg">
                            <p class="text-gray-400 text-sm">Personas restantes</p>
                            <p class="text-2xl font-bold text-red-500">${restantes}</p>
                        </div>
                    </div>
                    <div class="text-center p-4 bg-gray-700 rounded-lg">
                        <p class="text-xl font-bold ${estado === 'COMPLETA' ? 'text-green-500' : 'text-yellow-500'}">
                            Estado: ${estado === 'COMPLETA' ? 'Evacuación Completa' : estado === 'EN_CURSO' ? 'Evacuación en Curso' : 'Estado Desconocido'}
                        </p>
                    </div>
                    ${data.personas_detalle && data.personas_detalle.length > 0 ? `
                        <div class="bg-gray-700 p-4 rounded-lg">
                            <h4 class="text-lg font-semibold mb-3">Personas en el edificio:</h4>
                            <div class="space-y-2">
                                ${data.personas_detalle.map(persona => `
                                    <div class="flex justify-between items-center bg-gray-600 p-2 rounded">
                                        <span>${persona.nombre} (${typeof persona.cedula !== 'undefined' ? persona.cedula : 'N/A'})</span>
                                        <span class="text-sm text-gray-400">${persona.empresa} - ${persona.tiempo_dentro}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function runDiagnosis() {
            const container = document.getElementById('diagnostico-result-container');
            container.innerHTML = '<p class="text-gray-500">Ejecutando diagnóstico...</p>';
            mostrarLoading('Ejecutando diagnóstico del sistema...');
            
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler(response => {
                        ocultarLoading();
                        renderDiagnosisResult(response);
                        showNotification(
                            response?.mensaje || 'Diagnóstico completado',
                            response?.success ? 'success' : 'error'
                        );
                    })
                    .withFailureHandler(error => {
                        ocultarLoading();
                        container.innerHTML = '<p class="text-red-500">Error al ejecutar el diagnóstico.</p>';
                        showNotification('Error al ejecutar el diagnóstico', 'error');
                        console.error(error);
                    })
                    .ejecutarDiagnosticoUnificado('completo');
            } else {
                // Diagnóstico de demostración
                setTimeout(() => {
                    ocultarLoading();
                    renderDiagnosisResult({
                        success: true,
                        mensaje: 'Sistema operativo correctamente',
                        testsPasados: 5,
                        totalTests: 5
                    });
                    showNotification('Diagnóstico completado (modo demo)', 'success');
                }, 2000);
            }
        }

        function renderDiagnosisResult(response) {
            const container = document.getElementById('diagnostico-result-container');
            
            if (!response) {
                container.innerHTML = '<p class="text-red-500">Error: Sin respuesta del diagnóstico</p>';
                return;
            }
            
            const statusColor = response.success ? 'text-green-500' : 'text-red-500';
            const statusIcon = response.success ? 'fa-check-circle' : 'fa-exclamation-circle';
            
            let html = `
                <div class="space-y-4">
                    <div class="text-center p-6 bg-gray-700 rounded-lg">
                        <i class="fas ${statusIcon} text-4xl ${statusColor} mb-4"></i>
                        <p class="text-xl font-bold ${statusColor}">${response.mensaje || 'Diagnóstico completado'}</p>
                        <p class="text-gray-400 mt-2">
                            Tests pasados: <span class="font-bold">${response.testsPasados || 0} / ${response.totalTests || 0}</span>
                        </p>
                    </div>
                    ${response.detalles ? renderDiagnosisDetails(response.detalles) : ''}
                    ${response.diagnostico ? renderDiagnosticSummary(response.diagnostico) : ''}
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Alternar estado de evacuación
        function toggleEvacuation() {
            showLoader(true, 'Actualizando estado de evacuación...');
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler((response) => {
                        ocultarLoading();
                        if (typeof showNotification === 'function') showNotification('Estado de evacuación actualizado', 'success');
                        if (typeof loadEvacuationStatus === 'function') loadEvacuationStatus();
                    })
                    .withFailureHandler((error) => {
                        ocultarLoading();
                        console.error('Error al alternar evacuación:', error);
                        if (typeof showNotification === 'function') showNotification('No se pudo actualizar la evacuación', 'error');
                    })
                    .alternarEvacuacion();
            } else {
                // Modo desarrollo: simular toggle y recargar
                ocultarLoading();
                if (typeof showNotification === 'function') showNotification('Evacuación alternada (modo desarrollo)', 'success');
                if (typeof loadEvacuationStatus === 'function') loadEvacuationStatus();
            }
        }

        // Utilidades de zona horaria Panamá (fallback si no existen)
        if (typeof obtenerFechaHoraPanama !== 'function') {
            function obtenerFechaHoraPanama() {
                try {
                    const fmt = new Intl.DateTimeFormat('es-PA', { timeZone: 'America/Panama', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    return fmt.format(new Date());
                } catch {
                    return new Date().toISOString();
                }
            }
        }
        if (typeof convertirAZonaHoraPanama !== 'function') {
            function convertirAZonaHoraPanama(date) {
                try {
                    const d = date ? new Date(date) : new Date();
                    return new Date(d.toLocaleString('en-US', { timeZone: 'America/Panama' }));
                } catch {
                    return new Date(date);
                }
            }
        }

        function renderDiagnosisDetails(detalles) {
            let html = '<div class="mt-4 space-y-2"><h4 class="text-lg font-semibold mb-3">Detalles de Tests</h4>';

            // Nombres amigables para claves conocidas
            const nombres = {
                conectividad: 'Conectividad',
                estructura: 'Estructura de Hojas',
                personal: 'Datos de Personal',
                logs: 'Sistema de Logs'
            };

            for (const key in detalles) {
                const detail = detalles[key];
                if (detail && typeof detail === 'object') {
                    // Compatibilidad: usar 'pasado' si existe, si no, caer a 'status'/'ok'
                    const passed = (detail.pasado ?? detail.status ?? detail.ok ?? false) === true;
                    const status = passed ? '✅' : '❌';
                    const statusClass = passed ? 'text-green-400' : 'text-red-400';
                    const nombre = detail.nombre || nombres[key] || key;
                    const desc = detail.detalles || detail.mensaje || JSON.stringify(detail);

                    html += `
                        <div class="bg-gray-700 p-3 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="font-semibold ${statusClass}">${status} ${nombre}</span>
                                ${!passed ? `<button onclick="marcarComoResuelto('${key}')" class="text-xs bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded">Marcar como resuelto</button>` : ''}
                            </div>
                            <span class="ml-2 text-gray-400 text-sm">${desc}</span>
                        </div>
                    `;
                }
            }

            html += '</div>';
            return html;
        }

        function renderDiagnosticSummary(diagnostico) {
            if (!diagnostico.errores && !diagnostico.erroresManuales) {
                return '';
            }
            
            let html = '<div class="mt-6 space-y-4">';
            
            // Mostrar errores del sistema
            if (diagnostico.errores && diagnostico.errores.length > 0) {
                html += '<div class="bg-red-900/30 border border-red-500/50 p-4 rounded-lg">';
                html += '<h4 class="text-lg font-semibold text-red-400 mb-3"><i class="fas fa-exclamation-triangle mr-2"></i>Errores del Sistema</h4>';
                
                diagnostico.errores.forEach((error, index) => {
                    const errorObj = typeof error === 'string' ? { mensaje: error, id: `sistema_${index}` } : error;
                    html += `
                        <div class="bg-gray-800 p-3 rounded-lg mb-2">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="text-red-300 font-medium">${errorObj.mensaje}</p>
                                    ${errorObj.categoria ? `<p class="text-gray-400 text-sm">Categoría: ${errorObj.categoria}</p>` : ''}
                                    ${errorObj.solucion ? `<p class="text-blue-300 text-sm mt-1"><i class="fas fa-lightbulb mr-1"></i>${errorObj.solucion}</p>` : ''}
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="marcarComoResuelto('${errorObj.id}')" 
                                        class="text-xs bg-green-600 hover:bg-green-700 px-2 py-1 rounded">
                                        Resuelto
                                    </button>
                                    <button onclick="obtenerDetallesError('${errorObj.id}')" 
                                        class="text-xs bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded">
                                        Analizar
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            // Mostrar errores manuales
            if (diagnostico.erroresManuales && diagnostico.erroresManuales.length > 0) {
                html += '<div class="bg-orange-900/30 border border-orange-500/50 p-4 rounded-lg">';
                html += '<h4 class="text-lg font-semibold text-orange-400 mb-3"><i class="fas fa-user-edit mr-2"></i>Errores Reportados Manualmente</h4>';
                
                diagnostico.erroresManuales.forEach(error => {
                    html += `
                        <div class="bg-gray-800 p-3 rounded-lg mb-2">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="text-orange-300 font-medium">${error.descripcion}</p>
                                    <p class="text-gray-400 text-sm">Ubicación: ${error.ubicacion}</p>
                                    <p class="text-gray-400 text-sm">Categoría: ${error.categoria}</p>
                                    <p class="text-gray-400 text-sm">Reportado: ${new Date(error.timestamp).toLocaleString('es-CO')}</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="eliminarErrorManual('${error.id}')" 
                                        class="text-xs bg-red-600 hover:bg-red-700 px-2 py-1 rounded">
                                        Eliminar
                                    </button>
                                    <button onclick="mostrarAnalisisError('${error.id}')" 
                                        class="text-xs bg-purple-600 hover:bg-purple-700 px-2 py-1 rounded">
                                        Ver Análisis
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        }

        // *** FUNCIONES DE MODALES ***
        function openPersonModal(personOrCedula = null) {
            const modalContainer = document.getElementById('person-modal-container');
            
            let personData, title, cedula;
            
            if (personOrCedula === null) {
                // Nuevo usuario
                personData = { cedula: '', nombre: '', empresa: '', area: '', cargo: '', estado: 'activo' };
                title = 'Añadir Nueva Persona';
                cedula = null;
            } else if (typeof personOrCedula === 'string') {
                // Se pasó una cédula
                cedula = personOrCedula;
                personData = personalData.find(p => p.cedula === cedula) || 
                    { cedula: cedula, nombre: '', empresa: '', area: '', cargo: '', estado: 'activo' };
                title = 'Editar Persona';
            } else {
                // Se pasó un objeto persona
                personData = personOrCedula;
                cedula = personData.cedula;
                title = 'Editar Persona';
            }
            
            modalContainer.innerHTML = `
                <div class="modal-overlay">
                    <div class="modal-card">
                        <h3 class="text-xl font-semibold mb-4">${title}</h3>
                        <form id="person-form">
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-1">Cédula</label>
                                <input type="text" name="cedula" value="${personData.cedula}" ${cedula ? 'readonly' : ''} 
                                    class="w-full bg-gray-700 px-3 py-2 rounded-lg border border-gray-600" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-1">Nombre Completo</label>
                                <input type="text" name="nombre" value="${personData.nombre}" 
                                    class="w-full bg-gray-700 px-3 py-2 rounded-lg border border-gray-600" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-1">Empresa</label>
                                <input type="text" name="empresa" value="${personData.empresa}" 
                                    class="w-full bg-gray-700 px-3 py-2 rounded-lg border border-gray-600" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-1">Área</label>
                                <input type="text" name="area" value="${personData.area || ''}" 
                                    class="w-full bg-gray-700 px-3 py-2 rounded-lg border border-gray-600" required
                                    placeholder="Ej: Tecnología, Administración, Recursos Humanos">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-1">Cargo</label>
                                <input type="text" name="cargo" value="${personData.cargo}" 
                                    class="w-full bg-gray-700 px-3 py-2 rounded-lg border border-gray-600" required>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-1">Estado</label>
                                <select name="estado" class="w-full bg-gray-700 px-3 py-2 rounded-lg border border-gray-600" required>
                                    <option value="activo" ${(personData.estado || 'activo').toLowerCase() === 'activo' ? 'selected' : ''}>Activo</option>
                                    <option value="inactivo" ${(personData.estado || '').toLowerCase() === 'inactivo' ? 'selected' : ''}>Inactivo</option>
                                </select>
                            </div>
                            <div class="flex justify-end space-x-4 mt-6">
                                <button type="button" onclick="closePersonModal()" 
                                    class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">
                                    Cancelar
                                </button>
                                <button type="submit" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                                    ${cedula ? 'Actualizar' : 'Guardar'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.getElementById('person-form').addEventListener('submit', handlePersonSubmit);
        }

        function handlePersonSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const personData = Object.fromEntries(formData);
            
            // Verificar que todos los campos requeridos estén presentes
            if (!personData.cedula || !personData.nombre || !personData.empresa || !personData.area || !personData.cargo) {
                showNotification('Por favor complete todos los campos requeridos', 'error');
                return;
            }
            
            showLoadingModal('Guardando persona...');
            
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                // Determinar si es edición o creación nueva
                const isEdit = personalData.some(p => p.cedula === personData.cedula);
                
                if (isEdit) {
                    // Actualizar persona existente
                    google.script.run
                        .withSuccessHandler((result) => {
                            hideLoadingModal();
                            if (result && result.success) {
                                showNotification(result.message || 'Persona actualizada exitosamente', 'success');
                                closePersonModal();
                                loadPersonnel();
                            } else {
                                showNotification(result?.message || 'Error actualizando persona', 'error');
                            }
                        })
                        .withFailureHandler(error => {
                            hideLoadingModal();
                            showNotification('Error al actualizar persona: ' + error.message, 'error');
                            console.error(error);
                        })
                        .actualizarPersonal(personData.cedula, personData);
                } else {
                    // Crear nueva persona
                    google.script.run
                        .withSuccessHandler((result) => {
                            hideLoadingModal();
                            if (result && result.success) {
                                showNotification(result.message || 'Persona agregada exitosamente', 'success');
                                closePersonModal();
                                loadPersonnel();
                            } else {
                                showNotification(result?.message || 'Error guardando persona', 'error');
                            }
                        })
                        .withFailureHandler(error => {
                            hideLoadingModal();
                            showNotification('Error al guardar persona: ' + error.message, 'error');
                            console.error(error);
                        })
                        .savePersonData(personData);
                }
            } else {
                // Modo simulación
                setTimeout(() => {
                    const isEdit = personalData.some(p => p.cedula === personData.cedula);
                    
                    if (isEdit) {
                        // Actualizar en datos simulados
                        const index = personalData.findIndex(p => p.cedula === personData.cedula);
                        if (index !== -1) {
                            personalData[index] = { ...personalData[index], ...personData };
                        }
                        showNotification('Persona actualizada (modo demo)', 'success');
                    } else {
                        // Agregar a datos simulados
                        personalData.push(personData);
                        showNotification('Persona agregada (modo demo)', 'success');
                    }
                    
                    filteredPersonal = [...personalData];
                    renderPersonalTable(filteredPersonal, currentPage);
                    const stats = calculateMockStats(personalData);
                    updatePersonalStats(stats);
                    
                    hideLoadingModal();
                    closePersonModal();
                }, 1000);
            }
        }

        function closePersonModal() {
            document.getElementById('person-modal-container').innerHTML = '';
        }

        function closeAdminModal() {
            document.getElementById('person-modal-container').innerHTML = '';
        }

        // *** FUNCIONES PARA EL SISTEMA DE DIAGNÓSTICO MEJORADO ***
        
        function cambiarModoDiagnostico(modo) {
            document.getElementById('modo-actual').textContent = modo === 'activo' ? 'Activo (cada 5 min)' : 'Estático';
            
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler(response => {
                        showNotification(`Modo de diagnóstico cambiado a: ${modo}`, 'success');
                    })
                    .withFailureHandler(error => {
                        console.error('Error cambiando modo:', error);
                        showNotification('Error cambiando modo de diagnóstico', 'error');
                    })
                    .cambiarModoDiagnostico(modo);
            } else {
                // Modo demo - usar localStorage si está disponible
                if (typeof localStorage !== 'undefined') {
                    localStorage.setItem('modo_diagnostico', modo);
                }
                showNotification(`Modo de diagnóstico cambiado a: ${modo} (modo demo)`, 'info');
            }
        }
        
        function mostrarFormularioErrorManual() {
            const formulario = document.getElementById('formulario-error-manual');
            formulario.classList.toggle('hidden');
            
            if (!formulario.classList.contains('hidden')) {
                document.getElementById('descripcion-error').focus();
            }
        }
        
        function cancelarErrorManual() {
            const formulario = document.getElementById('formulario-error-manual');
            formulario.classList.add('hidden');
            
            // Limpiar campos
            document.getElementById('descripcion-error').value = '';
            document.getElementById('ubicacion-error').value = '';
            document.getElementById('categoria-error').value = 'USUARIO';
        }
        
        function guardarErrorManual() {
            const descripcion = document.getElementById('descripcion-error').value.trim();
            const ubicacion = document.getElementById('ubicacion-error').value.trim() || 'Sin especificar';
            const categoria = document.getElementById('categoria-error').value;
            
            if (!descripcion) {
                showNotification('La descripción del error es obligatoria', 'error');
                return;
            }
            
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                showLoader(true, 'Guardando error manual...');
                
                google.script.run
                    .withSuccessHandler(response => {
                        ocultarLoading();
                        if (response && response.success) {
                            showNotification('Error reportado correctamente. Se ha realizado análisis automático.', 'success');
                            cancelarErrorManual();
                            
                            // Mostrar análisis automático
                            if (response.analisis) {
                                mostrarAnalisisAutomatico(response.analisis, response.errorId);
                            }
                        } else {
                            showNotification('Error guardando el reporte: ' + (response?.message || 'Error desconocido'), 'error');
                        }
                    })
                    .withFailureHandler(error => {
                        ocultarLoading();
                        showNotification('Error guardando el reporte: ' + error.message, 'error');
                        console.error(error);
                    })
                    .añadirErrorManual(descripcion, ubicacion, categoria);
            } else {
                // Modo demo - guardar en localStorage si está disponible
                let erroresManuales = [];
                if (typeof localStorage !== 'undefined') {
                    erroresManuales = JSON.parse(localStorage.getItem('errores_manuales') || '[]');
                }
                
                const nuevoError = {
                    id: `manual_${Date.now()}`,
                    descripcion: descripcion,
                    ubicacion: ubicacion,
                    categoria: categoria,
                    timestamp: new Date().toISOString()
                };
                
                erroresManuales.push(nuevoError);
                
                if (typeof localStorage !== 'undefined') {
                    localStorage.setItem('errores_manuales', JSON.stringify(erroresManuales));
                }
                
                showNotification('Error reportado correctamente (modo demo)', 'success');
                cancelarErrorManual();
            }
        }
        
        function buscarError() {
            const termino = prompt('Ingrese el ID del error o palabras clave para buscar:');
            
            if (!termino) {
                return;
            }
            
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                showLoader(true, `Buscando error: ${termino}...`);
                
                google.script.run
                    .withSuccessHandler(response => {
                        ocultarLoading();
                        mostrarResultadoBusqueda(response, termino);
                    })
                    .withFailureHandler(error => {
                        ocultarLoading();
                        showNotification('Error en la búsqueda: ' + error.message, 'error');
                        console.error(error);
                    })
                    .obtenerDetallesError(termino);
            } else {
                // Modo demo
                let erroresManuales = [];
                if (typeof localStorage !== 'undefined') {
                    erroresManuales = JSON.parse(localStorage.getItem('errores_manuales') || '[]');
                }
                
                const errorEncontrado = erroresManuales.find(error =>
                    error.id.includes(termino) || 
                    error.descripcion.toLowerCase().includes(termino.toLowerCase())
                );
                
                if (errorEncontrado) {
                    mostrarResultadoBusqueda({
                        encontrado: true,
                        error: errorEncontrado,
                        tipo: 'manual'
                    }, termino);
                } else {
                    mostrarResultadoBusqueda({
                        encontrado: false,
                        mensaje: 'Error no encontrado'
                    }, termino);
                }
            }
        }
        
        function mostrarResultadoBusqueda(response, termino) {
            if (!response.encontrado) {
                showNotification(`No se encontró el error "${termino}"`, 'warning');
                return;
            }
            
            const error = response.error;
            let mensaje = `🔍 Error encontrado: ${termino}\n\n`;
            mensaje += `📝 Descripción: ${error.descripcion || error.mensaje}\n`;
            
            if (error.ubicacion) {
                mensaje += `📍 Ubicación: ${error.ubicacion}\n`;
            }
            
            if (error.categoria) {
                mensaje += `🏷️ Categoría: ${error.categoria}\n`;
            }
            
            if (error.timestamp) {
                mensaje += `📅 Fecha: ${new Date(error.timestamp).toLocaleString('es-CO')}\n`;
            }
            
            if (error.solucion) {
                mensaje += `💡 Solución: ${error.solucion}\n`;
            }
            
            if (error.analisis) {
                mensaje += `\n🔍 ANÁLISIS AUTOMÁTICO:\n`;
                mensaje += `• Posibles causas: ${error.analisis.posiblesCausas.join(', ')}\n`;
                mensaje += `• Severidad: ${error.analisis.severidad}\n`;
                mensaje += `• Archivos relacionados: ${error.analisis.archivosRelacionados.join(', ')}\n`;
                mensaje += `• Soluciones sugeridas: ${error.analisis.solucionesSugeridas.join('; ')}`;
            }
            
            alert(mensaje);
        }
        
        function mostrarAnalisisAutomatico(analisis, errorId) {
            let mensaje = `🤖 ANÁLISIS AUTOMÁTICO DEL ERROR\n\n`;
            mensaje += `🔍 Posibles Causas:\n${analisis.posiblesCausas.map(c => `• ${c}`).join('\n')}\n\n`;
            mensaje += `📊 Severidad: ${analisis.severidad}\n\n`;
            mensaje += `🎯 Componentes Afectados:\n${analisis.componentesAfectados.map(c => `• ${c}`).join('\n')}\n\n`;
            mensaje += `📄 Archivos Relacionados:\n${analisis.archivosRelacionados.map(a => `• ${a}`).join('\n')}\n\n`;
            mensaje += `💡 Soluciones Sugeridas:\n${analisis.solucionesSugeridas.map(s => `• ${s}`).join('\n')}`;
            
            alert(mensaje);
        }
        
        function marcarComoResuelto(problemaId) {
            const solucion = prompt('Opcional: Describe la solución aplicada:') || '';
            
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler(response => {
                        if (response) {
                            showNotification('Problema marcado como resuelto', 'success');
                            // Reejecutar diagnóstico para actualizar vista
                            setTimeout(() => runDiagnosis(), 1000);
                        } else {
                            showNotification('El problema ya estaba marcado como resuelto', 'info');
                        }
                    })
                    .withFailureHandler(error => {
                        showNotification('Error marcando problema como resuelto', 'error');
                        console.error(error);
                    })
                    .marcarProblemaComoResuelto(problemaId, solucion);
            } else {
                // Modo demo
                let problemasResueltos = {};
                if (typeof localStorage !== 'undefined') {
                    problemasResueltos = JSON.parse(localStorage.getItem('problemas_resueltos') || '{}');
                    problemasResueltos[problemaId] = {
                        resuelto: true,
                        timestamp: new Date().toISOString(),
                        solucion: solucion
                    };
                    localStorage.setItem('problemas_resueltos', JSON.stringify(problemasResueltos));
                }
                showNotification('Problema marcado como resuelto (modo demo)', 'success');
            }
        }
        
        function eliminarErrorManual(errorId) {
            if (!confirm('¿Estás seguro de que quieres eliminar este error manual?')) {
                return;
            }
            
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler(response => {
                        if (response) {
                            showNotification('Error manual eliminado', 'success');
                            runDiagnosis(); // Reejecutar para actualizar vista
                        } else {
                            showNotification('Error no encontrado para eliminar', 'warning');
                        }
                    })
                    .withFailureHandler(error => {
                        showNotification('Error eliminando el reporte', 'error');
                        console.error(error);
                    })
                    .eliminarErrorManual(errorId);
            } else {
                // Modo demo
                if (typeof localStorage !== 'undefined') {
                    let erroresManuales = JSON.parse(localStorage.getItem('errores_manuales') || '[]');
                    erroresManuales = erroresManuales.filter(error => error.id !== errorId);
                    localStorage.setItem('errores_manuales', JSON.stringify(erroresManuales));
                }
                showNotification('Error manual eliminado (modo demo)', 'success');
            }
        }
        
        function mostrarAnalisisError(errorId) {
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler(response => {
                        if (response.encontrado && response.error.analisis) {
                            mostrarAnalisisAutomatico(response.error.analisis, errorId);
                        } else {
                            showNotification('No se encontró análisis para este error', 'warning');
                        }
                    })
                    .withFailureHandler(error => {
                        showNotification('Error obteniendo análisis', 'error');
                        console.error(error);
                    })
                    .obtenerDetallesError(errorId);
            } else {
                // Modo demo
                if (typeof localStorage !== 'undefined') {
                    const erroresManuales = JSON.parse(localStorage.getItem('errores_manuales') || '[]');
                    const error = erroresManuales.find(e => e.id === errorId);
                    if (error && error.analisis) {
                        mostrarAnalisisAutomatico(error.analisis, errorId);
                    } else {
                        showNotification('No se encontró análisis para este error (modo demo)', 'warning');
                    }
                } else {
                    showNotification('No se encontró análisis para este error (modo demo)', 'warning');
                }
            }
        }

        function openAdminModal(cedula = null) {
    const modalContainer = document.getElementById('person-modal-container');
    const title = cedula ? 'Editar Administrador' : 'Crear Nuevo Administrador';
    
    // Buscar datos del admin si es edición
    let adminData = { cedula: '', nombre: '', contrasena: '', cargo: 'Administrador', email: '', estado: 'activo' };
    if (cedula) {
        // Aquí podrías buscar los datos actuales del admin
        adminData.cedula = cedula;
    }
    
    modalContainer.innerHTML = `
        <div class="modal-overlay">
            <div class="modal-card">
                <h3 class="text-xl font-semibold mb-4">${title}</h3>
                <form id="admin-form">
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">Cédula/Usuario *</label>
                        <input type="text" name="cedula" value="${adminData.cedula}" ${cedula ? 'readonly' : ''} 
                            class="w-full bg-gray-700 px-3 py-2 rounded-lg border border-gray-600" required
                            placeholder="Ej: admin, 8-123-456">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">Nombre Completo *</label>
                        <input type="text" name="nombre" value="${adminData.nombre}" 
                            class="w-full bg-gray-700 px-3 py-2 rounded-lg border border-gray-600" required
                            placeholder="Nombre del administrador">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">Contraseña ${cedula ? '(dejar vacío para mantener actual)' : '*'}</label>
                        <input type="password" name="contrasena" value="${cedula ? '' : adminData.contrasena}" 
                            class="w-full bg-gray-700 px-3 py-2 rounded-lg border border-gray-600" ${cedula ? '' : 'required'}
                            placeholder="Contraseña segura">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">Cargo</label>
                        <select name="cargo" class="w-full bg-gray-700 px-3 py-2 rounded-lg border border-gray-600">
                            <option value="Administrador Principal" ${adminData.cargo === 'Administrador Principal' ? 'selected' : ''}>Administrador Principal</option>
                            <option value="Administrador" ${adminData.cargo === 'Administrador' ? 'selected' : ''}>Administrador</option>
                            <option value="Supervisor" ${adminData.cargo === 'Supervisor' ? 'selected' : ''}>Supervisor</option>
                            <option value="Operador" ${adminData.cargo === 'Operador' ? 'selected' : ''}>Operador</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">Email</label>
                        <input type="email" name="email" value="${adminData.email}" 
                            class="w-full bg-gray-700 px-3 py-2 rounded-lg border border-gray-600"
                            placeholder="admin@empresa.com">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">Estado</label>
                        <select name="estado" class="w-full bg-gray-700 px-3 py-2 rounded-lg border border-gray-600">
                            <option value="activo" ${adminData.estado === 'activo' ? 'selected' : ''}>Activo</option>
                            <option value="inactivo" ${adminData.estado === 'inactivo' ? 'selected' : ''}>Inactivo</option>
                        </select>
                    </div>
                    
                    <!-- Sección de Permisos -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Permisos del Sistema</label>
                        <div class="grid grid-cols-2 gap-3 bg-gray-800 p-3 rounded-lg">
                            <label class="flex items-center">
                                <input type="checkbox" name="perm_personal_ver" checked class="mr-2"> Ver Personal
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="perm_personal_editar" checked class="mr-2"> Editar Personal
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="perm_config_ver" checked class="mr-2"> Ver Configuración
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="perm_config_editar" checked class="mr-2"> Editar Configuración
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="perm_usuarios_ver" checked class="mr-2"> Ver Usuarios
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="perm_usuarios_editar" checked class="mr-2"> Editar Usuarios
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="perm_logs_ver" checked class="mr-2"> Ver Logs
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="perm_evacuacion_ver" checked class="mr-2"> Ver Evacuación
                            </label>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" onclick="closeAdminModal()" 
                            class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">
                            Cancelar
                        </button>
                        <button type="submit" 
                            class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">
                            ${cedula ? 'Actualizar' : 'Crear'} Administrador
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
    
    document.getElementById('admin-form').addEventListener('submit', handleAdminSubmit);
}

function handleAdminSubmit(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    
    // Recopilar datos básicos
    const adminData = {
        cedula: formData.get('cedula'),
        nombre: formData.get('nombre'),
        contrasena: formData.get('contrasena'),
        cargo: formData.get('cargo'),
        email: formData.get('email'),
        estado: formData.get('estado')
    };
    
    // Recopilar permisos
    const permisos = {
        personal: {
            ver: formData.get('perm_personal_ver') === 'on',
            editar: formData.get('perm_personal_editar') === 'on'
        },
        configuracion: {
            ver: formData.get('perm_config_ver') === 'on',
            editar: formData.get('perm_config_editar') === 'on'
        },
        usuarios: {
            ver: formData.get('perm_usuarios_ver') === 'on',
            editar: formData.get('perm_usuarios_editar') === 'on'
        },
        logs: {
            ver: formData.get('perm_logs_ver') === 'on',
            editar: false // Los logs normalmente no se editan
        },
        evacuacion: {
            ver: formData.get('perm_evacuacion_ver') === 'on',
            editar: true
        },
        diagnostico: {
            ver: true,
            ejecutar: adminData.cargo.includes('Principal') || adminData.cargo.includes('Administrador')
        }
    };
    
    adminData.permisos = JSON.stringify(permisos);
    
    // Validar campos requeridos
    if (!adminData.cedula || !adminData.nombre) {
        showNotification('Por favor complete los campos requeridos (Cédula y Nombre)', 'error');
        return;
    }
    
    showLoadingModal('Guardando administrador...');
    
    if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
            .withSuccessHandler((result) => {
                hideLoadingModal();
                if (result && result.success) {
                    showNotification(result.message || 'Administrador guardado exitosamente', 'success');
                    closeAdminModal();
                    loadAdminUsers();
                } else {
                    showNotification(result?.message || 'Error guardando administrador', 'error');
                }
            })
            .withFailureHandler(error => {
                hideLoadingModal();
                showNotification('Error al guardar administrador: ' + error.message, 'error');
                console.error(error);
            })
            .guardarAdministrador(adminData);
    } else {
        // Modo simulación
        setTimeout(() => {
            hideLoadingModal();
            showNotification('Administrador guardado (modo demo)', 'success');
            closeAdminModal();
            loadAdminUsers();
        }, 1000);
    }
}

function toggleAdminStatus(cedula, currentStatus) {
    const newStatus = currentStatus === 'activo' ? 'inactivo' : 'activo';
    
    if (!confirm(`¿Está seguro de cambiar el estado del administrador ${cedula} a ${newStatus.toUpperCase()}?`)) {
        return;
    }
    
    showLoadingModal(`Cambiando estado a ${newStatus}...`);
    
    if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
            .withSuccessHandler((result) => {
                hideLoadingModal();
                if (result && result.success) {
                    showNotification(result.message || 'Estado cambiado exitosamente', 'success');
                    loadAdminUsers();
                } else {
                    showNotification(result?.message || 'Error cambiando estado', 'error');
                }
            })
            .withFailureHandler(error => {
                hideLoadingModal();
                showNotification('Error al cambiar estado: ' + error.message, 'error');
                console.error(error);
            })
            .cambiarEstadoAdministrador(cedula, newStatus);
    } else {
        // Modo simulación
        setTimeout(() => {
            hideLoadingModal();
            showNotification(`Estado cambiado a ${newStatus} (modo demo)`, 'success');
            loadAdminUsers();
        }, 1000);
    }
}

/**
 * Confirma y elimina un administrador
 */
function confirmDeleteAdmin(cedula, nombre) {
    const mensaje = `¿Está seguro de eliminar permanentemente al administrador "${nombre}" (${cedula})?\n\nEsta acción no se puede deshacer.`;
    
    if (!confirm(mensaje)) {
        return;
    }
    
    showLoadingModal('Eliminando administrador...');
    
    if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
            .withSuccessHandler((result) => {
                hideLoadingModal();
                if (result && result.success) {
                    showNotification(result.message || 'Administrador eliminado exitosamente', 'success');
                    loadAdminUsers();
                } else {
                    showNotification(result?.message || 'Error eliminando administrador', 'error');
                }
            })
            .withFailureHandler(error => {
                hideLoadingModal();
                showNotification('Error al eliminar administrador: ' + error.message, 'error');
                console.error(error);
            })
            .eliminarAdministrador(cedula);
    } else {
        // Modo simulación
        setTimeout(() => {
            hideLoadingModal();
            showNotification('Administrador eliminado (modo demo)', 'success');
            loadAdminUsers();
        }, 1000);
    }
}

/**
 * Inicializar funcionalidad de configuración mejorada
 */
function setupSystemConfigUI() {
    console.log('🚀 [CONFIG UI] Iniciando sistema de configuración mejorado...');
    
    // Mostrar loader
    toggleModal('loading-modal', true);
    
    if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
            .withSuccessHandler(handleConfigurationResponse)
            .withFailureHandler(handleConfigErrorModal)
            .loadConfiguration();
    } else {
        // Modo desarrollo
        setTimeout(() => {
            handleConfigurationResponse({
                success: true,
                configuraciones: [
                    { clave: 'EMPRESA_NOMBRE', valor: 'SurPass S.A. (DEMO)', descripcion: 'Nombre de la empresa' },
                    { clave: 'EMPRESA_DIRECCION', valor: 'Ciudad de Panamá (DEMO)', descripcion: 'Dirección de la empresa' },
                    { clave: 'UI_TEMA_OSCURO', valor: 'SI', descripcion: 'Activar tema oscuro' },
                    { clave: 'QR_DURACION_ESCANEO', valor: '30', descripcion: 'Duración del escaneo QR (segundos)' }
                ]
            });
        }, 1000);
    }
}

/**
 * Maneja la respuesta de configuración del backend
 */
function handleConfigurationResponse(response) {
    toggleModal('loading-modal', false);
    
    if (!response || !response.success) {
        showGeneralMessage('Error', response?.message || 'Error cargando configuración', 'error');
        return;
    }
    
    renderConfigUICategories(response);
}

/**
 * Maneja errores de configuración
 */
function handleConfigErrorModal(error) {
    toggleModal('loading-modal', false);
    console.error('❌ [CONFIG UI] Error del servidor:', error);
    showGeneralMessage('Error del Servidor', error?.message || 'Error de conexión', 'error');
}

// === FUNCIONES DE UTILIDAD ADICIONALES ===

/**
 * Función para mostrar mensajes generales
 */
function showGeneralMessage(title, text, type) {
    const modal = document.getElementById('message-modal');
    const iconContainer = document.getElementById('message-icon-container');
    const titleElement = document.getElementById('message-title');
    const textElement = document.getElementById('message-text');

    if (!modal || !iconContainer || !titleElement || !textElement) {
        console.error('❌ Elementos del modal de mensaje no encontrados');
        alert(`${title}\n\n${text}`);
        return;
    }

    iconContainer.innerHTML = '';
    if (type === 'success') {
        iconContainer.innerHTML = '<i class="fas fa-check-circle text-green-500 text-4xl"></i>';
    } else if (type === 'error') {
        iconContainer.innerHTML = '<i class="fas fa-times-circle text-red-500 text-4xl"></i>';
    } else if (type === 'warning') {
        iconContainer.innerHTML = '<i class="fas fa-exclamation-triangle text-yellow-500 text-4xl"></i>';
    } else {
        iconContainer.innerHTML = '<i class="fas fa-info-circle text-blue-500 text-4xl"></i>';
    }

    titleElement.textContent = title;
    textElement.textContent = text;
    toggleModal('message-modal', true);
}

/**
 * Función para alternar visibilidad de modales
 */
function toggleModal(modalId, show) {
    const modal = document.getElementById(modalId);
    if (modal) {
        if (show) {
            modal.classList.remove('hidden');
        } else {
            modal.classList.add('hidden');
        }
    }
}

        function handleAdminSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const adminData = Object.fromEntries(formData);
            
            showLoader(true, 'Guardando administrador...');
            
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler(() => {
                        ocultarLoading();
                        showNotification('Administrador guardado exitosamente', 'success');
                        closePersonModal();
                        loadAdminUsers();
                    })
                    .withFailureHandler(error => {
                        ocultarLoading();
                        showNotification('Error al guardar administrador', 'error');
                        console.error(error);
                    })
                    .agregarAdministrador(adminData);
            } else {
                setTimeout(() => {
                    ocultarLoading();
                    showNotification('Administrador guardado (modo demo)', 'success');
                    closePersonModal();
                    loadAdminUsers();
                }, 1000);
            }
        }

        // *** FUNCIONES GLOBALES ***
        window.editPerson = (cedula) => {
            const persona = personalData.find(p => p.cedula === cedula);
            if (persona) {
                openPersonModal(persona);
            } else {
                showNotification('Persona no encontrada', 'error');
            }
        };
        
        window.confirmDeletePerson = (cedula) => {
            if (confirm(`¿Estás seguro de que deseas eliminar a la persona con cédula ${cedula}?`)) {
                showLoader(true, 'Eliminando persona...');
                
                if (typeof google !== 'undefined' && google.script && google.script.run) {
                    google.script.run
                        .withSuccessHandler(() => {
                            ocultarLoading();
                            showNotification('Persona eliminada exitosamente', 'success');
                            loadPersonnel();
                        })
                        .withFailureHandler(error => {
                            ocultarLoading();
                            showNotification('Error al eliminar persona', 'error');
                            console.error(error);
                        })
                        .deletePerson(cedula);
                } else {
                    setTimeout(() => {
                        ocultarLoading();
                        showNotification('Persona eliminada (modo demo)', 'success');
                        loadPersonnel();
                    }, 1000);
                }
            }
        };

        // *** FUNCIONES ESPECÍFICAS DE ADMINISTRADORES ***
        window.addNewAdmin = function() {
            openAdminModal();
        };

        window.editAdmin = function(cedula) {
            console.log('Editando admin:', cedula);
            openAdminModal(cedula);
        };

        window.confirmDeleteAdmin = function(cedula) {
            if (confirm(`¿Está seguro que desea eliminar el administrador ${cedula}?`)) {
                deleteAdmin(cedula);
            }
        };

        function deleteAdmin(cedula) {
            showLoader(true, 'Eliminando administrador...');
            
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler(response => {
                        ocultarLoading();
                        showNotification(
                            response?.success ? 'Administrador eliminado' : (response?.message || 'Error al eliminar'),
                            response?.success ? 'success' : 'error'
                        );
                        if (response?.success) {
                            loadAdminUsers();
                        }
                    })
                    .withFailureHandler(error => {
                        ocultarLoading();
                        showNotification('Error eliminando administrador', 'error');
                        console.error(error);
                    })
                    .eliminarAdministrador(cedula);
            } else {
                setTimeout(() => {
                    ocultarLoading();
                    showNotification('Administrador eliminado (modo demo)', 'success');
                    loadAdminUsers();
                }, 1000);
            }
        }

        // *** FUNCIONES DE LOGS ***
        window.clearLogs = function() {
            if (!confirm('¿Está seguro que desea limpiar todos los logs del sistema?')) {
                return;
            }
            
            showLoader(true, 'Limpiando logs del sistema...');
            
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler(response => {
                        ocultarLoading();
                        showNotification(
                            response?.message || 'Logs limpiados',
                            response?.success ? 'success' : 'error'
                        );
                        loadLogs();
                    })
                    .withFailureHandler(error => {
                        ocultarLoading();
                        showNotification('Error al limpiar los logs', 'error');
                        console.error(error);
                    })
                    .limpiarLogs();
            } else {
                setTimeout(() => {
                    ocultarLoading();
                    showNotification('Logs limpiados (modo demo)', 'success');
                    loadLogs();
                }, 1000);
            }
        };

        // *** FUNCIONES DE MANTENIMIENTO Y RESPALDO ***
        window.createBackup = function() {
            showLoader(true, 'Creando respaldo del sistema...');
            
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler(response => {
                        ocultarLoading();
                        if (response?.success) {
                            showNotification('Respaldo creado exitosamente', 'success');
                            console.log('Respaldo creado:', response.detalles);
                        } else {
                            showNotification(response?.mensaje || 'Error al crear respaldo', 'error');
                        }
                    })
                    .withFailureHandler(error => {
                        ocultarLoading();
                        showNotification('Error al crear respaldo', 'error');
                        console.error(error);
                    })
                    .crearRespaldo();
            } else {
                setTimeout(() => {
                    ocultarLoading();
                    showNotification('Respaldo creado (modo demo)', 'success');
                }, 2000);
            }
        };

        window.performMaintenance = function() {
            if (!confirm('¿Desea ejecutar el mantenimiento completo del sistema? Esto puede tomar varios minutos.')) {
                return;
            }
            
            showLoader(true, 'Ejecutando mantenimiento del sistema...');
            
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler(response => {
                        ocultarLoading();
                        if (response?.success) {
                            showNotification('Mantenimiento completado exitosamente', 'success');
                            console.log('Mantenimiento:', response.resultados);
                        } else {
                            showNotification(response?.mensaje || 'Error en el mantenimiento', 'error');
                        }
                    })
                    .withFailureHandler(error => {
                        ocultarLoading();
                        showNotification('Error ejecutando mantenimiento', 'error');
                        console.error(error);
                    })
                    .ejecutarMantenimiento('completo');
            } else {
                setTimeout(() => {
                    ocultarLoading();
                    showNotification('Mantenimiento completado (modo demo)', 'success');
                }, 3000);
            }
        };

        window.confirmClearLogs = () => {
            if (confirm('¿Estás seguro de que deseas eliminar todos los logs del sistema? Esta acción es irreversible.')) {
                showLoader(true, 'Limpiando logs...');
                
                if (typeof google !== 'undefined' && google.script && google.script.run) {
                    google.script.run
                        .withSuccessHandler(response => {
                            ocultarLoading();
                            showNotification(
                                response?.message || 'Logs limpiados',
                                response?.success ? 'success' : 'error'
                            );
                            loadLogs();
                        })
                        .withFailureHandler(error => {
                            ocultarLoading();
                            showNotification('Error al limpiar los logs', 'error');
                            console.error(error);
                        })
                        .limpiarLogs();
                } else {
                    setTimeout(() => {
                        ocultarLoading();
                        showNotification('Logs limpiados (modo demo)', 'success');
                        loadLogs();
                    }, 1000);
                }
            }
        };

        window.repararSistema = function() {
            showLoader(true, 'Reparando sistema...');
            
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler(result => {
                        ocultarLoading();
                        if (result?.success) {
                            showNotification('Sistema reparado exitosamente. Recarga la página.', 'success');
                            console.log('Credenciales por defecto:', result.credenciales);
                            setTimeout(() => location.reload(), 2000);
                        } else {
                            showNotification('Error reparando sistema: ' + (result?.message || 'Error desconocido'), 'error');
                        }
                    })
                    .withFailureHandler(error => {
                        ocultarLoading();
                        showNotification('Error ejecutando reparación: ' + error.message, 'error');
                        console.error('Error:', error);
                    })
                    .solucionarProblemaAutenticacion();
            } else {
                setTimeout(() => {
                    ocultarLoading();
                    showNotification('Sistema reparado (modo demo). Usuario: admin / Contraseña: admin123', 'success');
                }, 2000);
            }
        };

        // *** EVENT LISTENERS ***
        document.addEventListener('DOMContentLoaded', () => {
            // Ocultar el loader cuando la página esté completamente cargada
            ocultarLoading();
            
            // Login form
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            
            // Logout button
            document.getElementById('logout-button').addEventListener('click', () => {
                window.currentPermissions = {};
                window.currentCargo = '';
                window.currentUser = null;
                document.getElementById('dashboard-container').classList.add('hidden');
                document.getElementById('login-container').classList.remove('hidden');
                document.getElementById('login-form').reset();
                showNotification('Has cerrado sesión correctamente.', 'info');
            });
            
            // Tab buttons
            document.getElementById('tab-personal').addEventListener('click', () => showTab('personal'));
            document.getElementById('tab-configuracion').addEventListener('click', () => showTab('configuracion'));
            document.getElementById('tab-usuarios').addEventListener('click', () => showTab('usuarios'));
            document.getElementById('tab-logs').addEventListener('click', () => showTab('logs'));
            document.getElementById('tab-evacuacion').addEventListener('click', () => showTab('evacuacion'));
            document.getElementById('tab-diagnostico').addEventListener('click', () => showTab('diagnostico'));
        });

        // Para desarrollo: auto-login si no hay Google Apps Script
        if (typeof google === 'undefined' || !google.script) {
            console.log('🔧 Modo desarrollo detectado - Login automático disponible');
            console.log('💡 Usa: admin / admin123 para entrar');
        }

        // =============================================================
        // ⚙️ GESTIÓN DE LA UI DE CONFIGURACIÓN NUEVA
        // =============================================================

        // Variables globales para el estado de la UI de configuración
        let currentConfigModal = {};
        let configCategories = {};
        
         /**
         * Procesa los datos de configuración obtenidos del backend y los renderiza por categorías.
         * @param {Object} response - Objeto de respuesta del backend.
         */
        function renderConfigUICategories(response) {
            console.log('🎨 [CONFIG UI] =================================');
            console.log('🎨 [CONFIG UI] RENDERIZANDO CATEGORÍAS DE CONFIGURACIÓN');
            console.log('🎨 [CONFIG UI] =================================');
            
            toggleModal('loading-modal', false);
            console.log('🔧 [CONFIG UI] Modal de carga desactivado');
            console.log('✅ [CONFIG UI] Respuesta recibida para renderizar:', response);
            
            if (!response) {
                console.error('❌ [CONFIG UI] Respuesta vacía o null - no se puede renderizar');
                showGeneralMessage('Error', 'No se recibieron datos de configuración del servidor.', 'error');
                return;
            }

            if (!response.success) {
                console.error('❌ [CONFIG UI] Error en respuesta:', response.message);
                const container = document.getElementById('config-categories-container');
                if (container) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-8">
                            <div class="bg-red-900/30 border border-red-600 rounded-lg p-6">
                                <i class="fas fa-exclamation-triangle text-red-400 text-4xl mb-4"></i>
                                <h3 class="text-xl font-semibold text-red-300 mb-2">Error al Cargar Configuración</h3>
                                <p class="text-red-200 mb-4">${response.message || 'Error desconocido'}</p>
                                <button onclick="setupSystemConfigUI()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">
                                    <i class="fas fa-sync-alt mr-2"></i>Reintentar
                                </button>
                            </div>
                        </div>
                    `;
                }
                return;
            }

            const configuraciones = response.configuraciones || [];
            
            if (configuraciones.length === 0) {
                console.warn('⚠️ [CONFIG UI] No hay configuraciones disponibles');
                const container = document.getElementById('config-categories-container');
                if (container) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-8">
                            <div class="bg-yellow-900/30 border border-yellow-600 rounded-lg p-6">
                                <i class="fas fa-info-circle text-yellow-400 text-4xl mb-4"></i>
                                <h3 class="text-xl font-semibold text-yellow-300 mb-2">Sin Configuraciones</h3>
                                <p class="text-yellow-200 mb-4">No se encontraron configuraciones en el sistema.</p>
                                <button onclick="setupSystemConfigUI()" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg">
                                    <i class="fas fa-sync-alt mr-2"></i>Recargar
                                </button>
                            </div>
                        </div>
                    `;
                }
                return;
            }

            configCategories = {}; // Reiniciar las categorías

            // Agrupar la configuración por categoría
            configuraciones.forEach(config => {
                if (!config || !config.clave) {
                    console.warn('⚠️ [CONFIG UI] Configuración inválida ignorada:', config);
                    return;
                }

                let categoria = 'GENERAL';
                const clave = config.clave;
                
                if (clave.startsWith('EMPRESA_')) categoria = 'EMPRESA';
                else if (clave.startsWith('UI_')) categoria = 'INTERFAZ';
                else if (clave.startsWith('QR_')) categoria = 'CAMARA_QR';
                else if (clave.includes('CONTRASEÑA') || clave.includes('SESION') || clave.includes('BLOQUEO') || clave.includes('AUDIT')) categoria = 'SEGURIDAD';
                else if (clave.startsWith('NOTIF') || clave.includes('EMAIL') || clave === 'SONIDOS_ACTIVADOS') categoria = 'NOTIFICACIONES';
                else if (clave.startsWith('CACHE_')) categoria = 'CACHE';
                else if (clave.startsWith('REPORTE_') || clave.startsWith('ESTADISTICAS_')) categoria = 'REPORTES';
                else if (clave.startsWith('EVACUACION_')) categoria = 'EVACUACION';
                else if (clave.includes('BACKUP') || clave.includes('ARCHIVO') || clave.includes('LIMPIAR') || clave.includes('OPTIMIZAR')) categoria = 'ARCHIVO';
                else if (clave.startsWith('TEMA_') || clave.includes('IDIOMA') || clave.includes('MOSTRAR') || clave.includes('DASHBOARD')) categoria = 'PERSONALIZACION';
                else if (clave.startsWith('INTEGRACION_') || clave.startsWith('WEBHOOK_')) categoria = 'INTEGRACION';
                
                if (!configCategories[categoria]) {
                    configCategories[categoria] = [];
                }
                configCategories[categoria].push(config);
            });
            
            const container = document.getElementById('config-categories-container');
            if (!container) {
                console.error('❌ [CONFIG UI] Container config-categories-container no encontrado');
                showGeneralMessage('Error', 'Elemento de configuración no encontrado en la interfaz.', 'error');
                return;
            }
            
            container.innerHTML = ''; // Limpiar el contenedor

            // Títulos amigables para las categorías
            const categoriaTitulos = {
                'EMPRESA': '🏢 Configuración de Empresa',
                'INTERFAZ': '🎨 Interfaz de Usuario', 
                'CAMARA_QR': '📸 Cámara QR',
                'SEGURIDAD': '🔐 Seguridad',
                'NOTIFICACIONES': '🔔 Notificaciones',
                'CACHE': '⏱️ Cache y Rendimiento',
                'REPORTES': '📊 Reportes',
                'EVACUACION': '🚨 Sistema de Evacuación',
                'ARCHIVO': '🗂️ Archivo y Limpieza',
                'PERSONALIZACION': '🎨 Personalización',
                'INTEGRACION': '⚡ Integraciones',
                'GENERAL': '⚙️ Configuración General'
            };

            // Renderizar las tarjetas de categoría
            const categoriasRenderizadas = Object.keys(configCategories).filter(cat => configCategories[cat].length > 0);
            
            if (categoriasRenderizadas.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <div class="bg-blue-900/30 border border-blue-600 rounded-lg p-6">
                            <i class="fas fa-cogs text-blue-400 text-4xl mb-4"></i>
                            <h3 class="text-xl font-semibold text-blue-300 mb-2">Configuración Inicializada</h3>
                            <p class="text-blue-200">El sistema está configurando las categorías...</p>
                        </div>
                    </div>
                `;
                return;
            }

            categoriasRenderizadas.forEach(category => {
                const card = document.createElement('div');
                card.className = 'bg-[#1f2428] p-4 rounded-xl shadow-md border border-[#30363d] cursor-pointer hover:bg-[#2e343d] transition-colors';
                card.setAttribute('onclick', `openConfigModalCategory('${category}')`);
                card.innerHTML = `
                    <h3 class="text-xl font-semibold mb-2 text-white">${categoriaTitulos[category] || category.replace(/_/g, ' ')}</h3>
                    <p class="text-gray-400">${configCategories[category].length} parámetro${configCategories[category].length === 1 ? '' : 's'}</p>
                    <div class="mt-2 text-sm text-blue-400">
                        <i class="fas fa-edit mr-1"></i>Clic para editar
                    </div>
                `;
                container.appendChild(card);
            });

            console.log('✅ [CONFIG UI] Categorías renderizadas exitosamente:', categoriasRenderizadas.length);
        }
        
        /**
         * Abre el modal de edición de configuración para una categoría específica.
         * @param {string} category - Nombre de la categoría.
         */
        function openConfigModalCategory(category) {
    console.log('🔧 Abriendo modal para categoría:', category);
    
    // Usar configCategories en lugar de globalConfig.categorias
    if (!configCategories || !configCategories[category]) {
        showNotification('No hay configuraciones disponibles para esta categoría', 'warning');
        return;
    }
    
    const configs = configCategories[category];
    
    // CORREGIDO: Usar los elementos que SÍ existen en tu HTML
    const modal = document.getElementById('edit-config-modal');
    const container = document.getElementById('config-form-container');
    
    if (!modal || !container) {
        console.error('❌ Modal de configuración no encontrado');
        showNotification('Error: Modal de configuración no disponible', 'error');
        return;
    }
    
    const categoriaTitulos = {
        'EMPRESA': '🏢 Configuración de Empresa',
        'INTERFAZ': '🎨 Interfaz de Usuario', 
        'CAMARA_QR': '📸 Cámara QR',
        'SEGURIDAD': '🔐 Seguridad',
        'NOTIFICACIONES': '🔔 Notificaciones',
        'CACHE': '⏱️ Cache y Rendimiento',
        'REPORTES': '📊 Reportes',
        'EVACUACION': '🚨 Sistema de Evacuación',
        'ARCHIVO': '🗂️ Archivo y Limpieza',
        'PERSONALIZACION': '🎨 Personalización',
        'INTEGRACION': '⚡ Integraciones',
        'GENERAL': '⚙️ Configuración General'
    };
    
    // CORREGIDO: Actualizar título del modal que SÍ existe
    const titulo = document.querySelector('#edit-config-modal h3');
    if (titulo) {
        titulo.textContent = categoriaTitulos[category] || category.replace(/_/g, ' ');
    }
    
    // Crear formulario
    let formHTML = `<form id="categoria-config-form" class="space-y-4">`;
    
    configs.forEach(config => {
        const label = config.descripcion || config.clave.replace(/_/g, ' ').toLowerCase()
            .replace(/\b\w/g, l => l.toUpperCase());
        
        if (config.valor === 'SI' || config.valor === 'NO' || typeof config.valor === 'boolean') {
            const isChecked = config.valor === 'SI' || config.valor === true;
            formHTML += `
                <div class="mb-4">
                    <label class="flex items-center space-x-3">
                        <input type="checkbox" name="${config.clave}" 
                            ${isChecked ? 'checked' : ''} value="SI"
                            class="w-4 h-4 text-red-600 bg-gray-700 border-gray-600 rounded focus:ring-red-500">
                        <span class="text-sm font-medium text-gray-300">${label}</span>
                    </label>
                    <small class="text-gray-500 ml-7">${config.clave}</small>
                </div>
            `;
        } else {
            formHTML += `
                <div class="mb-4">
                    <label for="config-${config.clave}" class="block text-sm font-medium text-gray-300 mb-1">${label}</label>
                    <input type="text" id="config-${config.clave}" 
                           name="${config.clave}" 
                           value="${config.valor || ''}"
                           class="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-red-600 text-white">
                    <small class="text-gray-500">${config.clave}</small>
                </div>
            `;
        }
    });
    
    formHTML += `</form>`;
    
    // CORREGIDO: Usar el contenedor que SÍ existe
    container.innerHTML = formHTML;
    
    // Mostrar modal usando la función que ya tienes
    modal.classList.remove('hidden');
    
    // Guardar la categoría actual
    modal.dataset.editingCategory = category;
    currentConfigModal = {}; // Resetear datos actuales
    
    configs.forEach(config => {
        currentConfigModal[config.clave] = config.valor;
    });
}
        
        /**
         * Cierra el modal de edición de configuración.
         */
        function closeConfigModal() {
    const modal = document.getElementById('edit-config-modal');
    if (modal) {
        modal.classList.add('hidden');
        modal.dataset.currentCategory = '';
    }
}

        /**
         * Crea un campo de entrada para una configuración específica.
         * @param {string} key - La clave de la configuración.
         * @param {*} value - El valor actual.
         * @param {string} description - Descripción de la configuración.
         * @returns {HTMLElement} - El elemento HTML del campo de entrada.
         */
        function createConfigInputField(key, value, description) {
            const div = document.createElement('div');
            div.className = 'flex flex-col space-y-1';
            
            const label = document.createElement('label');
            label.className = 'text-gray-400 text-sm font-medium';
            label.textContent = description || key.replace(/_/g, ' ');
            label.setAttribute('for', key);

            let input;
            // Determinar el tipo de input basado en el valor
            if (typeof value === 'boolean' || value === 'SI' || value === 'NO') {
                input = document.createElement('select');
                input.id = key;
                input.className = 'bg-[#1f2428] border border-[#30363d] rounded-md p-2 focus:ring-2 focus:ring-[#960018] focus:border-transparent text-white';
                const optionYes = document.createElement('option');
                optionYes.value = 'SI';
                optionYes.textContent = 'SI';
                const optionNo = document.createElement('option');
                optionNo.value = 'NO';
                optionNo.textContent = 'NO';
                input.appendChild(optionYes);
                input.appendChild(optionNo);
                input.value = value === true || value === 'SI' ? 'SI' : 'NO';
            } else if (!isNaN(value) && value !== '') {
                input = document.createElement('input');
                input.type = 'number';
                input.id = key;
                input.className = 'bg-[#1f2428] border border-[#30363d] rounded-md p-2 focus:ring-2 focus:ring-[#960018] focus:border-transparent text-white';
                input.value = value;
            } else {
                input = document.createElement('input');
                input.type = 'text';
                input.id = key;
                input.className = 'bg-[#1f2428] border border-[#30363d] rounded-md p-2 focus:ring-2 focus:ring-[#960018] focus:border-transparent text-white';
                input.value = value;
            }

            div.appendChild(label);
            div.appendChild(input);
            return div;
        }
        
        /**
         * Guarda los cambios de configuración desde el modal.
         */
        function saveConfigModal() {
    const modal = document.getElementById('edit-config-modal');
    const categoria = modal.dataset.currentCategory;
    
    if (!categoria) {
        showNotification('Error: No se pudo identificar la categoría', 'error');
        return;
    }
    
    const form = document.getElementById('categoria-config-form');
    if (!form) {
        showNotification('Error: Formulario no encontrado', 'error');
        return;
    }
    
    // Recopilar datos del formulario
    const formData = new FormData(form);
    const newConfig = {};
    
    // Procesar checkboxes y campos de texto
    const inputs = form.querySelectorAll('input[name]');
    inputs.forEach(input => {
        if (input.type === 'checkbox') {
            newConfig[input.name] = input.checked ? 'SI' : 'NO';
        } else {
            newConfig[input.name] = input.value || '';
        }
    });
    
    console.log('💾 Guardando configuración:', newConfig);
    
    // Mostrar loader
    showLoader(true, 'Guardando configuración...');
    
    if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
            .withSuccessHandler((result) => {
                ocultarLoading();
                if (result && result.success) {
                    showNotification('Configuración guardada exitosamente', 'success');
                    closeConfigModal();
                    // Recargar configuración
                    setTimeout(() => setupSystemConfigUI(), 1500);
                } else {
                    showNotification(result?.message || 'Error al guardar configuración', 'error');
                }
            })
            .withFailureHandler((error) => {
                ocultarLoading();
                showNotification('Error de conexión al guardar', 'error');
                console.error('Error:', error);
            })
            .actualizarConfiguracion(newConfig);
    } else {
        // Modo demo
        setTimeout(() => {
            ocultarLoading();
            showNotification('Configuración guardada (modo demo)', 'success');
            closeConfigModal();
        }, 1000);
    }
}
        
        /**
         * Maneja el resultado de un guardado exitoso de la configuración.
         * @param {Object} response - Objeto de respuesta del backend.
         */
        function handleConfigSaveSuccess(response) {
            toggleModal('loading-modal', false);
            closeConfigModal();
            
            if (response && response.success) {
                showGeneralMessage('Éxito', response.message || 'Configuración guardada correctamente.', 'success');
                // Recargar la UI para reflejar los cambios
                setTimeout(() => setupSystemConfigUI(), 1500);
            } else {
                showGeneralMessage('Error', response?.message || 'Error desconocido al guardar', 'error');
            }
        }
        
        /**
         * Maneja errores en las llamadas al backend del modal.
         * @param {Object} error - Objeto de error.
         */
        function handleConfigErrorModal(error) {
            toggleModal('loading-modal', false);
            console.error('❌ [CONFIG UI] Error del servidor:', error);
            showGeneralMessage('Error del Servidor', error?.message || 'Error de conexión', 'error');
        }      
        
</script>

        <!-- Modal de Configuración Moderno -->
        <div id="config-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
            <div class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto border border-gray-700 animate-fade-in">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="config-modal-title" class="text-xl font-bold text-white flex items-center">
                            <i class="fa-solid fa-cogs mr-2 text-blue-400"></i>Editar Configuración
                        </h3>
                        <button onclick="document.getElementById('config-modal').classList.add('hidden')" class="text-gray-400 hover:text-white">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                    <div id="config-modal-body" class="py-4">
                        <!-- El contenido del formulario se insertará aquí dinámicamente -->
                        <div class="unified-loader-container" style="background: transparent; box-shadow: none;">
                            <div class="unified-loader"></div>
                            <p class="unified-loader-message">Cargando configuración...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Carga Moderno -->
        <div id="loading-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
            <div class="bg-gray-800 rounded-2xl p-8 flex flex-col items-center shadow-2xl border border-gray-700 animate-fade-in">
                <div class="unified-loader-container">
                    <div class="unified-loader"></div>
                    <p id="loading-text" class="unified-loader-message text-xl">Cargando...</p>
                </div>
            </div>
        </div>
        </script>